---
title: "Dynamic calculations of fire Disturbance Matrices for GCBM including fire severity"
author: "Thompson and Whitman"
format: pdf
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r defineVars, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(kableExtra)
library(tinytex)

#populate the values first:
global.vars <- list(0.9, 0.01, 0.09, 0.77, 0.03, 0.21)
#then label names
names(global.vars) <- array(c("FlamingCO2","FlamingCO","FlamingCH4","SmoulderingCO2","SmoulderingCO","SmoulderingCH4"))

#DID NOT RUN:
#global.vars$FlamingCO2 #returns desired value as double

ecozones.list <- list("LA","TP","TSW","BSW","BP","P","TC","BC","PM","MC","HP","TSE","BSE")

```

You can add options to executable code like this

```{r computeDuffConsump, echo=FALSE,message=FALSE, warning=FALSE}
#load an array of median DC values by ecozone (provided here hardcoded from Quinn Barber's dataframes of all Canadian hotspots from CWFIS 2002-2022):
Median.DC <- c(270,369,297,239,242,242,254,250,268,452,204,98,123)

# then the median forest floor load, minus an average litter value (provided here hardcoded from 10.1139/x2012-093):
Forest.Floor.Load <- c(1.7,15,1.7,8.8,9.8,9.8,8.31,8.31,15.2,6,7.9,1.7,10.9)

Forest.Floor.Load <- Forest.Floor.Load - 0.25 ### subtract average litter load (from 10.1139/cjfr-2016-0475)
Forest.Floor.consump.kg.m2 <- 0.016872*Median.DC^0.71*Forest.Floor.Load^0.671
Forest.Floor.consump.frac <- Forest.Floor.consump.kg.m2/Forest.Floor.Load


# start creating a simple list object per ecozone

BP <- list(ecozones.list[1],Median.DC[1],Forest.Floor.Load[1],Forest.Floor.consump.kg.m2[1],Forest.Floor.consump.frac[1])
names(BP) <- c("Ecozone.name","Median.DC.of.burning","Median.Forest.Floor.Load.kg.m2","Forest.Floor.consump.kg.m2","Forest.Floor.consump.frac")
BP$Ecozone.name <- c("BP")

```

```{r loadVarDefsSourceSink, echo=FALSE,message=FALSE, warning=FALSE}

#list of ecozone-specific terms (with and without severity dependence)
#first, import blank template that works for a single ecozone:
VarDefs.generic <- as.data.frame(read.csv("~/FireDMs/VarDefsGeneric.csv"))
VarDefs.generic <- VarDefs.generic[,1:7]

#then, replicate for each severity level*ecozone

#use slice from dplyr and each to replicate the template for each ecozone
VarDefs <- VarDefs.generic %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
VarDefs$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(VarDefs.generic))

#Once this is done and filled, load the canonical version: 
#NOT RUN (YET)
#VarDefs <- read.csv("~/FireDMs/FireDMTableDefs.csv")




#sink-source DM list:
#first, import blank template that works for a single ecozone:
SourceSinkGeneric <- read.csv("~/FireDMs/SourceSinkGeneric.csv")


#then, replicate for each severity level*ecozone
SourceSink <- SourceSinkGeneric %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
SourceSink$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(SourceSinkGeneric))


#Once this is done and filled, load the canonical version: 
#NOT RUN (YET)
#SourceSink <- read.csv("~/FireDMs/SourceSinkLong.csv")


```

```{r DefineDMvalues, echo=FALSE,message=FALSE, warning=FALSE}



for (i in seq(1:max(SourceSink$FluxID))) {

  ecozone <- as.character(ecozones.list[i]) #run this loop once for every ecozone, but have to cycle through all the fluxIDs
  
#FluxID: 1
#Source: SW Merch 
#sink: SW Merch
#Plain Language Summary of flux: survival of conifers
#Pseudocode: survival = 1-mortality
#Notes:  by axiom, survival = 1-mortality,

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Low"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Mod"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "High"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#but, I'm not doing this easily across all three severity classes, no need to run it across each severity class as its own line....

#FluxID: 2
#Source: SW Merch 
#sink: SW Stem Snag
#PLS: Mortality rate of large conifers (includes those with and without burned foliage)
#Pseudocode: as provided from field data, f(ecozone, severity class)
#Notes: mortality >= CFB; may not be the case in extremely fire-tolerant stands, but valid the vast majority of the time
#Notes2: just pulling Softwood CFB 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 3
#Source: SW Merch 
#sink: Black Carbon
#PLS: live stemwood to black carbon
#Pseudocode: =0, since no live stemwood -> 0 BC
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Low"] <- 0
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Mod"] <- 0
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 4
#Source: SW Foliage
#sink: SW Foliage
#PLS: Green fraction of canopy remaining intact after fire
#Pseudocode: IF([(1-Mortality)-CFB]<0,0,[(1-Mortality)-CFB])
#Notes: have to use logical statement here,

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Low"] <- ifelse((1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])) < 0,0,(1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])))
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Mod"] <- ifelse((1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])) < 0,0,(1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])))
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "High"] <- ifelse((1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])) < 0,0,(1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])))



## end loop

  # final step in loop: once you have a list each built by ecozone, then build a higher-level list called "FireDM"
   
}

```

```{r makeTables, echo=FALSE,message=FALSE, warning=FALSE}
 #example of ecozone-specific extraction
  SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$FluxID < 9 & SourceSink$SeverityClass == "Mod"]
  
  # and then do the source as rows and sink as column?
##single cell reference: SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == "Softwood Merchantable" & SourceSink$Sink == "Softwood Merchantable" & SourceSink$SeverityClass == "Mod"]
  
  
  ### list for columns and rows in visual DM: can be any order, not linked to FluxID or anything:
  sink.col.list <- c("Softwood Merchantable", "Softwood Stem Snag","Black Carbon","Softwood Foliage","Above Ground Very Fast soil C", "CO2", "CH4", "CO")
  source.row.list <- c("Softwood Merchantable", "Softwood Stem Snag","Black Carbon","Softwood Foliage","Above Ground Very Fast soil C", "CO2", "CH4", "CO")

  
  ###make this a function with attributes of ecozone and severity class:
  
  DM.temp <- as.data.frame(array(NA,c(8,8)))
  
  for (j in seq(1:8)) {
    for (k in seq(1:8)) {
     
      #if the pair is blank, then return NA, otherwise, look through the list of sink/source pairs for the ecozone and severity level and return that value 
      ifelse(is.na(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == "Mod"]),NA,DM.temp[j,k] <- SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == "Mod"])
     
      
    }
    
    
  } 
  rownames(DM.temp) <- source.row.list
  kbl(DM.temp[1:8,1:8],col.names = c("Softwood Merchantable", "Softwood Stem Snag","Black Carbon","Softwood Foliage","Above Ground Very Fast soil C", "CO2", "CH4", "CO")) %>%
    kable_styling(full_width = F, html_font = "Cambria")
    
```
