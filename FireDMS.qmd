---
title: "Dynamic calculations of fire Disturbance Matrices for GCBM including fire severity"
author: "Thompson and Whitman"
format: pdf
editor: visual
---

## Global Variables

Certain variables, like the fractionation of CO2:CH4:CO, are constant throughout ecozones, but vary by flaming vs smouldering. They are defined in a global variables table:

```{r defineVars, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(kableExtra)
library(tinytex)
library(formatR)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)

#populate the values first:
global.vars <- list(0.9, 0.01, 0.09, 0.77, 0.03, 0.21)
#then label names
names(global.vars) <- array(c("FlamingCO2","FlamingCH4","FlamingCO","SmoulderingCO2","SmoulderingCH4","SmoulderingCO"))

#DID NOT RUN:
#global.vars$FlamingCO2 #returns desired value as double

#can add/subtract ecozones here as needed.  Note that Mixedwood Plains not included here (but could/should be)
ecozones.list <- list("LA","TP","TSW","BSW","BP","P","TC","BC","PM","MC","HP","TSE","BSE")

```

## Duff Consumption

To be expanded later, but duff consumption can be calculated annually using the median hotspot Drought Code and de Groot's FFFC equations, as applied to median FFFL values. Could also be done per fire using fire-specific DC and mapped FFFC values as well. Need to compute this above for use below.

```{r computeDuffConsump, echo=FALSE,message=FALSE, warning=FALSE}
#load an array of median DC values by ecozone (provided here hardcoded from Quinn Barber's dataframes of all Canadian hotspots from CWFIS 2002-2022), using the exact same order of ecozones above:
Median.DC <- c(270,369,297,239,242,242,254,250,268,452,204,98,123)

# then the median forest floor load, minus an average litter value (provided here hardcoded from 10.1139/x2012-093):
Forest.Floor.Load <- c(1.7,15,1.7,8.8,9.8,9.8,8.31,8.31,15.2,6,7.9,1.7,10.9)

Forest.Floor.Load <- Forest.Floor.Load - 0.25 ### subtract average litter load (from 10.1139/cjfr-2016-0475)
Forest.Floor.consump.kg.m2 <- 0.016872*Median.DC^0.71*Forest.Floor.Load^0.671
Forest.Floor.consump.frac <- Forest.Floor.consump.kg.m2/Forest.Floor.Load


# start creating a single list object to encapsulate all the modelling:
#where FFFC is "Forest Floor Fuel Consumption" a la de Groot's naming convention:

FFFC <- as.data.frame(cbind(ecozones.list,Median.DC,Forest.Floor.Load,round(Forest.Floor.consump.kg.m2,digits = 2),round(Forest.Floor.consump.frac,digits = 2)))
names(FFFC) <- c("Ecozone","Median.DC.of.burning","Median.Forest.Floor.Load.kg.m2","Forest.Floor.consump.kg.m2","Forest.Floor.consump.frac")
## for example:
#FFFC$Ecozone.name[1]

### and to query values:
FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == "BP"]


```

## Constructing fire DMs from abstractions

```{r loadVarDefsSourceSink, echo=FALSE,message=FALSE, warning=FALSE}

#list of ecozone-specific terms (with and without severity dependence)
#first, import blank template that works for a single ecozone:
VarDefs.generic <- as.data.frame(read.csv("~/nrcan-cfs-fire/FireDMs/VarDefsGeneric.csv"))
VarDefs.generic <- VarDefs.generic[,1:7]

#then, replicate for each severity level*ecozone

#use slice from dplyr and each to replicate the template for each ecozone
VarDefs <- VarDefs.generic %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
VarDefs$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(VarDefs.generic))

#Once this is done and filled in with data from observations, load the canonical version: 
# this will overwrite the above loop
#NOT RUN (YET)
#VarDefs <- read.csv("~/nrcan-cfs-fire/FireDMs/FireDMTableDefs.csv")




#sink-source DM list:
#first, import blank template that works for a single ecozone:
SourceSinkGeneric <- read.csv("~/nrcan-cfs-fire/FireDMs/SourceSinkGeneric.csv")


#then, replicate for each severity level*ecozone
SourceSink <- SourceSinkGeneric %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
SourceSink$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(SourceSinkGeneric))


#Once this is done and filled, load the canonical version: 
# this will overwrite the above loop
#NOT RUN (YET)
#SourceSink <- read.csv("~/FireDMs/SourceSinkLong.csv")


```

First, a generic template for a fire DM is loaded, that can represent any ecozone. It comes in two parts: (1) a list of variables, some biophysical and not relating to fire severity (such as the portion of live branchwood that falls into the smaller size fraction); or (2) severity-specific variables (such as Crown Fraction Burn) for a severity class. The template is loaded, and replicated across the list of ecozones (or any spatial unit) desired. Other processes, such as the analysis of field data, can then be used to fill in ecozone-specific variables in severity classes.

An example of the variable definition template is as follows:

```{r varDefsExample, echo=FALSE, message=FALSE, warning=FALSE}
kbl(head(VarDefs)) %>%
  kable_minimal()  %>%
          kable_styling(latex_options = "scale_down")



```

A plain language name for each variable is provided right in the data, as well.

A second template defines each flux in a Disturbance Matrix, with Source and Sink defined as precise character variables, and a plain language summary ("Process Synonym") included to tie this flux back to language used in the fire science literature. Pseudocode and notes are included in each flux, which is repeated for each fire severity class and ecozone. There are 3900 total fluxes, though many do not have sufficient information to describe differences between ecozones. Many of these are computed automatically, tying back into variables such as Crown Fraction Burned.

```{r SinkSourceExample, echo=FALSE, message=FALSE, warning=FALSE}
kbl(head(SourceSink)) %>%
  kable_minimal() %>%
          kable_styling(latex_options = "scale_down")



```

With both generic ecozone variables as well as severity-specific variables defined and the pseudocode for each flux included, actual DM values are computed as references to tables, subset by ecozone and severity class:

```{r snip2}
#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Low"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])
```


Note that rather than defining softwood crown fraction burned as a variable called "SW.CFB.Boreal.Plains" for each ecozone, there is a row in the VarDefs table that represents SW.CFB in each ecozone and for each severity class, thus avoiding the creation of large lists of manually entered variable names and values in the R environment. Instead, these values can be programmatically entered via external analysis of plot data (not covered here).

```{r DefineDMvalues, echo=FALSE,message=FALSE, warning=FALSE}



for (i in seq(1:max(SourceSink$FluxID))) {

  ecozone <- as.character(ecozones.list[i]) #run this loop once for every ecozone, but have to cycle through all the fluxIDs
  
#FluxID: 1
#Source: Softwood (SW) Merch 
#sink: SW Merch
#Plain Language Summary of flux: survival of conifers
#Pseudocode: survival = 1-mortality
#Notes:  by axiom, survival = 1-mortality,

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Low"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Mod"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "High"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#but, I'm not doing this easily across all three severity classes, no need to run it across each severity class as its own line....

#FluxID: 2
#Source: SW Merch 
#sink: SW Stem Snag
#PLS: Mortality rate of large conifers (includes those with and without burned foliage)
#Pseudocode: as provided from field data, f(ecozone, severity class)
#Notes: mortality >= CFB; may not be the case in extremely fire-tolerant stands, but valid the vast majority of the time
#Notes2: just pulling Softwood CFB 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 3
#Source: SW Merch 
#sink: Black Carbon
#PLS: live stemwood to black carbon
#Pseudocode: =0, since no live stemwood -> 0 BC
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 4
#Source: SW Foliage
#sink: SW Foliage
#PLS: Green fraction of canopy remaining intact after fire
#Pseudocode: IF([(1-Mortality)-CFB]<0,0,[(1-Mortality)-CFB])
#Notes: have to use logical statement here, google sheets version said 1-Mortality, but can be <0 unless logic is enforced here
#note2: given definition of CFB, this includes all foliage in merch and submerch

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Low"] <- ifelse((1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])) - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) < 0,0,(1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])) - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])) 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Mod"] <- ifelse((1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])) - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) < 0,0,(1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])) - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])) 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "High"] <- ifelse((1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])) - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) < 0,0,(1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])) - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])) 

#FluxID: 5
#Source: SW Foliage
#sink: Above Ground Very Fast soil C
#PLS: Post-fire litterfall (heat-killed but not burned, then falls to ground within the season)
#Pseudocode: Mortality-CFB
#Notes: assume 100% of heat-killed litter falls within the year of fire

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] - VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] - VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] - VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 6
#Source: SW Foliage
#sink: CO2
#PLS: CO2 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO2
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 7
#Source: SW Foliage
#sink: CH4
#PLS: CH4 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCH4
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 8
#Source: SW Foliage
#sink: CO
#PLS: CO emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 9
#Source: SW Other
#sink: SW Other
#PLS: surviving Live branches, stumps, small trees and bark
#Pseudocode: =(1-(mortality rate of conifers)*branch fraction of "other" pool)+(1-(medium DOM consumption rate)*stump fraction of other pool)+(1-(mortality of small tree conifers in severity class)*small tree fraction of other pool)+(1-CFB*bark fraction of other pool)
#Notes: 

### trying this for now (not working), or else this could just be 1-(consumption + killed of other pool)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]) + (1 - VarDefs$Value[VarDefs$Variable.Name == "MedDOM.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone]) + (1 - VarDefs$Value[VarDefs$Variable.Name == "SmTree.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone]) + (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone])


#FluxID: 10
#Source: SW Other
#sink: SW Branch Snag
#PLS: Portion of "other" pool as killed by fire but otherwise unconsumed branches
#Pseudocode: (CFB * (1-SW.LgBranch.Comb.Frac))*SW.BW.frac.of.other

#Notes:  #since 1-SW.LgBranch.Comb.Frac is the snag creation rate

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]                                                                                                                     
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]   
                                                                                                                      
#FluxID: 11
#Source: SW Other
#sink: CO2
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO2)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO2)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO2)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO2)

#Notes:  works so far and gives reasonable values of ~0.17, 0.19, 0.2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "Low"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Low"] * global.vars$FlamingCO2 +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "Mod"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Mod"] * global.vars$FlamingCO2 +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "High"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "High"] * global.vars$FlamingCO2 +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO2)

#FluxID: 12
#Source: SW Other
#sink: CH4
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCH4)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCH4)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCH4)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCH4)

#Notes:  works so far and gives reasonable values of ~0.017, 0.019, 0.02

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "Low"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Low"] * global.vars$FlamingCH4 +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "Mod"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Mod"] * global.vars$FlamingCH4 +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "High"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "High"] * global.vars$FlamingCH4 +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCH4)

#FluxID: 13
#Source: SW Other
#sink: CO
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO)

#Notes:  works so far 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "Low"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Low"] * global.vars$FlamingCO +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "Mod"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Mod"] * global.vars$FlamingCO +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "High"] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "High"] * global.vars$FlamingCO +  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO)


#FluxID: 14
#Source: SW SubMerch
#sink: SW SubMerch
#PLS: Understory conifer survival rate
#Pseudocode:  =1-(mortality of submerch conifers in severity class) 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 14 & SourceSink$SeverityClass == "Low"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 14 & SourceSink$SeverityClass == "Mod"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 14 & SourceSink$SeverityClass == "High"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 15
#Source: SW SubMerch
#sink: SW Branch Snag
#PLS: Understory conifer stems killed but not consumed
#Pseudocode:  = SubMerch mortality, since live understory trees don't get consumed in the fire, 

#notes: submerch trees assumed to not have large enough branches to avoid consumption in fire.  Equal to 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 15 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 15 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 15 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 16
#Source: SW SubMerch
#sink: CO2
#PLS: Understory Conifer consumption rate
#Pseudocode:  = 0 !IF! this is only about submerch stems 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 16 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 16 & SourceSink$SeverityClass == "Mod"] <-0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 16 & SourceSink$SeverityClass == "High"] <- 0

#FluxID: 17
#Source: SW SubMerch
#sink: CH4
#PLS: Understory Conifer consumption rate
#Pseudocode:  = 0 !IF! this is only about submerch stems 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 17 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 17 & SourceSink$SeverityClass == "Mod"] <-0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 17 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 18
#Source: SW SubMerch
#sink: CO
#PLS: Understory Conifer consumption rate
#Pseudocode:  = 0 !IF! this is only about submerch stems 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 18 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 18 & SourceSink$SeverityClass == "Mod"] <-0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 18 & SourceSink$SeverityClass == "High"] <- 0

#FluxID: 19
#Source: SW Coarse roots
#sink: SW Coarse roots
#PLS: Surviving coarse roots in conifers
#Pseudocode:  =1-(conifer mortality rate)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "Low"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "Mod"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "High"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 20
#Source: SW Coarse roots
#sink: Above Ground Fast soil C
#PLS: Coarse Roots killed in fire but not combusted in organic soil
#Pseudocode:  =(conifer mortality rate)*(conifer coarse root fraction in organic soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides SW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]


#FluxID: 21
#Source: SW Coarse roots
#sink: Below Ground Fast soil C
#PLS: Coarse Roots killed in fire but not combusted since they are in mineral soil
#Pseudocode:  =(conifer mortality rate)*(conifer coarse root fraction in mineral soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides SW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * (1 -  VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * (1 -  VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])



#FluxID: 23
#Source: SW fine roots
#sink: Above Ground Very Fast soil C
#PLS: Fine roots killed but not burned in organic soil
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone]))


#FluxID: 24
#Source: SW fine roots
#sink: Below Ground Very Fast soil C
#PLS: Fine roots killed but not burned in mineral soil
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in mineral soil)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])




#FluxID: 25
#Source: SW fine roots
#sink: CO2
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to SW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2


#FluxID: 26
#Source: SW fine roots
#sink: CH4
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to SW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4



#FluxID: 27
#Source: SW fine roots
#sink: CO
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to SW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Forest.Floor.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

#FluxID: 22
#Source: SW fine roots
#sink: SW fine roots
#PLS: Surviving fine roots
#Pseudocode:  =1-(combustion rate of fine roots+mortality rate of fine roots)
#notes: computed at end of fine roots calculations, even though listed as Flux 22
# NOTE: debug needed on high severity, giving value of -0.002, so rounding problem??

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Low"] <- 1 - sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Mod"] <- 1 - sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "High"] <- 1 - sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "High"])

## end loop

  # final step in loop: once you have a list each built by ecozone, then build a higher-level list called "FireDM"
   
}

```

And make a checksum table to ensure all the major pools sum of up 1:

```{r checkSum, echo=FALSE,message=FALSE, warning=FALSE}

```



In a final step, a classical tabular DM is show, with row and column names precisely matching those in the Sink and Source columns in the SourceSink table:

```{r makeTables, echo=FALSE,message=FALSE, warning=FALSE}
 #example of ecozone-specific extraction NOT RUN
  #SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$FluxID < 9 & SourceSink$SeverityClass == "Mod"]
  
  # and then do the source as rows and sink as column?
##single cell reference: SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == "Softwood Merchantable" & SourceSink$Sink == "Softwood Merchantable" & SourceSink$SeverityClass == "Mod"]
  
  
  ### list for columns and rows in visual DM: can be any order, not linked to FluxID or anything:
  sink.col.list <- c("Softwood Merchantable", "Softwood Stem Snag","Black Carbon","Softwood Foliage","Above Ground Very Fast soil C", "CO2", "CH4", "CO")
  source.row.list <- c("Softwood Merchantable", "Softwood Stem Snag","Black Carbon","Softwood Foliage","Above Ground Very Fast soil C", "CO2", "CH4", "CO")

  
  ###make this a function with attributes of ecozone and severity class:
  
  DM.temp <- as.data.frame(array(NA,c(8,8)))
  
  for (j in seq(1:8)) {
    for (k in seq(1:8)) {
     
      #if the pair is blank, then return NA, otherwise, look through the list of sink/source pairs for the ecozone and severity level and return that value 
      ifelse(is.na(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == "Mod"]),NA,DM.temp[j,k] <- SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == "Mod"])
     
      
    }
    
    
  } 
  rownames(DM.temp) <- source.row.list
  kbl(DM.temp[1:8,1:8],col.names = c("Softwood Merchantable", "Softwood Stem Snag","Black Carbon","Softwood Foliage","Above Ground Very Fast soil C", "CO2", "CH4", "CO"), align = "c",caption = "Example moderate severity DM in Boreal Plains") %>%
    kable_styling(full_width = F, html_font = "Cambria") %>%
column_spec(2:8, width = "2cm") %>%
column_spec(1, width = "3cm") %>%
  kableExtra::landscape() %>%
          kable_styling(latex_options = "scale_down")
```
