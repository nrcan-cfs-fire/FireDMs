---
title: "Incorporating observed fire severity in refined emissions estimates for boreal and temperate forest fires in the carbon budget model CBM-CFS3"
journal: "`r rticles::copernicus_journal_abbreviations(journal_name = 'gmd')`"
author:
  - given_name: Dan K.
    surname: Thompson
    affiliation: 1
    email: daniel.thompson@nrcan-rncan.gc.ca
  - given_name: Ellen
    surname: Whitman
    affiliation: 2
    email: ellen.whitman@nrcan-rncan.gc.ca
  - given_name: Hafer
    surname: Mark
    affiliation: 3
    email: mark.hafer@nrcan-rncan.gc.ca
  - given_name: Oleksandra
    surname: Hararuk
    affiliation: 2
    email: oleksandra.hararuk@nrcan-rncan.gc.ca
  - given_name: Chelene
    surname: Hanes
    affiliation: 1
    email: chelene.hanes@nrcan-rncan.gc.ca
  - given_name: Vinicius
    surname: Manvailer Goncalves
    affiliation: 3
    email: vinicius.manvailergoncalves@nrcan-rncan.gc.ca
  - given_name: Ben
    surname: Hudson
    affiliation: 3
    email: benjamin.hudson@nrcan-rncan.gc.ca
affiliation:
  - code: 1
    address: Natural Resources Canada, Canadian Forest Service, Great Lakes Forestry Centre, Sault Ste. Marie, Canada
  - code: 2
    address: Natural Resources Canada, Canadian Forest Service, Northern Forestry Centre, Edmonton, Canada
  - code: 3
    address: Natural Resources Canada, Canadian Forest Service, Pacific Forestry Centre, Victoria, Canada
output:
  rticles::copernicus_article:
    highlight: null
    keep_tex: true
  word_document: null
  pdf_document: default
  bookdown::pdf_book:
    base_format: rticles::copernicus_article
abstract: "Among the many natural disturbances that affect Canada’s boreal and temperate forest biomes, wildfire has the greatest impact on forest productivity, landscape structure, timber supply and greenhouse gas emissions. Current representations of fire impact on forest carbon stocks is limited to a single parameterization of fire severity (i.e. the fate of biomass including consumption) that assumes only high severity fires, despite a large evidence base of widespread mixed-severity boreal wildfire. This paper describes a sub-model, termed FireDMs (Fire Disturbance Matrix: severity), of the National Forest Carbon Monitoring Accounting and Reporting System for Canada (NFC-MARS). In this sub-model, field measurements of biomass consumption are related to satellite-derived burn severity maps and are interpreted from a fire physics and ecology perspective to derive estimates of the forest greenhouse gas fluxes in the immediate aftermath of fires. The sub-model also quantifies fire-killed by uncombusted biomass as a set of disctinct pools. Model outputs indicate total direct carbon emissions range from a 11 t C/ha in Boreal Shield West forests of Saskatchewan following low severity fire to over 60 t C/ha in Pacific Maritime forests of British Columbia under high severity fire. The existing approach to emissions in NFC-MARS yields regional CO2e emissions that are 10-25 percent higher than this new method, owing to lower overall canopy consumption with mixed-severity fires, which is only partially offset by increased estimates forest floor consumption in this new approach. Comparisons against directly observed fire plume emissions ratios as well as against annualized carbon emissions for Canada's 2023 fire season show good model agreement with observations."
bibliography: references.bib
running:
  title: Fire Severity and Canadian Forest GHG Reporting
  author: Thompson et al.
competinginterests: The authors declare no competing interests.
copyrightstatement: His Majesty the King in Right of Canada as represented by the  Minister of Natural Resources Canada. This work is distributed under the Creative Commons Attribution 4.0 License.
availability:
  codedata: "This article was produced from an RMarkdown document with underlying data, available at https://github.com/nrcan-cfs-fire/FireDMs"
authorcontribution: 
disclaimer: "The algorithm and results presented only apply to boreal and temperate  forest ecosystems where sufficient ground plots of fire severity are available. As a data-driven model, this framework is not suitable for other ecosystems nor  agricultural or forestry biomass burning practices."
acknowledgements: 
appendix:
always_allow_html: true
editor_options:
  chunk_output_type: console
---

# Introduction

Wildfire is on par with insects as the largest stand-replacing disturbance process in Canada's forest, impacting \~1–3 Mha of Canada's 367 Mha forested area in a typical year [@hanes2019]. In Canada's reliable 54-year burned area record, ten years have exceeded 4 Mha of burned area (or approximately 1% of Canada's forest area) [@skakun2022]. The 2023 fire season in Canada burned a remarkable 15 Mha owing to extreme drought, severe fire weather conditions, and a prolonged fire season length [@jainDriversImpactsRecordBreaking2024].

Of this, publicly-owned managed forest under long or short-term tenure accounts for 23% of the area burned between 1972 and 2024; publicly-owned managed forest under long-term license to private timber companies forms 40% of Canada's forest area [@stinson2019]. Privately-owned forest constitutes only 6% of the forest area, but only 0.5% of area burned. The remainder of the forest area burned in Canada being a mix of formally protected areas, remote unmanaged forest, Indigenous reserve lands and other uses without large-scale harvesting. Managed northern forest areas adjacent to communities have historically shown some meaningful local fire suppression effects with a bias towards older forest nearby boreal forest communities in Canada, though the effect is largely limited to a 25 km radius between these widely dispersed communities [@parisien2020]. More southern boreal forest with extensive suppression activities has historically seen evidence of a reduction in observed vs potential area burned [@cummingEffectiveFireSuppression2005] though this effect has likely been erased given the increasing frequency of extreme burning conditions @wangCriticalFireWeather2023 and corresponding record area burned [@jainDriversImpactsRecordBreaking2024].

Burned area in Canada is dominated by a relatively small number of very large fires, with 3% of fires constituting 97% of the burned area [@stocks2002]. Lightning-caused fires account for approximately half of all ignitions and approximately 80% of burned area, but no distinction is made between human and lightning ignition for forest sector GHG reporting purposes. Annual burned area mapping for GHG reporting in Canada is conducted using a composite of satellite and aerial mapping at 30 metre resolution; the relatively small number of large fires, and their slow vegetation regeneration [@white2017] allows for reliable mapping using multi-spectral imagery such as Landsat within one year of the fire [@whitman2018].

Canada reports on GHG emission and removals from the forest sector in Canada’s National GHG Inventory Report (NIR). Carbon stocks and stock changes are modelled using CBM-CFS3 [@kurzCBMCFS3ModelCarbondynamics2009] parameterized and driven by spatial and non-spatial data describing forest inventory, annual yield and disturbance [@stinsonInventorybasedAnalysisCanadas2011]. Following international good practice guidance to focus on human-caused emissions in NIRs, Canada focuses emission reporting on managed forest lands, which make up approximately 225 Mha of Canada’s 367 Mha total forest area. In CBM-CFS3, forest inventory is represented by spatially referenced stand lists representing large homogeneous stands that fall within spatial units (e.g. forest management areas) and broad regions called Reconciliation Units (RU) that are the intersection of ecozones with provincial/territorial boundaries [@kurz2002]. Within CBM-CFS3 precisely mapped burned areas [@hall2020] are summarized at the level of spatial units and applied randomly to stands within that unit. Years with larger burned areas will improve the representative nature of random stands being assigned fire disturbance within a year, as a wider variety of stand types will be selected. Furthermore, large, drought-driven fire years such as 2023 have been observed to burn at more equal rates across the diversity of local ecosite flammability [@parks2018; @whitman2024] and thus provides an ideal test case for assessing changes in emissions estimates for a spatially referenced system. Importantly, these years with very large area burned still show a similar natural range in variability of burn severity [@whitman2018].

CBM-CFS3 currently assesses fire impacts to carbon pools only as representing high-severity fire, which is the most common of the three severity classes (low, moderate, and high) used for assessing of burned forest in Canada [@hallRemoteSensingBurn2008] and the conterminous US [@eidenshink2007]. Currently, biomass consumption estimates are based on the assumption of complete crown mortality, with additional biomass consumption following a spatially-referenced aggregated estimate at the RU of annualized drought conditions. Quantification of the change in carbon stock in CBM-CFS3 is made via a “Disturbance Matrix” (hereafter referred to as a DM) which is simply a matrix of the proportional mass flux of carbon (12 g/mol elemental carbon, not biomass units) between each pair of pools in the model for a site experiencing a given disturbance. This proportional mass flux is independent of the size of the C pool. Pools in the DM include all the above and below-ground pools tracked in CBM-CFS3, as well as an atmospheric sink pool. Importantly, unlike emissions-only fire models commonly used in air quality modelling in Canada [@chen2019], DM definitions in CBM-CFS3 also track the transfer of live biomass to dead, but still uncombusted pools, such as the transfer from live stemwood pools (which are killed but not burned) to standing deadwood, also known as snags.

In Canada’s forests, a combination of climate, disturbance history, soils, and less frequently topographic variables determine leading tree species; at local scales (1--100 ha), tree species composition plays a major role in determining ecosystem susceptibility to fire [@bernier2016] where older, conifer-dominated forests burn at very high rates relative to adjacent deciduous or mixed stands. Even when deciduous and mixed forests burn at rates more similar to older conifer stands during large drought-driven fire years [@parksNewMetricQuantifying2014], they do so at consistently lower severity compared to all but the most xeric conifer forests [@whitman2018]. Thus, important local biases in fire activity and severity towards older and moderate to poorly-drained forests are not resolved in the spatially-referenced CBM-CFS3 when a uniform fire severity is applied.

To support recent advances in operational burn severity mapping for Canada [@whitman2020] alongside multi-decade reliable burned area records that provide certainty on fire start and end dates [@guindon2014; @hall2020], this paper describes a local scale (30-m) method for defining a per-pixel proportional carbon flux estimate via a locally calculated fire DM. In this document, we outline the evidence-based fire Disturbance Matrices (DM) updated and designed for a planned, spatially-explicit update to the CBM-CFS3, anchored in a three severity class paradigm (low, moderate, and high severity). These fire carbon flux models are built from a blend of aggregated field data linked to remotely sensed severity, as well as insights from fire physics and experimental fires. Key knowledge gaps are also highlighted, with interim solutions presented until further quantification can be done in field studies, such as from further wildfire observations, experimental fires, or prescribed fires.

Simplified fire DMs (i.e. a scalar reduction on 100% mortality assumption across all DM components, constant severity across all fires) have been used in valuable scenario exercises using a spatial explicit version of CBM-CFS3 for assessment of future fire and harvest scenarios [@smyth2022]. The algorithm development shown here provides an important data-driven and regionally-adjusted framework that better reflects the ecological nuances of moderate and low-severity fire across Canada’s diverse ecozones.

# Methods

```{r loadLibsEtc, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(dplyr, warn.conflicts = FALSE)
library(kableExtra)
library(tinytex)
library(formatR)
library(data.table)
library(directlabels)
library(ggrepel)
library(gtools)
library(rticles)
library(mgcv)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
library(minpack.lm)
library(terra)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(tidyterra)
library(ggtern)
library(ggpubr)
library(pandoc)
options(dplyr.summarise.inform = FALSE)
library(exiftoolr)



###note you will need to install Latex via tinytex::install_tinytex()

##getting ready for renv
#https://rstudio.github.io/renv/articles/renv.html
###run renv::restore() if in doubt, should auto-load everything

#original list
#ecozones.list <- list("AM","TP","TSW","BSW","BP","P","TC","BC","PM","MC","HP","TSE","BSE")

#complete list, ordered by decreasing CNFDB burned area:
#ecozones.list <- list("BSW","TP","TSW","BP","BC","BSE","TSE","MC","HP","TC","PM","SuP","SeP","AM","MP")

##working list as of 2023-04-13 that has all the data we need, no P
ecozones.list <- list("BSW","TP","TSW","BP","BC","BSE","TSE","MC","HP","TC","PM","AM","MP")
```

```{r pandoc-custom-version-compile, eval=FALSE, include=FALSE}

## was getting a pandoc error using pandoc 3.4, so using an older pandoc release:
#see
##https://bookdown.org/yihui/rmarkdown-cookbook/install-pandoc.html
### use this to 
pandoc::with_pandoc_version(
  version = '3.2',
rmarkdown::render('~/nrcan-cfs-fire/FireDMs/GMD/FireDMs.Rmd'))

```

## Carbon Modelling

## Carbon Modelling Spatial Units

```{r RU-map, echo=FALSE, message=FALSE, warning=FALSE}

#### queue up data for figure 1:
### map of ecozones and plot locations using ggplot
### https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html
##gml link for ecozones is here:http://www.agr.gc.ca/atlas/data_donnees/bio/aafcEcostratification/gml/ECOZONE_V2_2_GML.zip
###WFS for ecozones is here: http://ecozones.ca/english/services.html
### using WFS in ggplot is here: https://inbo.github.io/tutorials/tutorials/spatial_wfs_services/

##read ecozones map from local dir:

ReportingUnits <- st_read("~/nrcan-cfs-fire/FireDMs/NationalReportingUnits.gpkg", quiet = TRUE)

ecozones_used <- st_read("~/nrcan-cfs-fire/FireDMs/ecozones_used_3978.gml",quiet=TRUE)
st_crs(ecozones_used) <- 3978


Canada <- ne_countries(scale = "medium", returnclass = "sf", country = "Canada")
##also load big lakes in Canada

###download option, but annoying loading message that's hard to suppress:
#lakes50 <- ne_download(scale = 50, type = 'lakes', category = 'physical', returnclass = "sf")
###use local copy: 
lakes50 <- st_read("~/nrcan-cfs-fire/FireDMs/ne_50m_lakes.gml", quiet = TRUE)
st_crs(lakes50) <- 4326
### convert this to gml and keep in github repo
### permalink?: https://github.com/nvkelso/natural-earth-vector/blob/master/50m_physical/ne_50m_lakes.shp

st_crs(Canada) <- 4326


lakes50_crop <- st_intersection(lakes50, Canada)

lakesCanada_3978 <- sf::st_transform(lakes50_crop, 3978)
Canada_3978 <- sf::st_transform(Canada, 3978)



```

```{r Fig1-RU-ecozones-NOT-RUN, eval=FALSE, fig.cap="\\label{fig:Fig1-RU-ecozones}Reconciliation Units used in the CBM-CFS3 framework.", message=FALSE, warning=FALSE, include=FALSE, out.width="50%"}
ReportingUnits <- ReportingUnits %>% filter(eco_name != "arctic cordillera") %>% filter(eco_name != "northern arctic") %>% filter(eco_name != "southern arctic")

ecozones_colours <- c("#a6cee3","#1f78b4","#fb9a99","#33a02c","#b2df8a","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928","#7d8b8f", "#c1c1c1","brown")

##clip lakes to RUs only

lakesCanada_3978_clip <- st_intersection(lakesCanada_3978,ReportingUnits)

ggplot(data = ReportingUnits) +  geom_sf(aes(fill=factor(eco_name)),,show.legend = "polygon") + scale_fill_manual(values=ecozones_colours) +  geom_sf(data = lakesCanada_3978_clip,colour="black",fill="white")  + geom_sf_label(data=ReportingUnits,nudge_y = c(0,0,0,0,250000,0,0,-100000,0,0,+100000),size=2.5,label.padding = unit(0.15, "lines"),aes(label = factor(unit_id))) +ylab("")+xlab("") + theme_bw() +theme(legend.title=element_blank(),legend.position = "inside",legend.position.inside = c(0.64,0.88),legend.text = element_text(size = 8),legend.key.size = unit(0.2, 'cm')) + guides(fill = guide_legend(ncol = 3),legend.background = element_blank())

## optional: label provinces at centroids?


### prior version without labels and incl arctic Canada:
#ggplot(data = Canada_3978) +  geom_sf(colour="black")+ geom_sf(data=ReportingUnits, aes(fill=factor(eco_name)),show.legend = "point") + geom_sf(data = lakesCanada_3978,colour="black",fill="white") + theme(legend.position = "none") + geom_sf_label(data=ReportingUnits,nudge_y = c(0,0,0,0,250000,0,0,-100000,0,0,+100000),size=2.5,label.padding = unit(0.15, "lines"),aes(label = factor(unit_id))) + scale_fill_manual(values=ecozones_colours)+ylab("")+xlab("") # + geom_sf_label(data=ecozones_used,nudge_y = c(0,0,0,0,250000,0,0,-100000,0,0,+100000),size=2.5,label.padding = unit(0.15, "lines"),aes(label = factor(ECOZONE))) # + ggrepel::geom_label_repel(data=ecozones_used, aes(label = ECOZONE, geometry = geometry), stat = "sf_coordinates", min.segment.length = 0,label.size = NA) 

```

```{r Fig1-RU-ecozones, echo=FALSE, fig.cap="\\label{fig:Fig1-RU-ecozones}Reconciliation Units used in the CBM-CFS3 framework.", out.width="75%", message=FALSE, warning=FALSE}

### was getting a strange error since the output map in pdf was too large for the latex compiler somehow.  Inserting the above ggplot image as png instead (lazy screenshot not ggsave)

knitr::include_graphics("~/nrcan-cfs-fire/FireDMs/RU_plot.png")
```

Carbon reporting in Canada's forests is broken down by Reconciliation Unit (RU), which is the intersection of terrestrial ecozones and provincial/territorial boundaries, as shown in Figure \ref{fig:Fig1-RU-ecozones}. Forest carbon stocks in Canada are influenced by species composition, age class distribution, natural disturbance history, human-influenced management regime and climatic variables, among other factors, which are well-represented by the RU framework supporting Canada’s NIR. Due to the current spatial imprecision of certain key model data (e.g. deforestation rates), analysis finer than the RU-level tends to misrepresent regional-variation in emission estimates. \## Biomass pools of the CBM-CFS3 Model

```{r CBM-pools-simple-table,tab.cap="\\label{tab:CBM-pools-simple-table}", echo=FALSE, message=FALSE, warning=FALSE}


Component <- c("Stemwood","Foliage","Branches","Coarse woody debris","Forest Floor","Snags")
FireBehaviour <- c("The main stem of the tree can either survive or be killed and converted to a snag, depending on severity.", "Susceptible to combustion at high severity and mortality at all severities. ","Smaller diameter classes susceptible to combustion at high severity and mortality at all severities. ","Susceptible to combustion at all severities. After fire, uncombusted snags fall down into this pool.","Combustion fraction dependent on drought condition; lower susceptibility in F, H, O soil horizons (i.e. Slow pool). After fire at any severity, uncombusted foliage and dead branches transfer to these pools. Uncombusted roots can be transferred into these pools for high severity fires when the main stem experiences mortality. ","Higher combustion susceptibility at higher severity ")
CBM_Pool <- c("Merchantable","Foliage","Other","Medium DOM","Above Ground Very Fast (Litter); Above Ground Fast; Above Ground Slow DOM (F,H,O)","Stem, Branch Snag")

CBM_pools_table <- cbind(Component,FireBehaviour,CBM_Pool)

colnames(CBM_pools_table) <- c("Component","Fire Behaviour", "CBM-CFS3 Pool")

kbl(CBM_pools_table,align="c",caption="Key components of the CBM-CFS3 model relevant to fire behaviour and fuel consumption.")  %>%  kable_minimal() %>%  column_spec(1, width = "3cm") %>%  column_spec(2, width = "6cm") %>% column_spec(3, width = "3cm")


```

The carbon pools represented in CBM-CFS3 can be broadly categorized as live biomass, dead organic matter (DOM) and soil carbon and are described in detail in @kurzCBMCFS3ModelCarbondynamics2009. Key components that interact most with wildfire are summarized in Table \ref{tab:CBM-pools-simple-table}. Though designed for forest GHG reporting, the pool structure of CBM-CFS3 does distinguish between softwood (conifer) and hardwood (broadleaf) that also have large contrasts in both foliage flammability [@alexanderSurfaceFireSpread2010] and ability to survive low to moderate intensity surface fires [@heonResistanceBorealForest2014]. Tree biomass pools are further divided into merchantable tree biomass pools (foliage, stemwood, branches), with separate hardwood and softwood pools for smaller, subcanopy trees. Representative pool values (in t C/ha) per Reconciliation Unit are produced and updated annually based on updated forest inventory and disturbance data. Pool size information by RU is provided in Appendix A. Upon the detection of a forest disturbance such as fire, pool C biomass (both dead and alive) can be transferred to other pools including an atmosphere pool (or remaining the same pool) at proportions prescribed by a Disturbance Matrix. Any live or dead biomass pools combusted immediately are tallied in the direct emissions sums reported here. Live biomass that is killed but not combusted by the fire is tracked, but experiences delayed decomposition on the order of years to decades, and therefore is not tallied within the direct emissions modelling shown below.

## Definitions and assumptions of forest carbon budget after fire

To simplify the process of creating DMs as a distillation of the complexities of fire severity and combustion patterns, the following statements are proposed and maintained throughout:

1.  Disturbance matrices are to be in terms of mortality, not survival. Mortality here is defined as tree death by the end of the calendar year of the fire's occurrence. Tree mortality in subsequent years is not modelled here.

2.  Crown Fraction Burned (CFB) is a mass-based estimate of the portion of foliage consumed in the flaming passage of a fire, and is inclusive of merchantable and submerchantable trees, both broadleaf and needleleaf. Needles that are heat-killed but otherwise not consumed in the fire are not considered part of CFB, and are instead considered part of the foliage to litter biomass transfer.

3.  The heat-killed but unconsumed fraction of the canopy is equal to (mortality minus CFB).

4.  In submerchantable trees, mortality is equal to CFB.

5.  In merchantable trees, CFB is less than or equal to mortality.

6.  Snags are inclusive of both those killed by prior fire as well as those killed by all other causes.

Of these, Crown Fraction Burned (CFB) is an important concept used primarily in fire behaviour science but not carbon accounting nor fire ecology. CFB was introduced in the 1992 Fire Behaviour Prediction System documentation [@forestrycanadafiredangerratinggroup1992], and provides a simple continuous 0-100 variable for only the consumption of foliage (which we assume here is inclusive of both conifer and broadleaf). For our purposes, CFB is the desirable metric as opposed to ordinal and less precise systems like Canopy Fire Severity Index [@kasischke2000] that allows the user to specify which pools of canopy biomass are consumed, but not the precise fraction of each given pool that is consumed.

## Combustion gas emission ratios

Certain variables, like the partitioning of CO~2~:CH~4~:CO gas emissions, are constant throughout ecozones, but vary by flaming vs smouldering combustion modes. The precise emissions ratios vary slightly between models and field studies, but for this initial algorithm assessment, we define these emissions ratios as being identical to those used in Canada's operational wildfire smoke forecasting system, FireWork [@chen2019]. Emissions ratios are provided in Table \ref{tab:tab-globalVarsEmissions}.

```{r defineVars, echo=FALSE, message=FALSE, warning=FALSE}


##load up an existing data table of the emissions factors (computed offline here)
CarbonEFs <- read.csv("~/nrcan-cfs-fire/FireDMs/GMD/CarbonCalculator.csv")

CarbonEFs_pivot_wider <- CarbonEFs[,1:3] %>% pivot_wider(names_from = Phase, values_from = Value)

global.vars <- CarbonEFs$Value

#then label names using updated "atmosphere sink" pools as they say, which is to say, carbon-focused EFs as fraction of 
names(global.vars) <- array(as.character(CarbonEFs$VarName))


### convert to list for easier referencing later down
global.vars <- as.list(global.vars)

global.vars$GWP_CO <- 1
global.vars$GWP_CH4 <- 28
global.vars$EF_N2O <- 0.00017 ### NIR emissions factor for N2O based on CO2e, not tonnes C
global.vars$GWP_N2O <- 265
global.vars$GWP_NMOG <- 1

##load field data to feed into DMs (computed offline)
VarDefs <- read.csv("~/nrcan-cfs-fire/FireDMs/FireDMTableDefs.csv")

##ensure that severity class is a factor
VarDefs$SeverityClass <- factor(VarDefs$SeverityClass,levels = c("Low", "Mod", "High"))


```

```{r tab-globalVarsEmissions, echo=FALSE, message=FALSE, warning=FALSE, tab.cap="\\label{tab:tab-globalVarsEmissions}"}
kbl(CarbonEFs_pivot_wider,caption="Emissions factors for flaming and smouldering used in this model.  Values are the molar fraction of carbon in the unburned biomass and the emitted species, e.g. 87 percent of C in biomass is converted to C as CO2 in flaming combustion.") %>% kable_minimal()  
```

CO~2~ is responsible for `r as.numeric(global.vars$FlamingCO2)*100`% of emissions in the flaming phase, but only `r as.numeric(global.vars$SmoulderingCO2)*100`% of emissions in the smouldering phase, with a doubling of CO emissions and tripling of CH~4~ emissions (Table \ref{tab:tab-globalVarsEmissions}). With a Global Warming Potential of CO equal to 1.0 and CH~4~ of 25, the Global Warming Potential per unit of biomass consumption in the smouldering phase is `r round(((as.numeric(global.vars$SmoulderingCO2*1+global.vars$SmoulderingCH4*25+global.vars$SmoulderingCO*1.0))/(as.numeric(global.vars$FlamingCO2*1+global.vars$FlamingCH4*25+global.vars$FlamingCO*1.9))),2)` times higher in global warming potential compared to flaming, not including differential aerosol production and injection heights, however. With flaming and smouldering each contributing roughly equally to wildfire emissions, these distinct flaming and smouldering emissions ratios correspond well prior emissions factors used in CBM-CFS3. Note that as currently described, the sum of CO~2~, CH~4~, and CO emissions from wildfires only represent approximately 95% of the fire carbon mass emitted to the atmosphere, with 0.5–2.0% of biomass emitted as particulate matter (e.g. PM~2.5~, but also PM~1~ and PM~10~ classes of particulates at 1 and 10 um diameters, respectively), and an additional 3% [@hayden2022] to as little as 1% [@simon2010] composed of non-methane organic gases that have a large range in global warming potentials as compared to CH~4~.

## Ground plot and remotely sensed fire severity data

```{r Fig-CBI-ecozones-map-chunk, echo=FALSE, fig.cap="\\label{fig:Fig-CBI-ecozones-map} Locations of field-based burn severity plots.", out.width="75%", message=FALSE, warning=FALSE}

#align with map colour scheme with others

knitr::include_graphics("~/nrcan-cfs-fire/FireDMs/CBIPlots_Canada_Ecozones.png")


```

While remotely sensed fire severity metrics are capable of determining if a specific location falls within a low, moderate, or high severity fire area [@hall2008], remotely sensed fire severity metrics alone do not inform estimates of fuel consumption down to specific biomass pools. Instead, this approach uses the change in biomass pools as empirically related to per-pixel satellite spectral reflectance indices (i.e. dNBR, RBR), using detailed and semi-standardized methods of burn severity ground plots with unburned controls [e.g. @cockeComparisonBurnSeverity2005; @hall2008]. Burn severity ground plot measurements are often aggregated into a single "Composite Burn Index" with a weighting scheme originating in southwestern U.S. forests [@keyLandscapeAssessment2006; @parksGivingEcologicalMeaning2019], which are classed into low, moderate, and high severity categories. Plot level measurements of individual forest biomass pools (e.g. conifer overstory mortality or canopy consumption) are recorded as part of the CBI methodology.

In this framework we do not use the CBI aggregated metric itself to infer biomass consumption, but rather compilations of burn severity ground plot measurements that include all the individual biomass pool measurements. Field studies with data describing biomass consumption fractions for individual biomass pools primarily from the northwestern boreal forest of Canada [@walkerSynthesisBurnedUnburned2020; @whitman2018]. Studies with eastern Canadian and Alaska were also used [@parks2019], as were data from the northwestern conterminous United States in ecozones that overlap with Canadian forests [@saberi2022]. Individual burn severity plots were assigned a severity class based on ground observations, and an ecozone-level median biomass pool consumption fraction was computed for each severity class for each biomass pool (see Figure \ref{fig:Fig-CBI-ecozones-map}). For ecozones without ground plot measurements, an adjacent and ecologically similar ecozone with observations was used.

The field survey data on biomass combustion and mortality rates as stratified by severity class, forms a improved data-driven and ecologically-informed approach to fire direct C emissions estimations here termed FireDMs (Fire Disturbance Matrix-severity).

## Biomass consumption specifics

### Overstory tree mortality and consumption

```{r tab-MortByEcozone, echo=FALSE, message=FALSE, warning=FALSE,tab.cap="\\label{tab:tab-MortByEcozone}"}

#subset to just the variable of interest:
VarDefs.SW.Mort <- VarDefs[VarDefs$Variable.Name == "SW.Mort",]

VarDefs.dt <- as.data.table(VarDefs.SW.Mort)

SW.Mort.wide <- dcast(VarDefs.dt,Ecozone~SeverityClass,value.var = "Value")

SW.Mort.wide <- SW.Mort.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(SW.Mort.wide, caption = "Softwood fractional mortality by ecozone, as derived from median values from field studies") %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

Numerous process-driven [@michaletz2006] or empirical [@hood2017] tree mortality models are available that show significant skill in predicting tree mortality based on fire behaviour (i.e. flame length, rate of spread). Since the driving data in this model is mapped fire severity over the landscape scale, fire behaviour metrics such as flame length or scorching height of bark are not available as a continuous mapped product. Instead, softwood and hardwood overstory mortality is calculated per ecozone as a function of satellite-observed fire severity using aggregated ground plot data (Table \ref{tab:tab-MortByEcozone}).

And since large-diameter, live trees killed by fire do not experience significant live stemwood consumption, the entirety of the live stemwood biomass pool that is killed is transferred to the snag pool. Note that the field data and disturbance modelling undertaken here only accounts for tree mortality within the calendar year of the fire, and delayed mortality of over one year has been documented in boreal low and moderate severity fires [@angers2011]where less than half of total mortality occurs after the year of the fire. Thus, the modelling here does not account for delayed mortality that may extend upwards of 5 years after fire.

Crown Fraction Burned (CFB) speaks to the fraction of the live canopy that is itself consumed in the flaming front. The alternate outcomes being survival of the foliage, or the mortality of the tree without canopy consumption, resulting in the dropping of foliage onto the forest floor. From the definitions stated earlier, the CFB must be lower than or equal to the mortality rate, using field studies that show any partial crown consumption is likely sufficient to result in high rates if not complete mortality [@hood2017], which is the case in Canadian trees, which are primarily species with thin bark. Due to the structure of CBM-CFS3, all high severity fires have their mortality in the merchantable and smaller trees set to exactly 1.0, which is no more than a 5% variance from observed values. Ecozone-specific CFB values from field studies of burn severity are summarized in Table \ref{tab:tab-CFBByEcozone}.

```{r tab-CFBByEcozone, echo=FALSE, message=FALSE, warning=FALSE,tab.cap="\\label{tab:tab-CFBByEcozone}"}

#subset to just the variable of interest:
VarDefs.SW.CFB <- VarDefs[VarDefs$Variable.Name == "SW.CFB",]

VarDefs.dt.SW.CFB <- as.data.table(VarDefs.SW.CFB)

SW.CFB.wide <- dcast(VarDefs.dt.SW.CFB,Ecozone~SeverityClass,value.var = "Value")

SW.CFB.wide <- SW.CFB.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(SW.CFB.wide, caption = "Softwood crown fraction burned by ecozone, as derived from median values from field studies in each ecozone.") %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

```{r CFBvsMortPlotNOTRUN, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
### this plot doesn't show too much other than the low severity areas where Mort > CFB
### included here for completeness, not in the manuscript itself

# gather VarDefs so that you have ecozone and then columns for SW Mort and SW CFB

VarDefs.SW.CFB <- VarDefs[VarDefs$Variable.Name == "SW.CFB",] 

VarDefs.SW.CFB <- VarDefs.SW.CFB %>% rename(SW.CFB = Value)
VarDefs.SW.Mort <- VarDefs.SW.Mort %>% rename(SW.Mort = Value)

CFB.Mort.Plot <- cbind(VarDefs.SW.CFB,VarDefs.SW.Mort$SW.Mort) 
colnames(CFB.Mort.Plot)[9] <- c("SW.Mort")

ggplot(CFB.Mort.Plot,aes(SW.Mort,SW.CFB))+geom_jitter(aes(color=Ecozone,shape=SeverityClass))

ggplot(CFB.Mort.Plot,aes(SW.Mort,SW.CFB))+geom_jitter(aes(color=Ecozone))+facet_wrap(vars(SeverityClass)) + geom_abline(slope=1,intercept=0)
```

The consumption of live bark biomass is a pool in the model, and consumption rates can be defined by severity class. At the moment, lacking robust field data on bark biomass consumption rates across ecozones and severity classes (which are a small portion of the overall biomass), the bark proportional consumption rate is set to 34% of the overstory mortality rate, based only on a single set well-observed high severity fires in the Taiga Plains by [@santín2015].

```{r tab-ReSproutByEcozone, echo=FALSE, message=FALSE, warning=FALSE,tab.cap="\\label{tab:tab-ReSproutByEcozone}"}

#subset to just the variable of interest:
VarDefs.HW.ReSprout <- VarDefs[VarDefs$Variable.Name == "HW.ReSprout" & VarDefs$SeverityClass == "Mod",]

VarDefs.dt.HW.ReSprout <- as.data.table(VarDefs.HW.ReSprout)

HW.ReSprout.wide <- dcast(VarDefs.dt.HW.ReSprout,Ecozone~SeverityClass,value.var = "Value")

HW.ReSprout.wide <- HW.ReSprout.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(HW.ReSprout.wide, caption = "Ecozone-level average fraction of hardwood overstory species that do not suffer extensive belowground biomass mortality after fire.", col.names = c("Ecozone", "Resprout Fraction"),digits = c(2)) %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

A major distinction is made between softwood and hardwood trees, where in Canada's boreal forests, a large fraction of hardwood trees (see Appendix E) are able to resprout even when the main stem has been killed by an intense forest fire [@brown1987]. Accordingly, the root mortality rates differ greatly between softwoods and hardwoods, with softwood root mortality equal precisely to stem mortality, while in resprouting hardwoods, little root mortality is observed even after intense fire [@pérez-izquierdo2019]. Though spatially explicit versions of CBM-CFS3 can resolve a species list down to the pixel level, currently an ecozone-level regional average composition of hardwood species with resprouting traits is used and is shown in Table \ref{tab:tab-ReSproutByEcozone}.

The fraction of fine roots contained within the combustible forest floor layers (the variable "SW.Prop.Fine.Root.duff" in the model) can be a close to or exceeding 50% of the fine root biomass [@strong1985]; this fine root live biomass is assumed to burn alongside the organic soils [@benscoter2011]. Fine root allocation is between the organic soil (termed "Aboveground" or AG in CBM-CFS3 vs "belowground" or BG for mineral soils) is a parameter that can be RU level and is distinct for hardwoods (HW) vs softwoods (SW). As a result, the calculation for softwood fine root consumption and mortality rate (SW.Mort) are as follows, using softwood as an example:

\begin{equation}
SWFineRootConsump = SW.Prop.Fine.Root.duff \times Duff.Consump.Fract
\end{equation} \begin{equation}
SWFineRootMort.AG = SW.Mort \times SW.Prop.Fine.Root.duff \times (1-Duff.Consump.Fract) \times (1-ReSproutFactor)
\end{equation} \begin{equation}
SWFineRootMort.BG = SW.Mort \times (1-SW.Prop.Fine.Root.duff)
\end{equation}

In contrast, the larger diameter of the coarse root biomass pool prevents its consumption during any smouldering of the duff layer, and the mortality rate of coarse roots is simply proportional to that of the stemwood overall.

### Understory tree mortality and consumption

Understory (or small diameter overstory) tree mortality is defined separately in the model in the "submerchantable" pool, but given the lack of data on diameter classes in the severity data, robust field data on differing mortality rates of smaller diameter trees is not available, and so the understory tree mortality rate is set equal to the overstory rate as defined in the table above. Note that smaller trees with a top height less than 1.4 m are not considered in this pool, and instead are lumped into the "other" pool.

### Litter layer area-wise consumption by severity class

```{r tab-UnBurnedForestFloorByEcozone, echo=FALSE, message=FALSE, warning=FALSE,tab.cap="\\label{tab:tab-UnBurnedForestFloorByEcozone}"}


#subset to just the variable of interest:

VarDefs.Unburned.Litter <- VarDefs[VarDefs$Variable.Name == "Unburned.litter.area",]

#convert to data.table:
VarDefs.dt <- as.data.table(VarDefs.Unburned.Litter)

##make it a wide data table for presentation purposes:
Unburned.Litter.wide <- dcast(VarDefs.dt,Ecozone~SeverityClass,value.var = "Value")

###then re-order the Ecozone factor (via https://stackoverflow.com/a/46130642)

Unburned.Litter.wide <- Unburned.Litter.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(Unburned.Litter.wide, caption = "Unburned litter area by ecozone and severity class.  The majority of the data comes from studies in the Boreal Plains and Boreal Shield West, and so values are extrapolated from those two well-observed ecozones to all others.  Ecozones are sorted in order from highest to lowest average annual burned area.") %>%
  kable_minimal()
```

The litter layer forms the first biomass pool in which a spreading fire consumes fuel. In low-severity fires, the litter layer may be consumed little to no underlying duff material consumed, nor any tree mortality [@hessburg2019]. In these low-severity patches, some area of fully unburned forest floor is present, and is summarized from CBI plot data by severity class and ecozone in Table \ref{tab:tab-UnBurnedForestFloorByEcozone}. Logically, since litter consumption is largely required for the ignition of the underlying duff layer, this unburned litter areas also informs and constrains duff consumption.

### Snag and stump consumption

Dead standing trees and branches on average is a biomass pool much smaller than organic soils or coarse woody debris on the ground, but in locals areas of extensive insect killed trees, recent fires, and blowdown, is a substantial biomass pool. Compared to live stemwood of the same diameter, the low moisture content of snags and snag branches allows for much greater consumption during the passage of an intense flaming front [@stocks2004]. The snag branch pool experiences almost complete combustion in high severity fires [@talucci2019], and is highly correlated with live foliage consumption (i.e Crown Fraction Burned) [@degroot2022]. The largest dead wood pool is the standing dead stemwood pool, which remains at most approximately 50% consumed; the consumption of standing snags pool is not quantified precisely in the CBI plot methodology. In the absence of extensive field data from CBI plots to quantify snag consumption, it is estimated as:

\begin{equation}
Snag Consumption fraction = \left( 0.5 \times Crown Fraction Burned \right) + 0.05
\end{equation}

And for snag branches, field observations [@talucci2019; @degroot2022] reliably point to a higher rate of consumption for this smaller diameter dead biomass pool:

\begin{equation}
Snag Branch Consumption = \left( 0.9 \times Crown Fraction Burned \right)
\end{equation}

Stumps are tracked as part of the "Other" pool in CBM-CFS3. As they are typically in contact with the upper forest floor, they are assumed to be consumed at the same rate as coarse woody debris.

### Woody debris consumption

Limited data is available on the fraction of woody debris consumption alongside fire severity measurements. Coarse woody debris of overstory stems that makes up 60-80% of woody debris biomass in Canada's boreal and temperate forests [@hanes2021], with its moisture and consumption patterns largely follows the moisture regime of the Drought Code [@mcalpine1995]. In this modelling framework, the proportion of coarse (\>7.5 cm diameter) and medium (\>0.5 cm and \<7.5 cm) woody debris consumption is estimated based on detailed measurements of consumption from experimental fires. Coarse woody debris is responsible for approximately 50–75% of the total woody debris load in most ecozones, and approximately 60% of the total woody debris consumption. Ecozone-level CWD consumption rates are summarized in Table \ref{tab:tab-CWDByEcozone}.

Note that where historical burn severity data from experimental fires is not available, the fire classification type of surface, intermittent crowning, and active crown fire are used instead as proxies for low, moderate, and high severity fire, respectively. Fine woody debris \<0.5 cm in diameter is consumed at the exact same rate as the litter pool (see section above).

## Forest Floor Consumption

Unlike canopy consumption metrics that are reliably estimated via burn severity remote sensing, the depth and magnitude of consumption in the forest floor is only weakly related to burn severity metrics, since increasing burn depth in organic soils typically yields little spectral response in remote sensing imagery [@frenchQuantifyingSurfaceSeverity2020]. Furthermore, there is at times a temporal disconnect between consumption in the canopy and the forest floor, with lower-intensity surface fires with a flaming residence time of a minute or less [@wottonFlameTemperatureResidence2011] without canopy involvement at times leading to deep smouldering occurring over hours to days afterwards [@hudaStudyFuelSmokeDynamics2020; @huangDownwardSpreadSmouldering2017]. Consumption of fine fuels in the litter layer of the forest floor is nearly complete for any given surface fire intensity [@vanwagnerDuffConsumptionFire1972], consumption of deeper organic soil horizons (F+H layers in upland forests and upper peat layers in wetlands) is more dependent on the interaction between moisture content of the soil organic layer and depth of the organic soil [@forestrycanadafiredangerratinggroup1992; @daviesVegetationStructureFire2016]. While the moisture content of the soil organic layer is not directly observable nor parameterized in Numerical Weather Model [@hanesEvaluationNewMethods2023], it is well-estimated by via simple water balance models within the Canadian Fire Weather Index System [@vanwagnerDevelopmentStructureCanadian1987] the Drought Code and Duff Moisture Code, as well as their composite, the Buildup Index. Given this lack of direct observability of forest floor consumption, this model uses fire weather and fuel loading as inputs to the forest floor consumption model, without consideration of the remotely sensed fire severity observations used in canopy consumption modelling.

In the fire literature in Canada, the soil organic layer is sometimes termed the Forest Floor Fuel Load (*FFFL*) [@letang2012] and is dominated by the equivalent organic soil Slow pool (Aboveground Slow Dead Organic Matter, or AGSlowDOM) in CBM-CFS3. Historically, attention has been paid to the absolute value of Forest Floor Fuel Consumption (*FFFC*) [@forestrycanadafiredangerratinggroup1992; @degrootForestFloorFuel2009]; however in the case of carbon modelling, it is the relative fraction of consumption (*FFFC/FFFL*) that is of interest. Given the strong empirical evidence that the amount of organic soil present strongly influences the absolute and relative combustion rates [@walkerFuelAvailabilityNot2020], modelling of forest floor consumption was conducted on field measurements of the relative fraction of organic soil consumption. In this scheme, we utilize a composite of wildfire data from [@degroot2009] alongside the ABoVE duff consumption data [@walker2020], with an alternative modelling approach to compute the relative amount of consumption (scalar from 0 to 1) rather than directly modelling an absolute value in kg m^-2^ or cm as otherwise done in the literature. A logit transform is used on the scalar data to make it suitable for the fitted non-linear least-squares modelling:

\begin{equation}
logit \left( \frac{FFFC}{FFFL}\right) = [3.91(1 - e^{(-0.008BUI)})] + (-0.53log_{e}(AGSlow))
\end{equation}

where BUI is the Fire Weather Index System's Buildup Index, and AGSlow in the CBM-CFS3 (given in Mg C/ha in this equation), and also synonymous with the the Forest Floor Fuel Load (with ecozone averages given in [@letang2012] or site-level data where observed). Assuming an average carbon content of 50%, CBM-CFS3 values in Mg C/ha are converted to fire behaviour units of kg of biomass per squared metre by dividing by 5.

```{r new-ABoVE-FFFC-data, message=FALSE, warning=FALSE, include=FALSE}

######### ABoVE combustion compilation:

ABoVE_Data <- read.csv("~/nrcan-cfs-fire/FireDMs/AK_CA_Burned_Plot_Data_1983_2016.csv")

### ABoVE data from https://daac.ornl.gov/cgi-bin/dsviewer.pl?ds_id=1744
## DOI: 10.3334/ORNLDAAC/1744

##this is exactly as provided except that the deGroot sites now have a "burn_name" equal to the first two letters of the plot ID

### prop_sol_combusted is the % mass combusted, so do that first

##from the Walker et al metadata:
## bg_c_prefire	g C/m2	Pre-fire belowground carbon pool (g C m2)
#bg_c_combusted	g C/m2	Below-ground carbon combusted (g C m2)
# prop_sol_c_combusted	0-1	Proportion of the soil organic layer C combusted (bg_c_combusted/bg_c_prefire)


### "prop_sol_c_combusted" is the other relevant response variable here.  and is the equivalent to the FFFC fractional consumption metric used in the analysis of de Groot's data

## step 1: convert a few values that are slightly higher than 1.0 to exactly 0.99
ABoVE_Data$prop_sol_c_combusted_logit <- ifelse(ABoVE_Data$prop_sol_c_combusted>1,NA,ABoVE_Data$prop_sol_c_combusted)

### convert the data frame NA values of -9999 to R NA
ABoVE_Data$prop_sol_c_combusted_logit <- ifelse(ABoVE_Data$prop_sol_c_combusted_logit<=0.01,NA,ABoVE_Data$prop_sol_c_combusted_logit)

#ABoVE_Data <- ifelse(ABoVE_Data<0,NA,ABoVE_Data)

ABoVE_Data$prop_sol_c_combusted_logit <- logit(ABoVE_Data$prop_sol_c_combusted_logit, min = 0.00001, max = 0.999)

ABoVE_Data$prop_sol_c_combusted_logit[is.infinite(ABoVE_Data$prop_sol_c_combusted_logit)] <- NA
ABoVE_Data$prop_sol_c_combusted_logit[is.nan(ABoVE_Data$prop_sol_c_combusted_logit)] <- NA


##########################
###load up De Groot data ####
##########################
# original data provided by B. de Groot, 2024 that went into 10.1139/X08-192

FFFC_Data <- read.csv("~/nrcan-cfs-fire/FireDMs/FFFC_Data.csv")

### convert any FFFC proportion values >1 to == 1 (11 out of 128 cases)
FFFC_Data$Frac_load_consump <- ifelse(FFFC_Data$Frac_load_consump>1,1,FFFC_Data$Frac_load_consump)


#FFFC_Data$Frac_load_consump <- ifelse(FFFC_Data$Frac_load_consump>1,1,FFFC_Data$Frac_load_consump)
FFFC_Data$Frac_load_consump_logit <- logit(FFFC_Data$Frac_load_consump, min = 0.00001, max = 1.01)

### convert FFFC_Data into the same column names as ABoVE:
FFFC_Data <- rename(FFFC_Data, drought_code = DC)
FFFC_Data <- rename(FFFC_Data, buildup_index = BUI)
FFFC_Data <- rename(FFFC_Data, prop_sol_c_combusted = Frac_load_consump)
FFFC_Data <- rename(FFFC_Data, prop_sol_c_combusted_logit = Frac_load_consump_logit)
FFFC_Data <- mutate(FFFC_Data, bg_c_prefire = Load*500) # the ABoVE data is in g C/m2 and the FFFC Load is in kg biomass/m2 so multiply Load by 500 to get gC/m2


## grab only the sites not in the ABoVE data (so GL is already there)
## don't take "Dawson City", "Green Lk", or "WBNP" from the FFFC data frame (already in Walker AboVE data), 94 obs left
FFFC_Data_trimmed <- FFFC_Data %>% filter(Site != "Dawson City") %>% filter(Site != "Green Lk") %>% filter(Site != "WBNP") %>% filter(FireType == "Wild")

## assign ecoregion to those sites we are adding
FFFC_Data_trimmed <- FFFC_Data_trimmed %>%
  mutate(
  ecozone = case_when(
      Site == "Burntwood R" ~ "BSW",
      Site == "Darwin Lk" ~ "TSW",
      Site == "Hondo" ~ "BP",
      Site == "ICFME" ~ "TP",
      Site == "Kasabonika" ~ "BSW",
      Site == "Kenshoe" ~ "BSE",
      Site == "Mtl Lk" ~ "BP",
      Site == "Porter Lake" ~ "TSW",
      Site == "Sharpsand" ~ "BSE",
      Site == "Thompson" ~ "BSW",
      .default = "other"
    )
  ) %>% rename(burn_name = Site)


###rename "Site" in FFFC_Data to "burn_name"



##then convert the provided ABoVE NA Level II Ecoregions into Canadian Ecozones

### delete any NA rows here so nls doesn't have to handle them at all
ABoVE_Data <- ABoVE_Data %>% drop_na(prop_sol_c_combusted) %>% filter(drought_code > 0) %>% filter(bg_c_prefire>0) %>% filter(buildup_index>0) %>% filter(burn_depth>0.5) %>% filter(ecoregion_name_l2!="Alaska Boreal Interior")#  %>%  filter(ag_c_prefire>0) %>% filter(prop_black_spruce>0) %>% filter(longitude>-140)

#hist(ABoVE_Data$prefire_sol)

ABoVE_Data <- ABoVE_Data %>%
  mutate(
  ecozone = case_when(
      ecoregion_name_l2 == "Boreal Cordillera" ~ "BC",
      ecoregion_name_l2 == "Softwood Shield" ~ "BSW",
      ecoregion_name_l2 == "Taiga Plains" ~ "TP",
      ecoregion_name_l2 == "Taiga Shield" ~ "TSW",
      ecoregion_name_l2 == "Boreal Plains" ~ "BP",
      .default = "other"
    )
  )

### add data, and convert the ABoVE data from gC/m2 and de Groot data in kg biomass/m2 to both in Mg C/ha (CBM units)
ABoVE_Data_w_FBP <- bind_rows(ABoVE_Data,FFFC_Data_trimmed) %>% mutate(SFL.kg.m2 = bg_c_prefire/500) %>% mutate(AGSlow.Mg.C.ha = SFL.kg.m2*5) ## the "5" multiplier being the conversion from kg biomass/m2 units to the CBM units of Mg C/ha

###manually fill in two more fire names from the other de Groot data:


#########################################
### GAM to examine ecozones
#######################################




FFFC.Frac.Consume.gam.ABoVE<-gam(prop_sol_c_combusted_logit ~ s(buildup_index,k=4,bs="tp")+ecozone+s(AGSlow.Mg.C.ha,k=4,bs="tp"), data = ABoVE_Data_w_FBP,method="REML", na.action=na.exclude)
summary(FFFC.Frac.Consume.gam.ABoVE)
plot.gam(FFFC.Frac.Consume.gam.ABoVE)

######################
### end GAM
#####################




##can compute this if needed, but isn't exactly Crown Fraction Burned or anything exciting like that
#ABoVE_Data_w_FBP <- ABoVE_Data_w_FBP %>% mutate(ag_frac_burn = ag_biomass_combusted/ag_biomass_prefire)






ABoVE_Data_w_FBP_excl_BC <- ABoVE_Data_w_FBP %>% filter(ecozone != "BC")






ABoVE_Data_w_FBP_only_BC <- ABoVE_Data_w_FBP %>% filter(ecozone == "BC")


### model no longer used, since it is using DC only, but still valid:
#ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC <- nlsLM(
 #formula = prop_sol_c_combusted_logit ~ c*(1-exp(a*drought_code))+(log(AGSlow.Mg.C.ha)*b),
  #data = ABoVE_Data_w_FBP_excl_BC,
  #start = list(a = -0.021, b = -0.71,c=1),
  #lower = c(a=-0.01,b=-Inf,c=-Inf)
  #)


##!!! NB this is the selected model
ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI <- nlsLM(
  formula = prop_sol_c_combusted_logit ~ c*(1-exp(a*buildup_index))+(log(AGSlow.Mg.C.ha)*b),
  data = ABoVE_Data_w_FBP_excl_BC,
  start = list(a = -0.0021, b = -0.71,c=3),
  lower = c(a=-0.008,b=-Inf,c=0),
  upper = c(a=-0.001,b=0,c=10)
  )

summary(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)

 ### r2~0.78, MPE~26% unbound #note that the hinge to zero relies on the ln of large numbers, and that using the log of kg m2 of Surface Fuel Load as per FBP leave the DC/BUI == 0 values of SFC consumption as non-zero, but using

 ## constraint is ~ ~-0.008 for BUI to get half of max possible consumption at BUI 50 (as per FBP)






## some model skill metrics
#cor(ABoVE_Data_w_FBP_excl_BC$drought_code,ABoVE_Data_w_FBP_excl_BC$drought_moisture_code,use="complete.obs",method=c("spearman"))
#cor(ABoVE_Data_w_FBP_excl_BC$drought_code,ABoVE_Data_w_FBP_excl_BC$drought_moisture_code,use="complete.obs",method=c("pearson"))


#MAE.nls <- mean(abs(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted-ABoVE_Data_w_FBP_excl_BC$nls.pred),na.rm=TRUE)

#MAE.nls/mean(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,na.rm=TRUE)

#MAE.nls <- mean(abs(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted-ABoVE_Data_w_FBP_excl_BC$nls.pred.BUI),na.rm=TRUE)

#MAE.nls/mean(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,na.rm=TRUE)




```

```{r DuffConsumpFunction, echo=FALSE, message=FALSE, warning=FALSE }

###Function: Compute FFFC given any BUI and duff load input (CalcFFFC)
# Written By: Dan Thompson
# Written On: 2024-09-19
# Parameters: Buildup Index of interest (BUI); Carbon pool amount of the Below Ground Slow pool (AGSlow) in Mega-grams of Carbon (12g/mol) per hectare of forest area.
# Modified on: 
# Modified by: 
# Purpose: for ecozones in Canada this function estimates the !!relative consumption!! fraction (0-1) of the forest floor (aka duff), which corresponds to the AGSlow pool in the Carbon Budget Model for the Canadian Forest Sector (CBM-CFS)
# Description: model is derived analysis of ABoVE project which is a composite of ABoVE project data plus some de Groot data (https://daac.ornl.gov/cgi-bin/dsviewer.pl?ds_id=1744) also adding in a few eastern/central Canadian sites from (https://www.nrcresearchpress.com/doi/full/10.1139/x08-192).

# output: a single floating point from 0-1 that is the portion of the duff layer that is consumed given a BUI and AGSlow pool input


### !! Note NOT using the hard-coded parameters, unlike chunks above which derive the parameters, so this function cannot as-written be used elsewhere


## CalcFFFC <- function(DC,PoolType,PoolSize) #alternate function that either accepts AGSlow or DuffLoad
BUI <- 70
AGSlow <- 60
CalcFFFC <- function(BUI=70,AGSlow=60,Spruce=TRUE)
{
CalcFFFC_param1 <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[3]
CalcFFFC_param2 <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[1]
CalcFFFC_param3 <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[2]

  ##apply the fitted nls logit model with parameters defined above:
  temp.logit <- CalcFFFC_param1 * (1 - exp(CalcFFFC_param2 * BUI)) + (log(AGSlow) * CalcFFFC_param3)
  
  ### and now compute the inverse logit of the model and apply a correction factor to convert fraction of mass (from line above) to fraction of depth, using standard duff density curves:
  
  #CF_non_spruce <- 0.13*inv.logit(temp.logit)+0.87
  #CF_spruce <- (1.02)*inv.logit(temp.logit)^(0.250)
  
  ### need if/else for spruce or not
  #CalcFFFC_return <- ifelse(Spruce==TRUE, inv.logit(temp.logit)*CF_spruce,inv.logit(temp.logit)*CF_non_spruce)
  CalcFFFC_return <- inv.logit(temp.logit)
  return(CalcFFFC_return)
}

#test the function:
#CalcFFFC(DC=250,AGSlow=25,Spruce=FALSE) ###this is the DMC standard 5kg/m2 of fuel loading at Petawawa as per Van Wagner 1987 FWI system description, gives you ~0.57

#CalcFFFC(DC=550,AGSlow=15,Spruce=TRUE) # similar to the origin area of the 2024 Jasper fire 

#CalcFFFC(DC=25,AGSlow=1200,Spruce=TRUE) ## very low values of DC above the highest value in the test dataset
###gives you close to zero as it should

#CalcFFFC(DC=290,AGSlow=(24*5),Spruce=TRUE) ##using just the acrotelm carbon stock and a well-known DC and fractional carbon loss in the acrotelm (Bona et al 2020 doi: 10.1016/j.ecolmodel.2020.109164, Table 4), you get ~0.30, which is too high compared to the observed ~0.12 fractional pool loss by fire



```

```{r computeFixed-DM-DuffConsump, echo=FALSE, message=FALSE, warning=FALSE}

#load an array of median DC values by ecozone (provided here hardcoded from Quinn Barber's dataframes of all Canadian hotspots from CWFIS 2002-2022):

Median.BUI <- c(39,79,72,58,67,54,59,60,60,112,52,35,40,40)
#Litter.Load <- 0.25 #litter load as an average from Thompson et al 2017, across a range of boreal forest sites, doi: 10.1139/cjfr-2016-0475

##load the AGSlow data:
NIR2023_AverageCPools <- read_csv("./NIR2023_AverageCPools.csv")

Duff.Load.kg.m2.all.ecozones <- NIR2023_AverageCPools %>% group_by(EcoBoundaryName) %>% summarise(Duff.Load.kg.m2 = mean(`Aboveground Slow DOM`)/5) ##5 being the 0.2x conversion from Mg C/ha to kg BM/m2, but will get custom %C of biomass soon

Duff.Load.kg.m2.NIR <- c(7.05,5.39,3.37,3.01,6.7,6.5,5.17,6.23,10.3,6.32,5.1,6.0,7.16,5.96)


# then the median forest floor load, minus an average litter value (provided here hardcoded from 10.1139/x2012-093):
##note this value is 30% higher than NIR2023, but using it for now since it forms the point data used for current efforts to map national duff thickness and load:
Ecozones.fffc   <- c("AM","TP","TSW","BSW","BP","P","TC","BC","PM","MC","HP","TSE","BSE","MP")
Duff.Load.kg.m2 <- c(7.5, 15.0, 2.2,  8.8,  9.8,9.8, 8.4,8.31,15.2,6.0, 7.9,  5.8,  10.9, 10.9) #gap filled here 



##raw data from Letang:Duff.Load.kg.m2 <- c(7.5, 15.0, 1.7,  8.8,  9.8,NA, NA,   8.31,15.2,6.0, 7.9,  NA,  10.9, NA)
### with NFI plot C content of organic matter (g C/kg DOM):
Letang.C.Adju.Duff.Load.kg.m2 <- c(7.5*(422/500), 15.0*(399/500), 2.2*(399/500),  8.8*(390/500),  9.8*(367/500),NA, NA,   8.31*(462/500),15.2*(446/500),6.0*(360/500), 7.9*(389/500),  NA,  10.9*(429/500), NA)
##note that TC, TSW, TSE should use NIR

##Letang numbers for FFFL but adjusted to the observed Carbon content of the AG Slow (aka duff) layer
Duff.Load.kg.m2 <- c(7.5*(422/500), 15.0*(399/500), 2.2*(399/500),  8.8*(390/500),  9.8*(367/500),9.8*(367/500), 8.4*(462/500),   8.31*(462/500),15.2*(446/500),6.0*(360/500), 7.9*(389/500),  5.8*(429/500),  10.9*(429/500), 10.9*(429/500))


Duff_summary <- bind_cols(Ecozones.fffc,as.numeric(Duff.Load.kg.m2),as.numeric(Duff.Load.kg.m2.NIR),as.numeric(Letang.C.Adju.Duff.Load.kg.m2))
colnames(Duff_summary) <- c("Ecozones.fffc","Duff.Load.kg.m2","Duff.Load.kg.m2.NIR","Letang.C.Adju.Duff.Load.kg.m2")
#ggplot(data=Duff_summary,aes(Letang.C.Adju.Duff.Load.kg.m2,Duff.Load.kg.m2.NIR,label = Ecozones.fffc))  +geom_text() + xlab("Letang and de Groot forest floor kg/m2 with C content adjusted by NFI") + xlim(0,16) +ylim(0,16) + geom_abline(aes(intercept=0,slope=1))

# from the NIR, but in the same order at the hard-coded above:


##conversion of Mg C/ha to kg biomass /m2
AGSlow.Mg.C.ha <- Duff.Load.kg.m2*5

###building the model for now from coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC)[1] in the chunk above



Duff.consump.frac.logit <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[3] * (1 - exp(coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[1] * Median.BUI)) + 
    (log(AGSlow.Mg.C.ha) * coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[2])


### calculate the inverse of the logit to get the duff consumption fraction, and apply the Correction Factor to convert from %depth to %mass

Duff.consump.frac <- inv.logit(Duff.consump.frac.logit)




#### should really call the coefficients from the nls, but here it is for now above hard-coded in there

Duff.consump.kg.m2 <- Duff.consump.frac * Duff.Load.kg.m2

# start creating a single list object to encapsulate all the modelling:
#where FFFC is "Forest Floor Fuel Consumption" a la de Groot's naming convention:

FFFC <- as.data.frame(cbind(Ecozones.fffc,Median.BUI,Duff.Load.kg.m2,round(Duff.consump.kg.m2,digits = 2),round(Duff.consump.frac,digits = 2)))
names(FFFC) <- c("Ecozone","Median.BUI.of.burning","Median.Duff.Load.kg.m2","Duff.consump.kg.m2","Duff.consump.frac")

##re-order data.frame by ecozones.list order
FFFC <- arrange(FFFC,factor(Ecozone, levels = as.matrix(ecozones.list)))

## for example:
#FFFC$Ecozone.name[1]

### and to query values:
#FFFC$Duff.consump.frac[FFFC$Ecozone == "BP"]




```

```{r tab-DuffConsumpTable, echo=FALSE, message=FALSE, warning=FALSE,tab.cap="\\label{tab:tab-DuffConsumpTable}"}
kbl(FFFC,caption=" Fire Weather, fuel loading, and duff consumption values per ecozone.  Note that FFFL values \n are from Letang et al., (2012) and not directly from the Reconciliation Unit values provided in the National GHG Inventory Report. \n Median Buildup Index of burning is from Barber et al., (2024)", col.names = c("Ecozone", "Median Buildup Index of Burning", "Median FFFL kg m-2", "FFFC kg m-2", "% consumption")) %>%
  kable_minimal()  #%>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

While ultimately this scheme can be used on individual fires with estimated or measured fuel loading and specific BUI values, as an example, an ecozone-averaged fuel load and a multi-year average of BUI during active fire satellite detection can also be used to provide representative values to showcase the modelframework. Specifically, a median BUI of detected fire hotspots in Canada from 2003-2021 [@barber2024] using the same data as the Canadian CFEEPS-FireWork wildfire air quality model of [@chen2019] is presented in Table \ref{tab:tab-DuffConsumpTable}, along with proportional consumption values of the forest floor by ecozone.

Note that the maximum upland Forest Floor Fuel Load is approximately 30 kg m^-2^ (150 Mg C ha^-1^) [@letang2012]; higher values are typically seen only in peat ecosystems, where the above scheme is still valid, as approximately 33% of the data used to fit this model is for organic soil pool values over 30 kg m^-2^ (\>150 Mg Mg C ha^-1^). Fully 10% of the data used in the FFFC model is for sites with over 60 kg m^-2^ of organic soil. Absolute consumption values are similar between deep forest floor organic layers and peatlands [@walker2020], though relative consumption rates decline rapidly in deeper organic soil layers, as demonstrated in the model selected here. For Canadian peatlands, the CaMP model [@bona2020] is instead used in spatially explicit version of CBM-CFS3. Within CaMP, a separate peatland water model driven by Drought Code determines the thickness of the unsaturated peat layer, and an amount approximating 12% of the thickness of the unsaturated peat is consumed as smouldering consumption. The peat-specific carbon pools and fire disturbance matrices are fully described in [@bona2020]; large peatland trees will still utilize the DM scheme described below. Since deeper forest organic soil and peat layers show approximately similar absolute consumption rates, for the purpose of this general model description no peatland-specific components of the fire DMs are required.

```{r tab-CWDByEcozone, echo=FALSE, message=FALSE, warning=FALSE, tab.cap="\\label{tab:tab-CWDByEcozone}"}

#subset to just the variables of interest:

VarDefs.CWD <- VarDefs[VarDefs$Variable.Name == "MedDOM.Comb.Frac",]

VarDefs.dt <- as.data.table(VarDefs.CWD)

CWD.wide <- dcast(VarDefs.dt,Ecozone~SeverityClass,value.var = "Value")

CWD.wide <- CWD.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(CWD.wide, caption = "Coarse Woody debris consumption rates from pre/post measurements in experimental fires") %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

```{r loadVarDefsSourceSink, echo=FALSE,message=FALSE, warning=FALSE}

#list of ecozone-specific terms (with and without severity dependence)
#first, import blank template that works for a single ecozone:
#VarDefs.generic <- as.data.frame(read.csv("~/nrcan-cfs-fire/FireDMs/VarDefsGeneric.csv"))
#VarDefs.generic <- VarDefs.generic[,1:7]

#then, replicate for each severity level*ecozone

#use slice from dplyr and each to replicate the template for each ecozone
#VarDefs <- VarDefs.generic %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
#VarDefs$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(VarDefs.generic))

#Once this is done and filled in with data from observations, load the canonical version: 
# this will overwrite the above loop
#NOT RUN (YET)
#VarDefs <- read.csv("~/nrcan-cfs-fire/FireDMs/FireDMTableDefs.csv")




#sink-source DM list:
#first, import blank template that works for a single ecozone:
SourceSinkGeneric <- read.csv("~/nrcan-cfs-fire/FireDMs/SourceSinkGeneric.csv")


#then, replicate for each severity level*ecozone
SourceSink <- SourceSinkGeneric %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
SourceSink$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(SourceSinkGeneric))


#Once this is done and filled, load the canonical version: 
# this will overwrite the above loop
#NOT RUN (YET)
#SourceSink <- read.csv("~/FireDMs/SourceSinkLong.csv")


```

## Calculation of Annual Direct C Emissions from Fire

In an effort to compare model outputs against an independent, large-scale set of fire atmospheric emissions, fire direct atmospheric emissions from the record breaking Canadian 2023 fire season were computed using the above framework. The classified burn severity product from the National Burned Area Composite annual production was utilized (see @hall2020 for an algorithm description). In NBAC, an internal tracking value "NFIREID" is utilized, which is the final satellite-derived burned area polygon (allowing for multi-part polygons) is split across any RU unit boundaries (if any). Since carbon pool sizes vary across RU boundaries, this allows for a single NFIREID to be present across multiple RUs.

A total of 2199 fires as small as 0.09 ha (one 30x30 Landsat pixel) were mapped in NBAC for burn severity for a total of 14.60 Mha, but only fires over 100 ha were utilized as a lower limit of where meaningful per-fire estimates of the fraction of low, moderate, and high severity burned area was available. Including only fires 100 ha and larger reduced the total number of fires to 966 but the total area remained largely the same at 14.58 Mha. A total of 189,704 ha of post-fire salvage logging was also mapped in 2023 and is assigned to the moderate severity class after consultation with provincial land managers. The direct C emissions from fire shown here are not altered by the act of post-fire salvage logging. Additionally, the NBAC mapping process accounts for unburned islands (and areas with a mapped fire severity no different than unburned) which count towards the total fire area but do not have a disturbance matrix and direct C estimate applied.

A unique DM was then calculated for each fire using the median area-weighted Buildup Index per fire. All thermal detection hotspots from VIIRS that intersect a fire were extracted from the historical hotspot archive that supports the Canadian smoke emissions model CFFEPS-FireWork [@chen2019]. The median DC value across all intersecting hotspots was used to derive a single DM per fire, no matter the duration of burning.

To compute total direct fire emissions per fire, a single estimate of the carbon pool size based on the Reconciliation Unit of the centroid of the NFIREID polygon was applied. Fires that cross provincial boundaries are mapped are mapped as discrete fires on either side of the boundary in NBAC, but no such division of fires was made across ecozone boundaries. While spatially explicit biomass maps are available for some aboveground components [@guindon2024] and some organic soil components [@hanes2022], the majority of the required pool sizes in CBM-CFS3 for the computation of the fire DMs are available only at the spatially referenced RU scale.

# Results and Discussion

```{r DefineDMvalues, echo=FALSE,message=FALSE, warning=FALSE}

j <- 1

for (j in seq(1:length(ecozones.list))) {

  ecozone <- as.character(ecozones.list[j]) #run this loop once for every ecozone

  #print(j)


  ####Pre-DM housekeeping
  
  
  ###(1) need to set bark consumption to 34% of mortality.  Can do this before the fluxID stuff, but within the ecozone loops
  
  
VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.34

  VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.34
  
  VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.34
  
  
  ###(2) as per guidance from the PFC CBM group (M Hafer,B Hudson, 2024-05-01, the tree stem mortality (merch and submerch) for all high severity scenarios is set to precisely 1.0
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  
  
  
  
  ###(3) Since no field CBI data is available to detail snag consumption in fire, use some of the patterns found Talucci and Krawchuk 2019, where let's call it (0.5*CFB)+0.1 is consumed, and is equal between hardwood and softwood.  Note that this relationship is imperfect when the stand has very low Crown Bulk Density and continuous crown fire is not as easily achieved.
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.5+0.05

  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.5+0.05
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.5+0.05
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.5+0.05

  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.5+0.05
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.5+0.05
  
  ###and similarly for snag branches, just 90% of CFB:
  
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.9

  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.9
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.9
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.9

  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.9
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.9


  ###### end housekeeping
  
  
#FluxID: 1
#Source: Softwood (SW) Merch 
#sink: SW Merch
#Plain Language Summary of flux: survival of conifers
#Pseudocode: survival = 1-mortality
#Notes:  by axiom, survival = 1-mortality,

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Low"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Mod"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "High"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#but, I'm not doing this easily across all three severity classes, no need to run it across each severity class as its own line....

#FluxID: 2
#Source: SW Merch 
#sink: SW Stem Snag
#PLS: Mortality rate of large conifers (includes those with and without burned foliage)
#Pseudocode: as provided from field data, f(ecozone, severity class)
#Notes: mortality >= CFB; may not be the case in extremely fire-tolerant stands, but valid the vast majority of the time
#Notes2: just pulling Softwood CFB 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])



#FluxID: 3
#Source: SW Merch 
#sink: Black Carbon
#PLS: live stemwood to black carbon
#Pseudocode: =0, since no live stemwood -> 0 BC
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 5
#Source: SW Foliage
#sink: Above Ground Very Fast DOM
#PLS: Post-fire litterfall (heat-killed but not burned, then falls to ground within the season)
#Pseudocode: Remainder of all fluxes above.
#Notes: assume 100% of heat-killed litter falls within the year of fire

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == 'SW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] - VarDefs$Value[VarDefs$Variable.Name == 'SW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']
  
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == 'SW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] - VarDefs$Value[VarDefs$Variable.Name == 'SW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == 'SW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] - VarDefs$Value[VarDefs$Variable.Name == 'SW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']


#FluxID: 6
#Source: SW Foliage
#sink: CO2
#PLS: CO2 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO2
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 7
#Source: SW Foliage
#sink: CH4
#PLS: CH4 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCH4
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 8
#Source: SW Foliage
#sink: CO
#PLS: CO emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 9 SW Other to SW Other is found at the very end (is remainder of the SW Other fluxes listed here)



#FluxID: 10
#Source: SW Other
#sink: SW Branch Snag
#PLS: Portion of "other" pool as killed by fire but otherwise unconsumed branches
#PLS: Understory conifer stems killed but not consumed.  Here, put into branch snag pool, since diameter of submerch trees is more similar to branches then stems
#Pseudocode: (CFB * (1-SW.LgBranch.Comb.Frac))*SW.BW.frac.of.other + (1-SW.Mort)*SW.Frac.of.other
#for example, for AM ecozone, large branches are 0.15, submerch is 0.38 (where submerch is 0.40 of the other pool, so almost all), so Other->snag pool total conversion is 0.53

#Notes:  #since 1-SW.LgBranch.Comb.Frac is the snag creation rate

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Low"] <- ((VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]) + ((VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "SW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])            

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]  + ((VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "SW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])    

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "SW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])       
                                                                                                                      
#FluxID: 11
#Source: SW Other
#sink: CO2
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO2)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO2)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO2)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO2)
#Note: SW submerch is not consumed in fire (becomes snag or survives) so is not represented here

#Notes:  works so far and gives reasonable values of ~0.17, 0.19, 0.2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "Low"] <-  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO2)

#FluxID: 12
#Source: SW Other
#sink: CH4
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCH4)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCH4)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCH4)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCH4)
#Note: SW submerch is not consumed in fire (becomes snag or survives) so is not represented here

#Notes:  works so far and gives reasonable values of ~0.017, 0.019, 0.02

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCH4)

#FluxID: 13
#Source: SW Other
#sink: CO
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO)
#Note: SW submerch is not consumed in fire (becomes snag or survives) so is not represented here

#Notes:  works so far 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO)



#FluxID: 14
#Source: SW SubMerch
#sink: SW SubMerch
#PLS: Understory conifer survival rate
#Pseudocode:  =1-(mortality of submerch conifers in severity class) 

#see below for SW Other -> SW Other FluxID: 9
#since SW Submerch now in Other


#FluxID: 15
#Source: SW Other (SubMerch)
#sink: SW Branch Snag
#PLS: Understory conifer stems killed but not .  Here, put into branch snag pool, since diameter of submerch trees is more similar to branches then stems
#Pseudocode:  = SubMerch mortality, since live understory trees don't get consumed in the fire, 

#notes: submerch trees assumed to not have large enough branches to avoid consumption in fire.  Equal to 0

#now handled in FluxID 10


#FluxID: 16-18 were the SW SubMerch to CO2, CH4, CO fluxes, but now merged into "other" pool above.



#FluxID: 19
#Source: SW Coarse roots
#sink: SW Coarse roots
#PLS: Surviving coarse roots in conifers
#Pseudocode:  =1-(conifer mortality rate)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "Low"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "Mod"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "High"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 20
#Source: SW Coarse roots
#sink: Above Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted in organic soil
#Pseudocode:  =(conifer mortality rate)*(conifer coarse root fraction in organic soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides SW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]


#FluxID: 21
#Source: SW Coarse roots
#sink: Below Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted since they are in mineral soil
#Pseudocode:  =(conifer mortality rate)*(conifer coarse root fraction in mineral soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides SW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * (1 -  VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * (1 -  VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])



#FluxID: 23
#Source: SW fine roots
#sink: Above Ground Very Fast DOM
#PLS: Fine roots killed but not burned in organic soil
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))


#FluxID: 24
#Source: SW fine roots
#sink: Below Ground Very Fast DOM
#PLS: Fine roots killed but not burned in mineral soil
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in mineral soil)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])




#FluxID: 25
#Source: SW fine roots
#sink: CO2
#PLS: Fine roots combusted in duff
#Pseudocode:  =(fine root fraction in organic soil)*(fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here. Note that here the initial DM uses a fixed ecozone FFFC$Duff.consump.frac, but later on this value is replace with a BUI-specific value via the CalcFFFC function.

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2


#FluxID: 26
#Source: SW fine roots
#sink: CH4
#PLS: Fine roots combusted in duff
#Pseudocode:  =(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to SW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4



#FluxID: 27
#Source: SW fine roots
#sink: CO
#PLS: Fine roots combusted in duff
#Pseudocode:  =(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO





#Fluxes 28:54 Hardwoods
### HARDWOODS!!!!
###


#FluxID: 28
#Source: HW Merch 
#sink: HW Merch
#Plain Language Summary of flux: survival of conifers
#Pseudocode: survival = 1-mortality
#Notes:  by axiom, survival = 1-mortality,

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 28 & SourceSink$SeverityClass == "Low"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 28 & SourceSink$SeverityClass == "Mod"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 28 & SourceSink$SeverityClass == "High"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])



#FluxID: 29
#Source: HW Merch 
#sink: HW Stem Snag
#PLS: Mortality rate of large broadleaf (includes those with and without burned foliage)
#Pseudocode: as provided from field data, f(ecozone, severity class)
#Notes: mortality >= CFB; may not be the case in extremely fire-tolerant stands, but valid the vast majority of the time
#Notes2: just pulling Softwood Mortality from field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 29 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 29 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 29 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 30
#Source: HW Merch 
#sink: Black Carbon
#PLS: live stemwood to black carbon
#Pseudocode: =0, since no live stemwood -> 0 BC
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 30 & SourceSink$SeverityClass == 'Low'] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 30 & SourceSink$SeverityClass == 'Mod'] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 30 & SourceSink$SeverityClass == 'High'] <- 0


#FluxID: 32
#Source: HW Foliage
#sink: Above Ground Very Fast DOM
#PLS: Post-fire litterfall (heat-killed but not burned, then falls to ground within the season)
#Pseudocode: Mortality-CFB
#Notes: assume 100% of heat-killed litter falls within the year of fire

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] - VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] - VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] - VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 33
#Source: HW Foliage
#sink: CO2
#PLS: CO2 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO2
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == 'Low'] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == 'Mod'] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == 'High'] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 34
#Source: HW Foliage
#sink: CH4
#PLS: CH4 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCH4
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == 'Low'] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == 'Mod'] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == 'High'] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 35
#Source: HW Foliage
#sink: CO
#PLS: CO emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == 'Low'] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == 'Mod'] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == 'High'] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 37
#Source: HW Other
#sink: HW Branch Snag
#PLS: Portion of 'other' pool as killed by fire but otherwise unconsumed branches
#Pseudocode: (CFB * (1-HW.LgBranch.Comb.Frac))*HW.BW.frac.of.other

#Notes:  #since 1-HW.LgBranch.Comb.Frac is the snag creation rate

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 37 & SourceSink$SeverityClass == 'Low'] <- (VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.LgBranch.Comb.Frac' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])) * VarDefs$Value[VarDefs$Variable.Name == 'HW.BW.frac.of.other' & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "HW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])              

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 37 & SourceSink$SeverityClass == 'Mod'] <- (VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.LgBranch.Comb.Frac' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])) * VarDefs$Value[VarDefs$Variable.Name == 'HW.BW.frac.of.other' & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "HW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])   

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 37 & SourceSink$SeverityClass == 'High'] <- (VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.LgBranch.Comb.Frac' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])) * VarDefs$Value[VarDefs$Variable.Name == 'HW.BW.frac.of.other' & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "HW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])    

#FluxID: 38
#Source: HW Other
#sink: CO2
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO2)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO2)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO2)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO2)

#Notes:  works so far and gives reasonable values of ~0.17, 0.19, 0.2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 38 & SourceSink$SeverityClass == 'Low'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 38 & SourceSink$SeverityClass == 'Mod'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 38 & SourceSink$SeverityClass == 'High'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO2)

#FluxID: 39
#Source: HW Other
#sink: CH4
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCH4)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCH4)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCH4)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCH4)

#Notes:  works so far and gives reasonable values of ~0.017, 0.019, 0.02

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 39 & SourceSink$SeverityClass == 'Low'] <- 
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCH4)
  
  
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 39 & SourceSink$SeverityClass == 'Mod'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 39 & SourceSink$SeverityClass == 'High'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCH4)

#FluxID: 40
#Source: HW Other
#sink: CO
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO)

#Notes:  works so far 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 40 & SourceSink$SeverityClass == 'Low'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 40 & SourceSink$SeverityClass == 'Mod'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 40 & SourceSink$SeverityClass == 'High'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO)



#FluxID: 41-45 now rolled into HW.Other.  For details, see SW.SubMerch and SW.Other



#FluxID: 46
#Source: HW Coarse roots
#sink: HW Coarse roots
#PLS: Surviving coarse roots in conifers
#Pseudocode:  =1-((HW mortality rate)*(1-HW Resprout Rate))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 46 & SourceSink$SeverityClass == 'Low'] <- 1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 46 & SourceSink$SeverityClass == 'Mod'] <- 1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 46 & SourceSink$SeverityClass == 'High'] <- 1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])

#FluxID: 47
#Source: HW Coarse roots
#sink: Above Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted in organic soil
#Pseudocode:  =(HW mortality rate*(1-HW Resproute Rate))*(conifer coarse root fraction in organic soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides HW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 47 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])* VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 47 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])* VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 47 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])* VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone]


#FluxID: 48
#Source: HW Coarse roots
#sink: Below Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted since they are in mineral soil
#Pseudocode:  =(conifer mortality rate)*(1-HW ReSprout rate)*(conifer coarse root fraction in mineral soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides HW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 48 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 48 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])*(1 -  VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 48 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])*(1 -  VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone])




#FluxID: 50
#Source: HW fine roots
#sink: Above Ground Very Fast DOM
#PLS: Fine roots killed but not burned in organic soil
#Pseudocode:  =(conifer mortality rate)*(1-HW ReSprout rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 50 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 50 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 50 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))


#FluxID: 51
#Source: HW fine roots
#sink: Below Ground Very Fast DOM
#PLS: Fine roots killed but not burned in mineral soil
#Pseudocode:  =(conifer mortality rate)*(1-HW ReSprout rate)*(fine root fraction in mineral soil)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 51 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 51 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 51 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone])




#FluxID: 52
#Source: HW fine roots
#sink: CO2
#PLS: Fine roots combusted in duff
#Pseudocode:  =(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to HW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 52 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 52 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 52 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2


#FluxID: 53
#Source: HW fine roots
#sink: CH4
#PLS: Fine roots combusted in duff
#Pseudocode:  =(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to HW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 53 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 53 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 53 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4



#FluxID: 54
#Source: HW fine roots
#sink: CO
#PLS: Fine roots combusted in duff
#Pseudocode:  =(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to HW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 54 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 54 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 54 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO







### end hardwoods


#FluxID: 55
#Source: Aboveground Very Fast DOM
#sink: Aboveground Very Fast DOM
#PLS: Unburned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =Unburned.litter.area(from plot data)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 55 & SourceSink$SeverityClass == "Low"] <-  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 55 & SourceSink$SeverityClass == "Mod"] <-  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 55 & SourceSink$SeverityClass == "High"] <-  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 56
#Source: Aboveground Very Fast DOM
#sink: CO2
#PLS: Burned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =1-Unburned.litter.area(from plot data)*Flaming

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 56 & SourceSink$SeverityClass == "Low"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 56 & SourceSink$SeverityClass == "Mod"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 56 & SourceSink$SeverityClass == "High"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*global.vars$FlamingCO2


#FluxID: 57
#Source: Aboveground Very Fast DOM
#sink: CH4
#PLS: Burned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =1-Unburned.litter.area(from plot data)*Flaming

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 57 & SourceSink$SeverityClass == "Low"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 57 & SourceSink$SeverityClass == "Mod"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 57 & SourceSink$SeverityClass == "High"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*global.vars$FlamingCH4


#FluxID: 58
#Source: Aboveground Very Fast DOM
#sink: CO
#PLS: Burned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =1-Unburned.litter.area(from plot data)*Flaming

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 58 & SourceSink$SeverityClass == "Low"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 58 & SourceSink$SeverityClass == "Mod"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 58 & SourceSink$SeverityClass == "High"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*global.vars$FlamingCO


#FluxID: 59
#Source: organic soil Very Fast DOM
#sink: organic soil Very Fast DOM
#PLS: Uncombusted Fraction of Dead fine roots in the mineral soil, approximately <5 mm diameter
#Pseudocode:  == 1, since dead roots in the mineral soil are not combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 59 & SourceSink$SeverityClass == "Low"] <- 1 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 59 & SourceSink$SeverityClass == "Mod"] <- 1

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 59 & SourceSink$SeverityClass == "High"] <- 1

#FluxID: 60
#Source: Aboveground Fast DOM
#sink: Above Ground Fast DOM
#PLS: Uncombusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately ≥5 and <75 mm diameter
#Pseudocode: =[(litter surface area fraction unburned*woody debris portion of AGFastDOM)+(Dead coarse root fraction of AGFastDOM*(fraction of duff consumed)]
#*Assume all woody fine+small woody debris is combusted, but only fractional combustion of dead coarse roots alongside duff
#CWD.frac.of.AGFastDOM

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone])*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"] <-  (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone])*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone])*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))))


#FluxID: 61
#Source: Aboveground Fast DOM
#sink: CO2
#PLS: Combusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately ≥5 and <75 mm diameter
#Pseudocode: = flux60*smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 61 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 61 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 61 & SourceSink$SeverityClass == "High"] <- (1 -  SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO2

#FluxID: 62
#Source: Aboveground Fast DOM
#sink: CH4
#PLS: Combusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately ≥5 and <75 mm diameter
#Pseudocode: = flux60*smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 62 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 62 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 62 & SourceSink$SeverityClass == "High"] <- (1 -  SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCH4

#FluxID: 63
#Source: Aboveground Fast DOM
#sink: CO
#PLS: Combusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately ≥5 and <75 mm diameter
#Pseudocode: = flux60*smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 63 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 63 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 63 & SourceSink$SeverityClass == "High"] <- (1 -  SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO

#FluxID: 64
#Source: organic soil Fast DOM
#sink: Below Ground Fast DOM
#PLS: Uncombusted fraction of Dead coarse roots in the mineral soil, approximately ≥5 diameter
#Pseudocode: =~ 1, since no combustion within mineral soil

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 64 & SourceSink$SeverityClass == "Low"] <- 1
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 64 & SourceSink$SeverityClass == "Mod"] <- 1
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 64 & SourceSink$SeverityClass == "High"] <- 1

#FluxID: 65
#Source: Medium DOM
#sink: Medium DOM
#PLS: Uncombusted Coarse woody debris on the ground
#Pseudocode: =(1-unburned litter area)*(1-MedDOM.Comb.Frac)
#note: could be from field data, here assuming burns at same rate as duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*(1 - VarDefs$Value[VarDefs$Variable.Name == "MedDOM.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*(1 - VarDefs$Value[VarDefs$Variable.Name == "MedDOM.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*(1 - VarDefs$Value[VarDefs$Variable.Name == "MedDOM.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) 

#FluxID: 66
#Source: Medium DOM
#sink: CO2
#PLS: Combusted Coarse woody debris on the ground
#Pseudocode: =(1-Flux65)*smoulderingCO2
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 66 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 66 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 66 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO2

#FluxID: 67
#Source: Medium DOM
#sink: CH4
#PLS: Combusted Coarse woody debris on the ground
#Pseudocode: =(1-(fraction of duff consumed))*(1-unburned litter area)*smouldering
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 67 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 67 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 67 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCH4


#FluxID: 68
#Source: Medium DOM
#sink: CO
#PLS: Combusted Coarse woody debris on the ground
#Pseudocode: =(1-(fraction of duff consumed))*(1-unburned litter area)*smouldering
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 68 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 68 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 68 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO



#FluxID: 69
#Source: Medium DOM
#sink: Black Carbon
#PLS: Coarse woody debris on the ground converted to black carbon
#Pseudocode: =0 (until field data given)
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data (or at least Koroscil MSc lab data)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 69 & SourceSink$SeverityClass == "Low"] <- 0
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 69 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 69 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 70
#Source: Aboveground Slow DOM
#sink: Above Ground slow DOM
#PLS: Uncombusted fraction of duff horizons
#Pseudocode: =1-(fraction of duff consumed)
#note: see CaMP for slow DOM in peat layers

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"] <- 1-(((as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])))*(VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"] <- 1-(((as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])))*(VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"] <- 1-(((as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])))*(VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]))


#FluxID: 71
#Source: Aboveground Slow DOM
#sink: CO2
#PLS: Combusted Fraction of duff horizons
#Pseudocode: =(fraction of duff consumed)*Smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 71 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 71 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 71 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO2

#FluxID: 72
#Source: Aboveground Slow DOM
#sink: CH4
#PLS: Combusted Fraction of duff horizons
#Pseudocode: ==(fraction of duff consumed)*Smouldering

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 72 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 72 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 72 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCH4


#FluxID: 73
#Source: Aboveground Slow DOM
#sink: CO
#PLS: Combusted Fraction of duff horizons
#Pseudocode: =(fraction of duff consumed)*Smouldering

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 73 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 73 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 73 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO


#FluxID: 74
#Source: organic soil Slow DOM
#sink: Below Ground Slow DOM
#PLS: Uncombusted fraction of Humified organic matter in the mineral soil
#Pseudocode: == 1
#notes: no combustion 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 74 & SourceSink$SeverityClass == "Low"] <- 1

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 74 & SourceSink$SeverityClass == "Mod"] <- 1

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 74 & SourceSink$SeverityClass == "High"] <- 1

#FluxID: 75
#Source: Softwood Stem Snag
#sink: Medium DOM
#PLS: Fraction of conifer snags that fall to ground but not combusted (i.e. fall after the passage of the fire and due to the fire)
#Pseudocode: =[1-(SW.Snag.Comb.Frac]*(Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 76
#Source: Softwood Stem Snag
#sink: Softwood Stem Snag
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-(SW.Snag.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 77
#Source: Softwood Stem Snag
#sink: CO2
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 77 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 77 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 77 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2

#FluxID: 78
#Source: Softwood Stem Snag
#sink: CH4
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 78 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 78 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 78 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4


#FluxID: 79
#Source: Softwood Stem Snag
#sink: CO
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*SW.Snag.Comb.Frac*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 79 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 79 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 79 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO

#FluxID: 80
#Source: Softwood Stem Snag
#sink: Black Carbon
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*BlackCarbon
#notes: no black carbon production for now, will need to estimate based on field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 80 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 80 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 80 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 81
#Source: Softwood Branch Snag
#sink: Above Ground Fast DOM
#PLS: Portion of conifer snag branches that falls onto the ground
#Pseudocode: =[1-(SW.Snag.BW.Comb.Frac)]*Snag.Fall.Frac
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 82
#Source: Softwood Branch Snag
#sink: Softwood Branch Snag
#PLS: Unaltered fraction of snag branches
#Pseudocode: =[1-(SW.Snag.BW.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 83
#Source: Softwood Branch Snag
#sink: CO2
#PLS: Combusted fraction of snag branches
#Pseudocode: = (SW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes:   

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 83 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 83 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 83 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2


#FluxID: 84
#Source: Softwood Branch Snag
#sink: CH4
#PLS: Combusted fraction of snag branches
#Pseudocode: = (SW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 84 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 84 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 84 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4



#FluxID: 85
#Source: Softwood Branch Snag
#sink: CO
#PLS: Combusted fraction of snag branches
#Pseudocode: = (SW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 85 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 85 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 85 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO


#FluxID: 86
#Source: Hardwood Stem Snag
#sink: Medium DOM
#PLS: Fraction of deciduous snags that fall to ground but not combusted (i.e. fall after the passage of the fire and due to the fire)
#Pseudocode: =[1-(HW.Snag.Comb.Frac]*(Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 87
#Source: Hardwood Stem Snag
#sink: Hardwood Stem Snag
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-(HW.Snag.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 88
#Source: Hardwood Stem Snag
#sink: CO2
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 88 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 88 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 88 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2

#FluxID: 89
#Source: Hardwood Stem Snag
#sink: CH4
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 89 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 89 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 89 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4


#FluxID: 90
#Source: Hardwood Stem Snag
#sink: CO
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*HW.Snag.Comb.Frac*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 90 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 90 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 90 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO

#FluxID: 91
#Source: Hardwood Stem Snag
#sink: Black Carbon
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*BlackCarbon
#notes: no black carbon production for now, will need to estimate based on field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 91 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 91 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 91 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 92
#Source: Hardwood Branch Snag
#sink: Above Ground Fast DOM
#PLS: Portion of deciduous snag branches that falls onto the ground
#Pseudocode: =[1-(HW.Snag.BW.Comb.Frac)]*Snag.Fall.Frac
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 93
#Source: Hardwood Branch Snag
#sink: Hardwood Branch Snag
#PLS: Unaltered fraction of snag branches
#Pseudocode: =[1-(HW.Snag.BW.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 94
#Source: Hardwood Branch Snag
#sink: CO2
#PLS: Combusted fraction of snag branches
#Pseudocode: = (HW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 94 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 94 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 94 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2


#FluxID: 95
#Source: Hardwood Branch Snag
#sink: CH4
#PLS: Combusted fraction of snag branches
#Pseudocode: = (HW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 95 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 95 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 95 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4



#FluxID: 96
#Source: Hardwood Branch Snag
#sink: CO
#PLS: Combusted fraction of snag branches
#Pseudocode: = (HW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes:  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 96 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 96 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 96 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO

### Black Carbon -> black carbon and BC to atm emissions are FluxID 97-100

#FluxID: 101-117
#Source: misc
#sink: PM2.5
#PLS: Combustion emissions to 2.5 micron particulate matter
#Pseudocode: = CORefFluxID * (CO to PM/NMOG ratio)
#notes:  

###now, loop through the PM2.5, PM10, and NMOG EFs, using the ratio of PM:CO(or NMOG) and phase to define them in bulk:

###do this in a loop for the PM2.5 range:

## here is the fluxID of interest to grab the CO of:

for(FluxIDLoop in seq(from=101,to=117)){
  
  ### this a.low placeholder grabs the reference CO DM value, which we then multiply against the CO:PM25 ratio in order to get the PM
a.low <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low" & SourceSink$Ecozone == ecozone]

a.mod <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod" & SourceSink$Ecozone == ecozone]

a.high <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High" & SourceSink$Ecozone == ecozone]


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.low & SourceSink$SeverityClass == "Low"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.mod & SourceSink$SeverityClass == "Mod"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.high & SourceSink$SeverityClass == "High"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)
}

#### now for PM10um

for(FluxIDLoop in seq(from=118,to=134)){
a.low <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low" & SourceSink$Ecozone == ecozone]

a.mod <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod" & SourceSink$Ecozone == ecozone]

a.high <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High" & SourceSink$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.low & SourceSink$SeverityClass == "Low"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.mod & SourceSink$SeverityClass == "Mod"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.high & SourceSink$SeverityClass == "High"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)
}

###lastly, for NMOG

for(FluxIDLoop in seq(from=135,to=151)){
a.low <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low" & SourceSink$Ecozone == ecozone]

a.mod <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod" & SourceSink$Ecozone == ecozone]

a.high <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High" & SourceSink$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.low & SourceSink$SeverityClass == "Low"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.mod & SourceSink$SeverityClass == "Mod"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.high & SourceSink$SeverityClass == "High"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)
}

### the foliage, other, and fine root pools have retention terms that are simple 1- all the other fluxes, so have to be computed at the end:


#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Low"] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Mod"] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Mod"]+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "High"] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "High"]+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "High"])
 


#FluxID: 9
#Source: SW Other
#sink: SW Other
#PLS: surviving Live branches, stumps, small trees and bark
#Pseudocode: = 1-(consumption + killed of other pool)

#notes: tried this more complex equation previously, without effect.
#(1-(mortality rate of conifers)*branch fraction of "other" pool)+(1-(medium DOM consumption rate)*stump fraction of other pool)+(1-(mortality of small tree conifers in severity class)*small tree fraction of other pool)+(1-CFB*bark fraction of other pool)
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Low"] <- 1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=10 & SourceSink$FluxID <=13 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 119 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 136 & SourceSink$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Mod"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=10 & SourceSink$FluxID <=13 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 119 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 136 & SourceSink$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "High"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=10 & SourceSink$FluxID <=13 & SourceSink$SeverityClass == "High"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 119 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 136 & SourceSink$SeverityClass == "High"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Low"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 10 & SourceSink$FluxID <= 13 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Mod"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 10 & SourceSink$FluxID <= 13 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "High"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 10 & SourceSink$FluxID <= 13 & SourceSink$SeverityClass == "High"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "High"])


#FluxID: 22
#Source: SW fine roots
#sink: SW fine roots
#PLS: Surviving fine roots
#Pseudocode:  =1-(combustion rate of fine roots+mortality rate of fine roots)
#notes: computed at end of fine roots calculations, even though listed as Flux 22
# NOTE: debug needed on high severity, giving value of -0.002, so rounding problem??

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Low"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Softwood Fine Roots" & SourceSink$SeverityClass == "Low"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Mod"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Softwood Fine Roots" & SourceSink$SeverityClass == "Mod"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "High"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Softwood Fine Roots" & SourceSink$SeverityClass == "High"],na.rm=TRUE)


#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Low"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "Low"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 104 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Mod"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "Mod"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 104 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "High"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "High"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 104 & SourceSink$SeverityClass == "High"]) 



#FluxID: 31
#Source: HW Foliage
#sink: HW Foliage
#PLS: Green fraction of canopy remaining intact after fire
#Pseudocode: Remainder of fluxes 32:35 above
#note2: given definition of CFB, this includes all foliage in merch and submerch

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == "Low"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Foliage" & SourceSink$SeverityClass == "Low"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == "Mod"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Foliage" & SourceSink$SeverityClass == "Mod"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == "High"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Foliage" & SourceSink$SeverityClass == "High"],na.rm=TRUE)




#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == 'Low'] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 105 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == 'Mod'] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == "Mod"]+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 105 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == 'High'] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 105 & SourceSink$SeverityClass == "High"])



#FluxID: 36
#Source: HW Other
#sink: HW Other
#PLS: surviving Live branches, stumps, small trees (and submerch) and bark
#Pseudocode: = 1-(consumption + killed of other pool)

#notes: tried this more complex equation previously, without effect.
#(1-(mortality rate of conifers)*branch fraction of 'other' pool)+(1-(medium DOM consumption rate)*stump fraction of other pool)+(1-(mortality of small tree conifers in severity class)*small tree fraction of other pool)+(1-CFB*bark fraction of other pool)
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == "Low"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=37 & SourceSink$FluxID <=40 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 123 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 140 & SourceSink$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == "Mod"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=37 & SourceSink$FluxID <=40 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 123 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 140 & SourceSink$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == "High"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=37 & SourceSink$FluxID <=40 & SourceSink$SeverityClass == "High"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 123 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 140 & SourceSink$SeverityClass == "High"])



#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == 'Low'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 37 & SourceSink$FluxID <= 40 & SourceSink$SeverityClass == 'Low']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == 'Mod'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 37 & SourceSink$FluxID <= 40 & SourceSink$SeverityClass == 'Mod'])+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == 'High'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 37 & SourceSink$FluxID <= 40 & SourceSink$SeverityClass == 'High']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "High"])


#FluxID: 49
#Source: HW fine roots
#sink: HW fine roots
#PLS: Surviving fine roots
#Pseudocode:  =1-(combustion rate of fine roots+mortality rate of fine roots)
#notes: computed at end of fine roots calculations, even though listed as Flux 49

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == "Low"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Fine Roots" & SourceSink$SeverityClass == "Low"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == "Mod"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Fine Roots" & SourceSink$SeverityClass == "Mod"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == "High"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Fine Roots" & SourceSink$SeverityClass == "High"],na.rm=TRUE)



#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == 'Low'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 50 & SourceSink$FluxID <= 54 & SourceSink$SeverityClass == 'Low']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 108 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == 'Mod'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 50 & SourceSink$FluxID <= 54 & SourceSink$SeverityClass == 'Mod']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 108 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == 'High'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 50 & SourceSink$FluxID <= 54 & SourceSink$SeverityClass == 'High']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 108 & SourceSink$SeverityClass == "High"])


  #FluxID: 4
#Source: SW Foliage
#sink: SW Foliage
#PLS: Green fraction of canopy remaining intact after fire
#Pseudocode: remainder of (consumed+litterfall)
#Notes: have to use logical statement here, google sheets version said 1-Mortality, but can be <0 unless logic is enforced here
#note2: given definition of CFB, this includes all foliage in merch and submerch

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Low"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=5 & SourceSink$FluxID <=8 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 118 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 135 & SourceSink$SeverityClass == "Low"])


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Mod"] <- 1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=5 & SourceSink$FluxID <=8 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 118 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 135 & SourceSink$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "High"] <- 0
## 100% CFB by definition



## end loop

  # final step in loop: once you have a list each built by ecozone, then build a higher-level list called "FireDM"
   
}

###convert SourceSink to a all-character array for export
  SourceSink.export <- apply(SourceSink,2,as.character)
  
##write to csv each time you build it.
write.csv(SourceSink.export,"FireDM-currents.csv")

```

```{r checkSum-not-run, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##example calc:
#sum(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == "Softwood Merchantable" & SourceSink$SeverityClass == "Mod"])

source.list.checksum <- c("Softwood Merchantable", "Softwood Foliage","Softwood Other", "Softwood Coarse Roots","Softwood Fine Roots","Aboveground Very Fast DOM","Aboveground Fast DOM","Medium DOM","Aboveground Slow DOM","Softwood Stem Snag","Softwood Branch Snag","Hardwood Merchantable", "Hardwood Foliage","Hardwood Other","Hardwood Coarse roots","Hardwood Fine Roots","Hardwood Stem Snag","Hardwood Branch Snag","PM25","PM10","NMOG") 

#checksum for a single ecozone, single severity level:


##check the sinks:
for (i in seq(1:length(source.list.checksum))) {

  print(source.list.checksum[i])
  print(sum(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Sink == source.list.checksum[i] & SourceSink$SeverityClass == "Mod"],na.rm=TRUE))
}

##check the source terms (no CO2 etc gas sources....):
for (i in seq(1:length(source.list.checksum))) {

  print(source.list.checksum[i])
  print(sum(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == source.list.checksum[i] & SourceSink$SeverityClass == "Mod"],na.rm=TRUE))
}


```

```{r ComputeDailyFluxes, echo=FALSE, message=FALSE, warning=FALSE}
### Goal: providing SCANFI and severity data, compute fluxes for a given set of FWI conditions

###basically, provide the following: (1) aligned rasters of SCANFI (corresponding to pool names) and severity data (0,1,2,3?) as well as a global DC value for duff consumption estimates

##outputs: tabular values of the sum of the gas fluxes and updated SCANFI rasters that reflect the fire DMs
  
```

```{r makeTables, echo=FALSE, message=FALSE, warning=FALSE}
 
###Function: produce simplified Disturbance Matrix tables
# Written By: Dan Thompson
# Written On: 2024-09-19
# Parameters: ecozone of Canada (as 2-3 letter string, i.e. "BP" for Boreal Plains, BSE for Boreal Shield East, etc), severity class one of c("Low","Mod","High")
# Modified on: 
# Modified by: 
# Purpose: providing a simple truncated 2-D Disturbance Matrix using CBM-CFS3 pool nomenclature.  Useful for error checking and 
# Description: this function produces a simplified DM of key pool from the SinkSource dataframe by simple selection criteria

# output: a formatted RMarkdown compatible kable table that can be put into pdf reports


## replace any NAs with blanks in kable tables
options(knitr.kable.NA = '')

  ### list for columns and rows in visual DM: can be any order, not linked to FluxID or anything:
### text here must exactly match the name of rows in SinkSource, however:

  sink.col.list <- c("Softwood Merchantable", "Softwood Stem Snag","Medium DOM","Softwood Foliage","Aboveground Very Fast DOM", "CO2", "CH4", "CO", "PM25")
  source.row.list <- c("Softwood Merchantable", "Softwood Stem Snag","Medium DOM","Softwood Foliage","Aboveground Very Fast DOM", "CO2", "CH4", "CO", "PM25")

  
  DMTables <- function(ecozone, SeverityClass) {
  
  DM.temp <- as.data.frame(array(NA,c(length(sink.col.list),length(sink.col.list))))
  
  for (j in seq(1:length(sink.col.list))) {
    for (k in seq(1:length(sink.col.list))) {
     
      #if the pair is blank, then return NA, otherwise, look through the list of sink/source pairs for the ecozone and severity level and return that value 
      ifelse(is.na(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == SeverityClass]),NA,DM.temp[j,k] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == SeverityClass])
     
      
    }
    
    
  } 
  rownames(DM.temp) <- source.row.list
  kbl(DM.temp[1:length(sink.col.list),1:length(sink.col.list)],col.names = c("Softwood Merchantable", "Softwood Stem Snag","Medium DOM
","Softwood Foliage","Aboveground Very Fast DOM", "CO2", "CH4", "CO", "PM25"), align = "c",caption = paste0(SeverityClass, " severity Disturbance Matrix in ", ecozone,".  Note: only some biomass and atmospheric pools are shown."),digits=3) %>%
    kable_styling(full_width = F, html_font = "Cambria") %>%
column_spec(2:(length(sink.col.list) + 1), width = "2cm") %>%
column_spec(1, width = "3cm") %>%
  kableExtra::landscape() %>%
          kable_styling(latex_options = "scale_down")  %>%
  kable_styling(latex_options = "hold_position")
  
 
  
  }
  
 ##example of function, for BP and moderate severity (NOT RUN):
  ##DMTables(ecozone = "BP", SeverityClass = "Low") 
  ##DMTables(ecozone = "BP", SeverityClass = "Mod")
 # DMTables(ecozone = "BP", SeverityClass = "High")
  
```

```{r SingleDMExtract, message=FALSE, warning=FALSE, include=FALSE}

###"ExtractFireDM" Function: produce a single machine-readable, long-format (13 columns and 135 rows) Disturbance Matrix
# Written By: Dan Thompson
# Written On: 2024-09-19
# Parameters: ecozone of Canada (as two-letter string, i.e. "BP" for Boreal Plains), severity class one of c("Low","Mod","High"), and Buildup Index (BUI) representative of burning.
# Modified on: 
# Modified by: 
# Purpose: given inputs of ecozone and 
# Description: Note that the AGSlow (aka Forest Floor Fuel Load) value used here is fixed by ecozone, this version of the function does not allow for site-level descriptions of the AGSlow pool size.  To be included in future versions.

# output: A data frame with the following columns: Ecozone, FluxID, Source (CBM pool name), Sink (CBM pool name),Process Synonym (text description of Flux), Phase (flaming vs smouldering), CORefFluxID, and Pseudocode, Notes, SeverityClass, Value (!! the actual Disturbance Matrix value of mass transfer of C), InterimValue (used for development, not used in code here), and SourSurfaceCanopy, which determines if a DM flux value is related to combustion in the surface layers (litter and lower) or in the forest subcanopy or canopy (all tree and tall shrub processes are labelled as "Canopy whether they are in the subcanopy or in the crown).



ExtractFireDM <- function(Ecozone_select="BP",Severity_select="High",BUI_for_DM=70)
{
  #DC_for_DM=700
  #Ecozone_select="BP"
  #Severity_select="High"
  
  ##for now, find the relevant average duff load and ##conversion of Mg C/ha to kg biomass /m2
  AGSlow_for_DM <- as.numeric(FFFC$Median.Duff.Load.kg.m2[FFFC$Ecozone == Ecozone_select])*5
  
  
  DM_temp <- SourceSink %>% filter(Ecozone==Ecozone_select & SeverityClass==Severity_select)
  ###now, need to use the above-defind CalcFFFC function within this to get a new Duff.Consump.frac term:
  ###slight danger since Duff.consump.frac is defined and used otherwise above, so careful
  Duff.consump.frac.ExtractFireDM <- CalcFFFC(AGSlow = AGSlow_for_DM,BUI = BUI_for_DM,Spruce=TRUE)
  
  
  ###now, need to redefine fluxes 11-12,23,25-27,38,40,50,53,54,60,70 here just for the given severity and ecozone but for the selected value of Duff.consump.frac
  
  DM_temp$Value[DM_temp$FluxID == 11] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCO2)

  DM_temp$Value[DM_temp$FluxID == 12] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCH4)
  
  DM_temp$Value[DM_temp$FluxID == 23] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(1 - Duff.consump.frac.ExtractFireDM)


DM_temp$Value[DM_temp$FluxID == 25] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$FluxID == 26] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCH4


DM_temp$Value[DM_temp$FluxID == 27] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO


DM_temp$Value[DM_temp$FluxID == 38] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCO2)


DM_temp$Value[DM_temp$FluxID == 40] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCO)

DM_temp$Value[DM_temp$FluxID == 50] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(1 - Duff.consump.frac.ExtractFireDM)


DM_temp$Value[DM_temp$FluxID == 53] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCH4


DM_temp$Value[DM_temp$FluxID == 54] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO


DM_temp$Value[DM_temp$FluxID == 60] <- (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == Ecozone_select] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == Ecozone_select])*(Duff.consump.frac.ExtractFireDM)))


###importantly, the duff remaining calculation also considered unburned litter area, where litter has to burn in order for the duff beneath to burn.  This can be up to 20% unburned litter area in low severity
DM_temp$Value[DM_temp$FluxID == 70] <- (1-(Duff.consump.frac.ExtractFireDM) *(1-VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$SeverityClass == Severity_select & VarDefs$Ecozone == Ecozone_select]))


#####
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 39] <- 
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCH4)


DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 52] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 61] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 60])*global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 62] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 60])*global.vars$SmoulderingCH4


DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 63] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 60])*global.vars$SmoulderingCO

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 71] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 70])*global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 72] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 70])*global.vars$SmoulderingCH4

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 73] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 70])*global.vars$SmoulderingCO



for(FluxIDLoop in seq(from=101,to=117)){
  
  ### this a.low placeholder grabs the reference CO DM value, which we then multiply against the CO:PM25 ratio in order to get the PM
a.low <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low" & DM_temp$Ecozone == Ecozone_select]

a.mod <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod" & DM_temp$Ecozone == Ecozone_select]

a.high <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High" & DM_temp$Ecozone == Ecozone_select]


DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.low & DM_temp$SeverityClass == "Low"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.mod & DM_temp$SeverityClass == "Mod"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.high & DM_temp$SeverityClass == "High"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)
}

#### now for PM10um

for(FluxIDLoop in seq(from=118,to=134)){
a.low <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low" & DM_temp$Ecozone == Ecozone_select]

a.mod <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod" & DM_temp$Ecozone == Ecozone_select]

a.high <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High" & DM_temp$Ecozone == Ecozone_select]

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.low & DM_temp$SeverityClass == "Low"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.mod & DM_temp$SeverityClass == "Mod"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.high & DM_temp$SeverityClass == "High"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)
}

###lastly, for NMOG

for(FluxIDLoop in seq(from=135,to=151)){
a.low <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low" & DM_temp$Ecozone == Ecozone_select]

a.mod <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod" & DM_temp$Ecozone == Ecozone_select]

a.high <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High" & DM_temp$Ecozone == Ecozone_select]

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.low & DM_temp$SeverityClass == "Low"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.mod & DM_temp$SeverityClass == "Mod"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.high & DM_temp$SeverityClass == "High"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)
}



### the fluxes below are calculated at the end of the algorithm above since they feature residual calculations and need to balance the DMs precisely.  The ones implicated in variable depth of burn with DC

DM_temp$Value[DM_temp$FluxID == 9] <- 1-( sum(DM_temp$Value[DM_temp$FluxID >=10 & DM_temp$FluxID <=13]) + DM_temp$Value[DM_temp$FluxID == 102] + DM_temp$Value[DM_temp$FluxID == 119] + DM_temp$Value[DM_temp$FluxID == 136])

DM_temp$Value[DM_temp$FluxID == 22] <- 1-sum(DM_temp$Value[DM_temp$Source == "Softwood Fine Roots"],na.rm=TRUE)


DM_temp$Value[DM_temp$FluxID == 36] <-1-( sum(DM_temp$Value[DM_temp$FluxID >=37 & DM_temp$FluxID <=40]) + DM_temp$Value[DM_temp$FluxID == 106] + DM_temp$Value[DM_temp$FluxID == 123] + DM_temp$Value[DM_temp$FluxID == 140])

DM_temp$Value[DM_temp$FluxID == 49] <- 1-sum(DM_temp$Value[DM_temp$Source == "Hardwood Fine Roots"],na.rm=TRUE)

  
  
  ###then return the new DM
return(DM_temp)
#return(Duff.consump.frac.ExtractFireDM) #turn this on to just test the duff consumption model

}
  
###some example function applications

testDM1 <- ExtractFireDM(Ecozone_select="BSE",Severity_select = "High",BUI_for_DM=50)
testDM2 <- ExtractFireDM(Ecozone_select="BSE",Severity_select = "High",BUI_for_DM=150)

testDM1$Value[testDM1$FluxID==70] ### fraction of remaining duff in test DM1
testDM2$Value[testDM2$FluxID==70] ### fraction of remaining duff in test DM2

```

```{r ComputeEmissionsPerFire, message=FALSE, warning=FALSE, include=FALSE}


###"EmissionsPerFire" Function: for a given fire size and mix of severity classes, compute the emissions of the various relevant GHGs
# Written By: Dan Thompson
# Written On: 2024-09-19
# Parameters: ID:can be used for testing and dataset creation, just an ID handler,Area_ha:area of the fire in hectares,EcoBoundaryName_select: the full CBM string of the ecozone, e.g. "Boreal Plains": AdminBoundaryName_select: jurisdiction as per CBM , e.g."Alberta", but also note "Labrador" and other provincial admin regions,Low_frac: the fraction area burned as low severity, e.g. "0.2", does not need to add up to 1.0, can be unburned areas,Mod_frac:see low,High_frac: see low,Median_BUI: representative BUI of burning for a fire, suggested as the area-weighted BUI of burning days from fire hotspot records and event-based fire spread datasets.  Can also use BUI of ignition day and NBAC record of ignition day, but will underestimate BUI for very large fires with long duration.
# Modified on: 
# Modified by: 
# Purpose: given average biomass pools per ecozone, this function computes the emissions based on the breakdown of severity classes and a fire area, as well as a provided BUI.  Can be for the final perimeter of fires, but can also be applied to daily spread perimeters in order to compute the daily emissions if large contrasts in BUI are present within fires.
# Description: Note currently using average CBM pool sizes by RU in this function, but could simply reference a spatialized pool dataset down to a pixel level in future applications

# output: 
  #ID: as passed from inputs; 
  #Area_ha,EcoBoundaryName_select, 
  #AdminBoundaryName_select, Low_frac, Mod_frac, High_frac, Median_BUI, all as passed from inputs for quality of life; 
  #MCE: the Mean Combustion Efficiency (see https://acp.copernicus.org/articles/13/7241/2013/ for detailed description), the ratio of CO to      CO2, with ~0.99 being pure flaming, and ~0.7 being pure smouldering.
  #CH4_MgC   CO_MgC  CO2_MgC NMOG_MgC PM10_MgC PM25_MgC emissions by species in Mg of Carbon (12g/mol) over the entire fire area
  #SumC_direct_emissions: the sum of direct emissions (Mg) in C units.
  #ER_CO_CO2: the molar emissions ratio of CO:CO2, an alternate formulation of the MCE
  #ER_CH4_CO2: molar emissions ratio of CH4 to CO2
  #proportion of emissions flagged as being from the surface
  #CO2e_Mg: CO2-equivalent emissions, using the Global Warming Potentials from CBM and NFC-MARS




##Goal: for a single fire, give the (0) some sort of ID (1) total area; (2) ecozone, (3) province, (4-6)% breakdown of low/mod/high, and (7) median DC of burning

##output is as a data frame with (0-7 inputs) as well as total gas and PM emissions as well as emission ratio 

### provide a random number for the ID if otherwise not provided

  ###now load the mean pool size from CBM 2023:
    NIR2023_AverageCPools <- read_csv("./NIR2023_AverageCPools.csv") ### it is in the same dir as the rmd file now

EmissionsPerFire <- function(ID=1,Area_ha=1,EcoBoundaryName_select="Boreal Plains",AdminBoundaryName_select="Alberta",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=250)
{
 
  ###insert function description here
  ##note that Low+Mod+High should not == 1 since unburned area is also possible and likely in most cases
  
  
  
  
   ### just for testing, will get loaded as defaults in the function
  ID <- runif(1, 1000000000000, 9999999999999) %>% round %>% as.character
  #Area_ha=1
  #EcoBoundaryName_select="Boreal Plains"
  #AdminBoundaryName_select="Alberta"
  #Low_frac=0.15
  #Mod_frac=0.15
  #High_frac=0.70
  #Median_BUI=250
  
  ### build the first columns of the output dataframe, which is just the input
  Emissions_DF_head <- as.data.frame(cbind(ID,Area_ha,EcoBoundaryName_select,AdminBoundaryName_select,Low_frac,Mod_frac,High_frac,Median_BUI))
  
  
    
  ##filter out to the pools of the admin and eco zones of interest
  NIR_AverageCPools_filter <- NIR2023_AverageCPools %>% filter(EcoBoundaryName==EcoBoundaryName_select,AdminBoundaryName==AdminBoundaryName_select,TimeStep==32) 
  
  ###make into a long dataframae where the Average C Pool Value is a data frame with columns for the pool name and pool size value
  NIR_AverageCPools_filter_long <- pivot_longer(NIR_AverageCPools_filter,cols=`Aboveground Very Fast DOM`:`Hardwood Fine Roots`) %>% rename(PoolName=name) %>% rename(PoolSize=value)
  
  
  
  
  ##now load up the three appropriate DMs here (one for each severity class):
  
  DM_Low <- ExtractFireDM(unique(NIR_AverageCPools_filter$EcoBoundaryNameShort),Severity_select = "Low",BUI_for_DM = Median_BUI)
  
  DM_Mod <- ExtractFireDM(unique(NIR_AverageCPools_filter$EcoBoundaryNameShort),Severity_select = "Mod",BUI_for_DM=Median_BUI)
  
  DM_High <- ExtractFireDM(unique(NIR_AverageCPools_filter$EcoBoundaryNameShort),Severity_select = "High",BUI_for_DM=Median_BUI)
  
  ### combine the three above into a DM with severity class as a column
  DM_all <- rbind(DM_Low,DM_Mod,DM_High)
  
  Fluxes_Low_tmp <- DM_all %>% filter(SeverityClass=="Low") %>% full_join(NIR_AverageCPools_filter_long,by=join_by(Source == PoolName)) %>% mutate(FluxMgCha = Value*PoolSize*Low_frac) #%>% mutate(UnburnedMgCha = Value*PoolSize*Low_frac)
  
  Fluxes_Mod_tmp <- DM_all %>% filter(SeverityClass=="Mod") %>% full_join(NIR_AverageCPools_filter_long,by=join_by(Source == PoolName)) %>% mutate(FluxMgCha = Value*PoolSize*Mod_frac)
 
  Fluxes_High_tmp <- DM_all %>% filter(SeverityClass=="High") %>% full_join(NIR_AverageCPools_filter_long,by=join_by(Source == PoolName)) %>% mutate(FluxMgCha = Value*PoolSize*High_frac) 
  
  Fluxes_all <- rbind(Fluxes_Low_tmp,Fluxes_Mod_tmp,Fluxes_High_tmp)
  
  ###useful temporary summary of emissions per severity class,but not otherwise used:
  Fluxes_summary_by_sevClass <- Fluxes_all %>% group_by(SeverityClass,Sink) %>% summarize(FluxTotalMgCha = sum(FluxMgCha,na.rm=TRUE))
  
  Fluxes_summary_by_SurfaceCanopy <- Fluxes_all %>% group_by(SourceSurfaceCanopy) %>% summarize(FluxTotalMgCha = sum(FluxMgCha,na.rm=TRUE))
  
  
  
  Fluxes_summary <- Fluxes_all %>% group_by(Sink) %>% summarize(FluxTotalMgCha = sum(FluxMgCha,na.rm=TRUE))
  
  ### calculate the fraction of the total
  Prop_surface <- Fluxes_summary_by_SurfaceCanopy$FluxTotalMgCha[Fluxes_summary_by_SurfaceCanopy$SourceSurfaceCanopy == "Surface"][1]/(Fluxes_summary_by_SurfaceCanopy$FluxTotalMgCha[Fluxes_summary_by_SurfaceCanopy$SourceSurfaceCanopy == "Surface"][1]+Fluxes_summary_by_SurfaceCanopy$FluxTotalMgCha[Fluxes_summary_by_SurfaceCanopy$SourceSurfaceCanopy == "Canopy"][1])
  
  #Prop_unburned
  ################
 
  
  
  
  
  ### calculate total emissions for the fire of interest, mulitplying by Area_ha
  CH4_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="CH4"][1]*Area_ha
  CO_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="CO"][1]*Area_ha
  CO2_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="CO2"][1]*Area_ha
  NMOG_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="NMOG"][1]*Area_ha
  PM10_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="PM10"][1]*Area_ha
  PM25_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="PM25"][1]*Area_ha
  
  ###note that GWP is typically computed on the kg/kg basis, not mol/mol:
  CO2e_Mg <- CO2_MgC*44/12 + CO_MgC*(28/12)*global.vars$GWP_CO + CH4_MgC*(16/12)*global.vars$GWP_CH4 + NMOG_MgC*(16/12)*global.vars$GWP_NMOG + CO2_MgC*44/12*global.vars$EF_N2O
  
  ### calculate the modified combustion efficiency and attach it to the output data frame
  #### MCE is in mixing ratio, so mass/mass terms
  
  MCE <- (CO2_MgC*44/(CO2_MgC*44+CO_MgC*28))
  
  
  ER_CO_CO2 <- CO_MgC/CO2_MgC
  ER_CH4_CO2 <- CH4_MgC/CO2_MgC
  
  SumC_direct_emissions <- sum(CH4_MgC,CO_MgC,CO2_MgC,NMOG_MgC,PM10_MgC,PM25_MgC)
  
  Emissions_DF <- as.data.frame(cbind(Emissions_DF_head,MCE,CH4_MgC,CO_MgC,CO2_MgC,NMOG_MgC,PM10_MgC,PM25_MgC,SumC_direct_emissions,ER_CO_CO2,ER_CH4_CO2,Prop_surface,CO2e_Mg))
  
  Emissions_DF$Area_ha <- as.numeric(Emissions_DF$Area_ha)
  Emissions_DF$Low_frac <- as.numeric(Emissions_DF$Low_frac)
  Emissions_DF$Mod_frac <- as.numeric(Emissions_DF$Mod_frac)
  Emissions_DF$High_frac <- as.numeric(Emissions_DF$High_frac)
  Emissions_DF$Median_BUI <- as.numeric(Emissions_DF$Median_BUI)
  Emissions_DF$NMOG_MgC <- as.numeric(Emissions_DF$NMOG_MgC)
  Emissions_DF$PM10_MgC <- as.numeric(Emissions_DF$PM10_MgC)
  Emissions_DF$PM25_MgC <- as.numeric(Emissions_DF$PM25_MgC)
  Emissions_DF$SumC_direct_emissions <- as.numeric(SumC_direct_emissions)
  Emissions_DF$CO2e_Mg <- as.numeric(Emissions_DF$CO2e_Mg)
  
  
  
  Emissions_DF <- as.data.frame(Emissions_DF) %>% mutate(across(5:20, as.numeric)) %>% mutate(across(5:20, round, 3))
  
  return(Emissions_DF)
}
  #EmissionsPerFire()

test_20_30_30_DC250 <- EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield East",AdminBoundaryName="Ontario",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=70)

test_20_30_30DC500 <- EmissionsPerFire(ID="test_20_30_30DC500",Area_ha = 1000,EcoBoundaryName="Boreal Shield East",AdminBoundaryName="Ontario",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=170)



### same balance of severity classes, just different Drought Code and therefore duff consumption:
rbind(EmissionsPerFire(ID="test_BP_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=50),EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=200))


##constrasting BUI and severity class (more typical), note 10% unburned here (low+mod+high = 0.90) which is by design
## about a ~18% difference in emissions intensity
rbind(EmissionsPerFire(ID="test_BP_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.40,Mod_frac=0.30,High_frac=0.20,Median_BUI=50),EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.20,Mod_frac=0.30,High_frac=0.40,Median_BUI=100))



##same ecoregion just small different balance of severity classes. 
rbind(EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=170),EmissionsPerFire(ID="test_BSE_20_30_50_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.10,Mod_frac=0.20,High_frac=0.50,Median_BUI=170))

##same ecoregion but large difference in balance of severity classes.  
rbind(EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.8,Mod_frac=0.01,High_frac=0.01,Median_BUI=170),EmissionsPerFire(ID="test_BSE_20_30_50_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.10,Mod_frac=0.20,High_frac=0.50,Median_BUI=170))


##contrasting ecozones where the AGSlow (duff) consumption is about 2x greater in BP compared to BSE, and softwood foliage is also about 2x as large.  As a result, per ha the emissions are about 2.0-2.5 times bigger
rbind(EmissionsPerFire(ID="test_BP_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Plains",AdminBoundaryName="Alberta",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=250),EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield East",AdminBoundaryName="Ontario",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=250))


##TSE Labrador
rbind(EmissionsPerFire(ID="test_BP_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Taiga Shield East",AdminBoundaryName="Labrador",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=325),EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Taiga Shield East",AdminBoundaryName="Labrador",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=370))

### real data example from Whitman et al., 2018, the 2014-WB-028 fire:

Fire_2014_WB_028 <- EmissionsPerFire(ID="Fire_2014_WB_028",Area_ha = 60000,EcoBoundaryName="Taiga Plains",AdminBoundaryName="Northwest Territories",Low_frac=0.28,Mod_frac=0.28,High_frac=0.43,Median_BUI=89)


```

```{r Ternary-plots, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#https://cran.r-project.org/web/packages/Ternary/vignettes/Ternary.html

#will need to label each DM endpoint as one of "live", "DOM", "emissions"

##maybe best done down in 2023 emissions instead of map to show variability?

##or show it here and also down in 2023?

##for fires, can scale dot size by area burned, and colour by ecozone?

```

```{r GasEmissions-all-combos, message=FALSE, warning=FALSE, include=FALSE}
###run through all combinations of ecozone*province, severity class, and DC class from 50 -> 750 and run the model there to make a giant lookup table for the DM itself and also the gas emissions


BUI_levels <- seq(from=20,to=200, by=20)
Severity_classes <- c("Low","Mod","High")


###will have to do a case_when here to map the severity classes to the function

###or make a grid for each of low/mod/high, run the function then rbind them

#emissions_temp <- EmissionsPerFire(Area_ha=1,EcoBoundaryName_select=FireDM_grid$EcoBoundaryName,AdminBoundaryName_select = FireDM_grid$AdminBoundaryName,Median_BUI = FireDM_grid$DC_levels)
EmissionsPerFire()

###expand out all combinations of ecozone, admin, and DC levels just once:
FireDM_grid <- expand(NIR2023_AverageCPools,nesting(EcoBoundaryName,AdminBoundaryName),BUI_levels)



###here's a simple 3 row test case across the severity levels
#emissions_grid_out_test <- EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.99999,Mod_frac=0.00001,High_frac=0.000001,Median_BUI=250)

#emissions_grid_out_test <- rbind(emissions_grid_out_test,EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.001,Mod_frac=1.0,High_frac=0.001,Median_BUI=250))

#emissions_grid_out_test <- rbind(emissions_grid_out_test,EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.001,Mod_frac=0.001,High_frac=1.001,Median_BUI=250))



##fill out the first dataframe to get the columns from this function call
emissions_grid_out <- EmissionsPerFire(ID=1,Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[1],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[1],Low_frac = 1,Mod_frac=0,High_frac=0,Median_BUI = FireDM_grid$BUI_levels[1])

emissions_grid_out$Severity_uniform[1] <- c("Low")

###loop the rest by severity class since it didn't want to work to call the function across the array without some strange R syntax that isn't worth it (this only runs to build the RMarkdown and a csv out a graph, runtime not important)
###low loop
for (i in seq(from=2,to=nrow(FireDM_grid)))
{
emissions_temp <- EmissionsPerFire(ID=paste0("Low",i),Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[i],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[i],Low_frac = 1,Mod_frac=0,High_frac = 0,FireDM_grid$BUI_levels[i])

Severity_uniform <- c("Low")

emissions_temp <- cbind(emissions_temp,Severity_uniform)

  emissions_grid_out <- rbind(emissions_grid_out,emissions_temp)
}


###mod loop
for (i in seq(from=1,to=nrow(FireDM_grid)))
{
emissions_temp <- EmissionsPerFire(ID=paste0("High",i),Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[i],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[i],Low_frac = 0,Mod_frac=1,High_frac = 0,FireDM_grid$BUI_levels[i])
  
Severity_uniform <- c("Mod")
emissions_temp <- cbind(emissions_temp,Severity_uniform)
  emissions_grid_out <- rbind(emissions_grid_out,emissions_temp)
}

##high loop
for (i in seq(from=1,to=nrow(FireDM_grid)))
{
emissions_temp <- EmissionsPerFire(ID=paste0("High",i),Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[i],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[i],High_frac = 1,Mod_frac = 0,Low_frac=0,FireDM_grid$BUI_levels[i])
  
Severity_uniform <- c("High")
emissions_temp <- cbind(emissions_temp,Severity_uniform)

  emissions_grid_out <- rbind(emissions_grid_out,emissions_temp)
}

emissions_grid_out$EcoAdmin <- paste(emissions_grid_out$EcoBoundaryName_select,emissions_grid_out$AdminBoundaryName_select)

emissions_grid_out <- emissions_grid_out %>% filter(EcoBoundaryName_select != "Semiarid Prairies") %>% filter(EcoBoundaryName_select != "Subhumid Prairies")

emissions_grid_out <- emissions_grid_out %>% filter(EcoBoundaryName_select != "Hardwood Plains")

#emissions_grid_out$Severity_uniform <- case_when(Low_frac > 0.5 ~ "Low", Mod_frac > 0.5 ~ "Mod", High_frac > 0.5 ~ "High")
### ggplot a line graph with DC on x-axis, CO2 on y axis, then facet by paste(Eco-Admin) combos



```

```{r emissions-grid-ratios-DO-NOT-RUN, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

###ad-hoc code to support the results section on direct fire emissions.  Code works fine, but not directly linked to graphics, tables, or text, so not running it here.

emissions_grid_out <- emissions_grid_out  %>% filter(EcoAdmin != "Pacific Maritime Yukon Territory") %>% filter(EcoAdmin != "Boreal Cordillera Northwest Territories") %>% filter(EcoAdmin != "Taiga Shield East Newfoundland") %>% filter(EcoAdmin != "Boreal Shield West Alberta") %>% filter(EcoAdmin != "Taiga Plains Yukon Territory") %>% filter(EcoAdmin != "Atlantic Maritime Prince Edward Island") %>% filter(EcoAdmin != "Mixedwood Plains Quebec") %>% filter(EcoAdmin != "Taiga Cordillera Yukon Territory") 

##easy stats: top three and bottom three for t C/ha high severity/low severity

emissions_grid_out %>% filter(Median_BUI == 200) %>% arrange(desc(SumC_direct_emissions)) %>% slice_head(n=3)


emissions_grid_out %>% filter(Median_BUI == 200) %>% arrange(SumC_direct_emissions) %>% slice_head(n=3)


### what % of the total pools is released?

### join (emissions_grid_out and NIR_AverageCPools) and mutate sum of pools with sum of emissions to get grand DM value
##what is the median value, highest and lowest?
 


### largest low vs high contrast at BUI ~80

###take the emissions ratio of the IQR of BUI - per ecozone?  Or a fixed global IQR from the CFSDB?

##mutate a new Tot_C_emit_BUI40 value:


emissions_grid_out_stats_40_High <- emissions_grid_out %>% filter(High_frac == 1) %>% filter(Median_BUI == 40) %>% group_by(EcoBoundaryName_select,AdminBoundaryName_select) %>% summarize(Tot_C_emit_BUI40_High = median(SumC_direct_emissions))
emissions_grid_out_stats_200_High <- emissions_grid_out %>% filter(High_frac == 1) %>% filter(Median_BUI == 200) %>% group_by(EcoBoundaryName_select,AdminBoundaryName_select) %>% summarize(Tot_C_emit_BUI200_High = median(SumC_direct_emissions))
emissions_grid_out_stats_High <- cbind(emissions_grid_out_stats_40_High,emissions_grid_out_stats_200_High[,3])
emissions_grid_out_stats_High <- emissions_grid_out_stats_High %>% mutate(Ratio_BUI_40_200_High = Tot_C_emit_BUI200_High/Tot_C_emit_BUI40_High)

#hist(emissions_grid_out_stats$Ratio_BUI_40_200_High)

emissions_grid_out_stats_40_Low <- emissions_grid_out %>% filter(Low_frac == 1) %>% filter(Median_BUI == 40) %>% group_by(EcoBoundaryName_select,AdminBoundaryName_select) %>% summarize(Tot_C_emit_BUI40_Low = median(SumC_direct_emissions))
emissions_grid_out_stats_200_Low <- emissions_grid_out %>% filter(Low_frac == 1) %>% filter(Median_BUI == 200) %>% group_by(EcoBoundaryName_select,AdminBoundaryName_select) %>% summarize(Tot_C_emit_BUI200_Low = median(SumC_direct_emissions))
emissions_grid_out_stats_Low <- cbind(emissions_grid_out_stats_40_Low,emissions_grid_out_stats_200_Low[,3])
emissions_grid_out_stats_Low <- emissions_grid_out_stats_Low %>% mutate(Ratio_BUI_40_200_Low = Tot_C_emit_BUI200_Low/Tot_C_emit_BUI40_Low)

#hist(emissions_grid_out_stats_Low$Ratio_BUI_40_200_Low)

emissions_grid_out %>% filter(Median_BUI == 200) %>% arrange(desc(SumC_direct_emissions)) %>% slice_head(n=3)

emissions_grid_out %>% filter(Median_BUI == 200) %>% arrange(SumC_direct_emissions) %>% slice_head(n=3)


emissions_grid_out_stats_Low %>% arrange(desc(Ratio_BUI_40_200_Low))
emissions_grid_out_stats_Low %>% arrange((Ratio_BUI_40_200_Low))

emissions_grid_out_stats_High %>% arrange(desc(Ratio_BUI_40_200_High))
emissions_grid_out_stats_High %>% arrange((Ratio_BUI_40_200_High))

```

## Direct fire carbon emissions as a function of fire severity and drought

```{r non-GWP-total-C-plot-CALCS, message=FALSE, warning=FALSE, include=FALSE}
#emissions_grid_out$Severity_uniform <- as.factor(emissions_grid_out$Severity_uniform)
#emissions_grid_out$Severity_uniform <- factor(emissions_grid_out$Severity_uniform, levels = c("High","Mod","Low"))

##already filtered out some that are a tiny sliver of an area
emissions_grid_out_plot <- emissions_grid_out 

###I think input data is missing for MP, but have the NIR pools...
###need to compute MW plains also those extra HP in MB and QC.  add the HP, will still be square once PM YT and BC NWT are gone
##%>% filter(EcoAdmin != "Mixedwood Plains Ontario") %>% filter(EcoAdmin != "Mixedwood Plains Quebec")

##where is Hudson Plains MB?
##where is Hudson Plains QC??
##where is TSE QC?

##what about TSW Nunavut?
##BSW AB is tiny
###PM YT is tiny

emissions_grid_out_plot$EcoAdmin <- case_match(emissions_grid_out_plot$EcoAdmin,
                                          "Atlantic Maritime New Brunswick" ~ "AM NB",
                                          "Atlantic Maritime Nova Scotia" ~ "AM NS",
                                          "Atlantic Maritime Prince Edward Island" ~ "AM PE",
                                          "Atlantic Maritime Quebec" ~ "AM QC",
                                          "Boreal Cordillera British Columbia" ~ "BC BC",
                                          "Boreal Cordillera Northwest Territories" ~ "BC NT",
                                          "Boreal Cordillera Yukon Territory" ~ "BC YT",
                                          "Boreal Plains Alberta" ~ "BP AB",
                                          "Boreal Plains British Columbia" ~ "BP BC",
                                          "Boreal Plains Manitoba" ~ "BP MB",
                                          "Boreal Plains Northwest Territories" ~ "BP NT",
                                          "Boreal Plains Saskatchewan" ~ "BP SK",
                                          "Boreal Shield East Labrador" ~ "BSE Lab",
                                          "Boreal Shield East Newfoundland" ~ "TSE NFLD",
                                          "Boreal Shield East Ontario" ~ "BSE ON",
                                          "Boreal Shield East Quebec" ~ "BSE QC",
                                          "Boreal Shield West Alberta" ~ "BSW AB",
                                          "Boreal Shield West Manitoba" ~ "BSW MB",
                                          "Boreal Shield West Ontario" ~ "BSW ON",
                                          "Boreal Shield West Saskatchewan"  ~ "BSW SK",
                                          "Hudson Plains Manitoba"  ~ "HP MB",
                                          "Hudson Plains Ontario"  ~ "HP ON",
                                          "Hudson Plains Quebec"  ~ "HP QC",
                                          "Montane Cordillera British Columbia" ~ "MC BC",
                                          "Montane Cordillera Alberta" ~ "MC AB",
                                          "Mixedwood Plains Ontario" ~ "MP ON",
                                          "Mixedwood Plains Quebec" ~ "MP QC",
                                          "Pacific Maritime British Columbia" ~ "PM BC",
                                          "Pacific Maritime Yukon Territory" ~ "PM YT",
                                          "Taiga Cordillera Northwest Territories" ~ "TC NT",
                                          "Taiga Cordillera Yukon Territory" ~ "TC YT",
                                          "Taiga Plains Alberta" ~ "TP AB",
                                          "Taiga Plains British Columbia"  ~ "TP BC",
                                          "Taiga Plains Northwest Territories" ~ "TP NT",
                                          "Taiga Plains Yukon Territory" ~ "TP YT",
                                          "Taiga Shield East Labrador"  ~ "TSE Lab",
                                          "Taiga Shield East Quebec"  ~ "TSE QC",
                                          "Taiga Shield West Alberta" ~ "TSW AB",
                                          "Taiga Shield West Manitoba" ~ "TSW MB",
                                          "Taiga Shield West Nunavut" ~ "TSW NU",
                                          "Taiga Shield West Saskatchewan" ~ "TSW SK",
                                          "Taiga Shield West Northwest Territories" ~ "TSW NT")


emissions_plot <- ggplot(emissions_grid_out_plot,aes(Median_BUI,SumC_direct_emissions,colour = Severity_uniform)) + geom_line() + facet_wrap(vars(EcoAdmin),labeller = labeller(EcoAdmin = label_wrap_gen(20))) + theme_bw() + ylab("Direct emissions from wildfire\n(t C/ha) not adjusted to GWP") + xlab("Buildup Index of burning") + theme(legend.position="none") + scale_colour_manual(values = c("#fc6f03",  "darkgreen","gold")) + theme(strip.text.x = element_text(size = 8)) +theme(plot.caption = element_text(hjust = 0.5)) +  scale_x_continuous(guide = guide_axis(n.dodge = 2)) + ylim(0,100) + theme(panel.grid.minor = element_blank()) + theme(strip.background = element_rect(colour = "black", fill = "white"))

ggsave("emissions_plot.png")
```


```{r non-GWP-total-C-plot, fig.cap="\\label{fig:non-GWP-total-C-plot}Direct emissions by severity class: orange = high, fig.width=6, message=FALSE, warning=FALSE, include=FALSE, yellow = moderate, green = low severity.  Labelled acronyms \n are Reconciliation Units (see Figure 1) as Ecozone then Province, so BC is both Boreal Cordillera \n and British Columba. Labrador is distinct from the island of Newfoundland for Reconciliation Units,\n so 'Lab' and 'NFLD' is used.  Some small Reconciliation Units without unique NIR biomass pool data are not shown in this figure but are computed still from adjacent RU from the same ecozone.  Some RU with very small burned area are also not shown in this figure.",out.width="75%", message=FALSE, warning=FALSE}

### was getting a strange error since the output map in pdf was too large for the latex compiler somehow.  Inserting the above ggplot image as png instead (lazy screenshot not ggsave)

knitr::include_graphics("~/nrcan-cfs-fire/FireDMs/emissions_plot.png")
```



```{r GWP-adjusted-total-C-plot-NOT-READY, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

###just need to adjust CH4 by 28x and CO is just ~1.  NMOG not sure
ggplot(emissions_grid_out,aes(Median_BUI,SumCO2e_direct_emissions_GWP,colour = Severity_uniform)) + geom_line() + facet_wrap(vars(EcoAdmin)) + ylab("Direct emissions from wildfire (Mg CO2e/ha)") + xlab("Buildup Index of burning")
```


Direct fire emissions per hectare by severity class and as a function of drought condition (Buildup Index) are shown in Figure \ref{fig:non-GWP-total-C-plot}. Direct fire emissions per hectare were greatest (using a constant BUI of 200 as a practical maximum) in the Pacific Maritime ecozone of British Columbia, with 83 and 71 t C/ha released in high and moderate severity fires, respectively. This equates to 295 and 252 t CO2e/ha and an MCE of 0.90 to 0.89, respectively. The Pacific Maritime ecozone features some of the highest relative contributions of canopy fuels to carbon release, with 32% of modelled emissions from the canopy, and 68% from the surface (i.e. woody debris, litter, duff, roots etc). Next highest emissions were 65 t C/ha from high severity fire in the Boreal Shield East of Labrador which features far lower merchantable volume (see Appendix A) but overall softwood foliage pools only 5% smaller than the Pacific Maritime. Larger aboveground very fast DOM (i.e. litter) pools in the BSE of Labrador offset slightly smaller aboveground slow DOM (i.e. forest floor duff) pools as compared to the PM.

The lowest emissions per area were estimated to be in the Boreal Shield West of Saskatchewan, where total emissions of 16 and 22 t C/ha (56 and 76 t CO2e/ha) for low and moderate severity fire at a BUI of 200 were 77% in surface fuels. Despite much lower overall emissions, these low emissions fires still feature 77-79% of the total emissions from surface fuels. The Taiga Shield West of the Northwest Territories also was modelled to have emissions of only 21.5 t C/ha under low severity fire.

Across both low and high severity fires, the effect of drought (i.e. Buildup Index) was fairly consistent, the emissions from BUI 200 fires (i.e. very dry conditions) were higher than those of identical severity class but at a much lower BUI of 40. This lower BUI of 40 represents the practical lower limit of large spreading fires in forests in Canada. Eastern regions such as the Mixedwood Plains of Ontario and Quebec as well as the Atlantic Maritime of Nova Scotia and Prince Edward Island see a modelled 60% enhancement of emissions across the range of simulated BUI here, while northwestern boreal regions such as the Taiga Shield West of the Northwest Territories, BSW of Alberta, and Taiga Cordillera of the NWT show a far smaller 10-13% enhancement of emissions per hectare. This patterns is consistent across both high and low severity fire, with the BUI enhancement of emissions as high as 63% in low severity fires, while the effect is only somewhat smaller in high severity fires at 54%. Regions with a high emissions drought sensitivity tend to be those with higher softwood (i.e. broadleaf) forest composition near 50% (by volume) or more (i.e. Atlantic Maritime, Mixedwood Plains and also Boreal Plains of Manitoba). RUs with the highest aboveground slow DOM pools also showed similarly high drought sensitivity of \~42%. RUs with the lowest drought sensitivity tend to also be the RUs with the lowest overall emissions.

## Comparison against existing fuel consumption models

```{r fig-DMs-vs-FBP-CALCS, fig.cap="\\label{fig:fig-DMs-vs-FBP}Fire direct emissions by severity class using the FireDMs approach from this study (lines) as compared to Canadian Fire Behaviour Prediction (FBP) System outputs for Total Fuel Consumption, message=FALSE, warning=FALSE, based on experimental fires of differing fuel types C.2 (boreal spruce), C.3 (Jack and lodgepole pine) as well as M.1 (leafless mixedwood 50% conifer).  An Initial Spread Index value of 14 is used in all FBP calculations.  Points are colourized by Crown Fraction Burned (CFB).", echo=FALSE, include=FALSE}
library(cffdrs)
###easy comparison is for a mixedwood, since the NIR biomass data is an average across all ground plots

##should probably show: C-1 (TSE/W only), C-2, C-3, M-1, C-5 & C-7 (BC MC only)

###figure out a good mixedwood % for QC BS and AB BP:

NIR2023_AverageCPools_FBP_comp <- NIR2023_AverageCPools %>% mutate(EcoAdmin = paste0(NIR2023_AverageCPools$EcoBoundaryName," ",NIR2023_AverageCPools$AdminBoundaryName)) %>% filter(EcoAdmin == "Boreal Shield West Saskatchewan" | EcoAdmin == "Taiga Plains Northwest Territories" | EcoAdmin == "Taiga Shield West Northwest Territories" | EcoAdmin == "Boreal Plains Alberta"| EcoAdmin == "Montane Cordillera British Columbia" | EcoAdmin == "Boreal Shield East Quebec" ) %>% filter(TimeStep==32)
                                                                                                                              
PC <- NIR2023_AverageCPools_FBP_comp$"Softwood Foliage" /(NIR2023_AverageCPools_FBP_comp$"Hardwood Foliage" + NIR2023_AverageCPools_FBP_comp$"Softwood Foliage")*100                                                                                        

NIR2023_AverageCPools_FBP_comp <- cbind(NIR2023_AverageCPools_FBP_comp,PC)

NIR2023_AverageCPools_FBP_comp <- NIR2023_AverageCPools_FBP_comp %>% select(EcoAdmin,PC)
                                                                                                                                          
BUI <- seq(from=20,to=200, by=20)
##then, expand the biomass pools out by BUI levels
NIR_C_Pools_FBP_grid <- expand_grid(NIR2023_AverageCPools_FBP_comp,BUI)

NIR_C_Pools_FBP_grid$FuelType <- c("C-3")
NIR_C_Pools_FBP_grid$FFMC <- 92
NIR_C_Pools_FBP_grid$WS <- 25

FBP_out <- fbp(NIR_C_Pools_FBP_grid,output="all") %>% mutate(order = as.numeric(ID)) %>% arrange(order)

NIR_C_Pools_FBP_grid <- cbind(NIR_C_Pools_FBP_grid,FBP_out$TFC*5)

colnames(NIR_C_Pools_FBP_grid)[7] <- c("TFC")

##just look at the filtered ecoAdmin areas of interest as from the above NIR pools:

emissions_grid_out_FBP <- emissions_grid_out %>% filter(EcoAdmin == "Boreal Shield West Saskatchewan" | EcoAdmin == "Taiga Plains Northwest Territories" | EcoAdmin == "Taiga Shield West Northwest Territories" | EcoAdmin == "Boreal Plains Alberta"| EcoAdmin == "Montane Cordillera British Columbia" | EcoAdmin == "Boreal Shield East Quebec")# %>%  filter(Severity_uniform == "High")

#emissions_grid_out_FBP_join <- emissions_grid_out_FBP %>% right_join(NIR_C_Pools_FBP_grid, by = join_by(EcoAdmin,Median_BUI==BUI))

test_fbp1 <- expand_grid(FuelType=c("C-2","C-3","M-1"),BUI = seq(from=30,to=200, by=20))

#BUI <- seq(from=40,to=200, by=20)
#test_fbp1 <- as.data.frame(BUI)
#test_fbp1$FuelType <- c("C-3")
test_fbp1$FFMC <- 92
test_fbp1$WS <- 18
test_fbp1$GS <- 0

test_fbp_out <- fbp(test_fbp1,output="all")

test_fbp_out$ID <- as.numeric(test_fbp_out$ID) 

test_fbp_out <- test_fbp_out %>% arrange(ID)

test_fbp_out <- bind_cols(test_fbp_out,test_fbp1$FuelType,test_fbp1$BUI)
colnames(test_fbp_out)[44] <- c("FuelType")
colnames(test_fbp_out)[45] <- c("Median_BUI")

library(ggnewscale)


##label the ecozones by % of CNFDB area burned 1980-2024?

DM_vs_FBP <- ggplot(emissions_grid_out_FBP,aes(Median_BUI,SumC_direct_emissions,colour = Severity_uniform)) + geom_line() + facet_wrap(vars(EcoAdmin),labeller = labeller(EcoAdmin = label_wrap_gen(20))) + theme_classic2() + ylab("Direct emissions from wildfire\n(Mg C/ha) not adjusted to GWP") + xlab("Buildup Index of burning")  + scale_colour_manual(values = c("#fc6f03",  "darkgreen","gold"),guide = "none") + theme(strip.text.x = element_text(size = 8)) +theme(plot.caption = element_text(hjust = 0.5)) + ggnewscale::new_scale_color() +  geom_point(data=test_fbp_out,aes(Median_BUI,TFC*5,colour=CFB,shape=FuelType)) + theme(legend.position="bottom") + scale_colour_steps2() 


### colourize the FBP data points by CFB.  Note in the legend the CFB approximations for severity classes



#ggplot(emissions_grid_out_FBP,aes(Median_BUI,SumC_direct_emissions,colour = Severity_uniform)) + geom_line(color="#fc6f03") + scale_colour_manual(values = c("#fc6f03",  "darkgreen","gold")) + facet_wrap(vars(EcoAdmin),nrow=2,labeller = labeller(EcoAdmin = label_wrap_gen(20))) + geom_point(data=test_fbp_out,aes(Median_BUI,TFC*5,colour=FuelType))

# + geom_point(aes(Median_BUI,TFC,colour="darkorange"))

## and then some manual labelling at the centroid of each?

##show rugplot etc of BUI from CFSDB?

ggsave("DM_vs_FBP.png")

```



```{r fig-DMs-vs-FBP, echo=FALSE, fig.cap="\\label{fig:fig-DMs-vs-FBP}Fire direct emissions by severity class using the FireDMs approach from this study (lines) as compared to Canadian Fire Behaviour Prediction (FBP) System outputs for Total Fuel Consumption, message=FALSE, warning=FALSE, based on experimental fires of differing fuel types C.2 (boreal spruce), C.3 (Jack and lodgepole pine) as well as M.1 (leafless mixedwood 50% conifer).  An Initial Spread Index value of 14 is used in all FBP calculations.  Points are colourized by Crown Fraction Burned (CFB).", echo=FALSE}

### was getting a strange error since the output map in pdf was too large for the latex compiler somehow.  Inserting the above ggplot image as png instead (lazy screenshot not ggsave)

knitr::include_graphics("~/nrcan-cfs-fire/FireDMs/DM_vs_FBP.png")
```



The fire disturbance matrix approach is compared to the FBP System in Figure \ref{fig:fig-DMs-vs-FBP}. The FBP used widely in fire growth modelling as well as in Canada's national air quality model [@chen2019]. The FBP fuel consumption values are based solely on experimental (i.e. controlled ignition) fires with fuel consumption measured within less than an hour of the passage of the flaming front, and therefore does not include the consumption from long-smouldering fuel beds such as organic soils and large-diameter woody debris. The FBP system emphasizes the prediction of fire intensity (i.e. flame length) and fire frontal spread rate, with no measurements of the complete fuel consumption. Fuel consumption values provided by the FBP system are dependent only on fuel type (related to leading tree species) and Buildup Index, with no allowance for site-specific variations in fuel load (both canopy and surface fuel loads are fixed in the FBP). Given the need for safe experimental fire operations and the demand for firefighting resources, experimental fires in the FBP with fuel consumption data have a BUI of no more than 80 for the most common C-2 and C-3 fuels. A BUI of 80 exceeds the area-weighted BUI for most years except in the Montane Cordillera ecozone (See Appendix C), though the record-breaking 2023 fire season saw an area-weighted mean BUI for burning days of 109.

The extrapolation of fuel consumption in the FBP beyond 80, coupled with the lack of long-duration smouldering pools, likely accounts for the systematic lower estimates of fuel consumption in the FBP compared to this disturbance matrix approach shown above (see Figure \ref{fig:fig-DMs-vs-FBP}). For more southern forests such as the Montane Cordillera, Boreal Plains, or Boreal Shield East, larger canopy fuels and woody debris volumes likely contribute to the larger fuel consumption estimates in this approach compared to the FBP. For the Taiga ecozones, smaller canopy fuel and woody debris fuel loads as well as thin duff layers (i.e. AGSlow in the CBM-CFS3 nomenclature) also contribute to lower total fuel consumption that falls closer to observed FBP Values.

## Comparison against observed direct fire emissions

### Forest fire observations of CO and CO~2~ emissions ratios

```{r MCE-from-airborne, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

###haven't yet incorporated these airborne emissions ratios from the ETL tower site: https://gml.noaa.gov/aftp/data/trace_gases/co/pfp/aircraft/txt/co_etl_aircraft-pfp_1_ccgg_event.txt, but possible.


AirborneMCE <- read.csv("~/nrcan-cfs-fire/FireDMs/AirborneMCE.csv")

MCE_temp <- array(data=NA)

MCE_temp1 <- EmissionsPerFire(ID=AirborneMCE$Study[1],Area_ha = 1,EcoBoundaryName=AirborneMCE$EcoBoundaryName[1],AdminBoundaryName=AirborneMCE$AdminBoundaryName[1],Low_frac=0.20,Mod_frac=0.30,High_frac=0.50,Median_BUI=AirborneMCE$Median_BUI[1])

MCE_Table <- cbind(AirborneMCE$Study[1],AirborneMCE$Date[1],AirborneMCE$Subset[1],MCE_temp1$EcoBoundaryName_select,AirborneMCE$Median_BUI[1],AirborneMCE$Obs.MCE[1],MCE_temp1$MCE)

colnames(MCE_Table) <- c("Study","Date","Subset","Ecozone","Buildup Index","Obs MCE","Modelled MCE")

MCE_temp2 <- EmissionsPerFire(ID=AirborneMCE$Study[2],Area_ha = 1,EcoBoundaryName=AirborneMCE$EcoBoundaryName[2],AdminBoundaryName=AirborneMCE$AdminBoundaryName[2],Low_frac=1.0,Mod_frac=0.0,High_frac=0.0,Median_BUI=AirborneMCE$Median_BUI[2])

MCE_temp3 <- EmissionsPerFire(ID=AirborneMCE$Study[3],Area_ha = 1,EcoBoundaryName=AirborneMCE$EcoBoundaryName[3],AdminBoundaryName=AirborneMCE$AdminBoundaryName[3],Low_frac=1.0,Mod_frac=0.0,High_frac=0.0,Median_BUI=AirborneMCE$Median_BUI[3])


MCE_Table2 <- cbind(AirborneMCE$Study[2],AirborneMCE$Date[2],AirborneMCE$Subset[2],MCE_temp2$EcoBoundaryName_select,AirborneMCE$Median_BUI[2],AirborneMCE$Obs.MCE[2],MCE_temp2$MCE)

MCE_Table3 <- cbind(AirborneMCE$Study[3],AirborneMCE$Date[3],AirborneMCE$Subset[3],MCE_temp3$EcoBoundaryName_select,AirborneMCE$Median_BUI[3],AirborneMCE$Obs.MCE[3],MCE_temp3$MCE)

MCE_Table <- rbind(MCE_Table,MCE_Table2,MCE_Table3)

### add in the TCCON ETL data too, just an average for when XCO2 is in the 95th percentile? Or just xCO>125?
### terra works for opening netcdf files
### East Trout Lake TCCON data: 10.14291/tccon.ggg2020.easttroutlake01.R0

#ETL <- rast("et20161003_20250119.public.qc.nc")

#ETL_df <- as.data.frame(ETL)

#The obs and modelled MCE needs to be a as.numeric

##then as kable, and add sum of FRP observed to get relative emissions (smouldering is far less)

kbl(MCE_Table, caption = "Comparison of the Modified Combustion Efficiency (MCE) of airborne gas measurements of Canadian wildfires against modelled MCE") %>%
  kable_minimal() %>% 
  kable_styling(latex_options="scale_down")

```

Mean observed Modified Combustion Efficiency was observed by @hornbrook2011 for distinct periods during the ARCTAS campaign over northern Saskatchewan in 2008. MCE observed by aircraft during the peak burn period when the majority of fuel consumption and area burned occurs largely corresponded with modelled values (Table \ref{tab:MCE-from-airborne}), suggesting the model provides a fair representation of the balance of flaming and smouldering during large active wildfires. Subsequent smoke plume observations during periods of greatly reduced spread and intensity (late evening and after rain) showed a substantially reduced MCE of 0.82--0.83 that indicates a near lack of flaming combustion. Even when represented as 100% low severity fire in the model, the modelled MCE only declines to 0.903. Since the fire DM model is based on area burned, fire activity such as smouldering but with minimal actual area burned increased is going to show an MCE far lower than areas of low severity fire spread, which are typically still a low sub-canopy flaming front that features a mix of smouldering duff and woody debris alongside flaming consumption of litter [@mcrae1994; @mcrae2017]. During the same ARCTAS campaign over a larger sample of 39 fires, @vayPatternsCO2Radiocarbon2011 observed a mean MCE of 0.89 for smoke plumes within 2 km of a large wildfire.

Comprehensive compilations of emissions factors from @binteshahidNEIVAv10NextgenerationEmissions2024 and @andreaeEmissionTraceGases2019 for boreal forest fuels show N~2~O emissions factors of 0.205 and 0.24 g/kg, respectively. The N~2~O observations from @andreaeEmissionTraceGases2019 are sourced from observations an aggregated MCE of 0.89, similar to our mean modelled MCE of \~0.91. Alternatively, the widely cited emissions factors for N~2~O as 0.77% of vegetation N [@lobertImportanceBiomassBurning1990; @worldmeteorologicalorganizationAtmosphericOzone19851985; @olivierEmissionDatabaseGlobal1994; @davidsonInventoriesScenariosNitrous2014] stems from a small number of observations over two Colorado wildfires by @crutzenBiomassBurningSource1979 that gives a similar result of N~2~O:CO~2~ \~0.22% by volume, or approximately 0.2 g/kg.

## 2023 Canadian wildfire season direct emissions

To calculate the sum total of estimate direct C emission from Canadian wildfires in 2023, severity maps were created for each fire using 2024 season satellite observations using an approach that produces severity class maps using both classified spectral indices [@whitman2020] with additional fire environment covariates to predict severity class at 30-m ***!!!![cite Ellen's upcoming paper]!!!***. A single representative area-weighted Buildup Index value from fire hotspots was computed for each fire. A set of DMs (composed of one DM per severity class) was then applied to Reconciliation Unit carbon stock values for the total fire area falling into low, moderate, and high severity classes. The same Buildup Index was used for all severity classes per fire event when computing the DM per fire event. Per-fire direct C emissions (i.e. CO~2~, CO, CH~4~, PM~2.5~, etc.) were then computed and summed by ecozone and nationally.

RU-level carbon stocks were extracted from the National Forest Carbon Monitoring Accounting and Reporting System (NFCMARS) CBM-CFS3 model results for the start of 2023. Given the extremes of the 2023 fire season, it is reasonable to assume that wildfires occurred indiscriminately across the forested landscape rather than being focused on specific forest types or significantly steered away from fire suppression zones - applying regionally average carbon stocks is correspondingly appropriate.

```{r TotalEmissions2023, message=FALSE, warning=FALSE, include=FALSE}
#burn_severity_by_nfireid_ha.csv is just by NFIREID, need to put RU onto that to get the mean biomass pools, then apply the DMs to compare with the above

NBAC2023 <- read.csv("~/nrcan-cfs-fire/FireDMs/NBAC-2023-points-4326-v4.csv")  ##this needs Median_BUI already joined to it
Severity2023 <- read.csv("~/nrcan-cfs-fire/FireDMs/burn_severity_by_nfireid_ha.csv")

Severity2023$Low_frac <- Severity2023$Low/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)

Severity2023$Mod_frac <- (Severity2023$Moderate+Severity2023$Post.fire.havest)/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)

Severity2023$High_frac <- Severity2023$High/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)

Severity2023$Unchanged_frac <- Severity2023$Unchanged.to.very.low/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)


#sum(NBAC2023$ADJ_HA) ## 14.6 Mha total over 2181 fires
NBAC2023 <- NBAC2023 %>% filter(ADJ_HA>100) #this could be smaller, down to as little as 10 ha potentially
sum(NBAC2023$ADJ_HA) #now only 652 fires but still 14.50 Mha

##specific to 2023, these two fires near Kitimat BC in the large-scale RU map appear on the water, so manually assign them to boreal cordillera RU:
NBAC2023[NBAC2023$NFIREID==829,]$unit_id <- 40
NBAC2023[NBAC2023$NFIREID==776,]$unit_id <- 40

###now, to feed the per-fire carbon function, will need to append the province and ecozone per fire, based on RU:
##in NIR2023_AverageCPools, RU is "SPUID", and in the NBAC, it is "unit_id"
## trim the NIR data frame to just retain the Reconciliation Unit ID (SPUID) and associated info
NIR2023_AverageCPools_temp <- NIR2023_AverageCPools %>% select(SPUID:TimeStep) %>% filter(TimeStep==32)


###need a few patches since the AverageCPools is missing a bit of data: SPUID 14 == 3 (QC becomes Labrdor TSE) and 13 == 18 (QC HP becomes ON HP)

### 3 (Lab+QC TSE),18 (ON+QC+MB+NU HP),32 (AB+MB TSW) ,51 (NT+SK TSW) are all aggregated
##report QC as Lab TSE (no managed forest in QC TSE)


##as a big case_match:

NBAC2023$unit_id <- case_match(
  NBAC2023$unit_id,
  14 ~ 3, 
  13 ~ 18, 
  21 ~ 32, 
  25 ~ 18, 
  26 ~ 32, 
  49 ~ 51, 
  56 ~ 51,
  57 ~ 51, 
  59 ~ 18, 
  .default = NBAC2023$unit_id
)
###now append that info to NBAC2023 data frame:
NBAC2023 <- NBAC2023 %>% left_join(NIR2023_AverageCPools_temp, by = join_by(unit_id == SPUID))
###now append with burn severity data
NBAC2023 <- NBAC2023 %>% left_join(Severity2023,by=join_by(NFIREID))
##make a running summary dataframe, so run the EmissionsPerFire function with i = 1 just to set it up

X <- NBAC2023$X[1]
Y<- NBAC2023$Y[1]
unit_id<- NBAC2023$unit_id[1]

AnnualEmissionsSummary <- cbind(EmissionsPerFire(ID=NBAC2023$NFIREID[1],Area_ha=NBAC2023$ADJ_HA[1],EcoBoundaryName_select = NBAC2023$EcoBoundaryName[1],AdminBoundaryName_select = NBAC2023$AdminBoundaryName[1],Low_frac=NBAC2023$Low_frac[1],Mod_frac=NBAC2023$Mod_frac[1],High_frac=NBAC2023$High_frac[1],Median_BUI=NBAC2023$bui_median[1]),X,Y,unit_id)

for(i in seq(from=2,to=nrow(NBAC2023))){
tmp <- EmissionsPerFire(ID=NBAC2023$NFIREID[i],Area_ha=NBAC2023$ADJ_HA[i],EcoBoundaryName_select = NBAC2023$EcoBoundaryName[i],AdminBoundaryName_select = NBAC2023$AdminBoundaryName[i],Low_frac=NBAC2023$Low_frac[i],Mod_frac=NBAC2023$Mod_frac[i],High_frac=NBAC2023$High_frac[i],Median_BUI=NBAC2023$bui_median[i])

X <- NBAC2023$X[i]
Y<- NBAC2023$Y[i]
unit_id <- NBAC2023$unit_id[i]
##pass along the xy info as well
tmp <- cbind(tmp,X,Y,unit_id)

AnnualEmissionsSummary <- rbind(AnnualEmissionsSummary,tmp)

}


#here's the sum of direct C emissions (Mg or tonnes C)
#sum(AnnualEmissionsSummary$SumC_direct_emissions)

#here's the sum of direct C emissions (Mg or tonnes C)
sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE)

sum(AnnualEmissionsSummary$SumC_direct_emissions,na.rm=TRUE)/sum(AnnualEmissionsSummary$Area_ha,na.rm=TRUE)

### CO2e intensity for all of 2023:
sum(AnnualEmissionsSummary$CO2e_Mg,na.rm=TRUE)/sum(AnnualEmissionsSummary$Area_ha,na.rm=TRUE)

##compare to about 450 Mt

###weighted mean of DC:
#round(weighted.mean(AnnualEmissionsSummary$Median_BUI, AnnualEmissionsSummary$Area_ha,na.rm=TRUE),digits=0)

#round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.05,na.rm=TRUE),digits=0)

#round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.95,na.rm=TRUE),digits=0)


#round(weighted.mean(AnnualEmissionsSummary$MCE, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=3)

#round(weighted.mean(AnnualEmissionsSummary$CO2_MgC/AnnualEmissionsSummary$CO_MgC, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=2)

###what are the mean LMH values per RU? and breakdown of DC by RU as well.





```

```{r Emissions-2023-by-RU,fig.cap="\\label{fig:Emissions-2023-by-RU}Comparison of CO2e emissions per hectare between this method at the 2025 National Inventory Report for the 2023 wildfires.  Dots are labelled by RU and coloured by ecozone (see Figure 1), with dot size proportional to 2023 area burned.  The solid line is the 1:1 reference line, and the dashed line represents 25% deviation from a 1:1 relationship.", echo=FALSE, message=FALSE, warning=FALSE}

#### emissions intensity per RU, compare this approach with NIR

##reminder: ### 3 (Lab+QC TSE),18 (ON+QC+MB+NU HP),32 (AB+MB TSW) ,51 (NT+SK TSW) are all aggregated


AnnualEmissionsSummary_table <- AnnualEmissionsSummary %>% group_by(unit_id) %>% summarize(SumArea = round(sum(Area_ha),0),Avg_Mod_Frac = round(mean(Mod_frac),2),Avg_High_Frac = round(mean(High_frac),2),Avg_C_Mg_ha = round(sum(SumC_direct_emissions)/(sum(Area_ha)),1),Avg_CO2e_ha = round(sum(CO2e_Mg)/(sum(Area_ha)),1)) 

###now load up the summarized emissions intensity from NIR2025 for fires in 2023:

NIR2025_fire_CO2e_intensity <- read.csv("~/nrcan-cfs-fire/FireDMs/NIR2025_fire_CO2e_intensity.csv")

AnnualEmissionsSummary_table <- AnnualEmissionsSummary_table %>% left_join(NIR2025_fire_CO2e_intensity) %>% select(unit_id:Avg_CO2e_ha,NIR2025Emissions_tCO2e_PerHa)

AnnualEmissionsSummary_table <- AnnualEmissionsSummary_table %>% left_join(ReportingUnits) %>% filter(SumArea>100000) %>% arrange(desc(SumArea)) %>% select(unit_id:NIR2025Emissions_tCO2e_PerHa,admin_name,eco_name) %>% relocate(admin_name,.before=unit_id) %>% relocate(eco_name,.after=admin_name)

AnnualEmissionsSummary_table$SumArea <- round(AnnualEmissionsSummary_table$SumArea/10^6,digits=2)

###rename a few of the RU unit IDs here:

AnnualEmissionsSummary_table$admin_name[AnnualEmissionsSummary_table$unit_id==3] <- "Lab+QC"
AnnualEmissionsSummary_table$unit_id[AnnualEmissionsSummary_table$unit_id==3] <- "3+14"

AnnualEmissionsSummary_table$admin_name[AnnualEmissionsSummary_table$unit_id==18] <- "ON+QC+MB"
AnnualEmissionsSummary_table$unit_id[AnnualEmissionsSummary_table$unit_id==18] <- "18+13+25"

AnnualEmissionsSummary_table$admin_name[AnnualEmissionsSummary_table$unit_id==32] <- "AB+MB+SK"
AnnualEmissionsSummary_table$unit_id[AnnualEmissionsSummary_table$unit_id==32] <- "32+21+26"

##revise colour scheme to only smaller subset of ecozones, so no AM, no MP or SeP SuP or SA

ecozones_colours_trunc <- c("#1f78b4","#fb9a99","#33a02c","#b2df8a","#e31a1c","#ff7f00","#b15928","#7d8b8f", "#c1c1c1","brown")


ggplot(AnnualEmissionsSummary_table,aes(NIR2025Emissions_tCO2e_PerHa,Avg_CO2e_ha,label=unit_id))+geom_point(aes(size=log10(SumArea),colour=eco_name))+ theme_classic2() +guides(size = "none") + geom_abline()+ scale_colour_manual(values=ecozones_colours_trunc)+xlim(50,225)+ylim(50,225)+geom_text_repel()+labs(colour = "Ecozone",size="log10 Area Burned",x="NIR 2025 tCO2e per hectare average",y="This Study tCO2e per hectare average") + geom_abline(intercept = 0,linetype = "dashed", slope = 0.750) + geom_abline(intercept = 0,linetype = "dashed", slope = 1.25)

#ggplot(AnnualEmissionsSummary_table,aes(Avg_CO2e_ha,NIR2025Emissions_tCO2e_PerHa,label=unit_id))+geom_point(aes(size=log10(SumArea),colour=eco_name))+ theme_classic2() +guides(size = "none") + geom_abline()+ scale_colour_manual(values=ecozones_colours_trunc)+xlim(50,225)+ylim(50,225)+geom_text_repel()+labs(colour = "Ecozone",size="log10 Area Burned",y="NIR 2025 tCO2e per hectare average",x="This Study tCO2e per hectare average") + geom_abline(intercept = 0,linetype = "dashed", slope = 0.750) + geom_abline(intercept = 0,linetype = "dashed", slope = 1.25)

## +geom_text_repel(data=AnnualEmissionsSummary_table[1:10,]) to only label the 10 largest RUs

colnames(AnnualEmissionsSummary_table) <- c("Jurisdiction","Ecozone","Reconciliation Unit","Area Burned (Mha)","Moderate Severity Fraction","High Severity Fraction","Emissions t C/ha","This Study Emissions t CO2e/ha","NIR 2025 Emissions tCO2e/ha") 




```

```{r tab-RU-CO2e-comp, echo=FALSE}
kbl(AnnualEmissionsSummary_table,align="c", padding=0L,caption="Comparison of per hectare CO2e direct emissions from this study against the 2025 National Inventory Report for the 2023 wildfire season in Canada. Rows are sorted by decreasing 2023 area burned.  Note that for RUs with no managed forest area and no biomass pool data available.") %>% kable_minimal() %>% column_spec(1:9, width = "2cm") %>%
  kableExtra::landscape() %>%
          kable_styling(latex_options = "scale_down")  %>%
  kable_styling(latex_options = "hold_position")  


##style reference
#kbl(NIR_AverageCPools_filterSurface_sorted,align="c",caption="Carbon pool (Mg C/ha) for sub-canopy fuels by Reconciliation Unit for 2023.  RU are sorted in decreasing size of Aboveground Slow DOM, the largest average surface pool.  Columns are in decreasing mean pool size.") %>%
 # kableExtra::landscape() %>%
#  kable_styling(latex_options = "scale_down")  %>%
#  kable_styling(latex_options = "hold_position") %>% column_spec(4:13, width = "2cm")



```

```{r Ecozone-Emissions-2023-table-admin-only, eval=FALSE, include=FALSE}

##too busy, but here's the breakdown by RU
#AnnualEmissionsSummary_table <- AnnualEmissionsSummary %>% group_by(EcoBoundaryName_select,AdminBoundaryName_select) %>% summarize(SumArea = round(sum(Area_ha),0),Avg_Mod_Frac = round(mean(Mod_frac),2),Avg_High_Frac = round(mean(High_frac),2),Avg_C_Mg_ha = round(sum(SumC_direct_emissions)/(sum(Area_ha)),1)) %>% filter(SumArea>10000) %>% arrange(desc(SumArea))

##just by ecozone
AnnualEmissionsSummary_table_admin_only <- AnnualEmissionsSummary %>% group_by(AdminBoundaryName_select) %>% summarize(SumArea = round(sum(Area_ha),0),Avg_Mod_Frac = round(mean(Mod_frac),2),Avg_High_Frac = round(mean(High_frac),2),SumTotal_C_Mg=round(sum(SumC_direct_emissions,na.rm=TRUE),1),Avg_C_Mg_ha = round(sum(SumC_direct_emissions,na.rm=TRUE)/(sum(Area_ha)),1)) %>% filter(SumArea>1000) %>% arrange(desc(SumArea))


## query a single jurisdiction
AnnualEmissionsSummary_table_admin_only$SumTotal_C_Mg[AnnualEmissionsSummary_table_admin_only$AdminBoundaryName_select=="British Columbia"]/10^6

AnnualEmissionsSummary_table_admin_only$SumTotal_C_Mg[AnnualEmissionsSummary_table_admin_only$AdminBoundaryName_select=="Alberta"]/10^6


```

```{r tab-Model-comp-Emissions-2023-table, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

### goal is to make a small data table to show off the 2023 emissions comparison.

Source <- c("This study","Byrne 2024","CAMS-GFAS","FireWork")
Approach <- c("Severity-Inventory", "Total column CO anomaly","Fire Radiative Power","Hotspot-FBP")
TotalEmission <- c(round(sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE),digits=0),"510*","478","168")

Model_comp_Emissions_2023_table <- cbind(Source,Approach,TotalEmission)

kbl(Model_comp_Emissions_2023_table,align="c",caption="Comparison of total carbon emissions estimates for the Canadian 2023 fire season.  Note that the Byrne et al 2024 estimate shown here uses the emissions ratio for CO inferred from this study.  See main text for details.")  %>%
  kable_minimal()  


```

A total of `r {round(sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE),digits=0)}` Mt C was estimated to be released directly by fires in Canada in 2023. The area-weighted mean Buildup Index for all fires in Canada in 2023 was `r  {round(weighted.mean(AnnualEmissionsSummary$Median_BUI, AnnualEmissionsSummary$Area_ha,na.rm=TRUE),digits=0)}`, representing severe but not uniformly exceptional drought conditions in Canada's northern forests. The area-weighted mean total C emissions per unit area was `r {round(weighted.mean(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, AnnualEmissionsSummary$Area_ha,na.rm=TRUE),digits=2)}` t C/ha, though 90% of the emissions per unit area were between the 5th percentile of `r  {round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.05,na.rm=TRUE),digits=0)}` t C/ha typical of the Taiga Plains ecozone under low drought conditions and the 95th percentile of `r  {round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.95,na.rm=TRUE),digits=0)}` t C/ha typical of Pacific coastal forests.

Comparison of emissions totals against the NIR is only possible for spatial units (i.e. Reconciliation Units, provinces, or ecozones) where the entire RU is composed of managed forest. In British Columbia, across 2.2 Mha burned, this FireDMs approach estimates were consistently lower than NIR. This was driven by a lower average emissions in FireDMs for both the Taiga Plains with 1.3 Mha burned (124 t CO2e/ha) and Montane Cordillera with 0.68 Mha burned (127 t CO2e/ha) as compared to the NIR (161 and 189 t CO2e/ha, respectively). For Alberta the 1.5 Mha of Boreal Plains ecozone burned showed close agreement (155 vs 163) as well as in the Taiga Plains (130 vs 144). The Taiga Plains fires of both Alberta and British Columbia were largely adjacent, and the FireDMs output was very similar (123 vs 129) across nearly identical moderate and high severity fractions, but the NIR showed a larger contrast (144 vs 161) that may originate from the underlying assumptions of the previous methods of calculating fire emissions in the NIR.

The RU with the largest burned area in 2023 was in the unmanaged forest of Quebec's Taiga Shield East, where NIR pool sizes from the adjacent jurisdiction of Labrador TSE were used in the FireDMs estimates, as no NIR pool sizes were available for Quebec's TSE ecozone area. Over this 2.5 Mha of burned area, the Quebec TSE FireDMs emissions estimates were substantially larger (149 t CO2e/ha) compared to NIR (99 t CO2e/ha, see Figure \ref{fig:Emissions-2023-by-RU}). In the Quebec Boreal Shield East ecozone where NIR pools are available, the FireDMs were still larger than NIR, though the gap between the two was much smaller (106 vs 92). Only the Manitoba Boreal Plains and Yukon Taiga Plains showed a similarly larger estimate in the FireDMs compared to NIR, with all other RUs showing a typically 10-30% reduction in emissions in the FireDMs compared to the NIR. Overall, this new emissions estimate method will yield more representative fire emissions estimates that are sensitive to annual differences in drought condition and fire-specific patterns of severity. The small overall impact is likely due to larger soil organic layer emissions in the FireDMs being offset by lower canopy consumption in the low and moderate severity areas.

@byrneCarbonEmissions20232024 used observed total atmospheric column excess CO and a range of MCE values to estimate total fire C emissions in Canada in 2023 of between 570-727 Mt C with a mean estimate of 647 Mt. The uncertainty in the estimate from @byrneCarbonEmissions20232024 lies primarily in the uncertain CO~2~:CO ratio (more commonly computed as the normalized ratio MCE) that was estimated to be between 7.8–10.8 g CO~2~ / g CO. Our bottom-up estimates that partition flaming vs smouldering shows a lower CO~2~:CO estimate of `r  {round(weighted.mean(AnnualEmissionsSummary$CO2_MgC/AnnualEmissionsSummary$CO_MgC, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=1)}`. This lower CO~2~:CO ratio (i.e. more smouldering) if applied to the data from @byrneCarbonEmissions20232024 would reduce their lower range of total C emissions to `r  {round(weighted.mean(((AnnualEmissionsSummary$CO2_MgC/AnnualEmissionsSummary$CO_MgC)/7.7)*647, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=0)}` Mt C, which is comparable to the `r {round(sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE),digits=0)}` Mt C computed from this bottom-up approach. Estimates of total carbon emissions based solely on the sum of observed Fire Radiative Power (FRP) from Copernicus-CAMS (GFASv1.2 [@kaiserBiomassBurningEmissions2012]) was 478 Mt C [@jonesStateWildfires202320242024]. The operational air quality model for Canada produces wildfire smoke emissions estimates using the CFFEPS-FireWork framework [@chen2019] which utilizes active fire satellite detections coupled to biomass burning rates from the Canadian Forest Fire Danger Rating System which are known to underestimate total emissions from forest floor combustion [@degroot2009]. As a result, the CFFEPS-FireWork total emissions in 2023 with their exceptional nation-wide moisture deficits [@jainDriversImpactsRecordBreaking2024] underestimate total emissions compared to other methods, with CFFEPS estimates of CO emissions only \~40% of satellite observed values [@griffinBiomassBurningCO2024; @voshtaniQuantifyingCOEmissions2025]. Even after assimilating satellite CO and tower-based total carbon measurements, CFFEPS still retains 20% understimating bias, likely attributable to an estimate of peak CO (i.e. smouldering) emissions that are lower than reality [@voshtaniQuantifyingCOEmissions2025].

### Relationship to other estimates

The forest floor emissions modelling scheme used here builds upon the CanFIRE model [@degroot2013] which incorporates a similar estimate of absolute forest floor emissions based on fuel type and various Fire Weather Index inputs (including but not limited to Buildup Index). While the CanFIRE model is also capable of estimating tree mortality, the premise of CanFIRE lies in the use of the Canadian Fire Behaviour Prediction (FBP) System to model fire intensity and a physiological-thermodynamic model of tree damage and mortality. CanFIRE is able to run entirely in scenario or forecast mode, i.e. no fire severity map is needed to run the model, unlike the focus here on a mechanism to estimate carbon fluxes and pools after fire severity is mapped. Ultimately, models like CanFIRE can be used for near-real time emissions estimates of direct and indirect fire carbon emissions (and also for prescribed fire planning and scenario testing), while this modelling framework is best used solely operational carbon accounting and reporting given its strong dependence on severity maps. While fire severity can be estimated empirically based on geospatial inputs without observation using multispectral satellite data such as Landsat ***!!![Ellen's paper]!!!***, estimation using coupled fire behaviour and ecology models such as CanFIRE is a more direct approach. Under severe drought conditions and light winds, very large fires often create more wind and energy than is available in gradient winds as measured at nearby airports and fire weather observing stations [@clarkAnalysisSmallScaleConvective1999]. Thus, fire behaviour and fuel consumption models solely driven by wind inputs from distant meteorological stations can under-predict fire intensity and therefore likely fire severity. While fire-atmosphere models are available for research [@coenGenerationForecastExtreme2018] and some forecasting and planning purposes [@linn2020], modelling resources are typically not made available for the extensive and largely unsuppressed fires in northern Canada. Fire severity mapping after the fact is able to account for high fire severity [@whitman2018] even when fire spread occurs under light winds more associated with lower fire intensity [@whitman2024].

While the fire DMs presented here are designed for use in NFCMARS for GHG estimation and reporting, their simplicity and similarity to many other forest carbon schema allows them to be used elsewhere such as in other forest dynamics [@brecka2020] and earth system models [@melton2020] that require estimates of Canadian forest carbon emissions from wildfire. @stenzel2019 showed that severity-informed fire C estimates (with snags) in the US are only 30-40% as large as fixed or variable severity data using their LANDIS-type models. Large over-estimates of in-fire bole consumption in models were not observed to correspond to measurements in the field. In the model presented here, our estimates of snag consumption are based on simple but logical relationships with Crown Fraction Burned, but more comprehensive data collection and field observations would be required to extend the accuracy of the snag consumption scheme.

### Indirect fire emissions

While fire emissions within the year of the fire are majority of the GHG flux, enhanced post-fire decomposition of dead biomass persists for many years after a fire. The increase in post-fire tree mortality between the year of the fire and the year following the fire is as much as 30% in low and moderate-severity stands [@angers2011]. This extended mortality is not captured in year-of fire severity mapping but is likely better assessed using fire severity data captured the year following fire, as is operation practice in Canada ***!!!![cite Ellen's upcoming paper]!!!***. Similarly, the transition of fire-killed stems (snags) from upright to the forest floor woody debris takes between 5-8 years for 50% of stems to fall [@angers2011] with stemfall rate highest in low-severity fire. Field observations show that initial assessments of fire severity are the primary predictors of snag fall @angers2011 and decomposition [@boulanger2011] rates, meaning the mapped severity method used here provides a useful input for multi-year fire carbon modelling of the snag pool in CBM-CFS3. For organic soil pools, fire has been shown to suppress decomposition rates in upland soil pools where drier post-fire conditions are present [@holden2015], while in permafrost upland [@odonnell2011] and peatland [@gibson2018; @gibson2019] systems, fire has profound impacts on soil carbon pools by rapidly increasing thaw depths and subsequent decomposition rates. Currently in CBM-CFS3, decomposition rates are calibrated against field decomposition litterbag experiments [@trofymow2002] and annual climate metrics that do not take into account how disturbances such as fire (and fire of varying severity) modify decomposition rates in the absence of a change in climate.

### Model gaps

Currently, the model framework only accounts of regionally-averaged soil carbon stocks, meaning that Reconciliation Units with high peatland areas will show higher organic soil slow pool size, but peatlands themselves are not spatially represented in the model, and instead peatlands influence the mean reported Aboveground Slow pool size. Currently, fire disturbance in peatlands is performed by the CaMP model, which uses the closely related Drought Code fire weather metric to estimate peat layer consumption [@bona2020] and uses the overstory carbon schema of CBM-CFS3 to estimate overstory tree carbon pools and fluxes. Direct satellite monitoring of upland forest organic soil and peatland carbon loss via burn severity monitoring is possible but remains a challenge to implement with accuracy for monitoring purposes [@bourgeau-chavez2020]. Despite the large carbon stock (c. 500 Mg C/ha from @beilmanPeatCarbonStocks2008), the mean C emissions per area in peatland due to fire (65 t C/ha) as modelled by @bona2024 are comparable to regional emissions from peat-rich ecozones such as the Boreal and Taiga Plains under moderate to severe drought conditions. Indeed, it is under these moderate to severe drought conditions under which peatlands burn more frequently [@turetsky2004; @thompson2019] and severely [@kuntzemann2023].

While Canadian wildfires shown an overall selection bias towards preferentially burning older conifer stands [@bernier2016], fuel selectivity against less flammable portions of the landscape decreases strongly under severe drought conditions [@parks2018]. The severe drought conditions experienced in Canada in 2023 [@jainDriversImpactsRecordBreaking2024] are an ideal setting to compare an emissions model using spatially referenced biomass data against observed emissions. The 2023 fires were observed to largely burn boreal forest ecosystems at the same rate as their abundance on the landscape, owing to severe drought and fire weather conditions [@boulanger2024]. Emissions model evaluation against individual fires or in years of less profound drought would be more likely to highlight the limitation of the regionally-averaged carbon pool (i.e. fuel load) values used here. Ultimately, the mapped severity used here is best paired with mapped carbon pools at a similar scale, such as the 1-ha forest carbon modelling for analysis and scenario testing used by @smyth2024. Future work will extend this fire disturbance algorithm to finer-scale carbon reporting using gridded data as it becomes available for annual reporting purposes.

Species-specific traits in trees with overlapping ranges, such as resprouting in aspen [@brown1987] but not other broadleaves such as oak or maple, are not explicitly handled in this model. Instead, the relative abundance of trees with contrasting traits that influence ecological outcomes such as fire survival are lumped at the ecozone scale from the aggregation of the plot data. While ecozone-level contrasts in key considerations such as overstory mortality do strongly vary by ecozone (Table \ref{tab:tab-ReSproutByEcozone}), the same DM (e.g. hardwood root mortality) is applied in adjacent stands at the same severity class despite the potential for strongly contrasting traits that are readily tied back to mapping at the stand level by leading species. Alternately, models such as CanFIRE can account for species-level contrasts in fire ecology traits, but compiling the relevant ecophysiological properties and traits for all tree species across the spectrum of fire intensity in Canada remains incomplete at this time.

# Conclusions

Carbon emissions from wildfires in Canada represent a substantial pulse input of greenhouse gases to the atmosphere: the 2023 fire emissions in Canada were an input of approximately `r {round(sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE),digits=0)}` Mt C. A modelling framework to extend the current fire and greenhouse gas reporting in Canada is presented. In contrast to the existing modelling system that utilizes a fixed fire severity (i.e. tree mortality) assumption, a field-calibrated satellite fire severity mapping process that follows mature and well-established scientific methods is used. Above-ground carbon pool changes (from live to dead and in situ as well as to the gas phase) rely on a robust field observation dataset that relates back to satellite metrics. Evaluation of the modelling presented above against fully independent airborne observations of CO:CO~2~ emissions ratios for boreal wildfires indicates the modelling of proportion of flaming vs smouldering emissions are well-replicated by the model. With confidence in this modelled CO:CO~2~ ratio, the total fire CO emissions for the 2023 wildfire season in Canada (with a record 15 Mha burned) is broadly consistent with fire season estimates using satellite total column CO anomalies.

While this prototype carbon flux framework utilizes regionally-averaged carbon stock estimates, future systems deployment within Canada's carbon accounting system is likely to incorporate precisely mapped (30 m) carbon pools alongside the finely mapped fire severity products (30 m) used here. As both the spatial estimates of carbon stocks across Canada's forested ecosystems improves alongside additional field observations, it is anticipated that this modelling framework will increase in both accuracy and precision over time.

::: {#refs}
:::

# Appendix A: Mean pool size by Reconciliation Unit

```{r PoolSizeByRU, echo=FALSE, message=FALSE, warning=FALSE}

#######
#Surface
######


###rows are RUs as EcoAdmin
NIR_AverageCPools_filterSurface <- NIR2023_AverageCPools %>% filter(TimeStep==32) %>% select('EcoBoundaryNameShort','AdminBoundaryName',SPUID,'Aboveground Very Fast DOM':'Aboveground Slow DOM','Softwood Stem Snag':'Softwood Other','Softwood Coarse Roots','Softwood Fine Roots','Hardwood Coarse Roots','Hardwood Fine Roots')  %>% filter(EcoBoundaryNameShort != "ShP") %>% filter(EcoBoundaryNameShort != "SaP") %>% filter(EcoBoundaryNameShort != "MP") %>% select(!'Black Carbon') %>% select(!Peat) %>% mutate(across(where(is.numeric), round, 1)) 

###now sort columns from largest to smallest mean value by using select() to declare the new order.

##first, reorder:

col_sum <- NIR_AverageCPools_filterSurface %>% summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))
col_sum <- t(col_sum)
colnames(col_sum) <- c("value")
col_sum <- as.data.frame(col_sum) %>% arrange(desc(value))
#row.names(col_sum)

NIR_AverageCPools_filterSurface_sorted <- NIR_AverageCPools_filterSurface %>% select(EcoBoundaryNameShort,AdminBoundaryName,SPUID,"Aboveground Slow DOM", "Medium DOM" , "Aboveground Fast DOM"  ,  "Aboveground Very Fast DOM", "Softwood Coarse Roots",  "Hardwood Coarse Roots" ,  "Belowground Fast DOM" , "Belowground Very Fast DOM", "Softwood Fine Roots", "Hardwood Fine Roots")  %>% rename(RU = SPUID) %>% rename(Jurisdiction = AdminBoundaryName)

##then sort descending of the first (largest) column:
NIR_AverageCPools_filterSurface_sorted <- NIR_AverageCPools_filterSurface_sorted %>% arrange(desc(`Aboveground Slow DOM`))

######
# Canopy
######

## rounding mutate via https://stackoverflow.com/questions/43314328/how-to-use-dplyrmutate-all-for-rounding-selected-columns

NIR_AverageCPools_filterCanopy <- NIR2023_AverageCPools %>% filter(TimeStep==32) %>% select('EcoBoundaryNameShort','AdminBoundaryName',SPUID,'Softwood Stem Snag':'Softwood Other','Hardwood Merchantable':'Hardwood Other') %>% filter(EcoBoundaryNameShort != "ShP") %>% filter(EcoBoundaryNameShort != "SaP") %>% filter(EcoBoundaryNameShort != "MP") %>% select(!'Black Carbon') %>% select(!Peat)%>% mutate(across(where(is.numeric), round, 1)) 

col_sum <- NIR_AverageCPools_filterCanopy %>% summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))
col_sum <- t(col_sum)
colnames(col_sum) <- c("value")
col_sum <- as.data.frame(col_sum) %>% arrange(desc(value))
#row.names(col_sum)

NIR_AverageCPools_filterCanopy_sorted <- NIR_AverageCPools_filterCanopy %>% select(EcoBoundaryNameShort,AdminBoundaryName,SPUID,"Softwood Merchantable", "Softwood Other",        "Hardwood Merchantable", "Softwood Stem Snag",    "Hardwood Other",        "Softwood Foliage" ,     "Hardwood Stem Snag", "Softwood Branch Snag",  "Hardwood Branch Snag",  "Hardwood Foliage") %>% rename(RU = SPUID) %>% rename(Jurisdiction = AdminBoundaryName)

##then sort descending of the first (largest) column:
NIR_AverageCPools_filterCanopy_sorted <- NIR_AverageCPools_filterCanopy_sorted %>% arrange(desc(`Softwood Merchantable`))

##shorten the first column name in each table:
colnames(NIR_AverageCPools_filterCanopy_sorted)[1] <- c("Ecozone")
colnames(NIR_AverageCPools_filterSurface_sorted)[1] <- c("Ecozone")



kbl(NIR_AverageCPools_filterCanopy_sorted,align="c",caption="Carbon pool size (Mg C/ha) for canopy fuels by Reconciliation Unit for 2023. RU are sorted in decreasing size of Softwood Merchantable, the largest average surface pool.  Columns are in decreasing mean pool size.")  %>% kable_styling(full_width = F, html_font = "Cambria") %>%
  kableExtra::landscape() %>%
  kable_styling(latex_options = "scale_down")  %>%
  kable_styling(latex_options = "hold_position")%>% column_spec(4:13, width = "2cm")



#%>%
#    kable_styling(full_width = F, html_font = "Cambria") %>%
#  kable_styling(latex_options = "scale_down")  %>%
#  kable_styling(latex_options = "hold_position")%>%
#  kableExtra::landscape()

kbl(NIR_AverageCPools_filterSurface_sorted,align="c",caption="Carbon pool (Mg C/ha) for sub-canopy fuels by Reconciliation Unit for 2023.  RU are sorted in decreasing size of Aboveground Slow DOM, the largest average surface pool.  Columns are in decreasing mean pool size.") %>%
  kableExtra::landscape() %>%
  kable_styling(latex_options = "scale_down")  %>%
  kable_styling(latex_options = "hold_position") %>% column_spec(4:13, width = "2cm")

  
```

```         
\newpage
```

# Appendix B: Non-linear least squares modelling of soil organic layer consumption

For national annual estimates of forest organic soil layer consumption during wildfire, implementations that only utilize Canadian experimental fire data from the Fire Behaviour Prediction System will be limited to a maximum consumption value of 5 kg (biomass) m^-2^ of total surface fuel (woody debris, litter, and duff) of 5 kg m^-2^, or 25 Mg C ha^-1^, given the observation dataset and fitted model parameters. For the common "C-2" boreal spruce fuel type for instance, Surface Fuel Consumption, SFC (biomass units in kg m^-2^ not kg C) is modelled as:

\begin{equation}
SFC = 5.0 \left(1-e^{-0.0115BUI} \right)^{1.0}
\end{equation}

This model form has the distinct advantage of SFC being 0.0 at a BUI of zero. The model parameters vary by fuel type (i.e. deciduous broadleaf fuels are limited to 1.5 kg m^-2^ of maximum SFC) but are fixed within a fuel type.

More recent observations and modelling from @degroot2009 extended the FBP data with an additional 128 observations from 7 additional wildfires, and the ABoVE project compiled over 1,000 field observations of depth of burn and C stocks before and after wildfire in Canada and Alaska, over 600 of which are in North American Level II ecoregions also occurring in Canada [@walker2020]. @degroot2009 provides a concise and informative improvement on the FBP fuel consumption equations, where both a Fire Weather Index System component (in this case, Buildup Index) is used similarly to Buildup Index in the FBP, but importantly, the site-level organic soil layer fuel load is also accounted for, which allows for the greater absolute combustion in deeper organic soils that is moderated by the natural logarithm transformation:

\begin{equation}
log_{e}(FFFC) = -4.252+0.710log_{e}(DC) + 0.671log_{e}(FFFL)
\end{equation}

where FFFC is Forest Floor Fuel Consumption (SFC minus surface woody debris) in kg (biomass) m^-2^ and FFFL is Forest Floor Fuel Load in kg m^-2^. The forest floor as defined here is inclusive of the litter and duff layers, live mosses and lichens. This model presented above fits well within the dataset and extends the observed maximum FFFC to nearly 10 kg m^-2^. The ABoVE synthesis of FFFL and FFFC [@walker2020] expands upon a slightly smaller dataset used in a modelling summary also by Walker et al @walkerFuelAvailabilityNot2020, where structural equation modelling was used to explore drivers of FFFC but no concise and readily reproducible modelling is produced. The results of the SEM from Walker et al @walkerFuelAvailabilityNot2020 emphasized a greater role of FFFL over DC, though coarse reanalysis that lacked local fire agency weather stations was used. An analysis of just 2014 fires in the Northwest Territories by Walker et al @walkerSoilOrganicLayer2018 showed that while the mean depth of burn across all black spruce stands was 6-10 cm, the driest (xeric) black spruce stands with the smallest FFFL showed upwards of 75% soil organic consumption, while deeper organic soils in subhygric black spruce stands showed less than 25% consumption.

To provide the largest possible dataset for FFFC and FFFL, the ABoVE synthesis was combined with wildfire data from de Groot et al 2009 not otherwise found in the ABoVE synthesis. The ABoVE synthesis sites in the Alaska Boreal Interior ecoregion, which have equivalent Canadian ecozone were excluded due to the presence of continuous permafrost and deep organic soils, but Alaska Boreal Cordillera sites near the Yukon border were utilized. Experimental fire data from the FBP data was not used, as deeper combustion measurements resulting from hours and days of smouldering combustion captured in wildfire data are not available in experimental fires where extensive smouldering is not measured due to suppression.

For the purposes of improving national estimates of the fractional soil organic layer loss during wildfire, this framework emphasizes the proportional C stock loss (as with all CBM-CFS3 disturbance matrices) rather than the absolute value of combustion. In contrast to the modelling of absolute combustion value, any analysis of proportions is best conducted as logit- transformed data, where the logit transformation is:

\begin{equation}
logit(p) = log \frac{p}{1-p}
\end{equation}

which effectively transforms a data of proportions of [0,1] to a Gaussian distribution with a range of approximately -5 to +5 (in this dataset), and a mode approximately at zero.

In the logit transformed space, saturation-type non-linear curve using the relevant FWI component was fitted in a non-linear least squares model, but an additive term of the natural-logarithm transformed forest floor fuel load (FFFL) (given as AGSlow pool in Mg C/ha) was used as well. The non-linear least squares model fit was conducted using the Levenberg-Marquardt nonlinear least-squares algorithm found in MINPACK [@elzhovMinpacklmInterfaceLevenbergMarquardt2023] R package, which supported bounded parameter constraints.

In the abstract, the model follows the form:

\begin{equation}
logit \left( \frac{depth of burn}{pre-fire organic depth}\right) = [c (1 - e^{(a  BUI)})] + (b log_{e}(AGSlow))
\end{equation}

with fitted parameters as:

\begin{equation}
logit \left( \frac{depth of burn}{pre-fire organic depth}\right) = [3.50 (1 - e^{(-0.008 BUI)})] + (-0.53 log_{e}(AGSlow))
\end{equation}

Note the "b coefficient on the parameter associated with the forest floor fuel load (AGSlow) of -0.53, which results in larger organic layer fuel loads leading to smaller proportional consumption values, which follows the patterns shown by @walkerCrossscaleControlsCarbon2018 for NWT fires of 2014.

The a parameter term that forms the exponent of *e* alongside the Buildup Index is related to the BUI value at which half of the maximum possible asymptotal consumption value is observed (for a given FFFL value). The NLS fitting was given a minimum value of -0.008 such that a 50% consumption rate was modelled as occurring at or around a BUI value of 70 for typical upland spruce forest floor (FFFL of 8 kg/m2 or AGSlow of 40 t C/ha) following the wildfire data of @degrootForestFloorFuel2009 as well as experimental fire observations in spruce forests from the FBP System. The other parameters were fit to the best possible value with no constraint.

For example, using a moderately thick \~12 cm thick organic soil layer, the proportion of consumption as a function of Buildup Index using the model above:

```{r example-FFFC-vs-DC-plot-nls, echo=FALSE, fig.cap="Example of the forest floor consumption model for a duff layer (AGSlow) of 60 Mg C ha-1 (12 kg m-2)", message=FALSE, warning=FALSE}

###just show a single (or multiple?) FFFL values here but DC on the x-axis, consumption on the y-axis:

#but also show the raw data pointed coloured by ecozone for that slice of MedDOM (say 70-90) since the median is 80

buildup_index = seq(from = 0.0, to = 300,by = 10)
AGSlow.Mg.C.ha = rep(60,length(buildup_index))

FFFC.single.final.df <- cbind(buildup_index,AGSlow.Mg.C.ha)

FFFC.single<- array(NA,dim=c(length(buildup_index)))
#FFFC.grid <- as.data.frame(FFFC.grid)

for(i in seq(1:length(buildup_index))){

  FFFC.single[i] <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI,newdata=FFFC.single.final.df[i,])))
  }

FFFC.single <- as.data.frame(FFFC.single)

FFFC.single <- t(FFFC.single)

FFFC.single.final.df <- cbind(buildup_index,AGSlow.Mg.C.ha,FFFC.single)

colnames(FFFC.single.final.df)[3] <- c("prop_sol_c_combusted")

ggplot(FFFC.single.final.df, aes(buildup_index,prop_sol_c_combusted)) + geom_line() + ylim(0,1) + ylab("Forest floor mass fraction consumed") + xlab("Buildup Index (BUI)") + theme_classic2()
```

With the parameter constrained NLS fitting, the proportional consumption model for the forest floor has a leave-one-out (conducted at the fire-level, not plot) cross validated r^2^ of 0.52 and a Mean Percent Error of 45%

```{r show-biplot-FFFC-new, fig.cap="Leave one out cross-validation of the forest floor consumption model.  Where multiple measurements were conducted within a single fire, the entire fire was excluded from the training data used in the model training.", echo=FALSE, message=FALSE, warning=FALSE}


#### expanded Leave-One-Out cross-validation
burn_list <- unique(ABoVE_Data_w_FBP_excl_BC$burn_name)


nls.pred.BUI <- NA
for (i in seq(1:length(burn_list)))
#for (i in seq(1:5)) ##keep this for testing

{
  ### do a leave-out-one-fire cross validation by fire ($burn_name), there are 29 unique fires/sites
  
  ##grab the data that doesn't include this burn:
temp.data <- ABoVE_Data_w_FBP_excl_BC %>% filter(burn_name != burn_list[i])
  
temp.valid.data <- ABoVE_Data_w_FBP_excl_BC %>% filter(burn_name == burn_list[i])
  
  ###fit the model:
temp.nls <-  nlsLM(
formula = prop_sol_c_combusted_logit ~ c*(1-exp(a*buildup_index))+(log(AGSlow.Mg.C.ha)*b),
data = temp.data,
start = list(a = -0.0021, b = -0.71,c=3),
lower = c(a=-0.008,b=-Inf,c=0),
upper = c(a=-0.001,b=0,c=10)
)
  
  ##produce a data frame of values from the temporary nls fit and using the data from the burn_list[i]:
nls.pred.BUI.out.temp <- as.data.frame(inv.logit(predict(temp.nls,newdata=temp.valid.data)))
colnames(nls.pred.BUI.out.temp) <- c("nls.pred.BUI")
  
nls.pred.BUI <- rbind(nls.pred.BUI,nls.pred.BUI.out.temp)
}

##crop out the first dummy value:
nls.pred.BUI <- as.data.frame(nls.pred.BUI[2:nrow(nls.pred.BUI),])


#nls.pred.BUI <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI,newdata=ABoVE_Data_w_FBP_excl_BC)))
colnames(nls.pred.BUI) <- c("nls.pred.BUI")

ABoVE_Data_w_FBP_excl_BC <- cbind(ABoVE_Data_w_FBP_excl_BC,nls.pred.BUI)


#ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_combusted,nls.pred)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)


#ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_combusted,nls.pred.BUI)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)

#### but for soil C
#ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_c_combusted,nls.pred)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)

##this is the one to show, biomass and BUI

#ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_c_combusted,nls.pred.BUI)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)







#cor(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,ABoVE_Data_w_FBP_excl_BC$nls.pred)

##model selected:
#cor(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,ABoVE_Data_w_FBP_excl_BC$nls.pred.BUI)





MAE.nls <- mean(abs(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted-ABoVE_Data_w_FBP_excl_BC$nls.pred.BUI),na.rm=TRUE)

#MAE.nls/mean(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,na.rm=TRUE)


ecozones_colours_4 <- c("#fb9a99","#b2df8a","#7d8b8f","brown")


ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_c_combusted,nls.pred.BUI)) + geom_point(aes(colour = factor(ecozone))) + scale_colour_manual(values=ecozones_colours_4) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.55) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1) + xlab("Observed fraction of forest floor mass loss") + ylab("Modelled fraction of forest floor mass loss") + theme_classic2()
```

Across the entire parameter space of Buildup Index and AGSlow pool size, the following isolines of proportional consumption in the model can be plotted:

```{r FFFC-surface-plot, echo=FALSE, fig.height=7, fig.width=7, message=FALSE, warning=FALSE,fig.cap="Isoline contours of equal organic soil layer consumption fraction as a function of BUI and the organic soil layer (Medium DOM) Carbon pool in Mg C/ha.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba.  Rug plots at the axis margins show the marginal density of the data."}

###goal is to produce a surface plot from DC from 0-750 and AGSlow from 0-200 (or 0-500 maybe)
### with isolines of FFFC/FFFL


#FFFC_expand <- tibble(
#  drought_code = seq(from = 0.0, to = 750,by = 25),
#AGSlow.Mg.C.ha = seq(from = 0, to = 600,by = 20)) ## has to be same size, so 31 in this case


#FFFC_expand <- as.data.frame(expand(data=FFFC_expand,drought_code,AGSlow.Mg.C.ha))



#FFFC.grid <- array(NA,dim=c(length(FFFC_expand$drought_code)))
#FFFC.grid <- as.data.frame(FFFC.grid)

#for(i in seq(1:length(FFFC_expand$drought_code))){

 # FFFC.grid[i] <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC,newdata=FFFC_expand[i,])))
  #}
#FFFC.grid <- as.data.frame(FFFC.grid)

#FFFC.grid <- t(FFFC.grid)

#FFFC_expand <- cbind(FFFC_expand,FFFC.grid)

#colnames(FFFC_expand)[3] <- c("prop_total_bg_c_combusted")


##let's add in some example data:

#fuelTypes <- c("C-1", "C-3", "C-7", "O-1")
#SH <- c(4.1,9,9,0)
#CC <- c(8,40,5,0)

#FBP.Example <- as.data.frame(cbind(fuelTypes,SH,CC))
#FBP.Example$SH <- as.numeric(FBP.Example$SH)
#FBP.Example$CC <- as.numeric(FBP.Example$CC)

##plot
brks_FFFC <- c(0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2)

### rename ABoVE_Data_w_FBP_excl_BC$prop_total_bg_c_combusted as "prop_total_bg_c_combusted"

#ggplot(FFFC_expand, aes(drought_code, AGSlow.Mg.C.ha, z=prop_total_bg_c_combusted)) + geom_contour(breaks=brks_FFFC) + geom_dl(aes(label=..level..), method="top.pieces", stat="contour",breaks = brks_FFFC) +labs(caption="Isoline contours of equal organic soil layer consumption fraction as a function of Drought Code and the organic soil layer (Aboveground Slow DOM) Carbon pool in Mg C/ha.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba") +xlab("Drought Code") + ylab("Duff (AGSlow) load Mg C/ha") + theme(plot.caption = element_text(hjust = 0)) + geom_rug(data=ABoVE_Data_w_FBP_excl_BC) +scale_y_continuous(limits = c(0,250))

###would love for the geom_rug to work.....
###+ geom_rug(data=ABoVE_Data_w_FBP_excl_BC)

#TO DO: add in more text at quartiles of AGSlow

# + geom_hline(yintercept=quantile(ABoVE_Data_w_FBP_excl_BC$AGSlow.Mg.C.ha,na.rm=TRUE,c(0.25))) + geom_hline(yintercept=quantile(ABoVE_Data_w_FBP_excl_BC$AGSlow.Mg.C.ha,na.rm=TRUE,c(0.5))) + geom_hline(yintercept=quantile(ABoVE_Data_w_FBP_excl_BC$AGSlow.Mg.C.ha,na.rm=TRUE,c(0.75))) #+scale_y_continuous(limits = c(0,20)) +scale_x_continuous(limits = c(0,60))# + geom_text(data=FBP.Example,aes(CC,SH,label=fuelTypes), inherit.aes = FALSE)

#+geom_tile() ###use fill=prop_total_bg_c_combusted
FFFC_expand.BUI <- tibble(
  buildup_index = seq(from = 0.0, to = 300,by = 10),
AGSlow.Mg.C.ha = seq(from = 0, to = 600,by = 20)) ## has to be same size, so 31 in this case

FFFC_expand.BUI <- as.data.frame(expand(data=FFFC_expand.BUI,buildup_index,AGSlow.Mg.C.ha))

FFFC.grid.BUI <- array(NA,dim=c(length(FFFC_expand.BUI$buildup_index)))
#FFFC.grid <- as.data.frame(FFFC.grid)

for(i in seq(1:length(FFFC_expand.BUI$buildup_index))){

  FFFC.grid.BUI[i] <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI,newdata=FFFC_expand.BUI[i,])))
  }
FFFC.grid.BUI <- as.data.frame(FFFC.grid.BUI)

FFFC.grid.BUI <- t(FFFC.grid.BUI)

FFFC_expand.BUI <- cbind(FFFC_expand.BUI,FFFC.grid.BUI)

colnames(FFFC_expand.BUI)[3] <- c("prop_total_bg_c_combusted")


##let's add in some example data:

#fuelTypes <- c("C-1", "C-3", "C-7", "O-1")
#SH <- c(4.1,9,9,0)
#CC <- c(8,40,5,0)

#FBP.Example <- as.data.frame(cbind(fuelTypes,SH,CC))
#FBP.Example$SH <- as.numeric(FBP.Example$SH)
#FBP.Example$CC <- as.numeric(FBP.Example$CC)

##plot

brks_FFFC <- c(0.95,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2)

### rename ABoVE_Data_w_FBP_excl_BC$prop_total_bg_c_combusted as "prop_total_bg_c_combusted"

ggplot(FFFC_expand.BUI, aes(buildup_index, AGSlow.Mg.C.ha, z=prop_total_bg_c_combusted)) + geom_contour(breaks=brks_FFFC) + geom_dl(aes(label=..level..), method="top.pieces", stat="contour",breaks = brks_FFFC) + theme(plot.caption = element_text(hjust = 0)) + geom_rug(data=ABoVE_Data_w_FBP_excl_BC) +scale_y_continuous(limits = c(0,125)) + scale_x_continuous(limits = c(0,200))



```

```{r FFFC-plot-next, fig.cap="Isoline contours of equal organic soil layer consumption fraction as a function of BUI and the organic soil layer (Medium DOM) Carbon pool in Mg C/ha.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba.", echo=FALSE, message=FALSE, warning=FALSE}

FFFC_expand.BUI$FFFL <- FFFC_expand.BUI$AGSlow.Mg.C.ha/5

### total forest floor consumption in familiar FBP units (kg/m2)
FFFC_expand.BUI$FFFC <- FFFC_expand.BUI$FFFL*FFFC_expand.BUI$prop_total_bg_c_combusted


###plot with FBP units for fuel load (kg/m2), and upper limit of FBP Red Book BUI 

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFL, z=prop_total_bg_c_combusted)) + geom_contour(breaks=brks_FFFC) + geom_dl(aes(label=..level..), method="top.pieces", stat="contour",breaks = brks_FFFC) +xlab("Buildup Index") + ylab("Forest Floor Fuel Load (kg/m2)") + theme(plot.caption = element_text(hjust = 0)) + scale_y_continuous(limits = c(0,25)) + scale_x_continuous(limits = c(0,300))

```

```{r FFFC-plot-next2, echo=FALSE, message=FALSE, warning=FALSE,fig.cap="Isoline contours of equal organic soil layer consumption in kg/m2 as a function of BUI and the organic soil layer fuel load in kg/m2.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba.  Note that peatland ecosystems begin at approximately 50 kg/m2 of forest floor fuel load, or approximately 40 cm organic soil thickness."}
 ### try it with isolines of absolute consumption:

brks_FFFC_abs <- c(1,2.5,5,10,15,20)

FFFC_expand.BUI <- FFFC_expand.BUI %>% filter(FFFL < 25) %>% filter(buildup_index < 300)

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFL, z=FFFC)) + geom_contour(breaks=brks_FFFC_abs) + scale_y_continuous(limits = c(0,25)) + scale_x_continuous(limits = c(0,300)) + geom_dl(aes(label=..level..), method="maxvar.qp", stat="contour",breaks = brks_FFFC_abs)+xlab("Buildup Index") + ylab("Forest Floor Fuel Load (kg/m2)") + theme(plot.caption = element_text(hjust = 0)) 

```

```{r FFFC-plot-next3, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE,fig.cap="Isoline contours of equal organic soil layer consumption in kg/m2 as a function of BUI and the organic soil layer fuel load in kg/m2.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba"}
 ###maybe like FBP with FFFC vs BUI, then varying lines of FFFL:

FFFC_expand.BUI <- FFFC_expand.BUI %>% filter(FFFL > 0) %>% filter(buildup_index > 0) # %>% filter(buildup_index < 300)

brks_FFFL_abs <- c(4,8,12,20)

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFC, z=FFFL)) + geom_contour(breaks=brks_FFFL_abs) + scale_y_continuous(limits = c(0,25)) + scale_x_continuous(limits = c(0,300)) + geom_dl(aes(label=..level..), method="maxvar.qp", stat="contour",breaks = brks_FFFL_abs) +xlab("Buildup Index") + ylab("Forest Floor Fuel Load (kg/m2") + theme(plot.caption = element_text(hjust = 0)) 


```

```{r FFFC-plot-next4, echo=FALSE, message=FALSE, warning=FALSE,fig.cap="Forest floor consumption as a function of BUI across varying levels of forest floor fuel load (FFFL), as shown by coloured dots."}
 ###maybe like FBP with FFFC vs BUI, then varying lines of FFFL:
FFFC_expand.BUI$FFFL <- as.factor(FFFC_expand.BUI$FFFL)

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFC)) + geom_point(aes(colour = FFFL)) +scale_color_viridis_d() + ylab("Forest Floor Fuel Consumption (kg/m2)") + xlab("Buildup Index")

```

```         
\newpage
```

# Appendix C: Annual variability in observed Buildup Index during wildfire spread, and impact on modelled ecozone-level forest floor emissions

```{r AnnualBUI, echo=FALSE, message=FALSE, warning=FALSE}

###can always update this via CFSDB: https://osf.io/f48ry/
###example extract for individual fires
#WB028 <- Firegrowth_groups_v1_01 %>% filter(ID == "2014_295")
#Horse <- Firegrowth_groups_v1_01 %>% filter(ID == "2016_255")
#write.csv(WB028,"2014-WB-028-fire-history.csv")
#Firegrowth_groups_v1_01 <- read.csv()

##weighted-mean BUI of spread by year and ecozone

##not run, loaded in below
##CFSDB_summary <- Firegrowth_groups_v1_1_4June25 %>% group_by(ecozone,year) %>% summarise(AreaWeightedBUIofSpread = weighted.mean(bui,firearea,na.rm=TRUE), n = n())

CFSDB_summary <- read.csv("~/nrcan-cfs-fire/FireDMs/CFSDB_summary.csv")

#CFSDB_summary_ecozone <- Firegrowth_groups_v1_01 %>% group_by(ecozone) %>% summarise(AreaWeightedBUIofSpread = weighted.mean(bui,firearea,na.rm=TRUE), n = n())



###Load in legacy file with ecozone names cross-referenced with ecozone numbers from CFSDB
DC.year <- read.csv("~/nrcan-cfs-fire/FireDMs/DC_by_ecozone_year.csv")

ecozones.unique <- DC.year %>% group_by(Ecozone) %>% summarize(EcoID = mean(ECOZONE),FFFL = mean(Median.Forest.Floor.Load.kg.m2))  %>% filter(Ecozone != "southern arctic") %>% filter(Ecozone != "prairies")

###gotta join Firegrowth_groups_v1_01 to DC.year to get the ecozone names ported over:

CFSDB_summary <- full_join(CFSDB_summary,ecozones.unique,by = join_by(ecozone == EcoID))


##which has the forest floor loading data from the FFFC dataframe already loaded in:

##if DC50 < 20, then set to DC=20
##not sure the source of DC50 == 0 in CFSDB....
#DC.year$DC50 <- ifelse(DC.year$DC50<20,250,DC.year$DC50)

## apply isn't working easily, silly matrix output
#as.data.frame(t(apply(X = DC.year, MARGIN = 1, FUN = CalcFFFC, DC=DC.year$DC50,AGSlow=(DC.year$Median.Forest.Floor.Load.kg.m2*5))))

CFSDB_summary$Duff.consump.frac <- NA
CFSDB_summary$Duff.consump.kg.m2 <- NA


for (i in seq(from=1,to=nrow(CFSDB_summary)))
{
  CFSDB_summary$Duff.consump.frac[i] <- CalcFFFC(BUI=CFSDB_summary$AreaWeightedBUIofSpread[i],AGSlow=CFSDB_summary$FFFL[i]*5)

CFSDB_summary$Duff.consump.kg.m2[i] <- CFSDB_summary$Duff.consump.frac[i]*CFSDB_summary$FFFL[i]
 
  
}
 

CFSDB_summary <- CFSDB_summary %>% filter(!is.na(Ecozone)) 

###if we want, can also query the annual area burned by ecozone by year, then compute it all up from there to get some mass amount
  


```

```{r AnnualDC-Vis-BUI50, fig.cap="Annual variability in area-weighted median BUI of active fire spread days by ecozone.", echo=FALSE, message=FALSE, warning=FALSE}
 
ecozones_colours_trunc_w_PM <- c("#1f78b4","#fb9a99","#33a02c","#b2df8a","#e31a1c","#ff7f00","#cab2d6","#b15928","#7d8b8f", "#c1c1c1","brown")


   ### the graphs, all time series: (1) annual DC by year; (2) absolute consumption values by year; (3) fractional consumption values by year; (4) will add in burned area by ecozone by year eventually too

ggplot(CFSDB_summary, aes(year,AreaWeightedBUIofSpread,colour=Ecozone))  + geom_point() + ylab("Median Buildup Index of fires in ecozone") + facet_wrap(vars(Ecozone)) +theme_classic2() + theme(legend.position="none") + scale_colour_manual(values=ecozones_colours_trunc_w_PM)+ylim(0,200) +  scale_x_continuous(guide = guide_axis(n.dodge = 2))
  
  
  #

#+ geom_dl(aes(label = Ecozone, color = Ecozone), method=list("last.points",rot=30))

```

```{r AnnualBUI-Vis-Consump, fig.cap="Annual variability in forest floor median consumption values by ecozone.", echo=FALSE, message=FALSE, warning=FALSE}


ggplot(CFSDB_summary, aes(year,Duff.consump.kg.m2,colour=Ecozone)) + facet_wrap(vars(Ecozone)) +theme(legend.position="none")+ geom_point() + ylab("Modelled Duff Consumption, kg/m2") +theme_classic2() + theme(legend.position="none") + scale_colour_manual(values=ecozones_colours_trunc_w_PM) + ylim(0,8) +  scale_x_continuous(guide = guide_axis(n.dodge = 2))
  
#+ geom_dl(aes(label = Ecozone, color = Ecozone), method=list("last.points",rot=30)) + 

```

```{r AnnualBUI-Vis-frac, fig.cap="Annual variability in forest floor proportional consumption by ecozone.", echo=FALSE, message=FALSE, warning=FALSE}
 

ggplot(CFSDB_summary, aes(year,Duff.consump.frac,colour=Ecozone)) + facet_wrap(vars(Ecozone)) +theme(legend.position="none")+ geom_point() + ylab("Modelled duff consumption proportion") +theme_classic2() + theme(legend.position="none") + scale_colour_manual(values=ecozones_colours_trunc_w_PM) + ylim(0,1) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2))



```

```         
\newpage
```

```         
\newpage
```

# Appendix D: List of Resprouting Hardwoods of Canada

Alnus spp. Arbutus men. Betula all. Betula pap. Betula pop. Fraxinus ame. Fraxinus nig. Fraxinus pen. Populus bal. Populus gra. Populus tre. Populus tri. Quercus spp. Salix spp.

# Appendix E: Disturbance Matrix Examples

```{r example-DM-tables, echo=FALSE}
DMTables(ecozone = "BP", SeverityClass = "Low")
DMTables(ecozone = "BP", SeverityClass = "Mod")
DMTables(ecozone = "BP", SeverityClass = "High")
DMTables(ecozone = "TSE", SeverityClass = "High")
```

# Appendix F: Representative photos

```{r Appendix-D-photos-load, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

image_files <- dir("~/nrcan-cfs-fire/FireDMs/Photos/", full.names = TRUE) 

exifinfo <- exif_read(image_files)

exifinfo$panel <-  c("A", "B", "C", "D", "E", "F") 

exifinfo$Description <-  c("", "", "", "", "", "")  

exifinfo$Description[1] <- c("Partial area-wise burning of thin litter and duff layer in a boreal pine-aspen mixedwood stand following surface fire, one year after fire.  Note low consumption of woody debris and snags.")   

exifinfo$Description[2] <- c("Continuous crown fire in a forested boreal peatland dominated by black spruce.  90% of the forest floor experienced approximately 10 cm of burning except small patches of Sphagnum moss that appear as unburned light coloured features.  Note low consumption of downed woody debris embedded in unburned peat in bottom right corner")     

exifinfo$Description[3] <- c("Example of high rates of relative duff consumption in a low pre-fire duff (AGSlow) loading.  Note the low rates of woody debris and stump consumption in this jack pine-dominated stand.")       

exifinfo$Description[4] <- c("Preferrential mortality of understory trees in a low-severity surface fire, one year after the fire.  Larger diameter trees in the background remain alive with near-zero Crown Fraction Burned, while smaller diameter trees, many of which are <5 m in height visible in the foreground, were killed by the fire but with no canopy fuel consumption even of smaller trees.")       
exifinfo$Description[5] <- c("Patchy crown fuel consumption in a high severity fire, one year after the fire.  While the majority of canopy fuels were consumed in this photo, local landscape features such as this depression allowed for small patches of trees to be killed by a surface fire, but the canopy remained unconsumed.  These red needles remain on the tree for 1-2 years and afterwards are an input into the litter layer.")        

exifinfo$Description[6] <- c("Example of consumption of broadleaf foliage during high severity fire in mixedwood fuels, taken one week after the fire.  Note the lack of foliage in the aspen trees (white coloured stems in background) in a mixedwood with Engelmann spruce and subalpine fir.")   ##fields to potentially add: ecozone=c(),BUI=c(),dNBR=c(),Severity=c(),Lat=c(),Lon=c(),DateOfBurn=c(),DateOfPhoto=c(),FFFC_frac_mod=c(),Leading_spp=c()) 

q<-1

```

```{r Appendix-D-knitr-png-1, echo=FALSE, fig.cap=exifinfo$Description[q], out.width="75%"}


knitr::include_graphics(exifinfo$SourceFile[q]) 
q <- q+1
```

```{r Appendix-D-knitr-png-2, echo=FALSE, fig.cap=exifinfo$Description[q],out.extra='angle=-90', out.width="75%"}

knitr::include_graphics(exifinfo$SourceFile[q]) 
q <- q+1
```

```{r Appendix-D-knitr-png-3, echo=FALSE, fig.cap=exifinfo$Description[q], out.width="75%"}

knitr::include_graphics(exifinfo$SourceFile[q]) 
q <- q+1
```

```{r Appendix-D-knitr-png-4, echo=FALSE, fig.cap=exifinfo$Description[q], out.width="75%"}

knitr::include_graphics(exifinfo$SourceFile[q]) 
q <- q+1
```

```{r Appendix-D-knitr-png-5, echo=FALSE, fig.cap=exifinfo$Description[q], out.width="75%"}

knitr::include_graphics(exifinfo$SourceFile[q]) 
q <- q+1
```

```{r Appendix-D-knitr-png-6, echo=FALSE, fig.cap=exifinfo$Description[q], out.width="75%"}

knitr::include_graphics(exifinfo$SourceFile[q]) 
q <- q+1

```

# References
