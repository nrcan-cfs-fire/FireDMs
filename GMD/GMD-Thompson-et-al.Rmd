---
title: "Incorporating fire severity for refined data-drive carbon emissions estimates of boreal and temperate forest fires in the Carbon Budget Model for Canadian forests"
journal: "`r rticles::copernicus_journal_abbreviations(journal_name = 'gmd')`"

author:
  - given_name: Dan K.
    surname: Thompson
    affiliation: 1
    email: daniel.thompson@nrcan-rncan.gc.ca
    corresponding: true
  - given_name: Ellen
    surname: Whitman
    affiliation: 2
    email: ellen.whitman@nrcan-rncan.gc.ca
  - given_name: Hafer
    surname: Mark
    affiliation: 3
    email: mark.hafer@nrcan-rncan.gc.ca
  - given_name: Oleksandra
    surname: Hararuk
    affiliation: 2
    email: oleksandra.hararuk@nrcan-rncan.gc.ca
  - given_name: Chelene
    surname: Hanes
    affiliation: 1
    email: chelene.hanes@nrcan-rncan.gc.ca
  - given_name: Vinicius
    surname: Manvailer Goncalves
    affiliation: 3
    email: vinicius.manvailergoncalves@nrcan-rncan.gc.ca
  - given_name: Ben
    surname: Hudson
    affiliation: 3
    email: benjamin.hudson@nrcan-rncan.gc.ca
affiliation:
  - code: 1
    address: Natural Resources Canada, Canadian Forest Service, Great Lakes Forestry Centre, Sault Ste. Marie, Canada
  - code: 2
    address: Natural Resources Canada, Canadian Forest Service, Northern Forestry Centre, Edmonton, Canada
  - code: 3
    address: Natural Resources Canada, Canadian Forest Service, Pacific Forestry Centre, Victoria, Canada
output:
  rticles::copernicus_article:
    highlight: null
    keep_tex: true
  pdf_document: default
  bookdown::pdf_book:
    base_format: rticles::copernicus_article
  word_document: null
abstract: "Wildfire is the most impactful natural disturbance to Canada's boreal and  temperate forest biomes.  Current representations of fire impact on forest carbon  stocks is limited to a single parameterization of fire severity (i.e. the fraction  of biomass consumed) that assumes only high severity fires, despite a large and  increasing evidence base of widespread mixed-severity wildfire.  In this submodel  of the larger Generic Carbon Budget Model for forest carbon accounting, field measurements  of biomass consumption as related to satellite-derived burn severity maps are interpretted  from a fire physics and ecology perspective to derive algorithms to describe forest  carbon fluxes in the immediate aftermath of fires.  Model outputs indicate total  carbon emissions range from a 11 t C/ha in Boreal Shield West forests of Saskatchewan following low severity fire to over 70 t C/ha in Taiga Cordillera and Pacific Maritime  forests of Yukon under high severity fire. Shifting from a low drought condition, low-severity burn to a high drought condition, high severity burn typically doubles total carbon emissions.  Pacific Maritime forest showed the largest  fraction of carbon release in the canopy biomass pools (67%), while Taiga Shield  West and Boreal Plains of the Northwest Territories and Manitoba were estimated  of having 82% of carbon emissions in the surface and organic soil biomass pools of  litter, duff, and roots. Comparisons against direct fire plume emissions ratios as well as against annualized carbon emissions for 2023 from total atmospheric column excess CO concentrations showed good model agreement with observations."
bibliography: references.bib
running:
  title: Fire Severity and Canadian Forest Carbon Budget Models
  author: Thompson et al.
competinginterests: The authors declare no competing interests.
copyrightstatement: His Majesty the King in Right of Canada as represented by the  Minister of Natural Resources Canada. This work is distributed under the Creative  Commons Attribution 4.0 License.
availability:
  codedata: "This article was produced from an RMarkdown document with underlying data, available at https://github.com/nrcan-cfs-fire/FireDMs"
authorcontribution: 
disclaimer: "The algorithm and results presented only apply to boreal and temperate  forest ecosystems where sufficient ground plots of fire severity are available. As a data-driven model, this framework is not suitable for other ecosystems nor  agricultural or forestry biomass burning practices."
acknowledgements: 
appendix:
always_allow_html: true
editor_options:
  chunk_output_type: console
---

# Introduction

Wildfire is on par with insects as the largest stand-replacing disturbance process in Canada's forest, impacting \~1-3 Mha of Canada's 355 Mha forested area in a typical year [@hanes2019]. In Canada's reliable 53-year burned area record, nine years have exceeded 4 Mha of burned area (or approximately 1% of Canada's forest area) [@skakun2022]. The 2023 fire season in Canada burned a remarkable 15 Mha owing to extreme drought, severe fire weather conditions, and a prolonged fire season length [@jain2024].

Of this, publicly-owned managed forest under long or short-term tenure accounts for 23% of the area burned between 1972 and 2024; publicly-owned managed forest under long-term licence to private timber companies forms 40% of Canada's forest area [@stinson2019]. Privately-owned forest constitutes only 6% of the forest area, but only 0.5% of area burned. The remainder of the forest area burned in Canada being a mix of formally protected areas, remote unmanaged forest, Indigenous reserve lands and other uses without large-scale harvesting. Managed northern forest areas adjacent to communities have historically shown some meaningful local fire suppression effects with a bias towards older forest nearby boreal forest communities in Canada, though the effect is largely limited to a 25 km radius between these widely dispersed communities [@parisien2020].  More southern boreal forest with extensive suppression activities has historically seen evidence of a reduction in observed vs potential area burned [@cummingEffectiveFireSuppression2005] though this effect has likely been erased given the increasing frequency of extreme burning conditions [@wangCriticalFireWeather2023] and corresponding record area burned [@jain2024].

Burned area in Canada is dominated by a relatively small number of very large fires, with 3% of fires constituting 97% of the burned area [@stocks2002]. Lightning-caused fires account for approximately half of all ignitions and approximately 80% of burned area, but no distinction is made between human and lightning ignition for carbon accounting purposes. Annual burned area mapping for carbon reporting in Canada is conducted using a composite of satellite and aerial mapping at 30 metre resolution; the relatively small number of large fires, and their slow vegetation regeneration [@white2017] allows for reliable mapping using multi-spectral imagery such as Landsat within one year of the fire [@whitman2018].

[2 sentences on CBM-CFS3 and simple stuff about it]..[also about emissions reporting and accounting in managed vs unmanaged forest]... In CBM-CFS, spatially referenced stand lists representing large homogenous stands that fall within spatial units (ecozone-provincial intersections) [@kurz2002], even when applying precisely mapped burned areas [@hall2020]. CBM-CFS currently assesses fire impacts to carbon pools only as representing high-severity fire, which is the most common of three severity classes of burned forest in Canada [@hall2008]. Currently, biomass consumption estimates are based on the and the assumption of complete crown mortality, with additional biomass consumption following a spatially-referenced aggregated estimate at the ecozone-province of annualized drought conditions. Quantification of the change in carbon stock in CBM is made via a "Disturbance Matrix" (hereafter referred to as a DM) which is simply a matrix of the proportional mass flux of carbon between each pair of pools in the model for a site experiencing a given disturbance. This proportional mass flux is independent of the size of the C pool. Pools in the DM include all the above and below-ground pools tracked in CBM, as well as an atmospheric sink pool. Importantly, unlike an emissions-only fire models commonly used in air quality modelling in Canada [@chen2019], DM definitions in CBM also track the transfer of live biomass to dead, but still uncombusted pools such as the transfer from live stemwood pools (which are killed but not burned) to standing deadwood, also known as snags.

In Canada's forests, a combination of disturbance history, soils, and less frequently topographic variables determine leading tree species; at local scales (1-100 ha), tree species plays a major role in determining ecosystem susceptibility to fire [@bernier2016] where older, conifer-dominated forests burn at very high rates relative to adjacent deciduous or mixed stands. Even when deciduous and mixed forests do burn, they do so at consistently lower severity compared to all but the most xeric conifer forests [@whitman2018]. Thus, important local biases in fire activity towards older and moderate to poorly-drained forests are not resolved in the spatially-referenced CBM-CFS3 when only a regionally-averaged fire severity is applied.

To support recent advances in operational burn severity mapping for Canada [@whitman2020] alongside multi-decade reliable burned area records that provide certainty on fire start and end dates [@hall2020], this paper describes a local scale (30-m) method for defining a per-pixel proportional carbon flux measurement via a locally calculated fire DM. In this document, we outline the evidence-based fire Disturbance Matrices updated and designed for a spatially-explicit update to the CBM, anchored in a three severity class paradigm. These fire carbon flux models are built from a blend of aggregated field data linked to remotely sensed severity, as well as insights from fire physics and experimental fires. Key knowledge gaps are also highlighted, with interim solutions presented until further quantification can be done in field studies, such as from further wildfire observations, experimental fires, or prescribed fires.

Simplified fire DMs (i.e. a scalar reduction on 100% mortality assumption) have been used in valuable scenario exercises using CBM for assessment of future fire and harvest scenarios [@smyth2022]; the algorithm development shown here provides an important data-driven and regionally-adjusted framework that better reflects the ecological nuances of moderate and low-severity fire across Canada's diverse ecozones.

# Methods

```{r loadLibsEtc, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(dplyr, warn.conflicts = FALSE)
library(kableExtra)
library(tinytex)
library(formatR)
library(data.table)
library(directlabels)
library(ggrepel)
library(gtools)
library(rticles)
library(mgcv)
library(gslnls)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
library(minpack.lm)
library(terra)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

options(dplyr.summarise.inform = FALSE)

#original list
#ecozones.list <- list("AM","TP","TSW","BSW","BP","P","TC","BC","PM","MC","HP","TSE","BSE")

#complete list, ordered by decreasing CNFDB burned area:
#ecozones.list <- list("BSW","TP","TSW","BP","BC","BSE","TSE","MC","HP","TC","PM","SuP","SeP","AM","MP")

##working list as of 2023-04-13 that has all the data we need, no MP, no P
ecozones.list <- list("BSW","TP","TSW","BP","BC","BSE","TSE","MC","HP","TC","PM","AM","MP")
```

## Carbon Modelling

## Carbon Modelling Spatial Units

```{r RU-map, echo=FALSE, message=FALSE, warning=FALSE}

#### queue up data for figure 1:
### map of ecozones and plot locations using ggplot
### https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html
##gml link for ecozones is here:http://www.agr.gc.ca/atlas/data_donnees/bio/aafcEcostratification/gml/ECOZONE_V2_2_GML.zip
###WFS for ecozones is here: http://ecozones.ca/english/services.html
### using WFS in ggplot is here: https://inbo.github.io/tutorials/tutorials/spatial_wfs_services/

##read ecozones map from local dir:


ReportingUnits <- st_read("~/nrcan-cfs-fire/FireDMs/NationalReportingUnits.gpkg", quiet = TRUE)

ecozones_used <- st_read("~/nrcan-cfs-fire/FireDMs/ecozones_used_3978.gml",quiet=TRUE)
st_crs(ecozones_used) <- 3978

###add in a column with short-name of ecozones?
### or sub out number with TSW etc
### example here:https://stackoverflow.com/questions/63563285/extract-coordinates-of-polygon-centroids-and-label-them-by-polygon-number
#(st_centroid(ecozones_sf3978))

Canada <- ne_countries(scale = "medium", returnclass = "sf", country = "Canada")
##also load big lakes in Canada

###download option, but annoying loading message that's hard to suppress:
#lakes50 <- ne_download(scale = 50, type = 'lakes', category = 'physical', returnclass = "sf")
###use local copy: 
lakes50 <- st_read("~/nrcan-cfs-fire/FireDMs/ne_50m_lakes.gml", quiet = TRUE)
st_crs(lakes50) <- 4326
### convert this to gml and keep in github repo
### permalink?: https://github.com/nvkelso/natural-earth-vector/blob/master/50m_physical/ne_50m_lakes.shp

st_crs(Canada) <- 4326

### this is buggy - why??? lakes50 is WGS84
lakes50_crop <- st_intersection(lakes50, Canada)

lakesCanada_3978 <- sf::st_transform(lakes50_crop, 3978)
Canada_3978 <- sf::st_transform(Canada, 3978)



```

```{r Fig1-RU-ecozones, eval=FALSE, fig.cap=paste("Locations of NDVI time series data plots."), message=FALSE, warning=FALSE, include=FALSE}
ReportingUnits <- ReportingUnits %>% filter(eco_name != "arctic cordillera") %>% filter(eco_name != "northern arctic") %>% filter(eco_name != "southern arctic")

ecozones_colours <- c("#a6cee3","#1f78b4","#fb9a99","#33a02c","#b2df8a","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928","#7d8b8f", "#c1c1c1","brown")

ggplot(data = Canada_3978) +
    geom_sf(colour="black")+ theme_bw()+geom_sf(data=ReportingUnits,aes(fill=factor(eco_name))) + geom_sf(data = lakesCanada_3978,colour="black",fill="white") + theme(legend.position = "none") + geom_sf_label(data=ReportingUnits,nudge_y = c(0,0,0,0,250000,0,0,-100000,0,0,+100000),size=2.5,label.padding = unit(0.15, "lines"),aes(label = factor(unit_id)))  + geom_sf_label(data=ecozones_used,nudge_y = c(0,0,0,0,250000,0,0,-100000,0,0,+100000),size=2.5,label.padding = unit(0.15, "lines"),aes(label = factor(ECOZONE))) + scale_fill_manual(values=ecozones_colours)+ylab("")+xlab("")# + ggrepel::geom_label_repel(data=ecozones_used, aes(label = ECOZONE, geometry = geometry), stat = "sf_coordinates", min.segment.length = 0,label.size = NA) 
```

## Biomass pools of the Generic Carbon Budget Model

Short section explaining the pool definitions most relevant to fire.

## Axioms of forest carbon budget after fire

To simplify the process of the creation of the DMs as a distillation of the complexities of fire severity and combustion patterns, the following logical axioms are proposed and maintained throughout:

1.  Disturbance matrices are to be in terms of mortality, not survival. Mortality here is defined as tree death by the end of the calendar year of the fire's occurrence. Tree mortality in subsequent years is not modelled here.

2.  Crown Fraction Burned (CFB) is a mass-based estimate of the portion of foliage consumed in the flaming passage of a fire, and is inclusive of merchantable and submerchantable trees, both broadleaf and needleleaf. Needles that are heat-killed but otherwise not consumed in the fire are not considered part of CFB, and are instead considered part of the foliage to litter biomass transfer.

3.  The heat-killed but unconsumed fraction of the canopy is equal to (mortality - CFB).

4.  In submerchantable trees, mortality == CFB.

5.  In merchantable trees, CFB \<= mortality.

6.  Snags are inclusive of both those killed by prior fire as well as those killed by all other causes.

Of these, Crown Fraction Burned (CFB) is an important concept used primarily in fire behaviour science but not carbon accounting nor fire ecology. CFB was introduced in the 1992 Fire Behaviour Prediction System documentation [@forestrycanadafiredangerratinggroup1992], and provides a simple continuous 0-100 variable for only the consumption of foliage (inclusive of both conifer and broadleaf). For our purposes, CFB is the desirable metric as opposed to ordinal and less precise systems like Canopy Fire Severity Index [@kasischke2000] that allows the user to specify which pools of canopy biomass are consumed, but not the precise fraction of each given pool that is consumed.

## Ground plot and remotely sensed fire severity data

!!!Ellen to insert methods here - including the figure of where the samples are from etc.

```{r Fig2-CBI-ecozones-map, eval=FALSE, fig.cap=paste("Locations of NDVI time series data plots."), message=FALSE, warning=FALSE, include=FALSE}

#align with map colour scheme with others

### insert png from Ellen


```

## Combustion gas emission ratios

Certain variables, like the partitioning of CO~2~:CH~4~:CO gas emissions, are constant throughout ecozones, but vary by flaming vs smouldering combustion modes. The precise emissions ratios vary slightly between models and field studies, but for this initial algorithm assessment, we define these emissions ratios as being identical to those used in Canada's operational wildfire smoke forecasting system, FireWork [@chen2019]. They are defined in a global variables table:

```{r defineVars, echo=FALSE, message=FALSE, warning=FALSE}



CarbonEFs <- read.csv("~/nrcan-cfs-fire/FireDMs/GMD/CarbonCalculator.csv")

CarbonEFs_pivot_wider <- CarbonEFs[,1:3] %>% pivot_wider(names_from = Phase, values_from = Value)

global.vars <- CarbonEFs$Value

#then label names using updated "atmosphere sink" pools as they say, which is to say, carbon-focused EFs as fraction of 
names(global.vars) <- array(as.character(CarbonEFs$VarName))


### convert to list for easier referencing later down
global.vars <- as.list(global.vars)

##load Ellen's data (InterimValue==False)
VarDefs <- read.csv("~/nrcan-cfs-fire/FireDMs/FireDMTableDefs.csv")

VarDefs$SeverityClass <- factor(VarDefs$SeverityClass,levels = c("Low", "Mod", "High"))


```

```{r globalVarsEmissions, echo=FALSE, message=FALSE, warning=FALSE}
kbl(CarbonEFs_pivot_wider, caption = "Emissions factors in flaming and smouldering phase, expressed as portion of unburned biomass carbon content") %>%
  kable_minimal()  #%>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

where CO~2~ is responsible for `r as.numeric(global.vars$FlamingCO2)*100`% of emissions in the flaming phase, but only `r as.numeric(global.vars$SmoulderingCO2)*100`% of emissions in the smouldering phase, with a doubling of CO emissions and tripling of CH~4~ emissions. With a Global Warming Potential of CO equal to 1.9 and CH~4~ of 25, the Global Warming Potential per unit of biomass consumption in the smouldering phase is `r round(((as.numeric(global.vars$SmoulderingCO2*1+global.vars$SmoulderingCH4*25+global.vars$SmoulderingCO*1.9))/(as.numeric(global.vars$FlamingCO2*1+global.vars$FlamingCH4*25+global.vars$FlamingCO*1.9))),2)` times higher in global warming potential compared to flaming, not including differential aerosol production and injection heights, however. With flaming and smouldering each contributing roughly equally to wildfire emissions, these distinct flaming and smouldering emissions ratios correspond well prior emissions factors used in CBM. Note that as current described, the sum of CO~2~, CH~4~, and CO emissions from wildfires only represent approximately 95% of the fire carbon mass emitted to the atmosphere, with 0.5-2.0% of biomass emitted as particulate matter (e.g. PM2.5, but also PM1 and PM10 classes of particulates at 1 and 10 um diameters, respectively), and an additional 3% [@hayden2022] to as little as 1% [@simon2010] composed of non-methane organic gases that have a large range in global warming potentials as compared to CH~4~.

## Litter layer area-wise consumption by severity class

The litter layer forms the first biomass pool in which a spreading fire consumes fuel. In low-severity fires, the litter layer may be consumed little to no underlying duff material consumed, nor any tree mortality [@hessburg2019]. Logically, since litter consumption is largely required for the ignition of the underlying duff layer, this litter area-wise fractional consumption also informs and constrains duff consumption.

```{r UnBurnedForestFloorByEcozone, echo=FALSE, message=FALSE, warning=FALSE}

##load Ellen's data (InterimValue==False)


#subset to just the variable of interest:



VarDefs.Unburned.Litter <- VarDefs[VarDefs$Variable.Name == "Unburned.litter.area",]



VarDefs.dt <- as.data.table(VarDefs.Unburned.Litter)

Unburned.Litter.wide <- dcast(VarDefs.dt,Ecozone~SeverityClass,value.var = "Value")

###then re-order the Ecozone factor (via https://stackoverflow.com/a/46130642)

Unburned.Litter.wide <- Unburned.Litter.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(Unburned.Litter.wide, caption = "Unburned litter area by ecozone and severity class.  The majority of the data comes from studies in the Boreal Plains and Boreal Shield West, and so values are extrapolated from those two well-observed ecozones to all others.") %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

## Forest Floor Consumption

While consumption of fine fuels in the litter layer of the forest floor is nearly complete for any given fire intensity, consumption of deeper organic soil horizons (F+H layers in upland forests and upper peat layers in wetlands) is more drought dependent. In the fire literature in Canada, the soil organic layer is sometimes termed the Forest Floor Fuel Load (*FFFL*) [@letang2012] and is dominated by the equivalent organic soil Slow pool (Aboveground Slow Dead Organic Matter, or AGSlowDOM) in CBM. Typically attention has been paid to the absolute value of Forest Floor Fuel Consumption (*FFFC*); however in the case of carbon modelling, it is the relative fraction of consumption (*FFFC/FFFL*) that is of interest. In this scheme, we utilize a composite of wildfire data from [@degroot2009] alongside the ABoVE duff consumption data [@walker2020], with an alternative modelling approach to compute the relative amount of depth of consumption (scalar from 0 to 1) rather than an absolute value in kg m^-2^ or cm as otherwise done in the literature. A logit transform is used on the scalar data to make it suitable for the fitted non-linear least-squares modelling:

```{=tex}
\begin{equation}
logit \left( \frac{FFFC}{FFFL}\right) = [3.91(1 - e^{(-0.008BUI)})] + (-0.53log_{e}(AGSlow))
\end{equation}
```
where BUI is the Fire Weather Index System's Buildup Index, and AGSlow in the CBM (given in Mg C/ha in this equation), and also synonymous with the the Forest Floor Fuel Load (with ecozone averages given in [@letang2012] or site-level data where observed). 

While ultimately this scheme can used on individual fires with estimated or measured fuel loading and specific BUI values, as an example, an ecozone-averaged fuel load and a multi-year average of BUI during active fire satellite detection can also be used to provide representative values. Specifically, a median BUI of detected fire hotspots in Canada from 2003-2021 [@barber2024] using the same data as the Canadian CFEEPS-FireWork wildfire air quality model of [@chen2019] is presented below, along with proportional consumption values of the forest floor by ecozone:

```{r new-ABoVE-FFFC-data, message=FALSE, warning=FALSE, include=FALSE}

######### ABoVE combustion compilation:

ABoVE_Data <- read.csv("~/nrcan-cfs-fire/FireDMs/AK_CA_Burned_Plot_Data_1983_2016.csv")



### from https://daac.ornl.gov/cgi-bin/dsviewer.pl?ds_id=1744
## DOI: 10.3334/ORNLDAAC/1744



### prop_sol_combusted is the % depth of combustion, so do that first
## step 1: convert a few values that are slightly higher than 1.0 to exactly 0.99
ABoVE_Data$prop_sol_combusted_logit <- ifelse(ABoVE_Data$prop_sol_combusted>1,0.99,ABoVE_Data$prop_sol_combusted)

### convert the data frame NA values of -9999 to R NA
ABoVE_Data$prop_sol_combusted_logit <- ifelse(ABoVE_Data$prop_sol_combusted_logit<0,NA,ABoVE_Data$prop_sol_combusted_logit)

#ABoVE_Data <- ifelse(ABoVE_Data<0,NA,ABoVE_Data)

ABoVE_Data$prop_sol_combusted_logit <- logit(ABoVE_Data$prop_sol_combusted_logit, min = 0.00001, max = 1.01)



### "prop_sol_c_combusted" is the other relevant response variable here.  and is the equivalent to the FFFC fractional consumption metric used in the analysis of de Groot's data

## step 1: convert a few values that are slightly higher than 1.0 to exactly 0.99
ABoVE_Data$prop_sol_c_combusted_logit <- ifelse(ABoVE_Data$prop_sol_c_combusted>1,NA,ABoVE_Data$prop_sol_c_combusted)

### convert the data frame NA values of -9999 to R NA
ABoVE_Data$prop_sol_c_combusted_logit <- ifelse(ABoVE_Data$prop_sol_c_combusted_logit<=0.01,NA,ABoVE_Data$prop_sol_c_combusted_logit)

#ABoVE_Data <- ifelse(ABoVE_Data<0,NA,ABoVE_Data)

ABoVE_Data$prop_sol_c_combusted_logit <- logit(ABoVE_Data$prop_sol_c_combusted_logit, min = 0.00001, max = 0.999)

ABoVE_Data$prop_sol_c_combusted_logit[is.infinite(ABoVE_Data$prop_sol_c_combusted_logit)] <- NA
ABoVE_Data$prop_sol_c_combusted_logit[is.nan(ABoVE_Data$prop_sol_c_combusted_logit)] <- NA



##########################
###load up De Groot data ####
##########################
FFFC_Data <- read.csv("~/nrcan-cfs-fire/FireDMs/FFFC_Data.csv")

#### convert fractional FFFL consumption to fraction of depth consumed by the inverse of the Correction Factor equation
FFFC_Data$Frac_load_consump <- ifelse(FFFC_Data$Frac_load_consump>1,1,FFFC_Data$Frac_load_consump*((0.981)*FFFC_Data$Frac_load_consump^(-0.251)))


#FFFC_Data$Frac_load_consump <- ifelse(FFFC_Data$Frac_load_consump>1,1,FFFC_Data$Frac_load_consump)
FFFC_Data$Frac_load_consump_logit <- logit(FFFC_Data$Frac_load_consump, min = 0.00001, max = 1.01)

### convert FFFC_Data into the same column names as ABoVE:
FFFC_Data <- rename(FFFC_Data, drought_code = DC)
FFFC_Data <- rename(FFFC_Data, buildup_index = BUI)
FFFC_Data <- rename(FFFC_Data, prop_sol_c_combusted = Frac_load_consump)
FFFC_Data <- rename(FFFC_Data, prop_sol_c_combusted_logit = Frac_load_consump_logit)
FFFC_Data <- mutate(FFFC_Data, bg_c_prefire = Load*500) # the ABoVE data is in g C/m2 and the FFFC Load is in kg biomass/m2 so multiply Load by 500 to get gC/m2


## grab only the sites not in the ABoVE data (so GL is already there)
## don't take "Dawson City", "Green Lk", or "WBNP" from the FFFC data frame, 94 obs left
FFFC_Data_trimmed <- FFFC_Data %>% filter(Site != "Dawson City") %>% filter(Site != "Green Lk") %>% filter(Site != "WBNP") %>% filter(FireType == "Wild")

## assign ecoregion to those sites we are adding
FFFC_Data_trimmed <- FFFC_Data_trimmed %>%
  mutate(
  ecozone = case_when(
      Site == "Burntwood R" ~ "BSW",
      Site == "Darwin Lk" ~ "TSW",
      Site == "Hondo" ~ "BP",
      Site == "ICFME" ~ "TP",
      Site == "Kasabonika" ~ "BSW",
      Site == "Kenshoe" ~ "BSE",
      Site == "Mtl Lk" ~ "BP",
      Site == "Porter Lake" ~ "TSW",
      Site == "Sharpsand" ~ "BSE",
      Site == "Thompson" ~ "BSW",
      .default = "other"
    )
  )

##then convert the provided ABoVE NA Level II Ecoregions into Canadian Ecozones

### delete any NA rows here so nls doesn't have to handle them at all
ABoVE_Data <- ABoVE_Data %>% drop_na(prop_sol_c_combusted) %>% filter(drought_code > 0) %>% filter(bg_c_prefire>0) %>% filter(ecoregion_name_l2!="Alaska Boreal Interior")#  %>%  filter(ag_c_prefire>0) %>% filter(prop_black_spruce>0) %>% filter(longitude>-140)

hist(ABoVE_Data$prefire_sol)

ABoVE_Data <- ABoVE_Data %>%
  mutate(
  ecozone = case_when(
      ecoregion_name_l2 == "Boreal Cordillera" ~ "BC",
      ecoregion_name_l2 == "Softwood Shield" ~ "BSW",
      ecoregion_name_l2 == "Taiga Plains" ~ "TP",
      ecoregion_name_l2 == "Taiga Shield" ~ "TSW",
      ecoregion_name_l2 == "Boreal Plains" ~ "BP",
      .default = "other"
    )
  )

### add data, and convert the ABoVE data from gC/m2 and de Groot data in kg biomass/m2 to both in Mg C/ha (CBM units)
ABoVE_Data_w_FBP <- bind_rows(ABoVE_Data,FFFC_Data_trimmed) %>% mutate(SFL.kg.m2 = bg_c_prefire/500) %>% mutate(AGSlow.Mg.C.ha = SFL.kg.m2*5)




#hist(log(ABoVE_Data_w_FBP_excl_BC$bg_c_prefire))

#####################################################
###filter out NA data and other filters of relevance ###
####################################################


#########################################
### GAM to examine ecozones
#######################################


# hist(ABoVE_Data$prop_sol_combusted_logit) #looks good and now normally distributed

FFFC.Frac.Consume.gam.ABoVE<-gam(prop_sol_c_combusted_logit ~ s(buildup_index,k=4,bs="tp")+ecozone+s(AGSlow.Mg.C.ha,k=4,bs="tp"), data = ABoVE_Data_w_FBP,method="REML", na.action=na.exclude)
summary(FFFC.Frac.Consume.gam.ABoVE)
plot.gam(FFFC.Frac.Consume.gam.ABoVE)

######################
### end GAM
#####################




##can compute this if needed, but isn't exactly Crown Fraction Burned or anything exciting like that
#ABoVE_Data_w_FBP <- ABoVE_Data_w_FBP %>% mutate(ag_frac_burn = ag_biomass_combusted/ag_biomass_prefire)


##getting an r2 (via simple correlation) of 0.49 using just (DC^a)*(load^b)+c, not bad!
#ABoVE.FFFC.Frac.Consume.gsl.nls <- gsl_nls(
  #fn = prop_sol_combusted_logit ~ (drought_code^a)*(bg_c_prefire^b)+c,
  #fn = prop_sol_combusted_logit ~ (1-exp(a*(drought_code)))*(bg_c_prefire*b)+c, ### this one works quite well
  #fn = prop_sol_combusted_logit ~ (1-exp(a*(drought_code)))*(log(bg_c_prefire)*b)+c, ### works but with no drought effect
  #fn = prop_sol_combusted_logit ~ c*(1-exp(a*(drought_code)))^(bg_c_prefire*b), ### sorta like FBP consumption, but doesn't 
 # fn = prop_sol_combusted_logit ~ c*(1-exp(a*drought_code))+(log(SFL.kg.m2)*b), ### explore this one a bit more
  #fn = prop_sol_combusted_logit ~ c*(1-exp(a*drought_code))^(log(bg_c_prefire)*b), ### doesn't converge, but is most true to the old FBP consumption equations with a dynamic second exponent
  #data = ABoVE_Data_w_FBP,
  #start = list(a = -0.21, b = -0.71,c=0.01),
#  algorithm = "lm",
 # control = list(scale = "levenberg")
#)

#########################
### trying the same nls, but using the minpack-LM fitter, since it supports prescribed bounds on nls parameters

#https://www.rdocumentation.org/packages/minpack.lm/versions/1.2-4
#install.packages('minpack.lm')



ABoVE_Data_w_FBP_excl_BC <- ABoVE_Data_w_FBP %>% filter(ecozone != "BC")
ABoVE_Data_w_FBP_only_BC <- ABoVE_Data_w_FBP %>% filter(ecozone == "BC")


### model no longer selected, using DC only
#ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC <- nlsLM(
 #formula = prop_sol_c_combusted_logit ~ c*(1-exp(a*drought_code))+(log(AGSlow.Mg.C.ha)*b),
  #data = ABoVE_Data_w_FBP_excl_BC,
  #start = list(a = -0.021, b = -0.71,c=1),
  #lower = c(a=-0.01,b=-Inf,c=-Inf)
  #)


##!!! NB this is the selected model
ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI <- nlsLM(
  formula = prop_sol_c_combusted_logit ~ c*(1-exp(a*buildup_index))+(log(AGSlow.Mg.C.ha)*b),
  data = ABoVE_Data_w_FBP_excl_BC,
  start = list(a = -0.0021, b = -0.71,c=3),
  lower = c(a=-0.008,b=-Inf,c=-Inf)
  )

summary(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)

 ### r2~0.78, MPE~26% unbound #note that the hinge to zero relies on the ln of large numbers, and that using the log of kg m2 of Surface Fuel Load as per FBP leave the DC/BUI == 0 values of SFC consumption as non-zero, but using

 ## constraint is ~ -0.005 for DC, ~-0.04 for BUI to get half of max possible consumption at BUI 50 (as per FBP)

#### Boreal Cordillera just fitting a simple linear model for now
ABoVE.FFFC.Frac.Consume.gsl.nls.BC.only <- nlsLM(
  formula = prop_sol_combusted_logit ~ (a*drought_code)+(b*log(AGSlow.Mg.C.ha))+c, 
  data = ABoVE_Data_w_FBP_only_BC,
  start = list(a = -0.021, b = -0.71,c=1)
)


summary(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC)
summary(ABoVE.FFFC.Frac.Consume.gsl.nls.BC.only)

ggplot(data=ABoVE_Data_w_FBP_excl_BC, aes(drought_code,buildup_index))+geom_point(aes(size=prop_sol_c_combusted,colour=prop_sol_c_combusted))


### other candidates: 

 #fn = prop_sol_combusted_logit ~ (drought_code^a)*(bg_c_prefire^b)+c+(prop_black_spruce*d), ### only like a 4% improvement, but logical and sig increase in consumption with more black spruce, all else being equal
  #data = ABoVE_Data,
  #start = list(a = 0.71, b = 0.671,c=0,d=0.1),


nls.pred <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC,newdata=ABoVE_Data_w_FBP_excl_BC)))
colnames(nls.pred) <- c("nls.pred")
ABoVE_Data_w_FBP_excl_BC <- cbind(ABoVE_Data_w_FBP_excl_BC,nls.pred)

nls.pred.BUI <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI,newdata=ABoVE_Data_w_FBP_excl_BC)))
colnames(nls.pred.BUI) <- c("nls.pred.BUI")

ABoVE_Data_w_FBP_excl_BC <- cbind(ABoVE_Data_w_FBP_excl_BC,nls.pred.BUI)


#ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_combusted,nls.pred)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)


#ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_combusted,nls.pred.BUI)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)

#### but for soil C
#ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_c_combusted,nls.pred)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)

##this is the one to show, biomass and BUI

ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_c_combusted,nls.pred.BUI)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.5) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)







cor(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,ABoVE_Data_w_FBP_excl_BC$nls.pred)

##model selected:
cor(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,ABoVE_Data_w_FBP_excl_BC$nls.pred.BUI)





MAE.nls <- mean(abs(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted-ABoVE_Data_w_FBP_excl_BC$nls.pred.BUI),na.rm=TRUE)

MAE.nls/mean(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,na.rm=TRUE)


#MAE.nls <- mean(abs(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted-ABoVE_Data_w_FBP_excl_BC$nls.pred),na.rm=TRUE)

#MAE.nls/mean(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,na.rm=TRUE)

#MAE.nls <- mean(abs(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted-ABoVE_Data_w_FBP_excl_BC$nls.pred.BUI),na.rm=TRUE)

#MAE.nls/mean(ABoVE_Data_w_FBP_excl_BC$prop_sol_c_combusted,na.rm=TRUE)



##~40% error with the simple nls term for all wildfire data excluding Alaska Interior Boreal


############################
#### depth vs density correction factor
###########################

# data

CF <- read.csv("~/nrcan-cfs-fire/FireDMs/RelDepthVsCorrFact.csv")
CF.Spruce <- CF %>% filter(FuelType == "Spruce")
CF.non.Spruce <- CF %>% filter(FuelType == "NonSpruce")

### this is from de Groot et al 2009 Table 6 for C-2 fuels, the average bulk density by depth to 30 cm (n > 90 for depths < 15cm)

### this goes down to 30 cm, and the median pre-fire depth for the ABoVE data is 26cm, so a good representative fit.

### the C-2 fuel type is quite different, so fitting that by itself, then taking the C-3 data and calling it representative of all the others:

###fit form is simple exponential: y=b*exp(cx)

Depth.Correction.Factor.Spruce <- nlsLM( 
  formula = CorrectionFactor ~ b*RelativeDepth^c,
  data = CF.Spruce,
  start = list( b = 1,c=1)
  )

summary(Depth.Correction.Factor.Spruce)




Depth.Correction.Factor.non.Spruce <- nlsLM( 
  formula = CorrectionFactor ~ b*RelativeDepth+c,
  data = CF.non.Spruce,
  start = list(c = 1, b = 1)
  )

summary(Depth.Correction.Factor.non.Spruce)

##assuming constant carbon % (see table 5 for evidence), just computed the relative depth vs relative organic fuel load, and then computed the ratio of relative mass/relative depth at the depth intervals given in Table 6.  



##### end conversion factor#################

```

```{r DuffConsumpFunction, echo=FALSE, message=FALSE, warning=FALSE }

###Compute FFFC given any DC and duff load input (CalcFFFC)
# Written By: Dan Thompson
# Written On: 2024-09-19
# Parameters: Drought Code of interest (DC); Carbon pool amount of the Below Ground Slow pool (AGSlow) in Mega-grams of Carbon (12g/mol) per hectare of forest area.
# Modified on: 
# Modified by: 
# Purpose: for ecozones in Canada (not including Boreal Cordillera) this function estimates the !!relative consumption!! fraction (0-1) of the forest floor (aka duff), which corresponds to the AGSlow pool in the Carbon Budget Model for the Canadian Forest Sector (CBM-CFS)
# Description: model is derived analysis of ABoVE project which is a composite of ABoVE project data plus some de Groot data (https://daac.ornl.gov/cgi-bin/dsviewer.pl?ds_id=1744) also adding in a few eastern/central Canadian sites from (https://www.nrcresearchpress.com/doi/full/10.1139/x08-192).

# output: a single floating point from 0-1 that is the portion of the duff layer that is consumed given a DC and AGSlow pool input




### !! Note using the hard-coded parameters, unlike chunks above which derive the parameters, so this function can be used elsewhere


## CalcFFFC <- function(DC,PoolType,PoolSize) #alternate function that either accepts AGSlow or DuffLoad
BUI <- 70
AGSlow <- 60
CalcFFFC <- function(BUI=70,AGSlow=60,Spruce=TRUE)
{
CalcFFFC_param1 <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[3]
CalcFFFC_param2 <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[1]
CalcFFFC_param3 <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[2]

  ##apply the fitted nls logit model with parameters defined above:
  temp.logit <- CalcFFFC_param1 * (1 - exp(CalcFFFC_param2 * BUI)) + (log(AGSlow) * CalcFFFC_param3)
  
  ### and now compute the inverse logit of the model and apply a correction factor to convert fraction of mass (from line above) to fraction of depth, using standard duff density curves:
  
  #CF_non_spruce <- 0.13*inv.logit(temp.logit)+0.87
  #CF_spruce <- (1.02)*inv.logit(temp.logit)^(0.250)
  
  ### need if/else for spruce or not
  #CalcFFFC_return <- ifelse(Spruce==TRUE, inv.logit(temp.logit)*CF_spruce,inv.logit(temp.logit)*CF_non_spruce)
  CalcFFFC_return <- inv.logit(temp.logit)
  return(CalcFFFC_return)
}

#test the function:
#CalcFFFC(DC=250,AGSlow=25,Spruce=FALSE) ###this is the DMC standard 5kg/m2 of fuel loading at Petawawa as per Van Wagner 1987 FWI system description, gives you ~0.57

#CalcFFFC(DC=550,AGSlow=15,Spruce=TRUE) # similar to the origin area of the 2024 Jasper fire 

#CalcFFFC(DC=25,AGSlow=1200,Spruce=TRUE) ## very low values of DC above the highest value in the test dataset
###gives you close to zero as it should

#CalcFFFC(DC=290,AGSlow=(24*5),Spruce=TRUE) ##using just the acrotelm carbon stock and a well-known DC and fractional carbon loss in the acrotelm (Bona et al 2020 doi: 10.1016/j.ecolmodel.2020.109164, Table 4), you get ~0.30, which is too high compared to the observed ~0.12 fractional pool loss by fire



```

```{r computeFixed-DM-DuffConsump, echo=FALSE, message=FALSE, warning=FALSE}

#load an array of median DC values by ecozone (provided here hardcoded from Quinn Barber's dataframes of all Canadian hotspots from CWFIS 2002-2022):

Median.BUI <- c(39,79,72,58,67,54,59,60,60,112,52,35,40,40)
#Litter.Load <- 0.25 #litter load as an average from Thompson et al 2017, across a range of boreal forest sites, doi: 10.1139/cjfr-2016-0475

##load the AGSlow data:
NIR2023_AverageCPools <- read_csv("./NIR2023_AverageCPools.csv")

Duff.Load.kg.m2.all.ecozones <- NIR2023_AverageCPools %>% group_by(EcoBoundaryName) %>% summarise(Duff.Load.kg.m2 = mean(`Aboveground Slow DOM`)/5) ##5 being the 0.2x conversion from Mg C/ha to kg BM/m2, but will get custom %C of biomass soon

Duff.Load.kg.m2.NIR <- c(7.05,5.39,3.37,3.01,6.7,6.5,5.17,6.23,10.3,6.32,5.1,6.0,7.16,5.96)


# then the median forest floor load, minus an average litter value (provided here hardcoded from 10.1139/x2012-093):
##note this value is 30% higher than NIR2023, but using it for now since it forms the point data used for current efforts to map national duff thickness and load:
Ecozones.fffc   <- c("AM","TP","TSW","BSW","BP","P","TC","BC","PM","MC","HP","TSE","BSE","MP")
Duff.Load.kg.m2 <- c(7.5, 15.0, 2.2,  8.8,  9.8,9.8, 8.4,8.31,15.2,6.0, 7.9,  5.8,  10.9, 10.9) #gap filled here 



##raw data from Letang:Duff.Load.kg.m2 <- c(7.5, 15.0, 1.7,  8.8,  9.8,NA, NA,   8.31,15.2,6.0, 7.9,  NA,  10.9, NA)
### with NFI plot C content of organic matter (g C/kg DOM):
Letang.C.Adju.Duff.Load.kg.m2 <- c(7.5*(422/500), 15.0*(399/500), 2.2*(399/500),  8.8*(390/500),  9.8*(367/500),NA, NA,   8.31*(462/500),15.2*(446/500),6.0*(360/500), 7.9*(389/500),  NA,  10.9*(429/500), NA)
##note that TC, TSW, TSE should use NIR

##Letang numbers for FFFL but adjusted to the observed Carbon content of the AG Slow (aka duff) layer
Duff.Load.kg.m2 <- c(7.5*(422/500), 15.0*(399/500), 2.2*(399/500),  8.8*(390/500),  9.8*(367/500),9.8*(367/500), 8.4*(462/500),   8.31*(462/500),15.2*(446/500),6.0*(360/500), 7.9*(389/500),  5.8*(429/500),  10.9*(429/500), 10.9*(429/500))


Duff_summary <- bind_cols(Ecozones.fffc,as.numeric(Duff.Load.kg.m2),as.numeric(Duff.Load.kg.m2.NIR),as.numeric(Letang.C.Adju.Duff.Load.kg.m2))
colnames(Duff_summary) <- c("Ecozones.fffc","Duff.Load.kg.m2","Duff.Load.kg.m2.NIR","Letang.C.Adju.Duff.Load.kg.m2")
#ggplot(data=Duff_summary,aes(Letang.C.Adju.Duff.Load.kg.m2,Duff.Load.kg.m2.NIR,label = Ecozones.fffc))  +geom_text() + xlab("Letang and de Groot forest floor kg/m2 with C content adjusted by NFI") + xlim(0,16) +ylim(0,16) + geom_abline(aes(intercept=0,slope=1))

# from the NIR, but in the same order at the hard-coded above:


##conversion of Mg C/ha to kg biomass /m2
AGSlow.Mg.C.ha <- Duff.Load.kg.m2*5

###building the model for now from coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC)[1] in the chunk above



Duff.consump.frac.logit <- coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[3] * (1 - exp(coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[1] * Median.BUI)) + 
    (log(AGSlow.Mg.C.ha) * coef(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI)[2])


### calculate the inverse of the logit to get the duff consumption fraction, and apply the Correction Factor to convert from %depth to %mass

Duff.consump.frac <- inv.logit(Duff.consump.frac.logit)




#### should really call the coefficients from the nls, but here it is for now above hard-coded in there

Duff.consump.kg.m2 <- Duff.consump.frac * Duff.Load.kg.m2

# start creating a single list object to encapsulate all the modelling:
#where FFFC is "Forest Floor Fuel Consumption" a la de Groot's naming convention:

FFFC <- as.data.frame(cbind(Ecozones.fffc,Median.BUI,Duff.Load.kg.m2,round(Duff.consump.kg.m2,digits = 2),round(Duff.consump.frac,digits = 2)))
names(FFFC) <- c("Ecozone","Median.BUI.of.burning","Median.Duff.Load.kg.m2","Duff.consump.kg.m2","Duff.consump.frac")

##re-order data.frame by ecozones.list order
FFFC <- arrange(FFFC,factor(Ecozone, levels = as.matrix(ecozones.list)))

## for example:
#FFFC$Ecozone.name[1]

### and to query values:
#FFFC$Duff.consump.frac[FFFC$Ecozone == "BP"]




```

```{r DuffConsumpTable, echo=FALSE, message=FALSE, warning=FALSE }
kbl(FFFC, caption = "Fire Weather, fuel loading, and duff consumption values per ecozone.  Note that FFFL values \n are from Letang et al., (2012) and not directly from the Reporting Unit values provided in the National Inventory Report. \n Median Buildup Index of burning is from Barber et al., (2024).",col.names = c("Ecozone", "Median Buildup Index of Burning", "Median FFFL kg m-2", "FFFC kg m-2", "% consumption")) %>%
  kable_minimal()  #%>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

Note that the maximum upland Forest Floor Fuel Load is approximately 30 kg m-2 (150 Mg C/ha) [@letang2012]; higher values are typically seen only in peat ecosystems, where the above scheme is still valid, as approximately 33% of the data used to fit this model is for organic soil pool values over 30 kg m-2 (>150 Mg C/ha).  Fully 10% of the data used in the FFFC model is for sites with over 60 kg m-2 of organic soil.  Absolute consumption values are similar between deep forest floor organic layers and peatlands [@walker2020], though relative consumption rates decline rapidly in deeper organic soil layers, as demonstrated in the model selected here. For Canadian peatlands, the CaMP model [@bona2020] is instead used in CBM. Within CaMP, a separate peatland water model driven by Drought Code determines the thickness of the unsaturated peat layer, and an amount approximating 12% of the thickness of the unsaturated peat is consumed as smouldering consumption. The peat-specific carbon pools and fire Disturbance Matrices are fully described in [@bona2020]; large peatland trees will still utilize the DM scheme described below. Since deeper forest organic soil and peat layers show approximately similar absolute consumption rates, for the purpose of this general model description no peatland-specific components of the fire DMs are required.

Limited data is available on the fraction of woody debris consumption alongside fire severity measurements. Coarse woody debris of overstory stems that makes up 60-80% of woody debris biomass in Canada's boreal and temperate forests [@hanes2021], with its moisture and consumption patterns largely follows the moisture regime of the Drought Code [@mcalpine1995]. In this modelling framework, the proportion of coarse (\>7.5 cm diameter) and medium (\>0.5 cm and \<7.5 cm) woody debris consumption is estimated based on detailed measurements of consumption from experimental fires. Coarse Woody Debris is responsible for approximately 50-75% of the total woody debris load in most ecozones, and approximately 60% of the total woody debris consumption. Ecozone-level CWD consumption rates are summarized as:

```{r CWDByEcozone, echo=FALSE, message=FALSE, warning=FALSE}

#subset to just the variables of interest:

VarDefs.CWD <- VarDefs[VarDefs$Variable.Name == "MedDOM.Comb.Frac",]

VarDefs.dt <- as.data.table(VarDefs.CWD)

CWD.wide <- dcast(VarDefs.dt,Ecozone~SeverityClass,value.var = "Value")

CWD.wide <- CWD.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(CWD.wide, caption = "Coarse Woody debris consumption rates from pre/post measurements in experimental fires") %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

Note that where historical burn severity data is not available, and instead the fire classification type of surface, intermittent crowning, and active crown fire are used as proxies for low, moderate, and high severity fire, respectively. Fine woody debris \<0.5 cm in diameter is consumed at the exact same rate as the litter pool (see section above).

## Drivers of C losses in the tree canopy

### Overstory tree mortality and consumption

Numerous process-driven [@michaletz2006] or empirical [@hood2017] tree mortality models are present and show significant skill in predicting tree mortality based on fire behaviour (i.e. flame length, rate of spread). Since the driving data in this model is satellite-derived fire severity over the landscape scale, fire behaviour metrics such as flame length or scorching height of bark are not available as a continuous mapped product. Instead, softwood and hardwood overstory mortality is calculated per ecozone as a function of satellite-observed fire severity using aggregated ground plot data:

```{r MortByEcozone, echo=FALSE, message=FALSE, warning=FALSE}

#subset to just the variable of interest:
VarDefs.SW.Mort <- VarDefs[VarDefs$Variable.Name == "SW.Mort",]

VarDefs.dt <- as.data.table(VarDefs.SW.Mort)

SW.Mort.wide <- dcast(VarDefs.dt,Ecozone~SeverityClass,value.var = "Value")

SW.Mort.wide <- SW.Mort.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(SW.Mort.wide, caption = "Softwood fractional mortality by ecozone, as dervied from median values from field studies") %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

And since large-diameter, live trees killed by fire do not experience significant live stemwood consumption, the entirety of the live stemwood biomass pool that is killed is transferred to the snag pool. Note that the field data and disturbance modelling undertaken here only accounts for tree mortality within the calender year of the fire, and delayed mortality of over one year has been documented in boreal low and moderate severity fires [@angers2011]where less than half of total mortality occurs after the year of the fire. Thus, the modelling here does not account for delayed mortality that may extend upwards of 5 years after fire.

Crown Fraction Burned (CFB) speaks to the fraction of the live canopy that is itself consumed in the flaming front. The alternate outcomes being survival of the foliage, or the mortality of the tree without canopy consumption, resulting in the dropping of foliage onto the forest floor. From the axioms stated earlier, the CFB must be lower than or equal to the mortality rate, using field studies that show any partial crown consumption is likely sufficient to result in high rates if not complete mortality [@hood2017], which is the case in Canada's trees with primarily thin bark. Due to the structure of the CBM, all High Severity fires have their mortality in the merchantable and smaller trees set to exactly 1.0, which is no more than a 5% variance from observed values. From field studies, the following ecozone-specific CFB values are found:

```{r CFBByEcozone, echo=FALSE, message=FALSE, warning=FALSE}

#subset to just the variable of interest:
VarDefs.SW.CFB <- VarDefs[VarDefs$Variable.Name == "SW.CFB",]

VarDefs.dt.SW.CFB <- as.data.table(VarDefs.SW.CFB)

SW.CFB.wide <- dcast(VarDefs.dt.SW.CFB,Ecozone~SeverityClass,value.var = "Value")

SW.CFB.wide <- SW.CFB.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(SW.CFB.wide, caption = "Softwood crown fraction burned by ecozone, as dervied from median values from field studies") %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

```{r CFBvsMortPlotNOTRUN, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
### this plot doesn't show too much other than the low severity areas where Mort > CFB

# gather VarDefs so that you have ecozone and then columns for SW Mort and SW CFB

VarDefs.SW.CFB <- VarDefs[VarDefs$Variable.Name == "SW.CFB",] 

VarDefs.SW.CFB <- VarDefs.SW.CFB %>% rename(SW.CFB = Value)
VarDefs.SW.Mort <- VarDefs.SW.Mort %>% rename(SW.Mort = Value)

CFB.Mort.Plot <- cbind(VarDefs.SW.CFB,VarDefs.SW.Mort$SW.Mort) 
colnames(CFB.Mort.Plot)[9] <- c("SW.Mort")

ggplot(CFB.Mort.Plot,aes(SW.Mort,SW.CFB))+geom_jitter(aes(color=Ecozone,shape=SeverityClass))

ggplot(CFB.Mort.Plot,aes(SW.Mort,SW.CFB))+geom_jitter(aes(color=Ecozone))+facet_wrap(vars(SeverityClass)) + geom_abline(slope=1,intercept=0)
```

The consumption of live bark biomass is a pool in the model, and consumption rates can be defined by severity class. At the moment, lacking robust field data on bark biomass consumption rates across ecozones and severity classes (which are a small portion of the overall biomass), the bark proportional consumption rate is set to 34% of the overstory mortality rate, based only on a single set well-observed high severity fires in the Taiga Plains by [santn2015].

A major distinction is made between softwood and hardwood trees, where in Canada's boreal forests, a large fraction of hardwood trees (see Appendix E) are able to resprout even when the main stem has been killed by an intense forest fire [@brown1987]. Accordingly, the root mortality rates differ greatly between softwoods and hardwoods, with softwood root mortality equal precisely to stem mortality, while in resprouting hardwoods, little root mortality is observed even after intense fire [@prez-izquierdo2019]. Though GCBM can resolve a species list down to the pixel level, currently an ecozone-level regional average composition of hardwood species with resprouting traits is used and is shown below:

```{r ReSproutByEcozone, echo=FALSE, message=FALSE, warning=FALSE}

#subset to just the variable of interest:
VarDefs.HW.ReSprout <- VarDefs[VarDefs$Variable.Name == "HW.ReSprout" & VarDefs$SeverityClass == "Mod",]

VarDefs.dt.HW.ReSprout <- as.data.table(VarDefs.HW.ReSprout)

HW.ReSprout.wide <- dcast(VarDefs.dt.HW.ReSprout,Ecozone~SeverityClass,value.var = "Value")

HW.ReSprout.wide <- HW.ReSprout.wide[order(factor(Ecozone,levels = as.matrix(ecozones.list)))]

kbl(HW.ReSprout.wide, caption = "Ecozone-level average fraction of hardwood overstory species that do not suffer extensive belowgroud biomass mortality after fire", col.names = c("Ecozone", "Resprout Fraction"),digits = c(2)) %>%
  kable_minimal()#  %>%
          #kable_styling(latex_options = "scale_down") %>%
  #kable_styling(latex_options = "hold_position")
```

Concurrently, the fraction of fine roots contained within the combustible forest floor layers can be a close to or exceeding 50% of the fine root biomass [@strong1985], and burns alongside the organic soils [@benscoter2011]. As a result, the calculation for softwood fine root consumption and mortality are as follows, using Softwood as an example:

```{=tex}
\begin{equation}
SWFineRootConsump = SW.Mort \times SW.Prop.Fine.Root.duff \times Duff.Consump.Fract
\end{equation}
```

```{=tex}
\begin{align*}
SWFineRootMort.AG = SW.Mort \times SW.Prop.Fine.Root.duff \times (1-Duff.Consump.Fract) \times (1-ReSproutFactor)
\end{align*}
```

```{=tex}
\begin{equation}
SWFineRootMort.BG = SW.Mort \times (1-SW.Prop.Fine.Root.duff)
\end{equation}
```

In contrast, the larger diameter of the coarse root biomass pool prevents its consumption during any smouldering of the duff layer, and the mortality rate of coarse roots is simply proportional to that of the stemwood overall.

### Understory tree mortality and consumption

Understory (or small diameter overstory) tree mortality is defined seperately in the model, but given the lack of data on diameter classes in the severity data, robust field data on differing mortality rates of smaller diameter trees is not available, and so the understory tree mortality rate is set equal to the overstory rate as defined in the table above. Note that trees with a top height less than 1.4 m are not considered in this pool, and instead are lumped into the "other" pool.

### Snag and stump consumption

Dead standing trees and branches on average is a biomass pool much smaller than organic soils or coarse woody debris on the ground, but in areas of extensive insect killed trees, recent fires, and blowdown, is a substantial biomass pool. In this initial algorithm description, only typical boreal forest stands where snags are a small fraction of total stems are considered. Compared to live stemwood of the same diameter, the low moisture content of snags and snag branches allows for much greater consumption during the passage of an intense flaming front [@stocks2004]. The snag branch pool experiences almost complete combustion in high severity fires [@talucci2019], and is highly correlated with live foliage consumption (i.e Crown Fraction Burned) [@degroot2022]. The largest biomass pool of the main standing dead stemwood remains at most approximately 50-60% consumed. In the absence of extensive field data from CBI plots to quantify snag and snag branch consumption, snag (dead stemwood) consumption fraction is estimated as:

```{=tex}
\begin{equation}
Snag Consumption fraction = \left( 0.5 \times Crown Fraction Burned \right) + 0.05
\end{equation}
```
And for snag branches:

```{=tex}
\begin{equation}
Snag Branch Consumption = \left( 0.9 \times Crown Fraction Burned \right)
\end{equation}
```
Stumps are tracked as their own biomass pool in CBM. As they are typically in contact with the upper forest floor, are assumed to be consumed at the same rate as coarse woody debris.

```{r loadVarDefsSourceSink, echo=FALSE,message=FALSE, warning=FALSE}

#list of ecozone-specific terms (with and without severity dependence)
#first, import blank template that works for a single ecozone:
#VarDefs.generic <- as.data.frame(read.csv("~/nrcan-cfs-fire/FireDMs/VarDefsGeneric.csv"))
#VarDefs.generic <- VarDefs.generic[,1:7]

#then, replicate for each severity level*ecozone

#use slice from dplyr and each to replicate the template for each ecozone
#VarDefs <- VarDefs.generic %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
#VarDefs$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(VarDefs.generic))

#Once this is done and filled in with data from observations, load the canonical version: 
# this will overwrite the above loop
#NOT RUN (YET)
#VarDefs <- read.csv("~/nrcan-cfs-fire/FireDMs/FireDMTableDefs.csv")




#sink-source DM list:
#first, import blank template that works for a single ecozone:
SourceSinkGeneric <- read.csv("~/nrcan-cfs-fire/FireDMs/SourceSinkGeneric.csv")


#then, replicate for each severity level*ecozone
SourceSink <- SourceSinkGeneric %>% slice(rep(1:n(), each = length(ecozones.list)))

#fill in ecozone names:
SourceSink$Ecozone <- rep(as.matrix(ecozones.list),times = nrow(SourceSinkGeneric))


#Once this is done and filled, load the canonical version: 
# this will overwrite the above loop
#NOT RUN (YET)
#SourceSink <- read.csv("~/FireDMs/SourceSinkLong.csv")


```

## Calculation of Annual Direct C Emissions from Fire

To compute an estimate of the total direct C emissions from forest fires in Canada in 2023, the classified burn severity product from the National Burned Area Composite annual production was utilized (see Hall et al 2020 for an algorithm description). In NBAC, an internal tracking value "NFIREID" is utilized, which is the final satellite-derived burned area polygon (allowing for multi-part polygons) is split across any RU unit boundaries (if any). Since carbon pool sizes vary across RU boundaries, this allows for a single NFIREID to be present across multiple RUs.

A total of 2199 fires as small as 0.09 ha (one 30x30 landsat pixel) were mapped by NBAC for burn severity for a total of 14.60 Mha, but only fires over 100 ha were utilized as a lower limit of where meaningful per-fire estimates of the fraction of low, moderate, and high severity burned area was available. Including only fires 100 ha and larger reduced the total number of fires to 966 but the total area remained largely the same at 14.58 Mha. A total of 189,704 ha of post-fire salvage logging was also mapped in 2023 and is assigned to the moderate severity class after consultation with provincial land managers. The direct C emissions from fire shown here are not altered by the act of post-fire salvage logging. Additionally, the NBAC mapping process accounts for unburned islands (and areas with a mapped fire severity no different than unburned) which count towards the total fire area but do not have a disturbance matrix and direct C estimate applied.

A unique DM was then calculated for each fire using the median area-weighted Buildup Index per fire. All thermal detection hotspots from VIIRS that intersect a fire were extracted from the historical hotspot archive that supports the Canadian smoke emissions model CFFEPS-FireWork [@chen2019]. The median DC value across all intersecting hotspots was used to derive a single DM per fire, no matter the duration of burning.

To compute total direct fire emissions per fire, a single estimate of the carbon pool size based on the Reporting Unit of the centroid of the NFIREID polygon was applied. Since polygons are split across RU boundaries, the spatial weighting of the pool size per fire is performed automatically. While spatially explicit biomass maps are available for some aboveground components [@guindon2024] and some organic soil components [@hanes2022], the majority of the required pool sizes in CBM for the computation of the fire DMs are available only at the spatially referenced RU scale.

# Results and Discussion

```{r DefineDMvalues, echo=FALSE,message=FALSE, warning=FALSE}

j <- 1

for (j in seq(1:length(ecozones.list))) {

  ecozone <- as.character(ecozones.list[j]) #run this loop once for every ecozone

  #print(j)


  ####Pre-DM housekeeping
  
  
  ###(1) need to set bark consumption to 34% of mortality.  Can do this before the fluxID stuff, but within the ecozone loops
  
  
VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.34

  VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.34
  
  VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.34
  
  
  ###(2) as per guidance from the PFC CBM group (M Hafer,B Hudson, 2024-05-01, the tree stem mortality (merch and submerch) for all high severity scenarios is set to precisely 1.0
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- 1
  
  
  
  
  ###(3) Since no field CBI data is available to detail snag consumption in fire, use some of the patterns found Talucci and Krawchuk 2019, where let's call it (0.5*CFB)+0.1 is consumed, and is equal between hardwood and softwood.  Note that this relationship is imperfect when the stand has very low Crown Bulk Density and continuous crown fire is not as easily achieved.
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.5+0.05

  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.5+0.05
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.5+0.05
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.5+0.05

  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.5+0.05
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.5+0.05
  
  ###and similarly for snag branches, just 90% of CFB:
  
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.9

  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.9
  
  VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.9
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*0.9

  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*0.9
  
  VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "HW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*0.9


  ###### end housekeeping
  
  
#FluxID: 1
#Source: Softwood (SW) Merch 
#sink: SW Merch
#Plain Language Summary of flux: survival of conifers
#Pseudocode: survival = 1-mortality
#Notes:  by axiom, survival = 1-mortality,

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Low"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "Mod"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 1 & SourceSink$SeverityClass == "High"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#but, I'm not doing this easily across all three severity classes, no need to run it across each severity class as its own line....

#FluxID: 2
#Source: SW Merch 
#sink: SW Stem Snag
#PLS: Mortality rate of large conifers (includes those with and without burned foliage)
#Pseudocode: as provided from field data, f(ecozone, severity class)
#Notes: mortality >= CFB; may not be the case in extremely fire-tolerant stands, but valid the vast majority of the time
#Notes2: just pulling Softwood CFB 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 2 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])



#FluxID: 3
#Source: SW Merch 
#sink: Black Carbon
#PLS: live stemwood to black carbon
#Pseudocode: =0, since no live stemwood -> 0 BC
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 3 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 5
#Source: SW Foliage
#sink: Above Ground Very Fast DOM
#PLS: Post-fire litterfall (heat-killed but not burned, then falls to ground within the season)
#Pseudocode: Remainder of all fluxes above.
#Notes: assume 100% of heat-killed litter falls within the year of fire

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == 'SW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] - VarDefs$Value[VarDefs$Variable.Name == 'SW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']
  
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == 'SW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] - VarDefs$Value[VarDefs$Variable.Name == 'SW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == 'SW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] - VarDefs$Value[VarDefs$Variable.Name == 'SW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']


#FluxID: 6
#Source: SW Foliage
#sink: CO2
#PLS: CO2 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO2
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 7
#Source: SW Foliage
#sink: CH4
#PLS: CH4 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCH4
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 8
#Source: SW Foliage
#sink: CO
#PLS: CO emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Low"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Mod"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "High"] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 9 SW Other to SW Other is found at the very end (is remainder of the SW Other fluxes listed here)



#FluxID: 10
#Source: SW Other
#sink: SW Branch Snag
#PLS: Portion of "other" pool as killed by fire but otherwise unconsumed branches
#PLS: Understory conifer stems killed but not .  Here, put into branch snag pool, since diameter of submerch trees is more similar to branches then stems
#Pseudocode: (CFB * (1-SW.LgBranch.Comb.Frac))*SW.BW.frac.of.other + (1-SW.Mort)*SW.Frac.of.other
#for example, for AM ecozone, large branches are 0.15, submerch is 0.38 (where submerch is 0.40 of the other pool, so almost all), so Other->snag pool total conversion is 0.53

#Notes:  #since 1-SW.LgBranch.Comb.Frac is the snag creation rate

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Low"] <- ((VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]) + ((VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "SW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])            

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone]  + ((VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "SW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])    

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 10 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "SW.CFB" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] *
(1 - VarDefs$Value[VarDefs$Variable.Name == "SW.LgBranch.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])) * VarDefs$Value[VarDefs$Variable.Name == "SW.BW.frac.of.other" & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "SW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "SW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])       
                                                                                                                      
#FluxID: 11
#Source: SW Other
#sink: CO2
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO2)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO2)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO2)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO2)
#Note: SW submerch is not consumed in fire (becomes snag or survives) so is not represented here

#Notes:  works so far and gives reasonable values of ~0.17, 0.19, 0.2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "Low"] <-  
VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 11 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO2)

#FluxID: 12
#Source: SW Other
#sink: CH4
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCH4)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCH4)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCH4)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCH4)
#Note: SW submerch is not consumed in fire (becomes snag or survives) so is not represented here

#Notes:  works so far and gives reasonable values of ~0.017, 0.019, 0.02

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 12 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCH4)

#FluxID: 13
#Source: SW Other
#sink: CO
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO)
#Note: SW submerch is not consumed in fire (becomes snag or survives) so is not represented here

#Notes:  works so far 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 13 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO)



#FluxID: 14
#Source: SW SubMerch
#sink: SW SubMerch
#PLS: Understory conifer survival rate
#Pseudocode:  =1-(mortality of submerch conifers in severity class) 

#see below for SW Other -> SW Other FluxID: 9
#since SW Submerch now in Other


#FluxID: 15
#Source: SW Other (SubMerch)
#sink: SW Branch Snag
#PLS: Understory conifer stems killed but not .  Here, put into branch snag pool, since diameter of submerch trees is more similar to branches then stems
#Pseudocode:  = SubMerch mortality, since live understory trees don't get consumed in the fire, 

#notes: submerch trees assumed to not have large enough branches to avoid consumption in fire.  Equal to 0

#now handled in FluxID 10


#FluxID: 16-18 were the SW SubMerch to CO2, CH4, CO fluxes, but now merged into "other" pool above.



#FluxID: 19
#Source: SW Coarse roots
#sink: SW Coarse roots
#PLS: Surviving coarse roots in conifers
#Pseudocode:  =1-(conifer mortality rate)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "Low"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "Mod"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 19 & SourceSink$SeverityClass == "High"] <- 1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]

#FluxID: 20
#Source: SW Coarse roots
#sink: Above Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted in organic soil
#Pseudocode:  =(conifer mortality rate)*(conifer coarse root fraction in organic soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides SW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 20 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone]


#FluxID: 21
#Source: SW Coarse roots
#sink: Below Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted since they are in mineral soil
#Pseudocode:  =(conifer mortality rate)*(conifer coarse root fraction in mineral soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides SW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * (1 -  VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 21 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * (1 -  VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Coarse.Root.duff" & VarDefs$Ecozone == ecozone])



#FluxID: 23
#Source: SW fine roots
#sink: Above Ground Very Fast DOM
#PLS: Fine roots killed but not burned in organic soil
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 23 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))


#FluxID: 24
#Source: SW fine roots
#sink: Below Ground Very Fast DOM
#PLS: Fine roots killed but not burned in mineral soil
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in mineral soil)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 24 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone])




#FluxID: 25
#Source: SW fine roots
#sink: CO2
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to SW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 25 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2


#FluxID: 26
#Source: SW fine roots
#sink: CH4
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to SW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 26 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4



#FluxID: 27
#Source: SW fine roots
#sink: CO
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to SW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "Low"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "Mod"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 27 & SourceSink$SeverityClass == "High"] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO





#Fluxes 28:54 Hardwoods
### HARDWOODS!!!!
###


#FluxID: 28
#Source: HW Merch 
#sink: HW Merch
#Plain Language Summary of flux: survival of conifers
#Pseudocode: survival = 1-mortality
#Notes:  by axiom, survival = 1-mortality,

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 28 & SourceSink$SeverityClass == "Low"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 28 & SourceSink$SeverityClass == "Mod"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 28 & SourceSink$SeverityClass == "High"] <- 1 - (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])



#FluxID: 29
#Source: HW Merch 
#sink: HW Stem Snag
#PLS: Mortality rate of large broadleaf (includes those with and without burned foliage)
#Pseudocode: as provided from field data, f(ecozone, severity class)
#Notes: mortality >= CFB; may not be the case in extremely fire-tolerant stands, but valid the vast majority of the time
#Notes2: just pulling Softwood Mortality from field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 29 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 29 & SourceSink$SeverityClass == "Mod"] <- (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 29 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "HW.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 30
#Source: HW Merch 
#sink: Black Carbon
#PLS: live stemwood to black carbon
#Pseudocode: =0, since no live stemwood -> 0 BC
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 30 & SourceSink$SeverityClass == 'Low'] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 30 & SourceSink$SeverityClass == 'Mod'] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 30 & SourceSink$SeverityClass == 'High'] <- 0


#FluxID: 32
#Source: HW Foliage
#sink: Above Ground Very Fast DOM
#PLS: Post-fire litterfall (heat-killed but not burned, then falls to ground within the season)
#Pseudocode: Mortality-CFB
#Notes: assume 100% of heat-killed litter falls within the year of fire

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] - VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] - VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] - VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 33
#Source: HW Foliage
#sink: CO2
#PLS: CO2 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO2
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == 'Low'] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == 'Mod'] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == 'High'] <- global.vars$FlamingCO2 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 34
#Source: HW Foliage
#sink: CH4
#PLS: CH4 emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCH4
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == 'Low'] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == 'Mod'] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == 'High'] <- global.vars$FlamingCH4 *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 35
#Source: HW Foliage
#sink: CO
#PLS: CO emission from Crown Fraction Burned
#Pseudocode: CFB*FlamingCO
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == 'Low'] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == 'Mod'] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == 'High'] <- global.vars$FlamingCO *  VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']

#FluxID: 37
#Source: HW Other
#sink: HW Branch Snag
#PLS: Portion of 'other' pool as killed by fire but otherwise unconsumed branches
#Pseudocode: (CFB * (1-HW.LgBranch.Comb.Frac))*HW.BW.frac.of.other

#Notes:  #since 1-HW.LgBranch.Comb.Frac is the snag creation rate

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 37 & SourceSink$SeverityClass == 'Low'] <- (VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.LgBranch.Comb.Frac' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])) * VarDefs$Value[VarDefs$Variable.Name == 'HW.BW.frac.of.other' & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "HW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])              

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 37 & SourceSink$SeverityClass == 'Mod'] <- (VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.LgBranch.Comb.Frac' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])) * VarDefs$Value[VarDefs$Variable.Name == 'HW.BW.frac.of.other' & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "HW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])   

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 37 & SourceSink$SeverityClass == 'High'] <- (VarDefs$Value[VarDefs$Variable.Name == 'HW.CFB' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.LgBranch.Comb.Frac' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])) * VarDefs$Value[VarDefs$Variable.Name == 'HW.BW.frac.of.other' & VarDefs$Ecozone == ecozone] + ((VarDefs$Value[VarDefs$Variable.Name == "HW.SubMerch.Mort" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "HW.submerch.frac.of.other" & VarDefs$Ecozone == ecozone])    

#FluxID: 38
#Source: HW Other
#sink: CO2
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO2)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO2)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO2)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO2)

#Notes:  works so far and gives reasonable values of ~0.17, 0.19, 0.2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 38 & SourceSink$SeverityClass == 'Low'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 38 & SourceSink$SeverityClass == 'Mod'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO2)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 38 & SourceSink$SeverityClass == 'High'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO2)

#FluxID: 39
#Source: HW Other
#sink: CH4
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCH4)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCH4)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCH4)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCH4)

#Notes:  works so far and gives reasonable values of ~0.017, 0.019, 0.02

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 39 & SourceSink$SeverityClass == 'Low'] <- 
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCH4)
  
  
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 39 & SourceSink$SeverityClass == 'Mod'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCH4)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 39 & SourceSink$SeverityClass == 'High'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCH4)

#FluxID: 40
#Source: HW Other
#sink: CO
#PLS: Proportional Combustion sum of branches, stumps, small trees and bark (mix of flaming and smouldering)
#Pseudocode:   (Flux10*FlamingCO)+
# (Stumps.frac.of.other*DOM.Comb.Rate*SmoulderingCO)+
# (Litter.frac.burned*SmTree.frac.other*FlamingCO)+
# (Bark.frac.other*Bark.Comb.Frac*FlamingCO)

#Notes:  works so far 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 40 & SourceSink$SeverityClass == 'Low'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 40 & SourceSink$SeverityClass == 'Mod'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"] * global.vars$FlamingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 40 & SourceSink$SeverityClass == 'High'] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == ecozone] * as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]) * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == ecozone]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == ecozone] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"] * global.vars$FlamingCO)



#FluxID: 41-45 now rolled into HW.Other.  For details, see SW.SubMerch and SW.Other



#FluxID: 46
#Source: HW Coarse roots
#sink: HW Coarse roots
#PLS: Surviving coarse roots in conifers
#Pseudocode:  =1-((HW mortality rate)*(1-HW Resprout Rate))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 46 & SourceSink$SeverityClass == 'Low'] <- 1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 46 & SourceSink$SeverityClass == 'Mod'] <- 1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 46 & SourceSink$SeverityClass == 'High'] <- 1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])

#FluxID: 47
#Source: HW Coarse roots
#sink: Above Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted in organic soil
#Pseudocode:  =(HW mortality rate*(1-HW Resproute Rate))*(conifer coarse root fraction in organic soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides HW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 47 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])* VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 47 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])* VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 47 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High']* (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])* VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone]


#FluxID: 48
#Source: HW Coarse roots
#sink: Below Ground Fast DOM
#PLS: Coarse Roots killed in fire but not combusted since they are in mineral soil
#Pseudocode:  =(conifer mortality rate)*(1-HW ReSprout rate)*(conifer coarse root fraction in mineral soil)
#Note: assuming even if duff burns, coarse live roots don't burn alongsides HW.prop.Coarse.Root.duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 48 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 48 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])*(1 -  VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 48 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])*(1 -  VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Coarse.Root.duff' & VarDefs$Ecozone == ecozone])




#FluxID: 50
#Source: HW fine roots
#sink: Above Ground Very Fast DOM
#PLS: Fine roots killed but not burned in organic soil
#Pseudocode:  =(conifer mortality rate)*(1-HW ReSprout rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 50 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 50 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 50 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(1 - as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))


#FluxID: 51
#Source: HW fine roots
#sink: Below Ground Very Fast DOM
#PLS: Fine roots killed but not burned in mineral soil
#Pseudocode:  =(conifer mortality rate)*(1-HW ReSprout rate)*(fine root fraction in mineral soil)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 51 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Low'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 51 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'Mod'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 51 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == 'High'])*(1 - VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone])




#FluxID: 52
#Source: HW fine roots
#sink: CO2
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to HW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 52 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 52 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 52 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO2


#FluxID: 53
#Source: HW fine roots
#sink: CH4
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to HW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 53 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 53 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 53 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCH4



#FluxID: 54
#Source: HW fine roots
#sink: CO
#PLS: Fine roots combusted in duff
#Pseudocode:  =(conifer mortality rate)*(fine root fraction in organic soil)*(1-fraction of duff consumed)
#notes: since this is solely based on FFFC fraction, which isn't itself severity driven, there's no severity gradient in here.  Note also no relation to HW mortality (since you can burn off roots and not actually kill the tree, to a point)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 54 & SourceSink$SeverityClass == 'Low'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 54 & SourceSink$SeverityClass == 'Mod'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 54 & SourceSink$SeverityClass == 'High'] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == ecozone]*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])) * global.vars$SmoulderingCO







### end hardwoods


#FluxID: 55
#Source: Aboveground Very Fast DOM
#sink: Aboveground Very Fast DOM
#PLS: Unburned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =Unburned.litter.area(from plot data)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 55 & SourceSink$SeverityClass == "Low"] <-  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 55 & SourceSink$SeverityClass == "Mod"] <-  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 55 & SourceSink$SeverityClass == "High"] <-  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 56
#Source: Aboveground Very Fast DOM
#sink: CO2
#PLS: Burned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =1-Unburned.litter.area(from plot data)*Flaming

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 56 & SourceSink$SeverityClass == "Low"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 56 & SourceSink$SeverityClass == "Mod"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 56 & SourceSink$SeverityClass == "High"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*global.vars$FlamingCO2


#FluxID: 57
#Source: Aboveground Very Fast DOM
#sink: CH4
#PLS: Burned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =1-Unburned.litter.area(from plot data)*Flaming

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 57 & SourceSink$SeverityClass == "Low"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 57 & SourceSink$SeverityClass == "Mod"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 57 & SourceSink$SeverityClass == "High"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*global.vars$FlamingCH4


#FluxID: 58
#Source: Aboveground Very Fast DOM
#sink: CO
#PLS: Burned fraction of The L horizonb comprised of foliar litter plus dead fine roots, approximately <5 mm diameter
#Pseudocode:  =1-Unburned.litter.area(from plot data)*Flaming

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 58 & SourceSink$SeverityClass == "Low"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 58 & SourceSink$SeverityClass == "Mod"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 58 & SourceSink$SeverityClass == "High"] <- (1 -  VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*global.vars$FlamingCO


#FluxID: 59
#Source: organic soil Very Fast DOM
#sink: organic soil Very Fast DOM
#PLS: Uncombusted Fraction of Dead fine roots in the mineral soil, approximately <5 mm diameter
#Pseudocode:  == 1, since dead roots in the mineral soil are not combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 59 & SourceSink$SeverityClass == "Low"] <- 1 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 59 & SourceSink$SeverityClass == "Mod"] <- 1

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 59 & SourceSink$SeverityClass == "High"] <- 1

#FluxID: 60
#Source: Aboveground Fast DOM
#sink: Above Ground Fast DOM
#PLS: Uncombusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately 5 and <75 mm diameter
#Pseudocode: =[(litter surface area fraction unburned*woody debris portion of AGFastDOM)+(Dead coarse root fraction of AGFastDOM*(fraction of duff consumed)]
#*Assume all woody fine+small woody debris is combusted, but only fractional combustion of dead coarse roots alongside duff
#CWD.frac.of.AGFastDOM

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"] <- (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone])*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"] <-  (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone])*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"] <- (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == ecozone])*(as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone]))))


#FluxID: 61
#Source: Aboveground Fast DOM
#sink: CO2
#PLS: Combusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately 5 and <75 mm diameter
#Pseudocode: = flux60*smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 61 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 61 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 61 & SourceSink$SeverityClass == "High"] <- (1 -  SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO2

#FluxID: 62
#Source: Aboveground Fast DOM
#sink: CH4
#PLS: Combusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately 5 and <75 mm diameter
#Pseudocode: = flux60*smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 62 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 62 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 62 & SourceSink$SeverityClass == "High"] <- (1 -  SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCH4

#FluxID: 63
#Source: Aboveground Fast DOM
#sink: CO
#PLS: Combusted Fine and small woody debris plus dead coarse roots in the forest floor, approximately 5 and <75 mm diameter
#Pseudocode: = flux60*smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 63 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 63 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 63 & SourceSink$SeverityClass == "High"] <- (1 -  SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 60 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO

#FluxID: 64
#Source: organic soil Fast DOM
#sink: Below Ground Fast DOM
#PLS: Uncombusted fraction of Dead coarse roots in the mineral soil, approximately 5 diameter
#Pseudocode: =~ 1, since no combustion within mineral soil

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 64 & SourceSink$SeverityClass == "Low"] <- 1
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 64 & SourceSink$SeverityClass == "Mod"] <- 1
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 64 & SourceSink$SeverityClass == "High"] <- 1

#FluxID: 65
#Source: Medium DOM
#sink: Medium DOM
#PLS: Uncombusted Coarse woody debris on the ground
#Pseudocode: =(1-unburned litter area)*(1-MedDOM.Comb.Frac)
#note: could be from field data, here assuming burns at same rate as duff

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])*(1 - VarDefs$Value[VarDefs$Variable.Name == "MedDOM.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])*(1 - VarDefs$Value[VarDefs$Variable.Name == "MedDOM.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])*(1 - VarDefs$Value[VarDefs$Variable.Name == "MedDOM.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) 

#FluxID: 66
#Source: Medium DOM
#sink: CO2
#PLS: Combusted Coarse woody debris on the ground
#Pseudocode: =(1-Flux65)*smoulderingCO2
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 66 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 66 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 66 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO2

#FluxID: 67
#Source: Medium DOM
#sink: CH4
#PLS: Combusted Coarse woody debris on the ground
#Pseudocode: =(1-(fraction of duff consumed))*(1-unburned litter area)*smouldering
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 67 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 67 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 67 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCH4


#FluxID: 68
#Source: Medium DOM
#sink: CO
#PLS: Combusted Coarse woody debris on the ground
#Pseudocode: =(1-(fraction of duff consumed))*(1-unburned litter area)*smouldering
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 68 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 68 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 68 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 65 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO



#FluxID: 69
#Source: Medium DOM
#sink: Black Carbon
#PLS: Coarse woody debris on the ground converted to black carbon
#Pseudocode: =0 (until field data given)
#note: could be from field data, here assuming burns at same rate as duff
#high values are probably on the high end, would need field data (or at least Koroscil MSc lab data)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 69 & SourceSink$SeverityClass == "Low"] <- 0
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 69 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 69 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 70
#Source: Aboveground Slow DOM
#sink: Above Ground slow DOM
#PLS: Uncombusted fraction of duff horizons
#Pseudocode: =1-(fraction of duff consumed)
#note: see CaMP for slow DOM in peat layers

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"] <- 1-(((as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])))*(VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"] <- 1-(((as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])))*(VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]))

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"] <- 1-(((as.numeric(FFFC$Duff.consump.frac[FFFC$Ecozone == ecozone])))*(VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]))


#FluxID: 71
#Source: Aboveground Slow DOM
#sink: CO2
#PLS: Combusted Fraction of duff horizons
#Pseudocode: =(fraction of duff consumed)*Smouldering


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 71 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 71 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 71 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO2

#FluxID: 72
#Source: Aboveground Slow DOM
#sink: CH4
#PLS: Combusted Fraction of duff horizons
#Pseudocode: ==(fraction of duff consumed)*Smouldering

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 72 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 72 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 72 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCH4


#FluxID: 73
#Source: Aboveground Slow DOM
#sink: CO
#PLS: Combusted Fraction of duff horizons
#Pseudocode: =(fraction of duff consumed)*Smouldering

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 73 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Low"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 73 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "Mod"])*global.vars$SmoulderingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 73 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 70 & SourceSink$SeverityClass == "High"])*global.vars$SmoulderingCO


#FluxID: 74
#Source: organic soil Slow DOM
#sink: Below Ground Slow DOM
#PLS: Uncombusted fraction of Humified organic matter in the mineral soil
#Pseudocode: == 1
#notes: no combustion 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 74 & SourceSink$SeverityClass == "Low"] <- 1

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 74 & SourceSink$SeverityClass == "Mod"] <- 1

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 74 & SourceSink$SeverityClass == "High"] <- 1

#FluxID: 75
#Source: Softwood Stem Snag
#sink: Medium DOM
#PLS: Fraction of conifer snags that fall to ground but not combusted (i.e. fall after the passage of the fire and due to the fire)
#Pseudocode: =[1-(SW.Snag.Comb.Frac]*(Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 76
#Source: Softwood Stem Snag
#sink: Softwood Stem Snag
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-(SW.Snag.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 77
#Source: Softwood Stem Snag
#sink: CO2
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 77 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 77 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 77 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2

#FluxID: 78
#Source: Softwood Stem Snag
#sink: CH4
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 78 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 78 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 78 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4


#FluxID: 79
#Source: Softwood Stem Snag
#sink: CO
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*SW.Snag.Comb.Frac*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 79 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 79 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 79 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 75 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 76 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO

#FluxID: 80
#Source: Softwood Stem Snag
#sink: Black Carbon
#PLS: Uncombusted fraction of conifer snags (still upright)
#Pseudocode: =[1-SW.Snag.Comb.Frac-Snag.Fall.Frac)*BlackCarbon
#notes: no black carbon production for now, will need to estimate based on field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 80 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 80 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 80 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 81
#Source: Softwood Branch Snag
#sink: Above Ground Fast DOM
#PLS: Portion of conifer snag branches that falls onto the ground
#Pseudocode: =[1-(SW.Snag.BW.Comb.Frac)]*Snag.Fall.Frac
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 82
#Source: Softwood Branch Snag
#sink: Softwood Branch Snag
#PLS: Unaltered fraction of snag branches
#Pseudocode: =[1-(SW.Snag.BW.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "SW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 83
#Source: Softwood Branch Snag
#sink: CO2
#PLS: Combusted fraction of snag branches
#Pseudocode: = (SW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes:   

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 83 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 83 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 83 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2


#FluxID: 84
#Source: Softwood Branch Snag
#sink: CH4
#PLS: Combusted fraction of snag branches
#Pseudocode: = (SW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 84 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 84 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 84 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4



#FluxID: 85
#Source: Softwood Branch Snag
#sink: CO
#PLS: Combusted fraction of snag branches
#Pseudocode: = (SW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 85 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 85 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 85 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 81 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 82 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO


#FluxID: 86
#Source: Hardwood Stem Snag
#sink: Medium DOM
#PLS: Fraction of deciduous snags that fall to ground but not combusted (i.e. fall after the passage of the fire and due to the fire)
#Pseudocode: =[1-(HW.Snag.Comb.Frac]*(Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 87
#Source: Hardwood Stem Snag
#sink: Hardwood Stem Snag
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-(HW.Snag.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 88
#Source: Hardwood Stem Snag
#sink: CO2
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: assume no combustion of these snags otherwise

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 88 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 88 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 88 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2

#FluxID: 89
#Source: Hardwood Stem Snag
#sink: CH4
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 89 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 89 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 89 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4


#FluxID: 90
#Source: Hardwood Stem Snag
#sink: CO
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*HW.Snag.Comb.Frac*Flaming
#notes: snags not remaining upright nor fallen down are combusted

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 90 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 90 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 90 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 86 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 87 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO

#FluxID: 91
#Source: Hardwood Stem Snag
#sink: Black Carbon
#PLS: Uncombusted fraction of deciduous snags (still upright)
#Pseudocode: =[1-HW.Snag.Comb.Frac-Snag.Fall.Frac)*BlackCarbon
#notes: no black carbon production for now, will need to estimate based on field data

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 91 & SourceSink$SeverityClass == "Low"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 91 & SourceSink$SeverityClass == "Mod"] <- 0

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 91 & SourceSink$SeverityClass == "High"] <- 0


#FluxID: 92
#Source: Hardwood Branch Snag
#sink: Above Ground Fast DOM
#PLS: Portion of deciduous snag branches that falls onto the ground
#Pseudocode: =[1-(HW.Snag.BW.Comb.Frac)]*Snag.Fall.Frac
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]


#FluxID: 93
#Source: Hardwood Branch Snag
#sink: Hardwood Branch Snag
#PLS: Unaltered fraction of snag branches
#Pseudocode: =[1-(HW.Snag.BW.Comb.Frac)]*(1-Snag.Fall.Frac)
#notes: Assuming half of all unconsumed portions branches on snags fall to the ground, half of them remain on the snag.  No field data to this effect.  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"] <- (1 - VarDefs$Value[VarDefs$Variable.Name == "HW.Snag.BW.Comb.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"]) * (1 - VarDefs$Value[VarDefs$Variable.Name == "Snag.Fall.Frac" & VarDefs$Ecozone == ecozone & VarDefs$SeverityClass == "High"])

#FluxID: 94
#Source: Hardwood Branch Snag
#sink: CO2
#PLS: Combusted fraction of snag branches
#Pseudocode: = (HW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 94 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 94 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO2

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 94 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO2


#FluxID: 95
#Source: Hardwood Branch Snag
#sink: CH4
#PLS: Combusted fraction of snag branches
#Pseudocode: = (HW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 95 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 95 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCH4

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 95 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCH4



#FluxID: 96
#Source: Hardwood Branch Snag
#sink: CO
#PLS: Combusted fraction of snag branches
#Pseudocode: = (HW.Snag.BW.Comb.Frac)*(Snag.Fall.Frac)
#notes:  

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 96 & SourceSink$SeverityClass == "Low"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Low"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Low"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 96 & SourceSink$SeverityClass == "Mod"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "Mod"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "Mod"])*global.vars$FlamingCO

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 96 & SourceSink$SeverityClass == "High"] <- (1 - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 92 & SourceSink$SeverityClass == "High"] - SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 93 & SourceSink$SeverityClass == "High"])*global.vars$FlamingCO

### Black Carbon -> black carbon and BC to atm emissions are FluxID 97-100

#FluxID: 101-117
#Source: misc
#sink: PM2.5
#PLS: Combustion emissions to 2.5 micron particulate matter
#Pseudocode: = CORefFluxID * (CO to PM/NMOG ratio)
#notes:  

###now, loop through the PM2.5, PM10, and NMOG EFs, using the ratio of PM:CO(or NMOG) and phase to define them in bulk:

###do this in a loop for the PM2.5 range:

## here is the fluxID of interest to grab the CO of:

for(FluxIDLoop in seq(from=101,to=117)){
  
  ### this a.low placeholder grabs the reference CO DM value, which we then multiply against the CO:PM25 ratio in order to get the PM
a.low <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low" & SourceSink$Ecozone == ecozone]

a.mod <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod" & SourceSink$Ecozone == ecozone]

a.high <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High" & SourceSink$Ecozone == ecozone]


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.low & SourceSink$SeverityClass == "Low"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.mod & SourceSink$SeverityClass == "Mod"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.high & SourceSink$SeverityClass == "High"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)
}

#### now for PM10um

for(FluxIDLoop in seq(from=118,to=134)){
a.low <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low" & SourceSink$Ecozone == ecozone]

a.mod <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod" & SourceSink$Ecozone == ecozone]

a.high <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High" & SourceSink$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.low & SourceSink$SeverityClass == "Low"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.mod & SourceSink$SeverityClass == "Mod"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.high & SourceSink$SeverityClass == "High"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)
}

###lastly, for NMOG

for(FluxIDLoop in seq(from=135,to=151)){
a.low <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low" & SourceSink$Ecozone == ecozone]

a.mod <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod" & SourceSink$Ecozone == ecozone]

a.high <- SourceSink$CORefFluxID[SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High" & SourceSink$Ecozone == ecozone]

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Low"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.low & SourceSink$SeverityClass == "Low"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "Mod"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.mod & SourceSink$SeverityClass == "Mod"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == FluxIDLoop & SourceSink$SeverityClass == "High"] <-
SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == a.high & SourceSink$SeverityClass == "High"]*ifelse(unique(SourceSink$Phase[SourceSink$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)
}

### the foliage, other, and fine root pools have retention terms that are simple 1- all the other fluxes, so have to be computed at the end:


#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Low"] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Mod"] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "Mod"]+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "High"] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 5 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 6 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 7 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 8 & SourceSink$SeverityClass == "High"]+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "High"])
 


#FluxID: 9
#Source: SW Other
#sink: SW Other
#PLS: surviving Live branches, stumps, small trees and bark
#Pseudocode: = 1-(consumption + killed of other pool)

#notes: tried this more complex equation previously, without effect.
#(1-(mortality rate of conifers)*branch fraction of "other" pool)+(1-(medium DOM consumption rate)*stump fraction of other pool)+(1-(mortality of small tree conifers in severity class)*small tree fraction of other pool)+(1-CFB*bark fraction of other pool)
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Low"] <- 1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=10 & SourceSink$FluxID <=13 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 119 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 136 & SourceSink$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Mod"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=10 & SourceSink$FluxID <=13 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 119 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 136 & SourceSink$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "High"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=10 & SourceSink$FluxID <=13 & SourceSink$SeverityClass == "High"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 119 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 136 & SourceSink$SeverityClass == "High"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Low"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 10 & SourceSink$FluxID <= 13 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "Mod"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 10 & SourceSink$FluxID <= 13 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 9 & SourceSink$SeverityClass == "High"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 10 & SourceSink$FluxID <= 13 & SourceSink$SeverityClass == "High"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 102 & SourceSink$SeverityClass == "High"])


#FluxID: 22
#Source: SW fine roots
#sink: SW fine roots
#PLS: Surviving fine roots
#Pseudocode:  =1-(combustion rate of fine roots+mortality rate of fine roots)
#notes: computed at end of fine roots calculations, even though listed as Flux 22
# NOTE: debug needed on high severity, giving value of -0.002, so rounding problem??

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Low"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Softwood Fine Roots" & SourceSink$SeverityClass == "Low"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Mod"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Softwood Fine Roots" & SourceSink$SeverityClass == "Mod"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "High"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Softwood Fine Roots" & SourceSink$SeverityClass == "High"],na.rm=TRUE)


#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Low"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "Low"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 104 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "Mod"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "Mod"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 104 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 22 & SourceSink$SeverityClass == "High"] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 23 & SourceSink$FluxID <= 27 & SourceSink$SeverityClass == "High"])  + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 104 & SourceSink$SeverityClass == "High"]) 



#FluxID: 31
#Source: HW Foliage
#sink: HW Foliage
#PLS: Green fraction of canopy remaining intact after fire
#Pseudocode: Remainder of fluxes 32:35 above
#note2: given definition of CFB, this includes all foliage in merch and submerch

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == "Low"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Foliage" & SourceSink$SeverityClass == "Low"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == "Mod"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Foliage" & SourceSink$SeverityClass == "Mod"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == "High"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Foliage" & SourceSink$SeverityClass == "High"],na.rm=TRUE)




#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == 'Low'] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 105 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == 'Mod'] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == "Mod"]+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 105 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 31 & SourceSink$SeverityClass == 'High'] <- 1 - ( SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 32 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 33 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 34 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 35 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 105 & SourceSink$SeverityClass == "High"])



#FluxID: 36
#Source: HW Other
#sink: HW Other
#PLS: surviving Live branches, stumps, small trees (and submerch) and bark
#Pseudocode: = 1-(consumption + killed of other pool)

#notes: tried this more complex equation previously, without effect.
#(1-(mortality rate of conifers)*branch fraction of 'other' pool)+(1-(medium DOM consumption rate)*stump fraction of other pool)+(1-(mortality of small tree conifers in severity class)*small tree fraction of other pool)+(1-CFB*bark fraction of other pool)
#Notes: 

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == "Low"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=37 & SourceSink$FluxID <=40 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 123 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 140 & SourceSink$SeverityClass == "Low"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == "Mod"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=37 & SourceSink$FluxID <=40 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 123 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 140 & SourceSink$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == "High"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=37 & SourceSink$FluxID <=40 & SourceSink$SeverityClass == "High"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 123 & SourceSink$SeverityClass == "High"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 140 & SourceSink$SeverityClass == "High"])



#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == 'Low'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 37 & SourceSink$FluxID <= 40 & SourceSink$SeverityClass == 'Low']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == 'Mod'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 37 & SourceSink$FluxID <= 40 & SourceSink$SeverityClass == 'Mod'])+ SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "Mod"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 36 & SourceSink$SeverityClass == 'High'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 37 & SourceSink$FluxID <= 40 & SourceSink$SeverityClass == 'High']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 106 & SourceSink$SeverityClass == "High"])


#FluxID: 49
#Source: HW fine roots
#sink: HW fine roots
#PLS: Surviving fine roots
#Pseudocode:  =1-(combustion rate of fine roots+mortality rate of fine roots)
#notes: computed at end of fine roots calculations, even though listed as Flux 49

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == "Low"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Fine Roots" & SourceSink$SeverityClass == "Low"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == "Mod"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Fine Roots" & SourceSink$SeverityClass == "Mod"],na.rm=TRUE)

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == "High"] <- 1-sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == "Hardwood Fine Roots" & SourceSink$SeverityClass == "High"],na.rm=TRUE)



#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == 'Low'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 50 & SourceSink$FluxID <= 54 & SourceSink$SeverityClass == 'Low']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 108 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == 'Mod'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 50 & SourceSink$FluxID <= 54 & SourceSink$SeverityClass == 'Mod']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 108 & SourceSink$SeverityClass == "Low"])

#SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 49 & SourceSink$SeverityClass == 'High'] <- 1 - (sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >= 50 & SourceSink$FluxID <= 54 & SourceSink$SeverityClass == 'High']) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 108 & SourceSink$SeverityClass == "High"])


  #FluxID: 4
#Source: SW Foliage
#sink: SW Foliage
#PLS: Green fraction of canopy remaining intact after fire
#Pseudocode: remainder of (consumed+litterfall)
#Notes: have to use logical statement here, google sheets version said 1-Mortality, but can be <0 unless logic is enforced here
#note2: given definition of CFB, this includes all foliage in merch and submerch

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Low"] <-1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=5 & SourceSink$FluxID <=8 & SourceSink$SeverityClass == "Low"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 118 & SourceSink$SeverityClass == "Low"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 135 & SourceSink$SeverityClass == "Low"])


SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "Mod"] <- 1-( sum(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID >=5 & SourceSink$FluxID <=8 & SourceSink$SeverityClass == "Mod"]) + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 101 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 118 & SourceSink$SeverityClass == "Mod"] + SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 135 & SourceSink$SeverityClass == "Mod"])

SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$FluxID == 4 & SourceSink$SeverityClass == "High"] <- 0
## 100% CFB by definition



## end loop

  # final step in loop: once you have a list each built by ecozone, then build a higher-level list called "FireDM"
   
}

###convert SourceSink to a all-character array for export
  SourceSink.export <- apply(SourceSink,2,as.character)
  
##write to csv each time you build it.
write.csv(SourceSink.export,"FireDM-currents.csv")

```

```{r checkSum-not-run, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##example calc:
#sum(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == "Softwood Merchantable" & SourceSink$SeverityClass == "Mod"])

source.list.checksum <- c("Softwood Merchantable", "Softwood Foliage","Softwood Other", "Softwood Coarse Roots","Softwood Fine Roots","Aboveground Very Fast DOM","Aboveground Fast DOM","Medium DOM","Aboveground Slow DOM","Softwood Stem Snag","Softwood Branch Snag","Hardwood Merchantable", "Hardwood Foliage","Hardwood Other","Hardwood Coarse roots","Hardwood Fine Roots","Hardwood Stem Snag","Hardwood Branch Snag","PM25","PM10","NMOG") 

#checksum for a single ecozone, single severity level:


##check the sinks:
for (i in seq(1:length(source.list.checksum))) {

  print(source.list.checksum[i])
  print(sum(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Sink == source.list.checksum[i] & SourceSink$SeverityClass == "Mod"],na.rm=TRUE))
}

##check the source terms (no CO2 etc gas sources....):
for (i in seq(1:length(source.list.checksum))) {

  print(source.list.checksum[i])
  print(sum(SourceSink$Value[SourceSink$Ecozone == "BP" & SourceSink$Source == source.list.checksum[i] & SourceSink$SeverityClass == "Mod"],na.rm=TRUE))
}


```

```{r ComputeDailyFluxes, echo=FALSE, message=FALSE, warning=FALSE}
### Goal: providing SCANFI and severity data, compute fluxes for a given set of FWI conditions

###basically, provide the following: (1) aligned rasters of SCANFI (corresponding to pool names) and severity data (0,1,2,3?) as well as a global DC value for duff consumption estimates

##outputs: tabular values of the sum of the gas fluxes and updated SCANFI rasters that reflect the fire DMs
  
```

```{r makeTables, echo=FALSE, message=FALSE, warning=FALSE}
 
## replace any NAs with blanks in kable tables
options(knitr.kable.NA = '')

  ### list for columns and rows in visual DM: can be any order, not linked to FluxID or anything:
### text here must exactly match the name of rows in SinkSource, however:

  sink.col.list <- c("Softwood Merchantable", "Softwood Stem Snag","Medium DOM","Softwood Foliage","Aboveground Very Fast DOM", "CO2", "CH4", "CO", "PM25")
  source.row.list <- c("Softwood Merchantable", "Softwood Stem Snag","Medium DOM","Softwood Foliage","Aboveground Very Fast DOM", "CO2", "CH4", "CO", "PM25")

  
  ###make this a function with attributes of ecozone and severity class:
  
  DMTables <- function(ecozone, SeverityClass) {
  
  DM.temp <- as.data.frame(array(NA,c(length(sink.col.list),length(sink.col.list))))
  
  for (j in seq(1:length(sink.col.list))) {
    for (k in seq(1:length(sink.col.list))) {
     
      #if the pair is blank, then return NA, otherwise, look through the list of sink/source pairs for the ecozone and severity level and return that value 
      ifelse(is.na(SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == SeverityClass]),NA,DM.temp[j,k] <- SourceSink$Value[SourceSink$Ecozone == ecozone & SourceSink$Source == source.row.list[j] & SourceSink$Sink == sink.col.list[k] & SourceSink$SeverityClass == SeverityClass])
     
      
    }
    
    
  } 
  rownames(DM.temp) <- source.row.list
  kbl(DM.temp[1:length(sink.col.list),1:length(sink.col.list)],col.names = c("Softwood Merchantable", "Softwood Stem Snag","Medium DOM
","Softwood Foliage","Aboveground Very Fast DOM", "CO2", "CH4", "CO", "PM25"), align = "c",caption = paste0(SeverityClass, " severity Disturbance Matrix in ", ecozone)) %>%
    kable_styling(full_width = F, html_font = "Cambria") %>%
column_spec(2:(length(sink.col.list) + 1), width = "2cm") %>%
column_spec(1, width = "3cm") %>%
  kableExtra::landscape() %>%
          kable_styling(latex_options = "scale_down")  %>%
  kable_styling(latex_options = "hold_position")
  
 
  
  }
  
 ##example of function, for BP and moderate severity (NOT RUN):
  ##DMTables(ecozone = "BP", SeverityClass = "Low") 
  ##DMTables(ecozone = "BP", SeverityClass = "Mod")
  DMTables(ecozone = "BP", SeverityClass = "High")
  
```

```{r SingleDMExtract, message=FALSE, warning=FALSE, include=FALSE}

ExtractFireDM <- function(Ecozone_select="BP",Severity_select="High",BUI_for_DM=70)
{
  #DC_for_DM=700
  #Ecozone_select="BP"
  #Severity_select="High"
  
  ##for now, find the relevant average duff load and ##conversion of Mg C/ha to kg biomass /m2
  AGSlow_for_DM <- as.numeric(FFFC$Median.Duff.Load.kg.m2[FFFC$Ecozone == Ecozone_select])*5
  
  
  DM_temp <- SourceSink %>% filter(Ecozone==Ecozone_select & SeverityClass==Severity_select)
  ###now, need to use the above-defind CalcFFFC function within this to get a new Duff.Consump.frac term:
  ###slight danger since Duff.consump.frac is defined and used otherwise above, so careful
  Duff.consump.frac.ExtractFireDM <- CalcFFFC(AGSlow = AGSlow_for_DM,BUI = BUI_for_DM,Spruce=TRUE)
  
  
  ###now, need to redefine fluxes 11-12,23,25-27,38,40,50,53,54,60,70 here just for the given severity and ecozone but for the selected value of Duff.consump.frac
  
  ###replace_all ecozone -> Ecozone_select and "High" -> Severity_select
  ###since we still have to cite VarDefs in there
  
  #DM_temp$FluxID == 11
  
  ##here's one example of many of the fluxes
  
  ###need to locate "FFFC$Duff.consump.frac" and replace with "Duff.consump.frac.ExtractFireDM"
  
  DM_temp$Value[DM_temp$FluxID == 11] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCO2)

  DM_temp$Value[DM_temp$FluxID == 12] <- VarDefs$Value[VarDefs$Variable.Name == "SW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "SW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "SW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCH4)
  
  DM_temp$Value[DM_temp$FluxID == 23] <- VarDefs$Value[VarDefs$Variable.Name == "SW.Mort" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(1 - Duff.consump.frac.ExtractFireDM)


DM_temp$Value[DM_temp$FluxID == 25] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$FluxID == 26] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCH4


DM_temp$Value[DM_temp$FluxID == 27] <- VarDefs$Value[VarDefs$Variable.Name == "SW.prop.Fine.Root.duff" & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO


DM_temp$Value[DM_temp$FluxID == 38] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCO2 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCO2) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCO2)


DM_temp$Value[DM_temp$FluxID == 40] <-
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCO + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCO) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCO)

DM_temp$Value[DM_temp$FluxID == 50] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.Mort' & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * (1-VarDefs$Value[VarDefs$Variable.Name == 'HW.ReSprout' & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select])*VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(1 - Duff.consump.frac.ExtractFireDM)


DM_temp$Value[DM_temp$FluxID == 53] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCH4


DM_temp$Value[DM_temp$FluxID == 54] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO


DM_temp$Value[DM_temp$FluxID == 60] <- (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == Ecozone_select] + ((1 - VarDefs$Value[VarDefs$Variable.Name == "CWD.frac.of.AGFastDOM" & VarDefs$Ecozone == Ecozone_select])*(Duff.consump.frac.ExtractFireDM)))


###importantly, the duff remaining calculation also considered unburned litter area, where litter has to burn in order for the duff beneath to burn.  This can be up to 20% unburned litter area in low severity
DM_temp$Value[DM_temp$FluxID == 70] <- (1-(Duff.consump.frac.ExtractFireDM) *(1-VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$SeverityClass == Severity_select & VarDefs$Ecozone == Ecozone_select]))


#####
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 39] <- 
VarDefs$Value[VarDefs$Variable.Name == "HW.stumps.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * Duff.consump.frac.ExtractFireDM * global.vars$SmoulderingCH4 + (VarDefs$Value[VarDefs$Variable.Name == "Unburned.litter.area" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select]*VarDefs$Value[VarDefs$Variable.Name == "HW.SmTree.frac.of.other" & VarDefs$Ecozone == Ecozone_select]*global.vars$FlamingCH4) + (VarDefs$Value[VarDefs$Variable.Name == "HW.bark.frac.of.other" & VarDefs$Ecozone == Ecozone_select] * VarDefs$Value[VarDefs$Variable.Name == "Bark.Comb.Frac" & VarDefs$Ecozone == Ecozone_select & VarDefs$SeverityClass == Severity_select] * global.vars$FlamingCH4)


DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 52] <- VarDefs$Value[VarDefs$Variable.Name == 'HW.prop.Fine.Root.duff' & VarDefs$Ecozone == Ecozone_select]*(Duff.consump.frac.ExtractFireDM) * global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 61] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 60])*global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 62] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 60])*global.vars$SmoulderingCH4


DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 63] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 60])*global.vars$SmoulderingCO

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 71] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 70])*global.vars$SmoulderingCO2

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 72] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 70])*global.vars$SmoulderingCH4

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 73] <- (1 - DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == 70])*global.vars$SmoulderingCO



for(FluxIDLoop in seq(from=101,to=117)){
  
  ### this a.low placeholder grabs the reference CO DM value, which we then multiply against the CO:PM25 ratio in order to get the PM
a.low <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low" & DM_temp$Ecozone == Ecozone_select]

a.mod <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod" & DM_temp$Ecozone == Ecozone_select]

a.high <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High" & DM_temp$Ecozone == Ecozone_select]


DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.low & DM_temp$SeverityClass == "Low"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.mod & DM_temp$SeverityClass == "Mod"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.high & DM_temp$SeverityClass == "High"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM25/global.vars$FlamingCO,global.vars$SmoulderingPM25/global.vars$SmoulderingCO)
}

#### now for PM10um

for(FluxIDLoop in seq(from=118,to=134)){
a.low <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low" & DM_temp$Ecozone == Ecozone_select]

a.mod <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod" & DM_temp$Ecozone == Ecozone_select]

a.high <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High" & DM_temp$Ecozone == Ecozone_select]

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.low & DM_temp$SeverityClass == "Low"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.mod & DM_temp$SeverityClass == "Mod"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.high & DM_temp$SeverityClass == "High"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingPM10/global.vars$FlamingCO,global.vars$SmoulderingPM10/global.vars$SmoulderingCO)
}

###lastly, for NMOG

for(FluxIDLoop in seq(from=135,to=151)){
a.low <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low" & DM_temp$Ecozone == Ecozone_select]

a.mod <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod" & DM_temp$Ecozone == Ecozone_select]

a.high <- DM_temp$CORefFluxID[DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High" & DM_temp$Ecozone == Ecozone_select]

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Low"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.low & DM_temp$SeverityClass == "Low"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "Mod"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.mod & DM_temp$SeverityClass == "Mod"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)

DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == FluxIDLoop & DM_temp$SeverityClass == "High"] <-
DM_temp$Value[DM_temp$Ecozone == Ecozone_select & DM_temp$FluxID == a.high & DM_temp$SeverityClass == "High"]*ifelse(unique(DM_temp$Phase[DM_temp$FluxID == FluxIDLoop]) == "Flaming",global.vars$FlamingNMOG/global.vars$FlamingCO,global.vars$SmoulderingNMOG/global.vars$SmoulderingCO)
}



### the fluxes below are calculated at the end of the algorithm above since they feature residual calculations and need to balance the DMs precisely.  The ones implicated in variable depth of burn with DC

DM_temp$Value[DM_temp$FluxID == 9] <- 1-( sum(DM_temp$Value[DM_temp$FluxID >=10 & DM_temp$FluxID <=13]) + DM_temp$Value[DM_temp$FluxID == 102] + DM_temp$Value[DM_temp$FluxID == 119] + DM_temp$Value[DM_temp$FluxID == 136])

DM_temp$Value[DM_temp$FluxID == 22] <- 1-sum(DM_temp$Value[DM_temp$Source == "Softwood Fine Roots"],na.rm=TRUE)


DM_temp$Value[DM_temp$FluxID == 36] <-1-( sum(DM_temp$Value[DM_temp$FluxID >=37 & DM_temp$FluxID <=40]) + DM_temp$Value[DM_temp$FluxID == 106] + DM_temp$Value[DM_temp$FluxID == 123] + DM_temp$Value[DM_temp$FluxID == 140])

DM_temp$Value[DM_temp$FluxID == 49] <- 1-sum(DM_temp$Value[DM_temp$Source == "Hardwood Fine Roots"],na.rm=TRUE)

  
  
  ###then return the new DM
return(DM_temp)
#return(Duff.consump.frac.ExtractFireDM) #turn this on to just test the duff consumption model

}
  
###works, but need to check the sensitivity of the consumption term a bit more

testDM1 <- ExtractFireDM(Ecozone_select="BSE",Severity_select = "High",BUI_for_DM=150)
testDM2 <- ExtractFireDM(Ecozone_select="BSE",Severity_select = "High",BUI_for_DM=550)

testDM1$Value[testDM1$FluxID==70] ### fraction of remaining duff in test DM1
testDM2$Value[testDM2$FluxID==70] ### fraction of remaining duff in test DM2

```

```{r ComputeEmissionsPerFire, message=FALSE, warning=FALSE, include=FALSE}

##Goal: for a single fire, give the (0) some sort of ID (1) total area; (2) ecozone, (3) province, (4-6)% breakdown of low/mod/high, and (7) median DC of burning

##output is as a data frame with (0-7 inputs) as well as total gas and PM emissions as well as emission ratio 

### provide a random number for the ID if otherwise not provided

  ###now load the mean pool size from CBM 2023:
    NIR2023_AverageCPools <- read_csv("./NIR2023_AverageCPools.csv") ### it is in the same dir as the rmd file now

EmissionsPerFire <- function(ID=1,Area_ha=1,EcoBoundaryName_select="Boreal Plains",AdminBoundaryName_select="Alberta",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=250)
{
 
  ###insert function description here
  ##note that Low+Mod+High should not == 1 since unburned area is also possible and likely in most cases
  
  
  
  
   ### just for testing, will get loaded as defaults in the function
  ID <- runif(1, 1000000000000, 9999999999999) %>% round %>% as.character
  #Area_ha=1
  #EcoBoundaryName_select="Boreal Plains"
  #AdminBoundaryName_select="Alberta"
  #Low_frac=0.15
  #Mod_frac=0.15
  #High_frac=0.70
  #Median_BUI=250
  
  ### build the first columns of the output dataframe, which is just the input
  Emissions_DF_head <- as.data.frame(cbind(ID,Area_ha,EcoBoundaryName_select,AdminBoundaryName_select,Low_frac,Mod_frac,High_frac,Median_BUI))
  
  
    
  ##filter out to the pools of the admin and eco zones of interest
  NIR_AverageCPools_filter <- NIR2023_AverageCPools %>% filter(EcoBoundaryName==EcoBoundaryName_select,AdminBoundaryName==AdminBoundaryName_select,TimeStep==0) 
  
  ###make into a long dataframae where the Average C Pool Value is a data frame with columns for the pool name and pool size value
  NIR_AverageCPools_filter_long <- pivot_longer(NIR_AverageCPools_filter,cols=`Aboveground Very Fast DOM`:`Hardwood Fine Roots`) %>% rename(PoolName=name) %>% rename(PoolSize=value)
  
  
  
  
  ##now load up the three appropriate DMs here (one for each severity class):
  
  DM_Low <- ExtractFireDM(unique(NIR_AverageCPools_filter$EcoBoundaryNameShort),Severity_select = "Low",BUI_for_DM = Median_BUI)
  
  DM_Mod <- ExtractFireDM(unique(NIR_AverageCPools_filter$EcoBoundaryNameShort),Severity_select = "Mod",BUI_for_DM=Median_BUI)
  
  DM_High <- ExtractFireDM(unique(NIR_AverageCPools_filter$EcoBoundaryNameShort),Severity_select = "High",BUI_for_DM=Median_BUI)
  
  ### combine the three above into a DM with severity class as a column
  DM_all <- rbind(DM_Low,DM_Mod,DM_High)
  
  Fluxes_Low_tmp <- DM_all %>% filter(SeverityClass=="Low") %>% full_join(NIR_AverageCPools_filter_long,by=join_by(Source == PoolName)) %>% mutate(FluxMgCha = Value*PoolSize*Low_frac)
  
  Fluxes_Mod_tmp <- DM_all %>% filter(SeverityClass=="Mod") %>% full_join(NIR_AverageCPools_filter_long,by=join_by(Source == PoolName)) %>% mutate(FluxMgCha = Value*PoolSize*Mod_frac)
 
  Fluxes_High_tmp <- DM_all %>% filter(SeverityClass=="High") %>% full_join(NIR_AverageCPools_filter_long,by=join_by(Source == PoolName)) %>% mutate(FluxMgCha = Value*PoolSize*High_frac) 
  
  Fluxes_all <- rbind(Fluxes_Low_tmp,Fluxes_Mod_tmp,Fluxes_High_tmp)
  
  ###useful temporary summary of emissions per severity class,but not otherwise used:
  Fluxes_summary_by_sevClass <- Fluxes_all %>% group_by(SeverityClass,Sink) %>% summarize(FluxTotalMgCha = sum(FluxMgCha,na.rm=TRUE))
  
  Fluxes_summary_by_SurfaceCanopy <- Fluxes_all %>% group_by(SourceSurfaceCanopy) %>% summarize(FluxTotalMgCha = sum(FluxMgCha,na.rm=TRUE))
  
  
  
  Fluxes_summary <- Fluxes_all %>% group_by(Sink) %>% summarize(FluxTotalMgCha = sum(FluxMgCha,na.rm=TRUE))
  
  ### calculate the fraction of the total
  Prop_surface <- Fluxes_summary_by_SurfaceCanopy$FluxTotalMgCha[Fluxes_summary_by_SurfaceCanopy$SourceSurfaceCanopy == "Surface"][1]/(Fluxes_summary_by_SurfaceCanopy$FluxTotalMgCha[Fluxes_summary_by_SurfaceCanopy$SourceSurfaceCanopy == "Surface"][1]+Fluxes_summary_by_SurfaceCanopy$FluxTotalMgCha[Fluxes_summary_by_SurfaceCanopy$SourceSurfaceCanopy == "Canopy"][1])
  
  ################
 
  
  
  
  
  ### calculate total emissions for the fire of interest, mulitplying by Area_ha
  CH4_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="CH4"][1]*Area_ha
  CO_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="CO"][1]*Area_ha
  CO2_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="CO2"][1]*Area_ha
  NMOG_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="NMOG"][1]*Area_ha
  PM10_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="PM10"][1]*Area_ha
  PM25_MgC <- Fluxes_summary$FluxTotalMgCha[Fluxes_summary$Sink=="PM25"][1]*Area_ha
  
  ### calculate the modified combustion efficiency and attach it to the output data frame
  #### MCE is in mixing ratio, so mass/mass terms
  
  MCE <- (CO2_MgC*44/(CO2_MgC*44+CO_MgC*28))
  
  
  ER_CO_CO2 <- CO_MgC/CO2_MgC
  ER_CH4_CO2 <- CH4_MgC/CO2_MgC
  
  SumC_direct_emissions <- sum(CH4_MgC,CO_MgC,CO2_MgC,NMOG_MgC,PM10_MgC,PM25_MgC)
  
  Emissions_DF <- as.data.frame(cbind(Emissions_DF_head,MCE,CH4_MgC,CO_MgC,CO2_MgC,NMOG_MgC,PM10_MgC,PM25_MgC,SumC_direct_emissions,ER_CO_CO2,ER_CH4_CO2,Prop_surface))
  
  Emissions_DF$Area_ha <- as.numeric(Emissions_DF$Area_ha)
  Emissions_DF$Low_frac <- as.numeric(Emissions_DF$Low_frac)
  Emissions_DF$Mod_frac <- as.numeric(Emissions_DF$Mod_frac)
  Emissions_DF$High_frac <- as.numeric(Emissions_DF$High_frac)
  Emissions_DF$Median_BUI <- as.numeric(Emissions_DF$Median_BUI)
  Emissions_DF$NMOG_MgC <- as.numeric(Emissions_DF$NMOG_MgC)
  Emissions_DF$PM10_MgC <- as.numeric(Emissions_DF$PM10_MgC)
  Emissions_DF$PM25_MgC <- as.numeric(Emissions_DF$PM25_MgC)
  Emissions_DF$SumC_direct_emissions <- as.numeric(SumC_direct_emissions)
  
  
  Emissions_DF <- as.data.frame(Emissions_DF) %>% mutate(across(5:19, as.numeric)) %>% mutate(across(5:19, round, 3))
  
  return(Emissions_DF)
}
  EmissionsPerFire()

test_20_30_30_DC250 <- EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield East",AdminBoundaryName="Ontario",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=70)

test_20_30_30DC500 <- EmissionsPerFire(ID="test_20_30_30DC500",Area_ha = 1000,EcoBoundaryName="Boreal Shield East",AdminBoundaryName="Ontario",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=170)



### same balance of severity classes, just different Drought Code and therefore duff consumption:
rbind(EmissionsPerFire(ID="test_BP_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=50),EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=200))



##same ecoregion just small different balance of severity classes. 
rbind(EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=170),EmissionsPerFire(ID="test_BSE_20_30_50_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.10,Mod_frac=0.20,High_frac=0.50,Median_BUI=170))

##same ecoregion but large difference in balance of severity classes.  
rbind(EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.8,Mod_frac=0.01,High_frac=0.01,Median_BUI=170),EmissionsPerFire(ID="test_BSE_20_30_50_DC250",Area_ha = 1000,EcoBoundaryName="Montane Cordillera",AdminBoundaryName="British Columbia",Low_frac=0.10,Mod_frac=0.20,High_frac=0.50,Median_BUI=170))


##contrasting ecozones where the AGSlow (duff) consumption is about 2x greater in BP compared to BSE, and softwood foliage is also about 2x as large.  As a result, per ha the emissions are about 2.0-2.5 times bigger
rbind(EmissionsPerFire(ID="test_BP_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Plains",AdminBoundaryName="Alberta",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=250),EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Boreal Shield East",AdminBoundaryName="Ontario",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=250))


##troubleshooting TSE Labrador
rbind(EmissionsPerFire(ID="test_BP_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Taiga Shield East",AdminBoundaryName="Labrador",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=325),EmissionsPerFire(ID="test_BSE_20_30_30_DC250",Area_ha = 1000,EcoBoundaryName="Taiga Shield East",AdminBoundaryName="Labrador",Low_frac=0.20,Mod_frac=0.30,High_frac=0.30,Median_BUI=370))

```



```{r Ternary_plots, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#https://cran.r-project.org/web/packages/Ternary/vignettes/Ternary.html

#will need to label each DM endpoint as one of "live", "DOM", "emissions"

##maybe best done down in 2023 emissions instead of map to show variability?

##or show it here and also down in 2023?

##for fires, can scale dot size by area burned, and colour by ecozone?

```



```{r GasEmissions-all-combos, message=FALSE, warning=FALSE, include=FALSE}
###run through all combinations of ecozone*province, severity class, and DC class from 50 -> 750 and run the model there to make a giant lookup table for the DM itself and also the gas emissions


BUI_levels <- seq(from=40,to=200, by=20)
Severity_classes <- c("Low","Mod","High")


###will have to do a case_when here to map the severity classes to the function

###or make a grid for each of low/mod/high, run the function then rbind them

#emissions_temp <- EmissionsPerFire(Area_ha=1,EcoBoundaryName_select=FireDM_grid$EcoBoundaryName,AdminBoundaryName_select = FireDM_grid$AdminBoundaryName,Median_BUI = FireDM_grid$DC_levels)
EmissionsPerFire()

###expand out all combinations of ecozone, admin, and DC levels just once:
FireDM_grid <- expand(NIR2023_AverageCPools,nesting(EcoBoundaryName,AdminBoundaryName),BUI_levels)



###here's a simple 3 row test case across the severity levels
#emissions_grid_out_test <- EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.99999,Mod_frac=0.00001,High_frac=0.000001,Median_BUI=250)

#emissions_grid_out_test <- rbind(emissions_grid_out_test,EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.001,Mod_frac=1.0,High_frac=0.001,Median_BUI=250))

#emissions_grid_out_test <- rbind(emissions_grid_out_test,EmissionsPerFire(ID="test_20_30_30_DC250",Area_ha = 1,EcoBoundaryName="Boreal Shield West",AdminBoundaryName="Saskatchewan",Low_frac=0.001,Mod_frac=0.001,High_frac=1.001,Median_BUI=250))



##fill out the first dataframe to get the columns from this function call
emissions_grid_out <- EmissionsPerFire(ID=1,Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[1],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[1],Low_frac = 1,Mod_frac=0,High_frac=0,Median_BUI = FireDM_grid$BUI_levels[1])

emissions_grid_out$Severity_uniform[1] <- c("Low")

###loop the rest by severity class since it didn't want to work to call the function across the array without some strange R syntax that isn't worth it (this only runs to build the RMarkdown and a csv out a graph, runtime not important)
###low loop
for (i in seq(from=2,to=nrow(FireDM_grid)))
{
emissions_temp <- EmissionsPerFire(ID=paste0("Low",i),Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[i],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[i],Low_frac = 1,Mod_frac=0,High_frac = 0,FireDM_grid$BUI_levels[i])

Severity_uniform <- c("Low")

emissions_temp <- cbind(emissions_temp,Severity_uniform)

  emissions_grid_out <- rbind(emissions_grid_out,emissions_temp)
}


###mod loop
for (i in seq(from=1,to=nrow(FireDM_grid)))
{
emissions_temp <- EmissionsPerFire(ID=paste0("High",i),Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[i],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[i],Low_frac = 0,Mod_frac=1,High_frac = 0,FireDM_grid$BUI_levels[i])
  
Severity_uniform <- c("Mod")
emissions_temp <- cbind(emissions_temp,Severity_uniform)
  emissions_grid_out <- rbind(emissions_grid_out,emissions_temp)
}

##high loop
for (i in seq(from=1,to=nrow(FireDM_grid)))
{
emissions_temp <- EmissionsPerFire(ID=paste0("High",i),Area_ha=1,EcoBoundaryName_select = FireDM_grid$EcoBoundaryName[i],AdminBoundaryName_select = FireDM_grid$AdminBoundaryName[i],High_frac = 1,Mod_frac = 0,Low_frac=0,FireDM_grid$BUI_levels[i])
  
Severity_uniform <- c("High")
emissions_temp <- cbind(emissions_temp,Severity_uniform)

  emissions_grid_out <- rbind(emissions_grid_out,emissions_temp)
}

emissions_grid_out$EcoAdmin <- paste(emissions_grid_out$EcoBoundaryName_select,emissions_grid_out$AdminBoundaryName_select)

emissions_grid_out <- emissions_grid_out %>% filter(EcoBoundaryName_select != "Semiarid Prairies") %>% filter(EcoBoundaryName_select != "Subhumid Prairies")

emissions_grid_out <- emissions_grid_out %>% filter(EcoBoundaryName_select != "Hardwood Plains")

#emissions_grid_out$Severity_uniform <- case_when(Low_frac > 0.5 ~ "Low", Mod_frac > 0.5 ~ "Mod", High_frac > 0.5 ~ "High")
### ggplot a line graph with DC on x-axis, CO2 on y axis, then facet by paste(Eco-Admin) combos



```

## Direct fire carbon emissions as a function of fire severity and drought

```{r non-GWP-total-C-plot, echo=FALSE, fig.height=9, fig.width=6, message=FALSE, warning=FALSE}
#emissions_grid_out$Severity_uniform <- as.factor(emissions_grid_out$Severity_uniform)
#emissions_grid_out$Severity_uniform <- factor(emissions_grid_out$Severity_uniform, levels = c("High","Mod","Low"))

##filter out some that are a tiny sliver of an area
emissions_grid_out_plot <- emissions_grid_out  %>% filter(EcoAdmin != "Pacific Maritime Yukon Territory") %>% filter(EcoAdmin != "Boreal Cordillera Northwest Territories")# %>% filter(EcoAdmin != "Taiga Shield West Alberta") %>% filter(EcoAdmin != "Mixedwood Plains Ontario") %>% filter(EcoAdmin != "Mixedwood Plains Quebec")

###I think input data is missing for MP, but have the NIR pools...
###need to compute MW plains also those extra HP in MB and QC.  add the HP, will still be square once PM YT and BC NWT are gone
##%>% filter(EcoAdmin != "Mixedwood Plains Ontario") %>% filter(EcoAdmin != "Mixedwood Plains Quebec")

##where is Hudson Plains MB?
##where is Hudson Plains QC??
##where is TSE QC?

##what about TSW Nunavut?
##BSW AB is tiny
###PM YT is tiny

emissions_grid_out_plot$EcoAdmin <- case_match(emissions_grid_out_plot$EcoAdmin,
                                          "Atlantic Maritime New Brunswick" ~ "AM NB",
                                          "Atlantic Maritime Nova Scotia" ~ "AM NS",
                                          "Atlantic Maritime Prince Edward Island" ~ "AM PE",
                                          "Atlantic Maritime Quebec" ~ "AM QC",
                                          "Boreal Cordillera British Columbia" ~ "BC BC",
                                          "Boreal Cordillera Northwest Territories" ~ "BC NT",
                                          "Boreal Cordillera Yukon Territory" ~ "BC YT",
                                          "Boreal Plains Alberta" ~ "BP AB",
                                          "Boreal Plains British Columbia" ~ "BP BC",
                                          "Boreal Plains Manitoba" ~ "BP MB",
                                          "Boreal Plains Northwest Territories" ~ "BP NT",
                                          "Boreal Plains Saskatchewan" ~ "BP SK",
                                          "Boreal Shield East Labrador" ~ "BSE Lab",
                                          "Boreal Shield East Newfoundland" ~ "TSE NFLD",
                                          "Boreal Shield East Ontario" ~ "BSE ON",
                                          "Boreal Shield East Quebec" ~ "BSE QC",
                                          "Boreal Shield West Alberta" ~ "BSW AB",
                                          "Boreal Shield West Manitoba" ~ "BSW MB",
                                          "Boreal Shield West Ontario" ~ "BSW ON",
                                          "Boreal Shield West Saskatchewan"  ~ "BSW SK",
                                          "Hudson Plains Manitoba"  ~ "HP MB",
                                          "Hudson Plains Ontario"  ~ "HP ON",
                                          "Hudson Plains Quebec"  ~ "HP QC",
                                          "Montane Cordillera British Columbia" ~ "MC BC",
                                          "Montane Cordillera Alberta" ~ "MC AB",
                                          "Mixedwood Plains Ontario" ~ "MP ON",
                                          "Mixedwood Plains Quebec" ~ "MP QC",
                                          "Pacific Maritime British Columbia" ~ "PM BC",
                                          "Pacific Maritime Yukon Territory" ~ "PM YT",
                                          "Taiga Cordillera Northwest Territories" ~ "TC NT",
                                          "Taiga Cordillera Yukon Territory" ~ "TC YT",
                                          "Taiga Plains Alberta" ~ "TP AB",
                                          "Taiga Plains British Columbia"  ~ "TP BC",
                                          "Taiga Plains Northwest Territories" ~ "TP NT",
                                          "Taiga Plains Yukon Territory" ~ "TP YT",
                                          "Taiga Shield East Labrador"  ~ "TSE Lab",
                                          "Taiga Shield East Quebec"  ~ "TSE QC",
                                          "Taiga Shield West Alberta" ~ "TSW AB",
                                          "Taiga Shield West Manitoba" ~ "TSW MB",
                                          "Taiga Shield West Nunavut" ~ "TSW NU",
                                          "Taiga Shield West Saskatchewan" ~ "TSW SK",
                                          "Taiga Shield West Northwest Territories" ~ "TSW NT")


ggplot(emissions_grid_out_plot,aes(Median_BUI,SumC_direct_emissions,colour = Severity_uniform)) + geom_line() + facet_wrap(vars(EcoAdmin),labeller = labeller(EcoAdmin = label_wrap_gen(20))) + ylab("Direct emissions from wildfire (Mg C/ha) not adjusted to GWP") + xlab("Buildup Index of burning") + theme(legend.position="none") + scale_colour_manual(values = c("#fc6f03",  "darkgreen","gold")) + labs(caption=("Direct emissions by severity class: orange = high, yellow = moderate, green = low severity.  Labelled acronyms \n are Reporting Units (see Figure 1) as Ecozone then Province, so BC is both Boreal Cordillera \n and British Columba. Labrador is distinct from the island of Newfoundland for Reporting Units,\n so 'Lab' and 'NFLD' is used."))+ theme(strip.text.x = element_text(size = 8)) +theme(plot.caption = element_text(hjust = 0.5))# + geom_point(aes(x=Median_BUI,y=Prop_surface*100))
```

```{r GWP-adjusted-total-C-plot-NOT-READY, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

###just need to adjust CH4 by 28x and CO is just ~1.  NMOG not sure
ggplot(emissions_grid_out,aes(Median_BUI,SumCO2e_direct_emissions_GWP,colour = Severity_uniform)) + geom_line() + facet_wrap(vars(EcoAdmin)) + ylab("Direct emissions from wildfire (Mg CO2e/ha)") + xlab("Buildup Index of burning")
```

## Comparison against observed direct fire emissions

### Forest fire observations of CO and CO~2~ emissions ratios

```{r MCE-from-airborne, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

AirborneMCE <- read.csv("~/nrcan-cfs-fire/FireDMs/AirborneMCE.csv")

MCE_temp <- array(data=NA)

MCE_temp1 <- EmissionsPerFire(ID=AirborneMCE$Study[1],Area_ha = 1,EcoBoundaryName=AirborneMCE$EcoBoundaryName[1],AdminBoundaryName=AirborneMCE$AdminBoundaryName[1],Low_frac=0.20,Mod_frac=0.30,High_frac=0.50,Median_BUI=AirborneMCE$Median_BUI[1])

MCE_Table <- cbind(AirborneMCE$Study[1],AirborneMCE$Date[1],AirborneMCE$Subset[1],MCE_temp1$EcoBoundaryName_select,AirborneMCE$Median_BUI[1],AirborneMCE$Obs.MCE[1],MCE_temp1$MCE)

colnames(MCE_Table) <- c("Study","Date","Subset","Ecozone","Buildup Index","Obs MCE","Modelled MCE")

MCE_temp2 <- EmissionsPerFire(ID=AirborneMCE$Study[2],Area_ha = 1,EcoBoundaryName=AirborneMCE$EcoBoundaryName[2],AdminBoundaryName=AirborneMCE$AdminBoundaryName[2],Low_frac=1.0,Mod_frac=0.0,High_frac=0.0,Median_BUI=AirborneMCE$Median_BUI[2])

MCE_temp3 <- EmissionsPerFire(ID=AirborneMCE$Study[3],Area_ha = 1,EcoBoundaryName=AirborneMCE$EcoBoundaryName[3],AdminBoundaryName=AirborneMCE$AdminBoundaryName[3],Low_frac=1.0,Mod_frac=0.0,High_frac=0.0,Median_BUI=AirborneMCE$Median_BUI[3])


MCE_Table2 <- cbind(AirborneMCE$Study[2],AirborneMCE$Date[2],AirborneMCE$Subset[2],MCE_temp2$EcoBoundaryName_select,AirborneMCE$Median_BUI[2],AirborneMCE$Obs.MCE[2],MCE_temp2$MCE)

MCE_Table3 <- cbind(AirborneMCE$Study[3],AirborneMCE$Date[3],AirborneMCE$Subset[3],MCE_temp3$EcoBoundaryName_select,AirborneMCE$Median_BUI[3],AirborneMCE$Obs.MCE[3],MCE_temp3$MCE)

MCE_Table <- rbind(MCE_Table,MCE_Table2,MCE_Table3)



#The obs and modelled MCE needs to be a as.numeric

##then as kable, and add sum of FRP observed to get relative emissions (smouldering is far less)

kbl(MCE_Table, caption = "Comparison of the Modified Combustion Efficiency (MCE) of airborne gas measurements of Canadian wildfires against modelled MCE") %>%
  kable_minimal() %>% 
  kable_styling(latex_options="scale_down")

```

Mean observed Modified Combustion Efficiency was observed by @hornbrook2011 for distinct periods during the ARCTAS campaign over northern Saskatchewan in 2008. MCE observed by aircraft during the peak burn period when the majority of fuel consumption and area burned occurs (0.92) largely corresponded with modelled values (0.91), suggesting the model provides a fair representation of the balance of flaming and smouldering during large active wildfires. Subsequent smoke plume observations during periods of greatly reduced spread and intensity (late evening and after rain) showed a substantially reduced MCE of 0.82-0.83 that indicates a near lack of flaming combustion. Even when represented as 100% low severity fire in the model, the modelled MCE only declines to 0.903. Since the fire DM model is based on area burned, fire activity such as smouldering but with minimal actual area burned increased is going to show an MCE far lower than areas of low severity fire spread, which are typically still a low sub-canopy flaming front that features a mix of smouldering duff and woody debris alongside flaming consumption of litter [@mcrae1994; @mcrae2017].

## 2023 Canadian wildfire season total direct emissions

To calculate the sum total of estimate direct C emission from Canadian wildfires in 2023, severity maps were created for each fire using 2024 season satellite observations using an approach that produces severity class maps using both classified spectral indices [@whitman2020] with additional fire environment covariates to predict severity class at 30-m !!!![cite Ellen's upcoming paper]!!!. A single representative area-weighted Buildup Index value from fire hotspots was computed for each fire. A single set of Fire DMs (composed of one DM per severity class) was then applied to Reporting Unit carbon stock values for the total fire area falling into Low, Moderate, and High severity classes. The same Buildup Index was used for all severity classes per fire event when computing the DM per fire event. Per-fire direct C emissions (i.e. CO~2~, CO, CH~4~, PM~2.5~, etc.) were then computed and summed by ecozone and nationally.

!!! results table to be completed for the 2023 emissions !!!

```{r TotalEmissions2023, message=FALSE, warning=FALSE, include=FALSE}
#burn_severity_by_nfireid_ha.csv is just by NFIREID, need to put RU onto that to get the mean biomass pools, then apply the DMs to compare with the above

NBAC2023 <- read.csv("~/nrcan-cfs-fire/FireDMs/NBAC-2023-points-4326-v4.csv")  ##this needs Median_BUI already joined to it
Severity2023 <- read.csv("~/nrcan-cfs-fire/FireDMs/burn_severity_by_nfireid_ha.csv")

Severity2023$Low_frac <- Severity2023$Low/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)

Severity2023$Mod_frac <- (Severity2023$Moderate+Severity2023$Post.fire.havest)/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)

Severity2023$High_frac <- Severity2023$High/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)

Severity2023$Unchanged_frac <- Severity2023$Unchanged.to.very.low/(Severity2023$Unchanged.to.very.low+Severity2023$Low+Severity2023$Moderate+Severity2023$High+Severity2023$Post.fire.havest+Severity2023$NoData)


#sum(NBAC2023$ADJ_HA) ## 14.6 Mha total over 2181 fires
NBAC2023 <- NBAC2023 %>% filter(ADJ_HA>100) #this could be smaller, down to as little as 10 ha potentially
sum(NBAC2023$ADJ_HA) #now only 652 fires but still 14.50 Mha

##specific to 2023, these two fires near Kitimat BC in the large-scale RU map appear on the water, so manually assign them to boreal cordillera RU:
NBAC2023[NBAC2023$NFIREID==829,]$unit_id <- 40
NBAC2023[NBAC2023$NFIREID==776,]$unit_id <- 40

###now, to feed the per-fire carbon function, will need to append the province and ecozone per fire, based on RU:
##in NIR2023_AverageCPools, RU is "SPUID", and in the NBAC, it is "unit_id"
## trim the NIR data frame to just retain the Reporting Unit ID (SPUID) and associated info
NIR2023_AverageCPools_temp <- NIR2023_AverageCPools %>% select(SPUID:TimeStep) %>% filter(TimeStep==0)


###need a few patches since the AverageCPools is missing a bit of data: SPUID 14 == 3 (QC becomes Labrdor TSE) and 13 == 18 (QC HP becomes ON HP)

##as a big case_match:

NBAC2023$unit_id <- case_match(
  NBAC2023$unit_id,
  14 ~ 3,
  13 ~ 18,
  21 ~ 32,
  25 ~ 18,
  26 ~ 51,
  49 ~ 51,
  56 ~ 51,
  57 ~ 51,
  59 ~ 18,
  .default = NBAC2023$unit_id
)
###now append that info to NBAC2023 data frame:
NBAC2023 <- NBAC2023 %>% left_join(NIR2023_AverageCPools_temp, by = join_by(unit_id == SPUID))
###now append with burn severity data
NBAC2023 <- NBAC2023 %>% left_join(Severity2023,by=join_by(NFIREID))
##make a running summary dataframe, so run the EmissionsPerFire function with i = 1 just to set it up
AnnualEmissionsSummary <- EmissionsPerFire(ID=NBAC2023$NFIREID[1],Area_ha=NBAC2023$ADJ_HA[1],EcoBoundaryName_select = NBAC2023$EcoBoundaryName[1],AdminBoundaryName_select = NBAC2023$AdminBoundaryName[1],Low_frac=NBAC2023$Low_frac[1],Mod_frac=NBAC2023$Mod_frac[1],High_frac=NBAC2023$High_frac[1],Median_BUI=NBAC2023$bui_median[1])

for(i in seq(from=2,to=nrow(NBAC2023))){
tmp <- EmissionsPerFire(ID=NBAC2023$NFIREID[i],Area_ha=NBAC2023$ADJ_HA[i],EcoBoundaryName_select = NBAC2023$EcoBoundaryName[i],AdminBoundaryName_select = NBAC2023$AdminBoundaryName[i],Low_frac=NBAC2023$Low_frac[i],Mod_frac=NBAC2023$Mod_frac[i],High_frac=NBAC2023$High_frac[i],Median_BUI=NBAC2023$bui_median[i])
AnnualEmissionsSummary <- rbind(AnnualEmissionsSummary,tmp)

}


#here's the sum of direct C emissions (Mg or tonnes C)
#sum(AnnualEmissionsSummary$SumC_direct_emissions)

#here's the sum of direct C emissions (Mg or tonnes C)
sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE)

sum(AnnualEmissionsSummary$SumC_direct_emissions,na.rm=TRUE)/sum(AnnualEmissionsSummary$Area_ha,na.rm=TRUE)

##compare to about 450 Mt

###weighted mean of DC:
#round(weighted.mean(AnnualEmissionsSummary$Median_BUI, AnnualEmissionsSummary$Area_ha,na.rm=TRUE),digits=0)

#round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.05,na.rm=TRUE),digits=0)

#round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.95,na.rm=TRUE),digits=0)


#round(weighted.mean(AnnualEmissionsSummary$MCE, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=3)

#round(weighted.mean(AnnualEmissionsSummary$CO2_MgC/AnnualEmissionsSummary$CO_MgC, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=2)

###what are the mean LMH values per RU? and breakdown of DC by RU as well.

```

A total of `r {round(sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE),digits=0)}` Mt C was estimated to be released directly by fires in Canada in 2023. The area-weighted mean Buildup Index for all fires in Canada in 2023 was `r  {round(weighted.mean(AnnualEmissionsSummary$Median_BUI, AnnualEmissionsSummary$Area_ha,na.rm=TRUE),digits=0)}`, representing severe but not uniformly exceptional drought conditions in Canada's northern forests. The area-weighted mean total C emissions per unit area was `r {round(weighted.mean(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, AnnualEmissionsSummary$Area_ha,na.rm=TRUE),digits=2)}` t C/ha, though 90% of the emissions per unit area were between the 5th percentile of `r  {round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.05,na.rm=TRUE),digits=0)}` t C/ha typical of the Taiga Plains ecozone under low drought conditions and the 95th percentile of `r  {round(quantile(AnnualEmissionsSummary$SumC_direct_emissions/AnnualEmissionsSummary$Area_ha, probs=0.95,na.rm=TRUE),digits=0)}` t C/ha typical of Pacific coastal forests.

Byrne et al 2024 used observed total atmospheric column excess CO and a range of MCE values to estimate total fire C emissions in Canada in 2023 of between 570-727 Mt C with a mean estimate of 647 Mt. The uncertainty in the estimate from Byrne et al 2024 lies primarily in the uncertain CO~2~:CO ratio (more commonly computed as the normalized ratio MCE). Our bottom-up estimates that partition flaming vs smouldering shows a lower CO~2~:CO estimate of `r  {round(weighted.mean(AnnualEmissionsSummary$CO2_MgC/AnnualEmissionsSummary$CO_MgC, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=2)}`. This lower CO~2~:CO ratio (i.e. more smouldering) if applied to the data from Byrne et al 2024 would reduce their lower range of total C emissions to `r  {round(weighted.mean(((AnnualEmissionsSummary$CO2_MgC/AnnualEmissionsSummary$CO_MgC)/7.7)*647, AnnualEmissionsSummary$Area_ha,na.rm=TRUE), digits=0)}` Mt C, which is comparable to the `r {round(sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE),digits=0)}` Mt C computed from this bottom-up approach. Estimates of total carbon emissions based solely on the sum of observed Fire Radiative Power (FRP) from Copernicus-CAMS was approximately 490 Mt C (<https://atmosphere.copernicus.eu/smoke-canadian-wildfires-reaches-europe>)

### Relationship to other fire carbon models

The forest floor emissions modelling scheme used here builds upon the CanFIRE model [@degroot2013] which incorporates a similar estimate of absolute forest floor emissions based on fuel type and various Fire Weather Index inputs (including but not limited to Buildup Index). While the CanFIRE model is also capable of estimating tree mortality, the premise of CanFIRE lies in the use of the Canadian fire Behaviour Prediction (FBP) System to model fire intensity and a physiological-thermodynamic model of tree damage and mortality. CanFIRE is able to run entirely in scenario or forecast mode, i.e. no fire severity map is needed to run the model, unlike the focus here on a mechanism to estimate carbon fluxes and pools after fire severity is mapped. Ultimately, models like CanFIRE can be used for near-real time emissions estimates of direct and indirect fire carbon emissions (and also for prescribed fire planning and scenario testing), while this modelling framework is best used solely operational carbon accounting and reporting given its strong dependence severity maps. While fire severity can be estimated empirically based on geospatial inputs without observation using multispectral satellite data such as Landsat !!![Ellen's paper?]!!!, estimation using coupled fire behaviour and ecology models such as CanFIRE is a more direct approach. Under severe drought conditions and light winds, very large fires often create more wind and energy than is available in gradient winds as measured at nearby airports and fire weather observing stations !!!(cite Coen paper on fire-induced winds)!!! Thus, fire behaviour and fuel consumption models solely driven by wind inputs from distant meteorological stations can under-predict fire intensity and therefore likely fire severity. While fire-atmosphere models are available for research !![cite coen again] and some forecasting and planning purposes [@linn2020], modelling resources are typically not made available for the extensive and largely unsuppressed fires in northern Canada. Fire severity mapping after the fact is able to account for high fire severity [@whitman2018] even when fire spread occurs under light winds [@whitman2024].

While the fire DMs presented here are designed for use in the CFS-CBM carbon reporting framework, their simplicity and similarity to many other forest carbon schema allows them to be used elsewhere such as in other forest dynamics [@brecka2020] and earth system models [@melton2020] that require estimates of Canadian forest carbon emissions from wildfire. @stenzel2019 showed that severity-informed fire C estimates (with snags) in the US are only 30-40% as large as fixed or variable severity data using their LANDIS-type models. Large over-estimates of in-fire bole consumption in models were not observed to correspond to measurements in the field. In the model presented here, our estimates of snag consumption are based on simple but logical relationships with Crown Fraction Burned, but more comprehensive data collection and field observations would be required to extend the accuracy of the snag consumption scheme.

### Indirect fire emissions

While fire emissions within the year of the fire are majority of the GHG flux, enhanced post-fire decomposition of dead biomass persists for many years after a fire. The increase in post-fire tree mortality between the year of the fire and the year following the fire is as much as 30% in low and moderate-severity stands [@angers2011]. This extended mortality is not captured in year-of fire severity mapping but is likely better assessed using fire severity data captured the year following fire, as is operation practice in Canada !!!![cite Ellen's upcoming paper]!!!. Similarly, the transition of fire-killed stems (snags) from upright to the forest floor woody debris takes between 5-8 years for 50% of stems to fall [@angers2011] with stemfall rate highest in low-severity fire. Field observations show that initial assessments of fire severity are the primary predictors of snag fall @angers2011 and decomposition [@boulanger2011] rates, meaning the mapped severity method used here provides a useful input for multi-year fire carbon modelling of the snag pool in CBM. For organic soil pools, fire has been shown to suppress decomposition rates in upland soil pools where drier post-fire conditions are present [@holden2015], while in permafrost upland [@odonnell2011] and peatland [@gibson2018; @gibson2019] systems, fire has profound impacts on soil carbon pools by rapidly increasing thaw depths and subsequent decomposition rates. Currently in CBM, decomposition rates are calibrated against field decomposition litterbag experiments [@trofymow2002] and annual climate metrics that do not take into account how disturbances such as fire (and fire of varying severity) modify decomposition rates in the absence of a change in climate.

### Model gaps

Currently, the model framework only accounts of regionally-averaged soil carbon stocks, meaning that Reporting Units with high peatland areas will show higher organic soil slow pool size (see Table \###), but peatlands themselves are not spatially represented in the model. Currently, fire disturbance in peatlands is performed by the CaMP model, which uses the closely related Drought Code fire weather metric to estimate peat layer consumption [@bona2020] and uses the overstory carbon schema of CBM to estimate overstory tree carbon pools and fluxes. Direct satellite monitoring of upland forest organic soil and peatland carbon loss via burn severity monitoring is possible but remains a challenge to implement with accuracy for monitoring purposes [@bourgeau-chavez2020]. Despite the large carbon stock, the mean C emissions per area in peatland due to fire (65 t C/ha) as modelled by @bona2024 are comparable to regional emissions from peat-rich ecozones such as the Boreal and Taiga Plains under moderate to severe drought conditions. Indeed, it is under these moderate to severe drought conditions under which peatlands burn more frequently [@turetsky2004; @thompson2019] and severely [@kuntzemann2023].

This algorithm is currently built off of regionally averaged biomass pools by Reporting Unit (Figure 1; Appendix \###). While Canadian wildfires shown an overall selection bias towards preferentially burning older conifer stands [@bernier2016], fuel selectivity against less flammable portions of the landscape decreases strongly under severe drought conditions [@parks2018] such as those experienced in Canada in 2023 [@jain2024] where we performed the algorithm validation against independent fire emissions observations. Algorithm evaluation against individual fires or years of less profound drought would be more likely to highlight the limitation of the regionally-averaged carbon pool (i.e. fuel load) values used here. Ultimately, the mapped severity used here is best paired with mapped carbon pools at a similar scale, such as the 1-ha forest carbon modelling for analysis and scenario testing used by @smyth2024.

Species-specific traits in trees with overlapping ranges, such as resprouting is aspen [@brown1987] but not other broadleaves such as oak or maple, are not explicitly handled in this model. Instead, the relative abundance of trees with contrasting traits that influence ecological outcomes such as fire survival are lumped at the ecozone scale from the aggregation of the plot data. While ecozone-level contrasts in key considerations such as overstory mortality do strongly vary by ecozone !!!![Table \###], the same DM (e.g. hardwood root mortality) is applied in adjacent stands at the same severity class despite the potential for strongly contrasting traits that are readily tied back to mapping at the stand level by leading species. Alternately, models such as CanFIRE can account for species-level contrasts in fire ecology traits, but compiling the relevant ecophysiological properties and traits for all tree species in Canada remains incomplete at the current time.

# Conclusions

Carbon emissions from wildfires in Canada represent a substantial pulse input of greenhouse gases to the atmosphere: the 2023 fire emissions in Canada were an input of approximately `r {round(sum(AnnualEmissionsSummary$SumC_direct_emissions/10^6,na.rm=TRUE),digits=0)}` Mt C. A modelling framework to extend the current fire and greenhouse gas reporting in Canada is presented. In contrast to the existing modelling system that utilizes a fixed fire severity (i.e. tree mortality) assumption, a field-calibrated satellite fire severity mapping process that follows mature and well-established scientific methods is used. Above-ground carbon pool changes (from live to dead and in situ as well as to the gas phase) rely on a robust field observation dataset that relates back to satellite metrics. Evaluation of the modelling presented above against fully independent airborne observations of CO:CO~2~ emissions ratios for boreal wildfires indicates the modelling of proportion of flaming vs smouldering emissions are well-replicated by the model. With confidence in this modelled CO:CO~2~ ratio, the total fire CO emissions for the 2023 wildfire season in Canada (with a record 15 Mha burned) is broadly consistent with fire season estimates using satellite total column CO anomalies.

While this prototype carbon flux framework utilizes regionally-averaged carbon stock estimates, future systems deployment within Canada's carbon accounting system is likely to incorporate precisely mapped (1 ha) carbon pools alongside the finely mapped fire severity products (30 m) used here. As both the spatial estimates of carbon stocks across Canada's forested ecosystems improves alongside additional field observations, it is anticipated that this modelling framework will increase in both accuracy and precision over time.

# Appendix A: Mean pool size by Reporting Unit

```{r PoolSizeByRU, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

### Two tables, one abovegroud, one organic soil, with RU as columns?
###rows are RUs as EcoAdmin
NIR_AverageCPools_filterSurface <- NIR2023_AverageCPools %>% filter(TimeStep==0) %>% select('EcoBoundaryNameShort','AdminBoundaryName','Aboveground Very Fast DOM':'organic soil Slow DOM','Softwood Stem Snag':'Softwood Other','Softwood Coarse Roots','Softwood Fine Roots','Hardwood Coarse Roots','Hardwood Fine Roots')  %>% filter(EcoBoundaryNameShort != "ShP") %>% filter(EcoBoundaryNameShort != "SaP") %>% filter(EcoBoundaryNameShort != "MP") %>% select(!'Black Carbon') %>% select(!Peat)

NIR_AverageCPools_filterCanopy <- NIR2023_AverageCPools %>% filter(TimeStep==0) %>% select('EcoBoundaryNameShort','AdminBoundaryName','Softwood Stem Snag':'Softwood Other','Hardwood Merchantable':'Hardwood Other') %>% filter(EcoBoundaryNameShort != "ShP") %>% filter(EcoBoundaryNameShort != "SaP") %>% filter(EcoBoundaryNameShort != "MP") %>% select(!'Black Carbon') %>% select(!Peat)



kbl(NIR_AverageCPools_filterSurface) %>%
    kable_styling(full_width = F, html_font = "Cambria") %>%
  kable_styling(latex_options = "scale_down")  %>%
  kable_styling(latex_options = "hold_position")

kbl(NIR_AverageCPools_filterCanopy) %>%
    kable_styling(full_width = F, html_font = "Cambria") %>%
  kable_styling(latex_options = "scale_down")  %>%
  kable_styling(latex_options = "hold_position")

  
```

# Appendix B: non-linear least squares modelling of soil organic layer consumption

For national annual estimates of forest organic soil layer consumption during wildfire, implementations that only utilize Canadian experimental fire data from the Fire Behaviour Prediction System will be limited to a maximum consumption value of 5 kg (biomass) m^-2^ of total surface fuel (woody debris, litter, and duff) of 5 kg m^-2^, or 25 Mg C ha^-1^, given the observation dataset and fitted model parameters. For the common "C-2" boreal spruce fuel type for instance, Surface Fuel Consumption, SFC (biomass units in kg m^-2^ not kg C) is modelled as:

```{=tex}
\begin{equation}
SFC = 5.0 \left(1-e^{-0.0115BUI} \right)^{1.0}
\end{equation}                                             
```
This model form has the distinct advantage of SFC being 0.0 at a BUI of zero. The model parameters vary by fuel type (i.e. deciduous broadleaf fuels are limited to 1.5 kg m^-2^ of maximum SFC) but are fixed within a fuel type.

More recent observations and modelling from @degroot2009 extended the FBP data with an additional 128 observations from 7 additional wildfires, and the ABoVE project compiled over 1,000 field observations of depth of burn and C stocks before and after wildfire in Canada and Alaska, over 600 of which are in North American Level II ecoregions also occurring in Canada [@walker2020]. @degroot2009 provides a concise and informative improvement on the FBP fuel consumption equations, where both a Fire Weather Index System component (in this case, Buildup Index) is used similarly to Buildup Index in the FBP, but importantly, the site-level organic soil layer fuel load is also accounted for, which allows for the greater absolute combustion in deeper organic soils that is moderated by the natural logarithm transformation:

```{=tex}
\begin{equation}
log_{e}(FFFC) = -4.252+0.710log_{e}(DC) + 0.671log_{e}(FFFL)
\end{equation}
```
where FFFC is Forest Floor Fuel Consumption (SFC minus surface woody debris) in kg (biomass) m^-2^ and FFFL is Forest Floor Fuel Load in kg m^-2^. The forest floor as defined here is inclusive of the litter and duff layers, live mosses and lichens. This model presented above fits well within the dataset and extends the observed maximum FFFC to nearly 10 kg m^-2^. The ABoVE synthesis of FFFL and FFFC (Walker et al 2020 ORNL) expands upon a slightly smaller dataset used in a modelling summary also by Walker et al (2020 NCC), where structural equation modelling was used to explore drivers of FFFC but no concise and readily reproducible modelling is produced. The results of the SEM from Walker et al (2020 NCC) emphasized a greater role of FFFL over DC, though coarse reanalysis that lacked local fire agency weather stations was used. An analysis of just 2014 fires in the Northwest Territories by (walker2018) showed that while the mean depth of burn across all black spruce stands was 6-10 cm, the driest (xeric) black spruce stands with the smallest FFFL showed upwards of 75% soil organic consumption, while deeper organic soils in subhygric black spruce stands showed less than 25% consumption.

To provide the largest possible dataset for FFFC and FFFL, the ABoVE synthesis was combined with wildfire data from de Groot et al 2009 not otherwise found in the ABoVE synthesis. The ABoVE synthesis sites in the Alaska Boreal Interior ecoregion, which have equivalent Canadian ecozone were excluded due to the presence of continuous permafrost and deep organic soils, but Alaska Boreal Cordillera sites near the Yukon border were utilized. Experimental fire data from the FBP data was not used, as deeper combustion measurements resulting from hours and days of smouldering combustion captured in wildfire data are not available in experimental fires where extensive smouldering is not measured due to suppression. In order to best represent on-the-ground Fire Weather Index values, the Drought Code and other FWI values from Walker et al 2020 reanalysis were substituted with interpolated weather station (both Environment and Climate Change Canada as well fire agency stations). This data also has the benefit of being properly overwintered for Drought Code (Hanes DC overwinter) and capturing small rain events not captured in reanalysis that meaningfully impact the Duff Moisture Code in particular.

For the purposes of improving national estimates of the fractional soil organic layer loss during wildfire, this framework emphasizes the proportional C stock loss (as with all CBM disturbance matrices) rather than the absolute value of combustion. In contrast to the modelling of absolute combustion value, any analysis of proportions is best conducted as logit- transformed data, where the logit transformation is:

```{=tex}
\begin{equation}
logit(p) = log\frac{p}{1-p}
\end{equation}
```
which effectively transforms a data of proportions of [0,1] to a Gaussian distribution with a range of approximately -5 to +5 (in this dataset), and a mode approximately at zero. 

 In the logit transformed space, saturation-type non-linear curve using the relevant FWI component was fitted in a non-linear least squares model, but an additive term of the natural-logarithm transformed forest floor fuel load (FFFL) (given as AGSlow pool in Mg C/ha) was used as well.  The non-linear least squares model fit was conducted using the Levenberg-Marquardt nonlinear least-squares algorithm found in MINPACK (Elzhov et al 2023) R package, which supported bounded parameter constraints.

In the abstract, the model follows the form:

```{=tex}
\begin{equation}
logit \left( \frac{depth of burn}{pre-fire organic depth}\right) = [c (1 - e^{(a  DC)})] + (b log_{e}(AGSlow))
\end{equation}
```
with fitted parameters as:

```{=tex}
\begin{equation}
logit \left( \frac{depth of burn}{pre-fire organic depth}\right) = [3.50 (1 - e^{(-0.008 BUI)})] + (-0.45 log_{e}(AGSlow))
\end{equation}
```
Note the "b" coefficient on the parameter associated with the FFFL (AGSlow) of -0.458, which results in larger organic layer fuel loads leading to smaller proportional consumption values, which follows the patterns shown by Walker 2018 for NWT fires of 2014.

The a parameter term that forms the exponent of e alongside the Buildup Index is related to the BUI value at which half of the maximum possible asymptotal consumption value is observed (for a given FFFL value). The NLS fitting was given a minimum value of -0.008 such that a 50% consumption rate was modelled as occurring at or around a BUI value of 70 for typical upland spruce forest floor (FFFL of 8 kg/m2 or AGSlow of 40 t C/ha) following the wildfire data of de Groot et al 2008 as well as experimental fire observations in spruce forests from the FBP System. The other parameters were fit to the best possible value with no constraint.


For example, using a moderately thick \~12 cm thick organic soil layer, the proportion of consumption as a function of Buildup Index using the model above:

```{r example-FFFC-vs-DC-plot-nls, echo=FALSE, message=FALSE, warning=FALSE}

###just show a single (or multiple?) FFFL values here but DC on the x-axis, consumption on the y-axis:

#but also show the raw data pointed coloured by ecozone for that slice of MedDOM (say 70-90) since the median is 80

buildup_index = seq(from = 0.0, to = 300,by = 10)
AGSlow.Mg.C.ha = rep(60,length(buildup_index))

FFFC.single.final.df <- cbind(buildup_index,AGSlow.Mg.C.ha)

FFFC.single<- array(NA,dim=c(length(buildup_index)))
#FFFC.grid <- as.data.frame(FFFC.grid)

for(i in seq(1:length(buildup_index))){

  FFFC.single[i] <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI,newdata=FFFC.single.final.df[i,])))
  }

FFFC.single <- as.data.frame(FFFC.single)

FFFC.single <- t(FFFC.single)

FFFC.single.final.df <- cbind(buildup_index,AGSlow.Mg.C.ha,FFFC.single)

colnames(FFFC.single.final.df)[3] <- c("prop_sol_c_combusted")

ggplot(FFFC.single.final.df, aes(buildup_index,prop_sol_c_combusted)) + geom_line()# + geom_point(data=subset(ABoVE_Data_w_FBP_excl_BC,AGSlow.Mg.C.ha>50 & AGSlow.Mg.C.ha<70)) + ylim(0,1)

```

With the parameter constrained NLS fitting, the proportional consumption model for the forest floor has a leave-one-out (conducted at the fire-level, not plot) cross validated r2 of ###, and a Mean Percent Error of ###%

```{r show-biplot-FFFC-new, echo=FALSE}
ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_c_combusted,nls.pred.BUI)) + geom_point(aes(colour = factor(ecozone))) + geom_abline(intercept = 0, slope = 1) + ylim(0,1) + geom_abline(intercept = 0,linetype = "dotdash", slope = 1.25) + geom_abline(intercept = 0,linetype = "dotdash", slope = 0.75) + ylim(0,1) + xlim(0,1) + geom_abline(intercept = 0,linetype = "dotted", slope = 1.55) + geom_abline(intercept = 0,linetype = "dotted", slope = 0.50) + ylim(0,1) + xlim(0,1)
```

Across the entire parameter space of Buildup Index and AGSlow pool size, the following isolines of proportional consumption in the model can be plotted:

```{r FFFC-surface-plot, echo=FALSE, message=FALSE, warning=FALSE}
###goal is to produce a surface plot from DC from 0-750 and AGSlow from 0-200 (or 0-500 maybe)
### with isolines of FFFC/FFFL


FFFC_expand <- tibble(
  drought_code = seq(from = 0.0, to = 750,by = 25),
AGSlow.Mg.C.ha = seq(from = 0, to = 600,by = 20)) ## has to be same size, so 31 in this case


FFFC_expand <- as.data.frame(expand(data=FFFC_expand,drought_code,AGSlow.Mg.C.ha))



FFFC.grid <- array(NA,dim=c(length(FFFC_expand$drought_code)))
#FFFC.grid <- as.data.frame(FFFC.grid)

for(i in seq(1:length(FFFC_expand$drought_code))){

  FFFC.grid[i] <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC,newdata=FFFC_expand[i,])))
  }
FFFC.grid <- as.data.frame(FFFC.grid)

FFFC.grid <- t(FFFC.grid)

FFFC_expand <- cbind(FFFC_expand,FFFC.grid)

colnames(FFFC_expand)[3] <- c("prop_total_bg_c_combusted")


##let's add in some example data:

#fuelTypes <- c("C-1", "C-3", "C-7", "O-1")
#SH <- c(4.1,9,9,0)
#CC <- c(8,40,5,0)

#FBP.Example <- as.data.frame(cbind(fuelTypes,SH,CC))
#FBP.Example$SH <- as.numeric(FBP.Example$SH)
#FBP.Example$CC <- as.numeric(FBP.Example$CC)

##plot
brks_FFFC <- c(0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2)

### rename ABoVE_Data_w_FBP_excl_BC$prop_total_bg_c_combusted as "prop_total_bg_c_combusted"

#ggplot(FFFC_expand, aes(drought_code, AGSlow.Mg.C.ha, z=prop_total_bg_c_combusted)) + geom_contour(breaks=brks_FFFC) + geom_dl(aes(label=..level..), method="top.pieces", stat="contour",breaks = brks_FFFC) +labs(caption="Isoline contours of equal organic soil layer consumption fraction as a function of Drought Code and the organic soil layer (Aboveground Slow DOM) Carbon pool in Mg C/ha.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba") +xlab("Drought Code") + ylab("Duff (AGSlow) load Mg C/ha") + theme(plot.caption = element_text(hjust = 0)) + geom_rug(data=ABoVE_Data_w_FBP_excl_BC) +scale_y_continuous(limits = c(0,250))

###would love for the geom_rug to work.....
###+ geom_rug(data=ABoVE_Data_w_FBP_excl_BC)

#TO DO: add in more text at quartiles of AGSlow

# + geom_hline(yintercept=quantile(ABoVE_Data_w_FBP_excl_BC$AGSlow.Mg.C.ha,na.rm=TRUE,c(0.25))) + geom_hline(yintercept=quantile(ABoVE_Data_w_FBP_excl_BC$AGSlow.Mg.C.ha,na.rm=TRUE,c(0.5))) + geom_hline(yintercept=quantile(ABoVE_Data_w_FBP_excl_BC$AGSlow.Mg.C.ha,na.rm=TRUE,c(0.75))) #+scale_y_continuous(limits = c(0,20)) +scale_x_continuous(limits = c(0,60))# + geom_text(data=FBP.Example,aes(CC,SH,label=fuelTypes), inherit.aes = FALSE)

#+geom_tile() ###use fill=prop_total_bg_c_combusted
FFFC_expand.BUI <- tibble(
  buildup_index = seq(from = 0.0, to = 300,by = 10),
AGSlow.Mg.C.ha = seq(from = 0, to = 600,by = 20)) ## has to be same size, so 31 in this case

FFFC_expand.BUI <- as.data.frame(expand(data=FFFC_expand.BUI,buildup_index,AGSlow.Mg.C.ha))

FFFC.grid.BUI <- array(NA,dim=c(length(FFFC_expand.BUI$buildup_index)))
#FFFC.grid <- as.data.frame(FFFC.grid)

for(i in seq(1:length(FFFC_expand.BUI$buildup_index))){

  FFFC.grid.BUI[i] <- as.data.frame(inv.logit(predict(ABoVE.FFFC.Frac.Consume.nlsLM.excl.BC.BUI,newdata=FFFC_expand.BUI[i,])))
  }
FFFC.grid.BUI <- as.data.frame(FFFC.grid.BUI)

FFFC.grid.BUI <- t(FFFC.grid.BUI)

FFFC_expand.BUI <- cbind(FFFC_expand.BUI,FFFC.grid.BUI)

colnames(FFFC_expand.BUI)[3] <- c("prop_total_bg_c_combusted")


##let's add in some example data:

#fuelTypes <- c("C-1", "C-3", "C-7", "O-1")
#SH <- c(4.1,9,9,0)
#CC <- c(8,40,5,0)

#FBP.Example <- as.data.frame(cbind(fuelTypes,SH,CC))
#FBP.Example$SH <- as.numeric(FBP.Example$SH)
#FBP.Example$CC <- as.numeric(FBP.Example$CC)

##plot

brks_FFFC <- c(0.95,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2)

### rename ABoVE_Data_w_FBP_excl_BC$prop_total_bg_c_combusted as "prop_total_bg_c_combusted"

ggplot(FFFC_expand.BUI, aes(buildup_index, AGSlow.Mg.C.ha, z=prop_total_bg_c_combusted)) + geom_contour(breaks=brks_FFFC) + geom_dl(aes(label=..level..), method="top.pieces", stat="contour",breaks = brks_FFFC) +labs(caption="Isoline contours of equal organic soil layer consumption fraction as a function of BUI and the organic soil layer (Medium DOM) Carbon pool in Mg C/ha.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba") +xlab("Buildup Index") + ylab("Duff (AGSlow) load Mg C/ha") + theme(plot.caption = element_text(hjust = 0)) + geom_rug(data=ABoVE_Data_w_FBP_excl_BC) +scale_y_continuous(limits = c(0,125)) + scale_x_continuous(limits = c(0,200))

FFFC_expand.BUI$FFFL <- FFFC_expand.BUI$AGSlow.Mg.C.ha/5

### total forest floor consumption in familiar FBP units (kg/m2)
FFFC_expand.BUI$FFFC <- FFFC_expand.BUI$FFFL*FFFC_expand.BUI$prop_total_bg_c_combusted

###plot with FBP units for fuel load, and upper limit of FBP Red Book BUI

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFL, z=prop_total_bg_c_combusted)) + geom_contour(breaks=brks_FFFC) + geom_dl(aes(label=..level..), method="top.pieces", stat="contour",breaks = brks_FFFC) +labs(caption="Isoline contours of equal organic soil layer consumption fraction as a function of BUI and the organic soil layer (Medium DOM) Carbon pool in Mg C/ha.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba") +xlab("Buildup Index") + ylab("Forest Floor Fuel Load (kg/m2)") + theme(plot.caption = element_text(hjust = 0)) + scale_y_continuous(limits = c(0,25)) + scale_x_continuous(limits = c(0,300))

### try it with isolines of absolute consumption:

brks_FFFC_abs <- c(1,2.5,5,10,15,20)

FFFC_expand.BUI <- FFFC_expand.BUI %>% filter(FFFL < 25) %>% filter(buildup_index < 300)

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFL, z=FFFC)) + geom_contour(breaks=brks_FFFC_abs) + scale_y_continuous(limits = c(0,25)) + scale_x_continuous(limits = c(0,300)) + geom_dl(aes(label=..level..), method="maxvar.qp", stat="contour",breaks = brks_FFFC_abs)+labs(caption="Isoline contours of equal organic soil layer consumption in kg/m2 as a function of BUI and the organic soil layer fuel load in kg/m2.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba") +xlab("Buildup Index") + ylab("Forest Floor Fuel Load (kg/m2)") + theme(plot.caption = element_text(hjust = 0)) 

###maybe like FBP with FFFC vs BUI, then varying lines of FFFL:

FFFC_expand.BUI <- FFFC_expand.BUI %>% filter(FFFL > 0) %>% filter(buildup_index > 0) # %>% filter(buildup_index < 300)

brks_FFFL_abs <- c(4,8,12,20)

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFC, z=FFFL)) + geom_contour(breaks=brks_FFFL_abs) + scale_y_continuous(limits = c(0,25)) + scale_x_continuous(limits = c(0,300)) + geom_dl(aes(label=..level..), method="maxvar.qp", stat="contour",breaks = brks_FFFL_abs)+labs(caption="Isoline contours of equal organic soil layer consumption in kg/m2 as a function of BUI and the organic soil layer fuel load in kg/m2.  Field observations of burn from 547 field measurements across Canada from the Yukon-Alaska border to Manitoba") +xlab("Buildup Index") + ylab("Forest Floor Fuel Load (kg/m2") + theme(plot.caption = element_text(hjust = 0)) 

ggplot(FFFC_expand.BUI, aes(buildup_index, FFFC)) + geom_point(aes(colour = FFFL))

```

```{r correction-factor, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(ABoVE_Data_w_FBP_excl_BC, aes(prop_sol_combusted)) +stat_ecdf(geom = "step")

```

### Boreal Cordillera modelling

For the Boreal Cordillera, a simple linear model on the logit-transformed data was found to be the best performing model for estimating soil organic consumption proportion:

```{=tex}
\begin{equation}
logit \left( \frac{FFFC}{FFFL}\right) = (0.00257 * DC) + (-0.54 * log_{e}(AGSlow)) + 2.17
\end{equation}
```
In this case, the Drought code component of the Buildup Index is used, since a fit using Buildup Index alone does not produce a coefficient on the Buildup Index term in the model that is different from zoer.  Despite the presence of a fixed intercept term, the strong inverse dependence on the natural logarithm of the AGSlow pool size (FFFL) results in zero proportional consumption when Drought Code is equal to zero.

# Appendix C: annual variability in observed Buildup Index during wildfire spread, and impact on modelled ecozone-level forest floor emissions

```{r AnnualDC, echo=FALSE, message=FALSE, warning=FALSE}

###can always update this via CFSDB: https://osf.io/f48ry/
Firegrowth_groups_v1_01 <- read.csv("C:/Users/danthomp/Downloads/Firegrowth_groups_v1_01.csv")


##weighted-mean BUI of spread by year and ecozone
CFSDB_summary <- Firegrowth_groups_v1_01 %>% group_by(ecozone,year) %>% summarise(AreaWeightedBUIofSpread = weighted.mean(bui,firearea,na.rm=TRUE), n = n())

CFSDB_summary_ecozone <- Firegrowth_groups_v1_01 %>% group_by(ecozone) %>% summarise(AreaWeightedBUIofSpread = weighted.mean(bui,firearea,na.rm=TRUE), n = n())

Airborne_summary <- Firegrowth_groups_v1_01 %>% filter(year==2008) %>% filter(DOB==186) %>% filter(ecozone ==6) %>% summarise(mean_bui = mean(bui))

###Load annual hotspot median DC by ecozone (via Quinn Barber and CFSDB)
DC.year <- read.csv("~/nrcan-cfs-fire/FireDMs/DC_by_ecozone_year.csv")

ecozones.unique <- DC.year %>% group_by(Ecozone) %>% summarize(EcoID = mean(ECOZONE),FFFL = mean(Median.Forest.Floor.Load.kg.m2)) 

###gotta join Firegrowth_groups_v1_01 to DC.year to get the ecozone names ported over:

CFSDB_summary <- full_join(CFSDB_summary,ecozones.unique,by = join_by(ecozone == EcoID))


##which has the forest floor loading data from the FFFC dataframe already loaded in:

##if DC50 < 20, then set to DC=20
##not sure the source of DC50 == 0 in CFSDB....
DC.year$DC50 <- ifelse(DC.year$DC50<20,250,DC.year$DC50)

## apply isn't working easily, silly matrix output
#as.data.frame(t(apply(X = DC.year, MARGIN = 1, FUN = CalcFFFC, DC=DC.year$DC50,AGSlow=(DC.year$Median.Forest.Floor.Load.kg.m2*5))))

CFSDB_summary$Duff.consump.frac <- NA
CFSDB_summary$Duff.consump.kg.m2 <- NA


for (i in seq(from=1,to=nrow(CFSDB_summary)))
{
  CFSDB_summary$Duff.consump.frac[i] <- CalcFFFC(BUI=CFSDB_summary$AreaWeightedBUIofSpread[i],AGSlow=CFSDB_summary$FFFL[i]*5)

CFSDB_summary$Duff.consump.kg.m2[i] <- CFSDB_summary$Duff.consump.frac[i]*CFSDB_summary$FFFL[i]
 
  
}
 

###if we want, can also query the annual area burned by ecozone by year, then compute it all up from there to get some mass amount
  


```

```{r AnnualDC-Vis-DC50, echo=FALSE, message=FALSE, warning=FALSE}
 
   ### the graphs, all time series: (1) annual DC by year; (2) absolute consumption values by year; (3) fractional consumption values by year; (4) will add in burned area by ecozone by year eventually too

ggplot(CFSDB_summary, aes(year,AreaWeightedBUIofSpread,colour=Ecozone))  + geom_point() + ylab("Median Buildup Index of fires in ecozone") + facet_wrap(vars(Ecozone)) +theme(legend.position="none")
  
  
  #

#+ geom_dl(aes(label = Ecozone, color = Ecozone), method=list("last.points",rot=30))

```

```{r AnnualDC-Vis-Consump, echo=FALSE, message=FALSE, warning=FALSE}


ggplot(CFSDB_summary, aes(year,Duff.consump.kg.m2,colour=Ecozone)) + facet_wrap(vars(Ecozone)) +theme(legend.position="none")+ geom_point() + ylab("Modelled Duff Consumption, kg/m2") +
  theme(legend.position="none") 
  
#+ geom_dl(aes(label = Ecozone, color = Ecozone), method=list("last.points",rot=30)) + 

```

```{r AnnualDC-Vis-frac, eval=FALSE, fig.height=3, fig.width=4, message=FALSE, warning=FALSE, include=FALSE}
 

ggplot(CFSDB_summary, aes(year,Duff.consump.frac,colour=Ecozone))+ geom_dl(aes(label = Ecozone, color = Ecozone), method=list("last.points",rot=30)) + geom_line() + ylab("Modelled duff consumption proportion") + theme(legend.position="none")

```

# Appendix D: Representative photos

Photos of: (1) partial litter consumption; (2) partial vs full duff consumption; (3) mortality but not consumption of understory trees with live overstory; (4) mortality but not consumption of overstory trees; (5) mixedwood severity example showing consumption of broadleaf foliage; (6) woody debris consumption; (7) snag preferential consumption relative to little to no bole consumption in live trees

Give lat/long, year, ecozone, severity class, and leading spp for each photo, maybe other relevant metrics? From some of the experimental fires mostly??

# Appendix E: List of Resprouting Hardwoods of Canada

Alnus spp. Arbutus men. Betula all. Betula pap. Betula pop. Fraxinus ame. Fraxinus nig. Fraxinus pen. Populus bal. Populus gra. Populus tre. Populus tri. Quercus spp. Salix spp.
